<!doctype html>
<!--
  Компонентът „Начално табло“ използва css/dashboard_panel_styles.css за визията
  и js/populateUI.js за динамичното зареждане на стойности.
  При промени синхронизирайте:
    • .main-indexes ↔ populateDashboardMainIndexes
    • #detailedAnalyticsAccordion, .macro-metrics-grid ↔ populateDashboardDetailedAnalytics
    • .progress-bar/.progress-fill ↔ getProgressColor, animateProgressFill
  Пример в code.html:
    <link rel="stylesheet" href="css/dashboard_panel_styles.css">
    <script type="module">
      import { populateUI } from './js/populateUI.js';
      await populateUI();
    </script>
  Прехвърлете CSS променливи: --space-lg, --space-sm, --space-xs,
    --text-color-secondary, --surface-background,
    --progress-color.
-->
<html lang="bg">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ONE BODY - Вашето Персонално Табло</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <!-- Коригирани CSS Връзки -->
    <link href="css/base_styles.css" rel="stylesheet" />
    <link href="css/layout_styles.css" rel="stylesheet" />
    <link href="css/components_styles.css" rel="stylesheet" />
    <link href="css/dashboard_panel_styles.css" rel="stylesheet" />
    <link href="css/profile_panel_styles.css" rel="stylesheet" />
    <link href="css/week_plan_panel_styles.css" rel="stylesheet" />
    <link href="css/recommendations_panel_styles.css" rel="stylesheet" />
    <link href="css/extra_meal_form_styles.css" rel="stylesheet" />
    <link href="css/plan_mod_chat_styles.css" rel="stylesheet" />
    <link href="css/responsive_styles.css" rel="stylesheet" />
    <style>
      body.code-page {
        background: var(--code-bg);
        color: var(--code-text-primary);
      }
      .code-page h1 {
        color: var(--header-title-color);
      }
      .code-page a {
        color: var(--code-accent);
      }
    </style>
    <!-- Цветовете от админ панела се зареждат в app.js след инициализация на темата -->
    <!-- Chart.js - зарежда се в края на body за по-добра производителност -->
  </head>
  <body class="code-page">
    <!-- ======================================================================= -->
    <!-- ========================= SVG ICONS DEFINITION ======================== -->
    <!-- ======================================================================= -->
    <svg style="position: absolute; width: 0; height: 0" aria-hidden="true">
      <symbol
        id="icon-info"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"
          fill="currentColor"
        ></path>
      </symbol>
      <symbol
        id="icon-check"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"
          fill="currentColor"
        ></path>
      </symbol>
      <symbol
        id="icon-warning-triangle"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M12 2L1 21h22M12 6l7.55 13H4.45M11 10v4h2v-4m-2 6v2h2v-2"
          fill="currentColor"
        ></path>
      </symbol>
      <symbol
        id="icon-menu-burger"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
        ></path>
      </symbol>
      <symbol
        id="icon-close"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        ></path>
      </symbol>
      <symbol
        id="icon-send"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="currentColor"
      >
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
      </symbol>
      <symbol
        id="icon-upload"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 3v13m0 0l-5-5m5 5l5-5M3 16v5h18v-5"
        />
      </symbol>
      <symbol
        id="icon-trash"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3 6h18M8 6V4h8v2m-6 4v8m-4-8v8m8-8v8M6 6v12a2 2 0 002 2h8a2 2 0 002-2V6"
        />
      </symbol>
      <symbol
        id="icon-spinner"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"
        ></path>
      </symbol>
      <symbol
        id="icon-chevron-right"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M8.25 4.5l7.5 7.5-7.5 7.5"
        ></path>
      </symbol>
      <symbol
        id="icon-feedback"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="currentColor"
      >
        <path
          d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 12H5.17L4 15.17V4h16v10zm-6-5.41L14.59 8 12 10.59 9.41 8 8 9.41 10.59 12 8 14.59 9.41 16 12 13.41 14.59 16 16 14.59 13.41 12 16 9.41z"
        />
      </symbol>
      <symbol
        id="icon-chart-line"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="currentColor"
      >
        <path
          d="M16,11.78L20.24,4.45L21.97,5.45L16.74,14.5L10.23,10.75L5.46,19H22V21H2V3H4V17.54L9.5,8L16,11.78Z"
        />
      </symbol>
      <symbol
        id="icon-lightbulb"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        fill="currentColor"
      >
        <path
          d="M12,2A7,7 0 0,0 5,9C5,11.38 6.19,13.47 8,14.74V17A1,1 0 0,0 9,18H15A1,1 0 0,0 16,17V14.74C17.81,13.47 19,11.38 19,9A7,7 0 0,0 12,2M9,21A1,1 0 0,0 10,22H14A1,1 0 0,0 15,21V20H9V21Z"
        />
      </symbol>
      <symbol id="icon-email" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </symbol>
      <symbol id="icon-settings" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </symbol>
      <symbol id="icon-edit" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M16.8617 4.48667L18.5492 2.79917C19.2814 2.06694 20.4686 2.06694 21.2008 2.79917C21.9331 3.53141 21.9331 4.71859 21.2008 5.45083L10.5822 16.0695C10.0535 16.5981 9.40144 16.9868 8.68489 17.2002L6 18L6.79978 15.3151C7.01323 14.5986 7.40185 13.9465 7.93052 13.4178L16.8617 4.48667ZM16.8617 4.48667L19.5 7.12499M18 14V18.75C18 19.9926 16.9926 21 15.75 21H5.25C4.00736 21 3 19.9926 3 18.75V8.24999C3 7.00735 4.00736 5.99999 5.25 5.99999H10"/>
      </symbol>
      <symbol id="icon-question" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M9.87891 7.51884C11.0505 6.49372 12.95 6.49372 14.1215 7.51884C15.2931 8.54397 15.2931 10.206 14.1215 11.2312C13.9176 11.4096 13.6917 11.5569 13.4513 11.6733C12.7056 12.0341 12.0002 12.6716 12.0002 13.5V14.25"/>
        <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"/>
        <path d="M12 17.25H12.0075V17.2575H12V17.25Z"/>
      </symbol>
      <symbol id="icon-logout" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M15.75 9V5.25C15.75 4.00736 14.7426 3 13.5 3L7.5 3C6.25736 3 5.25 4.00736 5.25 5.25L5.25 18.75C5.25 19.9926 6.25736 21 7.5 21H13.5C14.7426 21 15.75 19.9926 15.75 18.75V15"/>
        <path d="M18.75 15L21.75 12M21.75 12L18.75 9M21.75 12L9 12"/>
      </symbol>
      <symbol id="icon-user" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M15.75 6C15.75 8.07107 14.071 9.75 12 9.75C9.9289 9.75 8.24996 8.07107 8.24996 6C8.24996 3.92893 9.9289 2.25 12 2.25C14.071 2.25 15.75 3.92893 15.75 6Z"/>
        <path d="M4.5011 20.1182C4.5714 16.0369 7.90184 12.75 12 12.75C16.0982 12.75 19.4287 16.0371 19.4988 20.1185C17.216 21.166 14.6764 21.75 12.0003 21.75C9.32396 21.75 6.78406 21.1659 4.5011 20.1182Z"/>
      </symbol>
      <symbol id="icon-calendar" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M6.75 3V5.25M17.25 3V5.25M3 18.75V7.5C3 6.25736 4.00736 5.25 5.25 5.25H18.75C19.9926 5.25 21 6.25736 21 7.5V18.75M3 18.75C3 19.9926 4.00736 21 5.25 21H18.75C19.9926 21 21 19.9926 21 18.75M3 18.75V11.25C3 10.0074 4.00736 9 5.25 9H18.75C19.9926 9 21 10.0074 21 11.25V18.75M12 12.75H12.0075V12.7575H12V12.75ZM12 15H12.0075V15.0075H12V15ZM12 17.25H12.0075V17.2575H12V17.25ZM9.75 15H9.7575V15.0075H9.75V15ZM9.75 17.25H9.7575V17.2575H9.75V17.25ZM7.5 15H7.5075V15.0075H7.5V15ZM7.5 17.25H7.5075V17.2575H7.5V17.25ZM14.25 12.75H14.2575V12.7575H14.25V12.75ZM14.25 15H14.2575V15.0075H14.25V15ZM14.25 17.25H14.2575V17.2575H14.25V17.25ZM16.5 12.75H16.5075V12.7575H16.5V12.75ZM16.5 15H16.5075V15.0075H16.5V15Z"/>
      </symbol>
      <symbol id="icon-moon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M21.7519 15.0019C20.597 15.4839 19.3296 15.75 18 15.75C12.6152 15.75 8.25 11.3848 8.25 6C8.25 4.67039 8.51614 3.40296 8.99806 2.24805C5.47566 3.71785 3 7.19481 3 11.25C3 16.6348 7.36522 21 12.75 21C16.8052 21 20.2821 18.5243 21.7519 15.0019Z"/>
      </symbol>
      <symbol id="icon-scale" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" />
        <path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" />
        <path d="M7 21h10" />
        <path d="M12 3v18" />
        <path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" />
      </symbol>
      <symbol id="icon-utensils" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" />
        <path d="M7 2v20" />
        <path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />
      </symbol>
      <symbol id="icon-droplet" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M12 2.25c-2.35 2.8-7.5 8.11-7.5 11.25a7.5 7.5 0 0 0 15 0c0-3.14-5.15-8.45-7.5-11.25z" />
      </symbol>
      <symbol id="icon-palette" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
        <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3M5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/>
        <path d="M16 8c0 3.15-1.866 2.585-3.567 2.07C11.42 9.763 10.465 9.473 10 10c-.603.683-.475 1.819-.351 2.92C9.826 14.495 9.996 16 8 16a8 8 0 1 1 8-8m-8 7c.611 0 .654-.171.655-.176.078-.146.124-.464.07-1.119-.014-.168-.037-.37-.061-.591-.052-.464-.112-1.005-.118-1.462-.01-.707.083-1.61.704-2.314.369-.417.845-.578 1.272-.618.404-.038.812.026 1.16.104.343.077.702.186 1.025.284l.028.008c.346.105.658.199.953.266.653.148.904.083.991.024C14.717 9.38 15 9.161 15 8a7 7 0 1 0-7 7"/>
      </symbol>
      <symbol id="icon-assistant" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2a7 7 0 0 1 7 7c0 5-7 11-7 11S5 14 5 9a7 7 0 0 1 7-7z" />
        <circle cx="10" cy="9" r="1" />
        <circle cx="14" cy="9" r="1" />
        <path d="M9 12c1 1 5 1 6 0" />
      </symbol>
      <symbol id="icon-trophy" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 012.916.52 6.003 6.003 0 01-5.395 4.972m0 0a6.726 6.726 0 01-2.749 1.35m0 0a6.772 6.772 0 01-3.044 0"/>
      </symbol>
      <symbol id="icon-brain" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 18V5" />
        <path d="M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4" />
        <path d="M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5" />
        <path d="M17.997 5.125a4 4 0 0 1 2.526 5.77" />
        <path d="M18 18a4 4 0 0 0 2-7.464" />
        <path d="M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517" />
        <path d="M6 18a4 4 0 0 1-2-7.464" />
        <path d="M6.003 5.125a4 4 0 0 0-2.526 5.77" />
      </symbol>
    </svg>
    <!-- ======================= END SVG ICONS DEFINITION ====================== -->

    <!-- ======================================================================= -->
    <!-- ========================== LOADING OVERLAY ============================ -->
    <!-- ======================================================================= -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <svg class="icon spinner" style="width: 50px; height: 50px">
        <use href="#icon-spinner"></use>
      </svg>
      <span id="loadingOverlayText" style="margin-left: 15px"
        >Зареждане...</span
      >
    </div>
    <!-- ======================= END LOADING OVERLAY =========================== -->

    <!-- ======================================================================= -->
    <!-- =================== PLAN GENERATION PENDING STATE ===================== -->
    <!-- ======================================================================= -->
    <div id="planPendingState" class="pending-state-container hidden">
      <svg
        class="icon spinner"
        style="width: 60px; height: 60px; margin-bottom: 1rem"
      >
        <use href="#icon-spinner"></use>
      </svg>
      <h2>Вашият план се генерира...</h2>
      <p>
        Благодарим ви за попълнения въпросник! Вашият персонализиран план
        ONE BODY се генерира.
      </p>
      <p>
        Моля, проверете отново по-късно. Ще бъдете уведомени (ако сте позволили
        известия) или опитайте да презаредите страницата след известно време.
      </p>
    </div>
    <!-- ================= END PLAN GENERATION PENDING STATE =================== -->

    <!-- ======================================================================= -->
    <!-- ============================ APP WRAPPER ============================== -->
    <!-- ======================================================================= -->
    <div id="appWrapper" style="display: none">
      <!-- ========================== HEADER & MAIN MENU ========================= -->
      <header>
        <div class="header-logo">
          <img src="https://radilovk.github.io/bodybest/img/logoindex.png" alt="ONE BODY" class="logo" />
        </div>
        <div id="header-user-name" class="header-user-name"></div>
        <button
          id="menu-toggle"
          aria-label="Отваряне на менюто"
          aria-expanded="false"
          aria-controls="main-menu"
        >
          <svg class="icon"><use href="#icon-menu-burger"></use></svg>
        </button>
      </header>

      <div id="menu-overlay" class="menu-overlay"></div>

      <nav
        id="main-menu"
        role="dialog"
        aria-labelledby="menu-heading"
        aria-modal="true"
      >
        <button class="menu-close" aria-label="Затваряне на менюто">
          <svg class="icon"><use href="#icon-close"></use></svg>
        </button>
        <h2 id="menu-heading" class="visually-hidden">Главно меню</h2>
        <ul>
          <li>
            <button id="theme-toggle-menu" aria-label="Смяна на тема">
              <span class="menu-icon" aria-hidden="true"><i class="bi bi-moon"></i></span>
              <span class="theme-text">Смени Тема</span>
            </button>
          </li>
          <li>
            <a href="#contact" id="menu-contact-link">
              <svg class="menu-icon" aria-hidden="true"><use href="#icon-email"></use></svg>Контакт
            </a>
          </li>
          <li>
            <button id="menu-feedback-btn" aria-label="Обратна връзка">
              <svg class="menu-icon" aria-hidden="true"><use href="#icon-feedback"></use></svg>Обратна връзка
            </button>
          </li>
          <li>
            <a href="profile-edit.html" id="menu-profile-edit-link">
              <svg class="menu-icon" aria-hidden="true"><use href="#icon-edit"></use></svg>Редакция на профил
            </a>
          </li>
          <li>
            <a href="faq.html" id="menu-help-link">
              <svg class="menu-icon" aria-hidden="true"><use href="#icon-question"></use></svg>Помощ
            </a>
          </li>
          <li>
            <a href="about.html" id="menu-about-link">
              <svg class="menu-icon" aria-hidden="true"><use href="#icon-info"></use></svg>За нас
            </a>
          </li>
        </ul>
        <div class="menu-footer">
          <button id="logoutButton">
            <svg class="menu-icon" aria-hidden="true"><use href="#icon-logout"></use></svg>Изход
          </button>
        </div>
      </nav>
      <!-- ======================= END HEADER & MAIN MENU ====================== -->

      <!-- ========================== TABS NAVIGATION ========================== -->
      <nav
        class="tabs styled-tabs"
        role="tablist"
        aria-label="Основна навигация"
      >
        <button
          id="dash-tab"
          class="tab-btn"
          role="tab"
          aria-selected="true"
          aria-controls="dash-panel"
        >
          <svg class="tab-icon" aria-hidden="true"><use href="#icon-chart-line"></use></svg><span class="tab-label">Табло</span>
        </button>
        <button
          id="profile-tab"
          class="tab-btn"
          role="tab"
          aria-selected="false"
          aria-controls="profile-panel"
        >
          <svg class="tab-icon" aria-hidden="true"><use href="#icon-user"></use></svg><span class="tab-label">Профил</span>
        </button>
        <button
          id="week-tab"
          class="tab-btn"
          role="tab"
          aria-selected="false"
          aria-controls="week-panel"
        >
          <svg class="tab-icon" aria-hidden="true"><use href="#icon-calendar"></use></svg><span class="tab-label">План</span>
        </button>
        <button
          id="recs-tab"
          class="tab-btn"
          role="tab"
          aria-selected="false"
          aria-controls="recs-panel"
        >
          <svg class="tab-icon" aria-hidden="true"><use href="#icon-lightbulb"></use></svg><span class="tab-label">Съвети</span>
        </button>
      </nav>
      <!-- ======================= END TABS NAVIGATION ========================= -->

      <main>
        <!-- ======================================================================= -->
        <!-- ========================== DASHBOARD PANEL ============================ -->
        <!-- ======================================================================= -->
        <section
          id="dash-panel"
          class="tab-content active-tab-content"
          role="tabpanel"
          aria-labelledby="dash-tab"
        >
          <div class="container">
            <!-- Основни Индекси -->
            <div class="main-indexes">
              <div class="card index-card" id="goalCard">
                <h4><i class="bi bi-bullseye"></i> <span id="goalName">Цел</span> <span id="goalProgressText" class="index-value">Изчисляване...</span></h4>
                <div class="progress-bar-container">
                  <div
                    id="goalProgressBar"
                    class="progress-bar"
                    role="progressbar"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  >
                  <div id="goalProgressFill" class="progress-fill"></div>
                  </div>
                </div>
              </div>
              <div class="card index-card" id="engagementCard">
                  <h4><i class="bi bi-link-45deg"></i> Ангажираност <span id="engagementProgressText" class="index-value">Изчисляване...</span></h4>
                <div class="progress-bar-container">
                  <div
                    id="engagementProgressBar"
                    class="progress-bar"
                    role="progressbar"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  >
                    <div
                      id="engagementProgressFill"
                      class="progress-fill"
                    ></div>
                  </div>
                </div>
              </div>
              <div class="card index-card" id="healthCard">
                <h4><i class="bi bi-heart-fill"></i> Здраве <span id="healthProgressText" class="index-value">Изчисляване...</span></h4>
                <div class="progress-bar-container">
                  <div
                    id="healthProgressBar"
                    class="progress-bar"
                    role="progressbar"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  >
                    <div id="healthProgressFill" class="progress-fill"></div>
                  </div>
                </div>
              </div>
              <!-- streakCard moved to Profile panel -->
            </div>
            <!-- Край Основни Индекси -->

            <!-- Акордеон за детайлни показатели -->
            <div
              id="detailedAnalyticsAccordion"
              class="card index-card accordion-container"
            >
            <div
              class="accordion-header"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="detailedAnalyticsContent"
              >
              <span><i class="bi bi-bar-chart" aria-hidden="true"></i> Детайлни Показатели и Анализ</span>
              <svg class="icon arrow">
                <use href="#icon-chevron-right"></use>
              </svg>
            </div>
            <div id="macroMetricsPreview" class="macro-metrics-grid macro-preview"></div>
            <div
              id="detailedAnalyticsContent"
              class="accordion-content"
              role="region"
            >
                <div
                  id="dashboardTextualAnalysis"
                  style="margin-bottom: var(--space-lg)"
                >
                  <p class="placeholder">Генериране на текстов анализ...</p>
                </div>
                <div class="card index-card" id="progressHistoryCard">
                  <h4>
                    <svg
                      class="icon"
                      style="width: 1em; height: 1em; margin-right: 0.3em"
                    >
                      <use href="#icon-chart-line"></use>
                    </svg>
                    История на Напредъка
                  </h4>
                  <div class="chart-container">
                    <p class="placeholder">
                      Зареждане на историята на напредъка...
                    </p>
                  </div>
                </div>
                <div id="analyticsCardsContainer" class="analytics-cards-grid">
                  <div id="macroAnalyticsCardContainer" class="card analytics-card"></div>
                </div>
              </div>
            </div>
            <!-- Край Акордеон детайлни показатели -->

            <!-- Меню -->
            <div id="dailyMenuCard" class="card">
              <h3 id="dailyPlanTitle"><svg class="icon"><use href="#icon-utensils"></use></svg> Меню (Зареждане...)</h3>
              <ul id="dailyMealList" class="meal-list">
                <li class="placeholder">Зареждане на храненията...</li>
              </ul>
              <button
                id="openExtraMealModalBtn"
                class="button-secondary"
                style="width: 100%"
              >
                <svg class="icon"><use href="#icon-utensils"></use></svg> Добави извънредно хранене
              </button>
            </div>
            <!-- Край Меню -->

            <!-- Дневник (с интегрирано тегло) -->
            <div id="dailyLogCard" class="card">
              <h4>
                <i class="bi bi-clipboard"></i> Дневник
                <span
                  id="dailyLogDate"
                  class="text-muted fs-sm"
                ></span>
              </h4>

              <div id="dailyTracker" class="tracker">
                <div class="placeholder">Зареждане на тракера...</div>
              </div>

              <div class="daily-note-section">
                <button
                  id="add-note-btn"
                  class="button-secondary"
                  aria-label="Добавяне или скриване на бележка за деня"
                ></button>
                <textarea
                  id="daily-note"
                  class="hidden"
                  placeholder="Вашите бележки за деня..."
                  rows="3"
                  aria-label="Бележки за деня"
                ></textarea>
              </div>
              <button
                id="saveLogBtn"
                class="button-primary"
              >
                Запази Дневник
              </button>
            </div>
            <!-- Край Дневник -->
          </div>
        </section>
        <!-- ======================= END DASHBOARD PANEL ========================= -->

        <!-- ======================================================================= -->
        <!-- ========================== MY PROFILE PANEL =========================== -->
        <!-- ======================================================================= -->
        <section
          id="profile-panel"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="profile-tab"
        >
          <div class="container">
            <h2><svg class="icon"><use href="#icon-user"></use></svg> Моят Профил и Цели</h2>
            <div class="card">
              <h3><svg class="icon"><use href="#icon-user"></use></svg> Лични Данни</h3>
              <ul id="profilePersonalData" class="profile-data-list">
                <li class="placeholder">Зареждане на лични данни...</li>
              </ul>
            </div>
            <div class="card">
              <h3><i class="bi bi-bullseye"></i> Основни Цели</h3>
              <ul id="profileGoals" class="profile-data-list">
                <li class="placeholder">Зареждане на целите...</li>
              </ul>
            </div>
            <div class="card" id="streakCard">
              <h3><svg class="icon" aria-hidden="true"><use href="#icon-trophy"></use></svg> Моите успехи</h3>
              <div id="streakGrid" class="streak-grid"></div>
            </div>
            <div class="card">
              <h3><i class="bi bi-clipboard-check"></i> Ключови Съображения от Въпросника</h3>
              <div id="profileConsiderations">
                <p class="placeholder">Зареждане на съображенията...</p>
              </div>
            </div>
            <div class="card" style="margin-top: var(--space-lg)">
              <h3><svg class="icon" aria-hidden="true"><use href="#icon-brain"></use></svg> Инструменти за Индивидуализация</h3>
              <p style="color: var(--text-color-secondary); font-size: var(--fs-sm); margin-bottom: var(--space-md);">
                Изпълнете психологическите тестове за по-добро разбиране на вашия хранителен профил.
              </p>
              <div class="psych-tests-grid">
                <a 
                  href="psy/index.html?from=profile" 
                  class="psych-test-card"
                >
                  <div class="psych-test-icon">
                    <i class="bi bi-image"></i>
                  </div>
                  <div class="psych-test-content">
                    <h4>Визуален тест</h4>
                    <p>Изследвайте вашето визуално възприятие</p>
                  </div>
                  <i class="bi bi-arrow-right psych-test-arrow"></i>
                </a>
                <a 
                  href="psy/psychotest.html?from=profile" 
                  class="psych-test-card"
                >
                  <div class="psych-test-icon">
                    <i class="bi bi-person-check"></i>
                  </div>
                  <div class="psych-test-content">
                    <h4>Личностен тест</h4>
                    <p>Разберете вашия личностен профил</p>
                  </div>
                  <i class="bi bi-arrow-right psych-test-arrow"></i>
                </a>
              </div>
              <div id="psychTestResults" style="margin-top: var(--space-md); display: none;">
                <div style="background: var(--color-success-bg); padding: var(--space-sm); border-radius: var(--radius-md); border-left: 4px solid var(--color-success);">
                  <p style="margin: 0; color: var(--text-color-primary); font-size: var(--fs-sm);">
                    <i class="bi bi-check-circle-fill" style="color: var(--color-success);"></i>
                    <strong>Резултатите са запазени!</strong>
                  </p>
                  <div id="psychTestSummary" style="margin-top: var(--space-xs); font-size: var(--fs-xs); color: var(--text-color-secondary);"></div>
                  <button 
                    id="regeneratePlanBtn" 
                    class="button" 
                    style="width: 100%; margin-top: var(--space-sm); display: none;"
                  >
                    <i class="bi bi-arrow-clockwise"></i> Регенерирай План с Нови Данни
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Detailed Psych Test Results Card -->
            <div class="card accordion-container" id="psychTestDetailsCard" style="margin-top: var(--space-lg); display: none;">
              <div 
                class="accordion-header" 
                id="psychTestDetailsHeader"
                role="button" 
                tabindex="0"
                aria-expanded="false" 
                aria-controls="psychTestDetailsContent"
              >
                <span><i class="bi bi-clipboard-data"></i> Детайлни Резултати от Тестовете</span>
                <svg class="icon arrow">
                  <use href="#icon-chevron-right"></use>
                </svg>
              </div>
              <div id="psychTestDetailsContent" class="accordion-content" role="region"></div>
            </div>
            <div class="card" style="margin-top: var(--space-lg)">
              <a href="profile-edit.html" class="button" style="width: 100%"
                >Редактирай Профила</a
              >
            </div>
          </div>
        </section>
        <!-- ======================= END MY PROFILE PANEL ======================== -->

        <!-- ======================================================================= -->
        <!-- ======================== WEEKLY PLAN PANEL ========================== -->
        <!-- ======================================================================= -->
        <section
          id="week-panel"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="week-tab"
        >
          <div class="container">
            <h2><svg class="icon"><use href="#icon-calendar"></use></svg> Седмичен План</h2>
            <div class="table-wrapper">
              <table id="weeklyPlanTable" aria-label="Седмичен хранителен план">
                <thead>
                  <tr>
                    <th>Ден</th>
                    <th>Закуска</th>
                    <th>Междинно 1</th>
                    <th>Обяд</th>
                    <th>Междинно 2</th>
                    <th>Вечеря</th>
                  </tr>
                </thead>
                <tbody id="weeklyPlanTbody">
                  <tr class="placeholder-row">
                    <td colspan="6">Зареждане на седмичния план...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- затваря .table-wrapper -->
            
            <!-- Бутон за заявка за промяна на плана -->
            <div class="card" style="margin-top: var(--space-lg);">
              <h4><svg class="icon"><use href="#icon-edit"></use></svg> Заявка за Промяна</h4>
              <p>Искате промяна в плана си? Изпратете заявка до администратора за преглед и одобрение.</p>
              <button
                id="planModificationBtn"
                class="button-primary"
                style="width: 100%; margin-top: var(--space-md);"
                aria-label="Заяви промяна в плана"
              >
                <svg class="icon" style="width: 1em; height: 1em; margin-right: 0.5em;"><use href="#icon-send"></use></svg>
                Заяви промяна в плана
              </button>
            </div>
            <!-- затваря card за заявка за промяна -->
          </div>
          <!-- затваря .container на week-panel -->
        </section>
        <!-- затваря week-panel -->

        <!-- ======================================================================= -->
        <!-- ===================== RECOMMENDATIONS PANEL ========================= -->
        <!-- ======================================================================= -->
        <section
          id="recs-panel"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="recs-tab"
        >
          <div class="container">
            <h2><svg class="icon"><use href="#icon-lightbulb"></use></svg> Препоръки</h2>
            <div class="recommendation-section">
              <h3><i class="bi bi-apple"></i> Основи на Храненето</h3>
              <div
                id="recFoodAllowedCard"
                class="card collapsible-card tip-card-success"
              >
                <h4><svg class="icon"><use href="#icon-check"></use></svg> Препоръчителни Храни</h4>
                <div class="collapsible-content">
                  <div id="recFoodAllowedContent">
                    <p class="placeholder">Зареждане...</p>
                  </div>
                  <div
                    class="info-note note-base hidden"
                    data-condition-type="medical"
                    data-condition-value="хипотиреоидизъм"
                  >
                    <svg class="icon prefix-icon">
                      <use href="#icon-info"></use>
                    </svg>
                    <span
                      ><strong>Забележка (Хипотиреоидизъм):</strong> Обърнете
                      внимание на храни, богати на селен, цинк и йод. Избягвайте
                      сурови кръстоцветни в големи количества.</span
                    >
                  </div>
                </div>
              </div>
              <div
                id="recFoodLimitCard"
                class="card collapsible-card tip-card-critical"
              >
                <h4><svg class="icon"><use href="#icon-close"></use></svg> Храни за ограничаване</h4>
                <div class="collapsible-content">
                  <div id="recFoodLimitContent">
                    <div
                      id="userAllergiesNote"
                      class="critical-note note-base hidden"
                    >
                      <svg class="icon prefix-icon">
                        <use href="#icon-warning-triangle"></use>
                      </svg>
                      <span
                        ><strong
                          >Ваши специфични алергени/непоносимости:</strong
                        >
                        <span id="userAllergiesList">Липсват данни</span></span
                      >
                    </div>
                    <p class="placeholder">Зареждане на общи препоръки...</p>
                  </div>
                </div>
              </div>
              <div
                id="recHydrationCard"
                class="card collapsible-card tip-card-info"
              >
                <h4><svg class="icon"><use href="#icon-droplet"></use></svg> Хидратация и Напитки</h4>
                <div class="collapsible-content">
                  <div id="recHydrationContent">
                    <p class="placeholder">Зареждане...</p>
                  </div>
                </div>
              </div>
              <div
                id="recCookingMethodsCard"
                class="card collapsible-card tip-card-info"
              >
                <h4><svg class="icon"><use href="#icon-utensils"></use></svg> Методи на Готвене</h4>
                <div class="collapsible-content">
                  <div id="recCookingMethodsContent">
                    <p class="placeholder">Зареждане...</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="recommendation-section">
              <h3><svg class="icon"><use href="#icon-brain"></use></svg> Поведенчески Стратегии и Нагласа</h3>
              <div id="recStrategiesContent" class="accordion-group">
                <div class="card placeholder">
                  <p>Зареждане на стратегии...</p>
                </div>
              </div>
            </div>
            <div class="recommendation-section">
              <h3><i class="bi bi-capsule" aria-hidden="true"></i> Хранителни Добавки</h3>
              <div
                id="recSupplementsCard"
                class="card collapsible-card tip-card-supplement"
              >
                <h4>Хранителни Добавки</h4>
                <div class="collapsible-content">
                  <div id="recSupplementsContent">
                    <p class="placeholder">Зареждане...</p>
                  </div>
                  <div class="important-note note-base">
                    <svg class="icon prefix-icon">
                      <use href="#icon-info"></use>
                    </svg>
                    <span
                      ><strong>Важно:</strong> Винаги се консултирайте с лекар
                      преди прием на нови хранителни добавки, особено ако имате
                      съществуващи заболявания или приемате медикаменти.</span
                    >
                  </div>
                </div>
              </div>
            </div>
            <div class="recommendation-section">
              <h3><i class="bi bi-book" aria-hidden="true"></i> Допълнителни насоки</h3>
              <div id="additionalGuidelines" class="accordion-group">
                <div class="card placeholder">
                  <p>Зареждане на насоки...</p>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- =================== END RECOMMENDATIONS PANEL ===================== -->
      </main>
      <!-- ======================= END MAIN CONTENT ============================ -->

      <!-- ======================================================================= -->
      <!-- ========================== MODAL WINDOWS ============================== -->
      <!-- ======================================================================= -->
      <!-- Welcome Screen Modal -->
      <div
        id="welcomeScreenModal"
        class="modal"
        role="dialog"
        aria-labelledby="welcomeModalTitle"
        aria-modal="true"
        aria-hidden="true"
      >
        <div class="modal-content">
          <button
            class="close-button"
            data-modal-close="welcomeScreenModal"
            aria-label="Затвори прозореца"
          >
            <svg class="icon" style="width: 1.2em; height: 1.2em">
              <use href="#icon-close"></use>
            </svg>
          </button>
          <h3 id="welcomeModalTitle" style="text-align: center">
            Добре дошли в ONE BODY!
          </h3>
          <div id="welcomeModalBody">
            <p class="text-center fs-xl" style="margin-bottom: 1rem">
              <i class="bi bi-stars"></i>
            </p>
            <img id="welcomeIllustration" class="welcome-illustration" src="" alt="Въведение">
            <p>
              Вашият персонализиран план е готов! Разгледайте секциите, за да се
              запознаете с него.
            </p>
            <p>
              Не забравяйте да попълвате дневния си лог и да следите напредъка
              си. Успех!
            </p>
          </div>
          <button id="showIntroVideoBtn" class="button-secondary" style="margin-top: 0.5rem">Гледай инструкциите</button>
          <button
            class="button-primary modal-close-btn"
            data-modal-close="welcomeScreenModal"
            style="margin-top: 1.5rem"
          >
            Разбрах, да започваме!
          </button>
        </div>
      </div>

      <!-- Extra Meal Entry Modal -->
      <div
        id="extraMealEntryModal"
        class="modal"
        aria-labelledby="extraMealModalTitle"
        aria-modal="true"
        aria-hidden="true"
      >
        <div class="modal-content">
          <div id="extraMealFormContainer">
            <div
              class="placeholder-form-loading"
              style="text-align: center; padding: 2rem"
            >
              <svg class="icon spinner" style="width: 30px; height: 30px">
                <use href="#icon-spinner"></use>
              </svg>
              <p>Зареждане на формата...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Generic Info Modal -->
      <div
        id="infoModal"
        class="modal"
        role="dialog"
        aria-labelledby="infoModalTitle"
        aria-modal="true"
        aria-hidden="true"
      >
        <div class="modal-content">
          <button
            class="close-button"
            data-modal-close="infoModal"
            aria-label="Затвори прозореца"
          >
            <svg class="icon" style="width: 1.2em; height: 1.2em">
              <use href="#icon-close"></use>
            </svg>
          </button>
          <h4 id="infoModalTitle" style="text-align: center">Информация</h4>
          <div
            id="infoModalBody"
            style="white-space: pre-wrap; text-align: left"
          >
            ...
          </div>
          <button
            class="button-primary modal-close-btn"
            data-modal-close="infoModal"
          >
            Затвори
          </button>
        </div>
      </div>

      <!-- Instructions Modal -->
      <div
        id="instructionsModal"
        class="modal"
        role="dialog"
        aria-labelledby="instructionsModalTitle"
        aria-modal="true"
        aria-hidden="true"
      >
        <div class="modal-content">
          <button class="close-button" data-modal-close="instructionsModal" aria-label="Затвори прозореца">
            <svg class="icon" style="width: 1.2em; height: 1.2em">
              <use href="#icon-close"></use>
            </svg>
          </button>
          <h4 id="instructionsModalTitle" style="text-align: center">Кратки инструкции</h4>
          <video id="instructionsVideo" class="instructions-video" controls>
            <source src="" type="video/mp4" />
          </video>
          <button class="button-primary modal-close-btn" data-modal-close="instructionsModal" style="margin-top: 1rem">Затвори</button>
        </div>
      </div>

      <!-- Achievement Modal -->
      <div
        id="achievementModal"
        class="modal"
        role="dialog"
        aria-labelledby="achievementModalTitle"
        aria-modal="true"
        aria-hidden="true"
      >
        <div class="modal-content">
          <button
            class="close-button"
            data-modal-close="achievementModal"
            aria-label="Затвори прозореца"
          >
            <svg class="icon" style="width: 1.2em; height: 1.2em">
              <use href="#icon-close"></use>
            </svg>
          </button>
          <div
            id="achievementModalEmoji"
            class="achievement-emoji"
            aria-hidden="true"
          ></div>
          <h3 id="achievementModalTitle" style="text-align: center">
            Поздравления!
          </h3>
          <div
            id="achievementModalBody"
            style="white-space: pre-wrap; text-align: left"
          ></div>
          <button id="achievementShareBtn" class="button-secondary" style="margin-top: 1rem">
            Сподели
          </button>
          <button
            class="button-primary modal-close-btn"
            data-modal-close="achievementModal"
            style="margin-top: 1.5rem"
          >
            Разбрах
          </button>
        </div>
      </div>

      <!-- Feedback Modal -->
      <div
        id="feedbackModal"
        class="modal"
        role="dialog"
        aria-labelledby="feedbackModalTitle"
        aria-modal="true"
        aria-hidden="true"
      >
        <div class="modal-content">
          <button
            class="close-button"
            data-modal-close="feedbackModal"
            aria-label="Затвори прозореца"
          >
            <svg class="icon" style="width: 1.2em; height: 1.2em">
              <use href="#icon-close"></use>
            </svg>
          </button>
          <h3 id="feedbackModalTitle" style="text-align: center">
            Обратна Връзка
          </h3>
          <form id="feedbackForm" aria-labelledby="feedbackModalTitle">
            <div>
              <label for="feedbackType">Тип на обратната връзка:</label>
              <select
                id="feedbackType"
                name="feedbackType"
                required
                autocomplete="off"
              >
                <option value="general">Общо</option>
                <option value="bug">Грешка</option>
                <option value="suggestion">Предложение</option>
                <option value="compliment">Похвала</option>
              </select>
            </div>
            <div style="margin-top: var(--space-md)">
              <label for="feedbackMessage">Вашето съобщение:</label>
              <textarea
                id="feedbackMessage"
                name="feedbackMessage"
                rows="4"
                required
                placeholder="Опишете тук..."
                aria-label="Текст на обратната връзка"
              ></textarea>
            </div>
            <div style="margin-top: var(--space-md)">
              <label for="feedbackRating">Оценка (по желание):</label>
              <select
                id="feedbackRating"
                name="feedbackRating"
                aria-label="Оценка на услугата"
                autocomplete="off"
              >
                <option value="">Без оценка</option>
                <option value="5">5 – Отлично</option>
                <option value="4">4 – Много добре</option>
                <option value="3">3 – Добре</option>
                <option value="2">2 – Задоволително</option>
                <option value="1">1 – Лошо</option>
              </select>
            </div>
            <button
              type="submit"
              class="button-primary"
              style="margin-top: var(--space-lg); width: 100%"
            >
              Изпрати
            </button>
          </form>
        </div>
      </div>

      <!-- Plan Modification Chat Modal -->
      <div id="planModChatModalContainer"></div>
      <!-- ======================= END MODAL WINDOWS =========================== -->

      <!-- ======================================================================= -->
      <!-- ========================= TOAST NOTIFICATION ========================== -->
      <!-- ======================================================================= -->
      <div id="toast" role="alert" aria-live="assertive"></div>
      <!-- ======================= END TOAST NOTIFICATION ======================== -->

      <!-- ======================================================================= -->
      <!-- ========================= FLOATING ACTION BUTTONS ===================== -->
      <!-- ======================================================================= -->
      <button
        id="chat-fab"
        aria-label="Чат с асистент"
        aria-expanded="false"
        aria-controls="chat-widget"
      >
        <img src="img/assisticon.png" class="icon assistant-icon" alt="" aria-hidden="true">
      </button>
      <!-- ======================= END FLOATING ACTION BUTTONS =================== -->

      <!-- ======================================================================= -->
      <!-- ========================== CHAT ASSISTANT ============================= -->
      <!-- ======================================================================= -->
      <div id="chat-widget" class="chat-widget" role="log" aria-live="polite">
        <div class="chat-header">
          <h4><img src="img/assisticon.png" class="icon assistant-icon" alt="" aria-hidden="true"> Чат с Асистент</h4>
          <div class="chat-actions">
            <button
              id="chat-clear"
              class="chat-clear-btn"
              aria-label="Изчисти чата"
            >
              <svg class="icon"><use href="#icon-trash"></use></svg>
            </button>
            <button
              id="chat-close"
              class="chat-close-btn"
              aria-label="Затвори чата"
            >
              <svg class="icon"><use href="#icon-close"></use></svg>
            </button>
          </div>
        </div>
        <div id="chat-messages" class="chat-messages">
          <!-- Messages will be added here by JS -->
        </div>
        <div class="chat-input-area">
          <textarea
            id="chat-input"
            placeholder="Вашето съобщение..."
            rows="2"
            aria-label="Поле за въвеждане на съобщение в чата"
          ></textarea>
          <input type="file" id="chat-image" accept="image/*" hidden />
          <button id="chat-upload" aria-label="Качи изображение">
            <svg class="icon"><use href="#icon-upload"></use></svg>
          </button>
          <button id="chat-send" aria-label="Изпрати съобщение">
            <svg class="icon"><use href="#icon-send"></use></svg>
          </button>
        </div>
      </div>
      <!-- ======================= END CHAT ASSISTANT ========================== -->

      <!-- Tooltip for Tracker (initially hidden) -->
      <div
        id="tooltip-tracker"
        class="tooltip-tracker"
        role="tooltip"
        aria-hidden="true"
      ></div>
    </div>
    <!-- End #appWrapper -->

    <!-- Коригирана JavaScript Връзка -->
    <script type="module">
      import { loadPartial } from './js/partialLoader.js';
      import { initializeSelectors } from './js/uiElements.js';
      import { syncPsychTestsToBackend, fetchPsychTestsFromBackend } from './js/psychTestsIntegration.js';
      import { apiEndpoints } from './js/config.js';
      
      loadPartial('planModChatModal.html', 'planModChatModalContainer').then(() => {
        initializeSelectors();
      });

      // Зарежда съхранените психотестове от backend и ги пази локално
      async function hydratePsychTestsFromBackend(userId) {
        if (!userId) return false;
        try {
          const data = await fetchPsychTestsFromBackend(userId);
          if (data && (data.visualTest || data.personalityTest)) {
            localStorage.setItem('psychTests', JSON.stringify(data));
            if (data.lastUpdated) {
              localStorage.setItem('psychTestsLastSync', data.lastUpdated);
            }
            return true;
          }
        } catch (error) {
          console.error('Failed to load psych tests from backend:', error);
        }
        return false;
      }

      // Sync psych tests to backend on page load
      async function syncPsychTestsIfNeeded() {
        const userId = sessionStorage.getItem('userId');
        if (!userId) return;

        const psychTestsStr = localStorage.getItem('psychTests');
        if (!psychTestsStr) return;

        // Check if already synced
        const lastSyncStr = localStorage.getItem('psychTestsLastSync');
        let psychTests;
        try {
          psychTests = JSON.parse(psychTestsStr);
        } catch (error) {
          console.error('Failed to parse psychTests from localStorage:', error);
          localStorage.removeItem('psychTests');
          return;
        }
        
        // Get latest timestamp from tests
        const latestTestTime = Math.max(
          psychTests.visualTest?.timestamp ? new Date(psychTests.visualTest.timestamp).getTime() : 0,
          psychTests.personalityTest?.timestamp ? new Date(psychTests.personalityTest.timestamp).getTime() : 0
        );

        const lastSync = lastSyncStr ? new Date(lastSyncStr).getTime() : 0;

        // Sync if tests are newer than last sync
        if (latestTestTime > lastSync) {
          try {
            const result = await syncPsychTestsToBackend(userId);
            if (result.success) {
              localStorage.setItem('psychTestsLastSync', new Date().toISOString());
              console.log('Psych tests synced successfully');
              
              // Show notification if plan should be regenerated
              if (result.shouldRegeneratePlan) {
                // Could show a toast or notification here
                console.log('Plan regeneration recommended');
              }
            }
          } catch (error) {
            console.error('Failed to sync psych tests:', error);
          }
        }
      }

      // Display saved psych test results
      function displayPsychTestResults() {
        const psychTestsStr = localStorage.getItem('psychTests');
        
        const resultsContainer = document.getElementById('psychTestResults');
        const summaryContainer = document.getElementById('psychTestSummary');
        const regenerateBtn = document.getElementById('regeneratePlanBtn');
        const detailsCard = document.getElementById('psychTestDetailsCard');
        const detailsContainer = document.getElementById('psychTestDetailsContent');
        
        if (!psychTestsStr) {
          // Show placeholder message when no tests are completed
          if (resultsContainer) {
            resultsContainer.style.display = 'block';
          }
          if (summaryContainer) {
            summaryContainer.innerHTML = '<span style="color: var(--text-color-muted);">Няма запазени резултати. Завършете тестовете и ще ги синхронизираме автоматично.</span>';
          }
          if (regenerateBtn) {
            regenerateBtn.style.display = 'none';
          }
          if (detailsCard) {
            detailsCard.style.display = 'none';
          }
          if (detailsContainer) {
            detailsContainer.innerHTML = '';
          }
          return;
        }

        let psychTests;
        try {
          psychTests = JSON.parse(psychTestsStr);
        } catch (error) {
          console.error('Error parsing psychTests from localStorage:', error);
          // Clear corrupted data
          localStorage.removeItem('psychTests');
          // Show error message
          if (resultsContainer) {
            resultsContainer.style.display = 'block';
          }
          if (summaryContainer) {
            summaryContainer.innerHTML = '<span style="color: var(--color-danger);">Грешка при зареждане на резултатите. Моля, попълнете тестовете отново.</span>';
          }
          return;
        }
        
        if (!psychTests || (!psychTests.visualTest && !psychTests.personalityTest)) {
          resultsContainer.style.display = 'block';
          if (summaryContainer) {
            summaryContainer.innerHTML = '<span style="color: var(--text-color-muted);">Няма запазени резултати. Завършете тестовете и ще ги синхронизираме автоматично.</span>';
          }
          if (regenerateBtn) {
            regenerateBtn.style.display = 'none';
          }
          if (detailsCard) {
            detailsCard.style.display = 'none';
          }
          if (detailsContainer) {
            detailsContainer.innerHTML = '';
          }
          return;
        }

        // Show results container
        resultsContainer.style.display = 'block';
        
        // Build summary
        let summary = '';
        if (psychTests.visualTest) {
          summary += `Визуален тест: ${psychTests.visualTest.name}<br>`;
        }
        if (psychTests.personalityTest) {
          summary += `Личностен тест: ${psychTests.personalityTest.typeCode}`;
        }
        summaryContainer.innerHTML = summary;

        // Show regenerate button if tests are completed
        if (regenerateBtn && (psychTests.visualTest || psychTests.personalityTest)) {
          regenerateBtn.style.display = 'block';
        }

        // Build detailed results
        displayDetailedPsychTestResults(psychTests, detailsCard, detailsContainer);
      }

      // Display detailed psych test results with correlation to profile data
      async function displayDetailedPsychTestResults(psychTests, detailsCard, detailsContainer) {
        if (!psychTests || (!psychTests.visualTest && !psychTests.personalityTest)) {
          return;
        }

        detailsCard.style.display = 'block';
        let html = '';

        // Visual Test Details
        if (psychTests.visualTest) {
          const vt = psychTests.visualTest;
          html += `
            <div style="margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--surface-background); border-radius: var(--radius-md);">
              <h4 style="margin-top: 0; color: var(--primary-color);">
                <i class="bi bi-image"></i> ${vt.name}
              </h4>
              <p style="font-style: italic; color: var(--text-color-secondary); margin-bottom: var(--space-md);">
                ${vt.short || ''}
              </p>
          `;
          
          // Показване на пълните резултати както в самия тест
          if (vt.mainPsycho && vt.mainPsycho.length > 0) {
            html += `
              <div style="margin-bottom: var(--space-md);">
                <h5 style="font-size: var(--fs-base); margin-bottom: var(--space-sm); color: var(--text-color-primary); font-weight: 600;">
                  Профил и рискови хранителни навици
                </h5>
                <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); color: var(--text-color-secondary); line-height: 1.6;">
                  ${vt.mainPsycho.map(item => `<li style="margin-bottom: var(--space-xs);">${item}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          if (vt.mainHabits && vt.mainHabits.length > 0) {
            html += `
              <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-warning-bg); border-left: 3px solid var(--color-warning); border-radius: var(--radius-sm);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-sm) 0; color: var(--color-warning); font-weight: 600;">
                  <i class="bi bi-exclamation-triangle"></i> Потенциални вредни последствия
                </h5>
                <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6;">
                  ${vt.mainHabits.map(habit => `<li style="margin-bottom: var(--space-xs);">${habit}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          if (vt.mainRisks && vt.mainRisks.length > 0) {
            html += `
              <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-info-bg); border-left: 3px solid var(--color-info); border-radius: var(--radius-sm);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-sm) 0; color: var(--color-info); font-weight: 600;">
                  <i class="bi bi-lightbulb"></i> Препоръки за хранене
                </h5>
                <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6;">
                  ${vt.mainRisks.map(risk => `<li style="margin-bottom: var(--space-xs);">${risk}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          if (vt.mainMind && vt.mainMind.length > 0) {
            html += `
              <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-success-bg); border-left: 3px solid var(--color-success); border-radius: var(--radius-sm);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-sm) 0; color: var(--color-success); font-weight: 600;">
                  <i class="bi bi-brain"></i> Психологически препоръки
                </h5>
                <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6;">
                  ${vt.mainMind.map(mind => `<li style="margin-bottom: var(--space-xs);">${mind}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          if (vt.timestamp) {
            html += `<p style="font-size: var(--fs-xs); color: var(--text-color-muted); margin: 0;">
              Завършен на: ${new Date(vt.timestamp).toLocaleDateString('bg-BG', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}
            </p>`;
          }
          
          html += `</div>`;
        }

        // Visual separator between tests
        if (psychTests.visualTest && psychTests.personalityTest) {
          html += `
            <div style="height: 2px; background: linear-gradient(to right, transparent, var(--primary-color), transparent); margin: var(--space-lg) 0; opacity: 0.3;"></div>
          `;
        }

        // Personality Test Details
        if (psychTests.personalityTest) {
          const pt = psychTests.personalityTest;
          html += `
            <div style="margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--surface-background); border-radius: var(--radius-md);">
              <h4 style="margin-top: 0; color: var(--primary-color);">
                <i class="bi bi-person-check"></i> Личностен профил: ${pt.typeCode}
              </h4>
          `;

          // Scores display
          if (pt.scores) {
            html += `<div style="margin-top: var(--space-md);">
              <h5 style="font-size: var(--fs-base); margin-bottom: var(--space-sm);">Измерения:</h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-sm);">
            `;
            
            const dimensionNames = {
              'E': 'Екстраверсия',
              'C': 'Съвестност',
              'O': 'Откритост',
              'A': 'Доброжелателност',
              'N': 'Невротизъм',
              'I': 'Импулсивност',
              'R': 'Рискова ориентация'
            };

            for (const [dim, score] of Object.entries(pt.scores)) {
              const percentage = score;
              const barColor = percentage > 60 ? 'var(--primary-color)' : 
                               percentage > 40 ? 'var(--color-warning)' : 'var(--secondary-color)';
              
              html += `
                <div style="padding: var(--space-xs); background: var(--card-bg); border-radius: var(--radius-sm);">
                  <div style="font-size: var(--fs-sm); font-weight: 600; margin-bottom: 2px; color: var(--text-color-primary);">${dim}</div>
                  <div style="font-size: var(--fs-xs); color: var(--text-color-secondary); margin-bottom: 4px;">
                    ${dimensionNames[dim] || dim}
                  </div>
                  <div style="width: 100%; height: 6px; background: var(--progress-bar-bg-empty); border-radius: 3px; overflow: hidden;">
                    <div style="width: ${percentage}%; height: 100%; background: ${barColor}; transition: width 0.3s ease;"></div>
                  </div>
                  <div style="font-size: var(--fs-xs); color: var(--text-color-muted); margin-top: 2px;">
                    ${score}%
                  </div>
                </div>
              `;
            }
            html += `</div></div>`;
          }
          
          // Strengths
          if (pt.strengths && pt.strengths.length > 0) {
            html += `
              <div style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--color-success-bg); border-left: 4px solid var(--color-success); border-radius: var(--radius-sm);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-xs) 0; color: var(--color-success);">
                  <i class="bi bi-check-circle"></i> Силни страни:
                </h5>
                <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6;">
                  ${pt.strengths.map(strength => `<li style="margin-bottom: var(--space-xs);">${strength}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          
          // Main risks
          if (pt.mainRisks && pt.mainRisks.length > 0) {
            html += `
              <div style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--color-warning-bg); border-left: 4px solid var(--color-warning); border-radius: var(--radius-sm);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-xs) 0; color: var(--color-warning);">
                  <i class="bi bi-exclamation-triangle"></i> Рискови области:
                </h5>
                <div style="margin: 0; padding-left: var(--space-sm);">
                  ${pt.mainRisks.map(risk => {
                    // Check if risk is an object with title and description
                    if (typeof risk === 'object' && risk.title) {
                      return `
                        <div style="margin-bottom: var(--space-md);">
                          <div style="font-weight: 600; color: var(--text-color-primary); margin-bottom: var(--space-xs); font-size: var(--fs-sm);">
                            ${risk.title}
                          </div>
                          ${risk.description ? `
                            <div style="color: var(--text-color-secondary); font-size: var(--fs-sm); line-height: 1.6;">
                              ${risk.description}
                            </div>
                          ` : ''}
                        </div>
                      `;
                    } else {
                      // Fallback for simple strings
                      return `<li style="margin-bottom: var(--space-xs); font-size: var(--fs-sm);">${risk}</li>`;
                    }
                  }).join('')}
                </div>
              </div>
            `;
          }
          
          // Top recommendations  
          if (pt.topRecommendations && pt.topRecommendations.length > 0) {
            html += `
              <div style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--color-info-bg); border-left: 4px solid var(--color-info); border-radius: var(--radius-sm);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-xs) 0; color: var(--color-info);">
                  <i class="bi bi-lightbulb"></i> Топ препоръки:
                </h5>
                <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6;">
                  ${pt.topRecommendations.map(rec => `<li style="margin-bottom: var(--space-xs);">${rec}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          // НОВО: Psyadvice профил - пълни данни от psyadvice.txt
          if (pt.psyadvice) {
            const psy = pt.psyadvice;
            html += `
              <div style="margin-top: var(--space-lg); padding: var(--space-md); background: linear-gradient(135deg, var(--color-info-bg) 0%, var(--surface-background) 100%); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-sm) 0; color: var(--primary-color); font-weight: 700;">
                  <i class="bi bi-journal-text"></i> Вашият психологически профил (psyadvice)
                </h5>
                
                <div style="margin-bottom: var(--space-md);">
                  <p style="font-size: var(--fs-sm); color: var(--text-color-primary); margin: 0 0 var(--space-xs) 0; font-weight: 600;">
                    ${psy.description}
                  </p>
                  <p style="font-size: var(--fs-sm); color: var(--text-color-secondary); margin: 0; font-style: italic;">
                    ${psy.traits}
                  </p>
                </div>
                
                ${psy.eatingRisks && psy.eatingRisks.length > 0 ? `
                  <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-warning-bg); border-left: 3px solid var(--color-warning); border-radius: var(--radius-sm);">
                    <h6 style="font-size: var(--fs-sm); margin: 0 0 var(--space-xs) 0; color: var(--color-warning); font-weight: 600;">
                      <i class="bi bi-exclamation-triangle"></i> Хранене – риск:
                    </h6>
                    <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6; color: var(--text-color-secondary);">
                      ${psy.eatingRisks.map(risk => `<li style="margin-bottom: 2px;">${risk}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}
                
                ${psy.directions && psy.directions.length > 0 ? `
                  <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-success-bg); border-left: 3px solid var(--color-success); border-radius: var(--radius-sm);">
                    <h6 style="font-size: var(--fs-sm); margin: 0 0 var(--space-xs) 0; color: var(--color-success); font-weight: 600;">
                      <i class="bi bi-arrow-right-circle"></i> Насока:
                    </h6>
                    <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6; color: var(--text-color-secondary);">
                      ${psy.directions.map(dir => `<li style="margin-bottom: 2px;">${dir}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}
                
                ${psy.communication && psy.communication.length > 0 ? `
                  <div style="padding: var(--space-sm); background: var(--card-bg); border-left: 3px solid var(--primary-color); border-radius: var(--radius-sm);">
                    <h6 style="font-size: var(--fs-sm); margin: 0 0 var(--space-xs) 0; color: var(--primary-color); font-weight: 600;">
                      <i class="bi bi-chat-dots"></i> Комуникация (AI асистент):
                    </h6>
                    <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm); line-height: 1.6; color: var(--text-color-secondary);">
                      ${psy.communication.map(comm => `<li style="margin-bottom: 2px;">${comm}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}
              </div>
            `;
          }

          // Risk flags (legacy support)
          if (pt.riskFlags && pt.riskFlags.length > 0 && (!pt.mainRisks || pt.mainRisks.length === 0)) {
            html += `
              <div style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--color-warning-bg); border-left: 4px solid var(--color-warning); border-radius: var(--radius-sm);">
                <h5 style="font-size: var(--fs-base); margin: 0 0 var(--space-xs) 0; color: var(--color-warning);">
                  <i class="bi bi-exclamation-triangle"></i> Рискови фактори:
                </h5>
                <ul style="margin: 0; padding-left: var(--space-md); font-size: var(--fs-sm);">
                  ${pt.riskFlags.map(flag => `<li>${flag}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          if (pt.timestamp) {
            html += `
              <p style="font-size: var(--fs-xs); color: var(--text-color-muted); margin: var(--space-sm) 0 0 0;">
                Завършен на: ${new Date(pt.timestamp).toLocaleDateString('bg-BG', { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </p>
            `;
          }
          html += `</div>`;
        }

        // Correlation with existing profile data
        html += `
          <div style="padding: var(--space-md); background: var(--color-info-bg); border-radius: var(--radius-md); border-left: 4px solid var(--color-info);">
            <h5 style="margin-top: 0; color: var(--color-info);">
              <i class="bi bi-info-circle"></i> Как това влияе на вашия план:
            </h5>
            <p style="font-size: var(--fs-sm); margin: 0;">
              Психологическият ви профил ще бъде включен при следващото генериране на хранителен план. 
              AI моделът ще адаптира препоръките според вашите емоционални нужди, личностни характеристики и потенциални рискове.
            </p>
          </div>
        `;

        detailsContainer.innerHTML = html;
      }

      // Handle plan regeneration button
      async function handlePlanRegeneration() {
        const regenerateBtn = document.getElementById('regeneratePlanBtn');
        if (!regenerateBtn) return;

        regenerateBtn.addEventListener('click', async () => {
          const userId = sessionStorage.getItem('userId');
          if (!userId) {
            alert('Не сте влезли в системата.');
            return;
          }

          if (!confirm('Искате ли да регенерирате хранителния си план с новите психологически данни? Това може да отнеме няколко минути.')) {
            return;
          }

          regenerateBtn.disabled = true;
          regenerateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Регенериране...';

          try {
            const response = await fetch(apiEndpoints.regeneratePlan, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ userId })
            });

            const result = await response.json();

            if (result.success) {
              alert('Планът започва да се регенерира! Ще получите известие когато е готов.');
              regenerateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Регенериране започна';
              
              // Reload page after a short delay to show updated status
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } else {
              throw new Error(result.message || 'Грешка при регенериране');
            }
          } catch (error) {
            console.error('Error regenerating plan:', error);
            alert('Възникна грешка при регенериране на плана: ' + error.message);
            regenerateBtn.disabled = false;
            regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Регенерирай План с Нови Данни';
          }
        });
      }

      async function initPsychTestsSection() {
        const userId = sessionStorage.getItem('userId');
        if (userId) {
          await hydratePsychTestsFromBackend(userId);
          await syncPsychTestsIfNeeded();
        }
        displayPsychTestResults();
        handlePlanRegeneration();
        initPsychTestAccordion();
      }

      // Initialize accordion for psych test details
      function initPsychTestAccordion() {
        const accordionHeader = document.getElementById('psychTestDetailsHeader');
        const accordionContent = document.getElementById('psychTestDetailsContent');
        
        if (!accordionHeader || !accordionContent) return;

        // Check if we should open the accordion (when returning from a test)
        const urlParams = new URLSearchParams(window.location.search);
        const fromTest = urlParams.get('fromTest');
        const shouldOpenAccordion = fromTest === 'true' || sessionStorage.getItem('openPsychTestDetails') === 'true';
        
        if (shouldOpenAccordion) {
          // Open the accordion
          accordionHeader.classList.add('open');
          accordionHeader.setAttribute('aria-expanded', 'true');
          accordionContent.classList.add('open-active');
          
          // Clear the session storage flag
          sessionStorage.removeItem('openPsychTestDetails');
          
          // Scroll to the accordion after a brief delay to ensure rendering
          setTimeout(() => {
            const detailsCard = document.getElementById('psychTestDetailsCard');
            if (detailsCard) {
              detailsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 500);
        }

        // Only add event listener if not already added
        if (!accordionHeader.dataset.listenerAttached) {
          accordionHeader.dataset.listenerAttached = 'true';
          
          // Toggle accordion on click
          accordionHeader.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event from bubbling to document
            const isOpen = accordionHeader.classList.contains('open');
            
            if (isOpen) {
              accordionHeader.classList.remove('open');
              accordionHeader.setAttribute('aria-expanded', 'false');
              accordionContent.classList.remove('open-active');
            } else {
              accordionHeader.classList.add('open');
              accordionHeader.setAttribute('aria-expanded', 'true');
              accordionContent.classList.add('open-active');
            }
          });

          // Close accordion when clicking outside
          document.addEventListener('click', (e) => {
            const detailsCard = document.getElementById('psychTestDetailsCard');
            if (detailsCard && !detailsCard.contains(e.target) && accordionHeader.classList.contains('open')) {
              accordionHeader.classList.remove('open');
              accordionHeader.setAttribute('aria-expanded', 'false');
              accordionContent.classList.remove('open-active');
            }
          });

          // Close accordion when switching tabs
          const tabButtons = document.querySelectorAll('.tab-btn');
          tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              if (accordionHeader.classList.contains('open')) {
                accordionHeader.classList.remove('open');
                accordionHeader.setAttribute('aria-expanded', 'false');
                accordionContent.classList.remove('open-active');
              }
            });
          });
        }
      }

      // Run on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          initPsychTestsSection();
        });
      } else {
        initPsychTestsSection();
      }
    </script>
    <script type="module" src="js/app.js" defer></script>
    <script type="module" src="js/planModChat.js" defer></script>
  </body>
</html>
