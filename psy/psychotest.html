<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Личностен Психотест | BodyBest</title>
  <!-- Линк към главния CSS файл на BodyBest -->
  <link rel="stylesheet" href="../css/base_styles.css">
  <style>
    /* Специфични стилове за психотеста, използващи променливите от base_styles.css */
    :root {
      --radius: var(--radius-md);
      --shadow: var(--shadow-md);
      --shadow-hover: var(--shadow-lg);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      font-family: var(--font-primary);
      background: var(--bg-gradient);
      color: var(--text-color-primary);
      line-height: 1.6;
      padding-bottom: var(--space-xl);
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: var(--space-md);
    }

    /* Theme Toggle Button - REMOVED */
    
    .screen {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: var(--space-xl);
      padding: var(--space-xl) var(--space-md) var(--space-md);
      border-bottom: 2px solid var(--border-color);
    }

    .header h1 {
      font-size: clamp(24px, 6vw, 32px);
      margin-bottom: var(--space-sm);
      color: var(--primary-color);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .header p {
      color: var(--text-color-secondary);
      font-size: var(--fs-base);
      max-width: 480px;
      margin: 0 auto;
    }

    /* Intro Screen */
    .intro-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      padding: var(--space-xl);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .intro-content:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .intro-content h2 {
      font-size: clamp(20px, 5vw, 24px);
      margin-bottom: var(--space-md);
      color: var(--secondary-color);
      font-weight: 700;
    }

    .intro-content p {
      margin-bottom: var(--space-md);
      color: var(--text-color-secondary);
      line-height: 1.7;
    }

    .intro-content ul {
      margin: var(--space-lg) 0;
      padding-left: var(--space-lg);
      color: var(--text-color-primary);
    }

    .intro-content li {
      margin-bottom: var(--space-sm);
      line-height: 1.7;
    }

    .intro-content strong {
      color: var(--primary-color);
      font-weight: 600;
    }

    /* Button Styles */
    .btn {
      width: 100%;
      max-width: 400px;
      min-height: 48px;
      padding: var(--space-md) var(--space-lg);
      border: none;
      border-radius: var(--radius-lg);
      font-size: var(--fs-base);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: var(--font-primary);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: #FFFFFF;
      box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(var(--primary-rgb), 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--text-color-primary);
      border: 2px solid var(--border-color);
      margin-top: var(--space-sm);
    }

    .btn-secondary:hover {
      background: var(--surface-background);
      border-color: var(--primary-color);
      color: var(--primary-color);
      transform: translateY(-2px);
    }

    /* Progress Bar */
    .progress-container {
      margin-bottom: var(--space-xl);
      background: var(--card-bg);
      padding: var(--space-md);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
      font-size: var(--fs-sm);
      color: var(--text-color-secondary);
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: var(--progress-bar-bg-empty);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: var(--radius-lg);
      box-shadow: 0 0 10px rgba(var(--primary-rgb), 0.5);
    }

    /* Question Card */
    .question-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      padding: var(--space-xl);
      box-shadow: var(--shadow);
      margin-bottom: var(--space-md);
    }

    .question-number {
      font-size: var(--fs-xs);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent-color);
      margin-bottom: var(--space-sm);
      font-weight: 700;
    }

    .question-text {
      font-size: clamp(18px, 4.5vw, 22px);
      margin-bottom: var(--space-lg);
      color: var(--text-color-primary);
      font-weight: 700;
      line-height: 1.4;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .option {
      background: var(--surface-background);
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      padding: var(--space-md);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: var(--space-md);
      min-height: 60px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .option:hover {
      background: var(--card-bg);
      border-color: var(--primary-color);
      transform: translateX(4px);
      box-shadow: var(--shadow-sm);
    }

    .option.selected {
      background: color-mix(in srgb, var(--primary-color) 15%, var(--card-bg));
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    .option-radio {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-round);
      flex-shrink: 0;
      position: relative;
      transition: all 0.3s ease;
      background: var(--card-bg);
    }

    .option.selected .option-radio {
      border-color: var(--primary-color);
      background: var(--primary-color);
    }

    .option.selected .option-radio::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background: white;
      border-radius: var(--radius-round);
    }

    .option-text {
      flex: 1;
      font-size: var(--fs-base);
      color: var(--text-color-primary);
      line-height: 1.5;
    }

    .legend {
      font-size: var(--fs-sm);
      color: var(--text-color-muted);
      font-style: italic;
      padding: var(--space-md);
      background: color-mix(in srgb, var(--accent-color) 10%, var(--card-bg));
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--accent-color);
      line-height: 1.6;
    }

    /* Navigation */
    .navigation {
      display: flex;
      gap: var(--space-md);
      margin-top: var(--space-lg);
      flex-wrap: wrap;
      justify-content: center;
    }

    .navigation .btn {
      flex: 1 1 auto;
      min-width: 160px;
      max-width: 300px;
    }

    /* Results Screen */
    .results-header {
      text-align: center;
      margin-bottom: var(--space-xl);
      padding: var(--space-lg);
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .results-header h2 {
      font-size: clamp(24px, 6vw, 30px);
      margin-bottom: var(--space-sm);
      color: var(--primary-color);
      font-weight: 700;
    }

    .results-header p {
      color: var(--text-color-secondary);
      font-size: var(--fs-base);
    }

    .dimension-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .dimension-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .dimension-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      gap: var(--space-sm);
    }

    .dimension-name {
      font-size: var(--fs-base);
      font-weight: 700;
      color: var(--text-color-primary);
      flex: 1;
    }

    .dimension-code {
      font-size: clamp(18px, 4vw, 22px);
      font-weight: 800;
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      min-width: 48px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.3);
    }

    .dimension-description {
      font-size: var(--fs-sm);
      color: var(--text-color-secondary);
      margin-bottom: var(--space-md);
    }

    .score-bar-container {
      position: relative;
      margin-bottom: var(--space-sm);
    }

    .score-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: var(--fs-xs);
      color: var(--text-color-muted);
      margin-bottom: var(--space-xs);
      font-weight: 600;
    }

    .score-bar {
      width: 100%;
      height: 28px;
      background: linear-gradient(90deg, var(--accent-color) 0%, var(--primary-color) 50%, var(--secondary-color) 100%);
      border-radius: var(--radius-lg);
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .score-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 4px;
      height: 36px;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), 0 0 0 3px rgba(var(--primary-rgb), 0.3);
    }

    .score-value {
      text-align: center;
      font-size: var(--fs-sm);
      color: var(--text-color-secondary);
      margin-top: var(--space-xs);
      font-weight: 700;
    }

    .type-code-card {
      background: linear-gradient(135deg, 
        color-mix(in srgb, var(--primary-color) 20%, var(--card-bg)),
        color-mix(in srgb, var(--secondary-color) 15%, var(--card-bg)));
      border: 2px solid var(--primary-color);
      border-radius: var(--radius);
      padding: var(--space-xl);
      text-align: center;
      margin: var(--space-xl) 0;
      box-shadow: var(--shadow-lg);
    }

    .type-code-label {
      font-size: var(--fs-sm);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-color-secondary);
      margin-bottom: var(--space-sm);
      font-weight: 700;
    }

    .type-code-value {
      font-size: clamp(28px, 8vw, 40px);
      font-weight: 800;
      color: var(--primary-color);
      letter-spacing: 0.05em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .flags-section {
      margin: var(--space-xl) 0;
    }

    .flags-section h3 {
      font-size: var(--fs-lg);
      margin-bottom: var(--space-md);
      color: var(--text-color-primary);
      font-weight: 700;
    }

    .flag-card {
      background: var(--note-critical-bg);
      border: 1px solid var(--note-critical-border);
      border-radius: var(--radius);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
    }

    .flag-card.warning {
      background: var(--note-warning-bg);
      border-color: var(--note-important-border);
    }

    .flag-title {
      font-weight: 700;
      color: var(--text-color-primary);
      margin-bottom: var(--space-xs);
      font-size: var(--fs-base);
    }

    .flag-description {
      font-size: var(--fs-sm);
      color: var(--text-color-secondary);
      line-height: 1.6;
    }

    /* AI Analysis Section */
    .ai-section {
      margin: var(--space-xl) 0;
    }

    .ai-section h3 {
      font-size: clamp(18px, 5vw, 22px);
      margin-bottom: var(--space-md);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-weight: 700;
      flex-wrap: wrap;
    }

    .ai-badge {
      font-size: var(--fs-xs);
      padding: var(--space-xs) var(--space-sm);
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--tertiary-color) 100%);
      color: white;
      border-radius: var(--radius-lg);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: 0 2px 6px rgba(var(--primary-rgb), 0.3);
    }

    .ai-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      padding: var(--space-xl);
      box-shadow: var(--shadow);
    }

    .ai-subsection {
      margin-bottom: var(--space-xl);
    }

    .ai-subsection:last-child {
      margin-bottom: 0;
    }

    .ai-subsection h4 {
      font-size: var(--fs-base);
      color: var(--text-color-primary);
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 2px solid var(--border-color);
      font-weight: 700;
    }

    .ai-list {
      list-style: none;
      padding: 0;
    }

    .ai-list li {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
      padding-left: var(--space-sm);
    }

    .ai-bullet {
      color: var(--accent-color);
      font-weight: 700;
      flex-shrink: 0;
      font-size: var(--fs-lg);
    }

    .ai-text {
      flex: 1;
      font-size: var(--fs-sm);
      color: var(--text-color-secondary);
      line-height: 1.7;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-xl);
      gap: var(--space-md);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: var(--radius-round);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--text-color-secondary);
      font-size: var(--fs-base);
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .container {
        padding: var(--space-sm);
      }

      .header {
        padding: var(--space-lg) var(--space-sm) var(--space-sm);
      }

      .intro-content,
      .question-card,
      .ai-content {
        padding: var(--space-lg);
      }

      .theme-toggle {
        top: var(--space-sm);
        right: var(--space-sm);
        width: 44px;
        height: 44px;
      }
    }

    @media (max-width: 380px) {
      .header h1 {
        font-size: 22px;
      }

      .question-text {
        font-size: 18px;
      }

      .intro-content,
      .question-card,
      .ai-content {
        padding: var(--space-md);
      }

      .dimension-code {
        font-size: 18px;
      }

      .type-code-value {
        font-size: 28px;
      }
    }
  </style>
  <script type="module">
    // Theme initialization
    import { initializeTheme } from '../js/uiHandlers.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
    });
  </script>
</head>
<body id="body">
  <!-- Back to Profile Button -->
  <a href="../code.html#profile-tab" class="back-btn" title="Назад към профила" style="position: fixed; top: var(--space-md); left: var(--space-md); width: 44px; height: 44px; border-radius: var(--radius-round); background: var(--card-bg); border: 2px solid var(--border-color); color: var(--text-color-primary); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); transition: all 0.3s ease; z-index: 1001; text-decoration: none;">
    <span style="font-size: 20px;">←</span>
  </a>

  <div class="container">
    <!-- Intro Screen -->
    <div id="screenIntro" class="screen active">
      <div class="header">
        <h1>Личностен Психопрофил</h1>
        <p>Кратък тест за личностни характеристики и хранителни навици</p>
      </div>
      <div class="intro-content">
        <h2>Добре дошли!</h2>
        <p>Този тест съдържа 13 въпроса, които помагат да се оцени личностният ви профил и потенциални връзки с хранителните навици.</p>
        <ul>
          <li>Всеки въпрос има три равностойни опции</li>
          <li>Изберете опцията, която е <strong>най-близка до естествения ви избор</strong> в повечето случаи</li>
          <li>Няма правилни или грешни отговори</li>
          <li>Отговаряйте спонтанно, без да мислите прекалено дълго</li>
          <li>Тестът отнема около 4-6 минути</li>
        </ul>
        <button class="btn btn-primary" onclick="startTest()">Започни теста</button>
        <a href="../code.html#profile-tab" class="btn btn-secondary" style="display: inline-block; text-align: center; text-decoration: none; color: var(--text-color-primary); margin-top: var(--space-sm);" onclick="sessionStorage.setItem('openPsychTestDetails', 'true');">Назад към профила</a>
      </div>
    </div>

    <!-- Questions Screen -->
    <div id="screenQuestions" class="screen">
      <div class="header">
        <h1>Личностен Психопрофил</h1>
      </div>
      
      <div class="progress-container">
        <div class="progress-info">
          <span>Въпрос <span id="currentQuestion">1</span> от <span id="totalQuestions">13</span></span>
          <span id="progressPercent">8%</span>
        </div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 8%"></div>
        </div>
      </div>

      <div id="questionContainer"></div>

      <div class="navigation">
        <button class="btn btn-secondary" id="btnPrevious" onclick="previousQuestion()" style="display: none">Назад</button>
        <button class="btn btn-primary" id="btnNext" onclick="nextQuestion()" disabled>Следващ въпрос</button>
      </div>
    </div>

    <!-- Results Screen -->
    <div id="screenResults" class="screen">
      <div class="header">
        <h1>Твоят резултат</h1>
      </div>
      
      <div class="results-header">
        <h2>Личностен профил</h2>
        <p>Оценки по различните измерения</p>
      </div>

      <div id="dimensionsContainer"></div>

      <div id="typeCodeContainer"></div>

      <div id="flagsContainer"></div>

      <div class="ai-section">
        <h3>
          Резултат за хранителни навици
          <span class="ai-badge">Персонален</span>
        </h3>
        <div id="aiAnalysisContainer" class="ai-content">
          <div class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Подготовка на резултата...</div>
          </div>
        </div>
      </div>
      
      <div id="saveStatusMessage" style="margin-top: 20px;"></div>

      <div class="navigation">
        <button id="saveResultBtn" class="btn btn-primary" style="display: none;">Запази резултата</button>
        <button class="btn btn-secondary" onclick="restartTest()">Започни отново</button>
        <a href="../code.html#profile-tab" class="btn btn-primary" style="text-decoration: none" onclick="sessionStorage.setItem('openPsychTestDetails', 'true')">Назад към профила</a>
      </div>
    </div>
  </div>

  <script>
    // Test data loaded from JSON files
    const testData = {
      "meta": {
        "id": "bb_optional_personality_v1_1",
        "title": "Кратък личностен модул (по избор)",
        "language": "bg",
        "version": "1.1.0",
        "questions_count": 13
      },
      "items": [
        {
          "id": "psy_01",
          "text": "Когато се заемам с нова цел...?",
          "type": "radio",
          "options": [
            "Правя точен план и стъпки, преди да започна",
            "Правя обща рамка и прецизирам по пътя",
            "Започвам веднага и оформям структурата в движение"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_02",
          "text": "В свободното си време предпочитам...?",
          "type": "radio",
          "options": [
            "Позната дейност, която вече е доказано приятна",
            "Нещо ново/непознато, за да пробвам и да науча",
            "Комбинация: познато + малък елемент на новост"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_03",
          "text": "След тежък ден имам нужда от...?",
          "type": "radio",
          "options": [
            "Време насаме и тишина",
            "Контакт с хора (приятели/екип), разговор, движение",
            "Малка социалност + после време насаме"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_04",
          "text": "При вземане на решение в трудна ситуация...?",
          "type": "radio",
          "options": [
            "Събирам още информация и чак тогава решавам",
            "Решавам бързо и после коригирам при нужда",
            "Питам/сверявам с доверен човек и действам"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_05",
          "text": "В напрегнат разговор...?",
          "type": "radio",
          "options": [
            "Заявявам директно и ясно мнение на момента",
            "Изчаквам да спадне напрежението и после обсъждам",
            "Търся мек подход: контекст, тон, стратегически стъпки"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_06",
          "text": "Когато работя под напрежение...?",
          "type": "radio",
          "options": [
            "Фокусирам се и ставам по-ефективен/а",
            "Ставам по-раздразнителен/а от разсейващи фактори",
            "Търся опора: рутина, правила, ясни граници"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_07",
          "text": "Нуждата ми от подкрепа е...?",
          "type": "radio",
          "options": [
            "Често и на малки стъпки",
            "Само по ключови етапи/на финала",
            "По поискване: аз решавам кога да я потърся"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_08",
          "text": "В ситуации на риск и печалба...?",
          "type": "radio",
          "options": [
            "Избирам сигурното и предвидимото",
            "Избирам балансирано: среден риск за средна полза",
            "Моят принцип е всичко или нищо."
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_09",
          "text": "Когато имам срок...?",
          "type": "radio",
          "options": [
            "Започвам рано и правя по малко, но регулярно",
            "Започвам по средата и поддържам темпо до финала",
            "Работя най-добре на финален спринт"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_10",
          "text": "При изграждане на нови умения...?",
          "type": "radio",
          "options": [
            "Следвам ясни инструкции и структуриран план",
            "Пробвам чрез експерименти и откриване",
            "Опитвам се да съчетая пример/ментор + действие"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_12",
          "text": "При малка полза веднага и по-голяма след време...?",
          "type": "radio",
          "options": [
            "Предпочитам малката полза веднага",
            "Предпочитам по-голямата полза по-късно",
            "Трябва добре да обмисля ситуацията"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_13",
          "text": "За да съм отдаден имам нужда от...?",
          "type": "radio",
          "options": [
            "Сигурност, постоянство, навици",
            "Честа промяна и разнообразие",
            "Рутина и нови елементи"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        },
        {
          "id": "psy_14",
          "text": "Когато възникне силна емоция...?",
          "type": "radio",
          "options": [
            "Изразявам я веднага и директно",
            "Обработвам я вътрешно и след това действам",
            "Търся диалог и информация, за да си я подредя"
          ],
          "legend": "Изберете една опция — най-близката до естествения ви избор в повечето случаи (последните шест месеца)."
        }
      ]
    };

    const scoringKey = {
      "psy_01": [
        {"C": 2, "O": -1, "E": 0, "A": 0, "N": 0, "I": -1, "R": 0},
        {"C": 1, "O": 0, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": -1, "O": 1, "E": 1, "A": 0, "N": 0, "I": 1, "R": 0}
      ],
      "psy_02": [
        {"C": 0, "O": -1, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": 0, "O": 2, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": 0, "O": 1, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0}
      ],
      "psy_03": [
        {"C": 0, "O": 0, "E": -2, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": 0, "O": 0, "E": 2, "A": 1, "N": 0, "I": 0, "R": 0},
        {"C": 0, "O": 0, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0}
      ],
      "psy_04": [
        {"C": 1, "O": 1, "E": 0, "A": 0, "N": 0, "I": -1, "R": -1},
        {"C": 0, "O": 0, "E": 1, "A": -1, "N": 0, "I": 1, "R": 1},
        {"C": 0, "O": 0, "E": 0, "A": 2, "N": 0, "I": 0, "R": 0}
      ],
      "psy_05": [
        {"C": 0, "O": 0, "E": 1, "A": -1, "N": 1, "I": 0, "R": 0},
        {"C": 1, "O": 0, "E": -1, "A": 0, "N": 1, "I": -1, "R": 0},
        {"C": 1, "O": 0, "E": 0, "A": 2, "N": 0, "I": 0, "R": 0}
      ],
      "psy_06": [
        {"C": 2, "O": 0, "E": 0, "A": 0, "N": -1, "I": 0, "R": 0},
        {"C": -1, "O": 0, "E": 0, "A": -1, "N": 2, "I": 1, "R": 0},
        {"C": 1, "O": 0, "E": 0, "A": 0, "N": 1, "I": 0, "R": 0}
      ],
      "psy_07": [
        {"C": 0, "O": 0, "E": 0, "A": 1, "N": 1, "I": 0, "R": 0},
        {"C": 1, "O": 0, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": 1, "O": 1, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0}
      ],
      "psy_08": [
        {"C": 0, "O": 0, "E": 0, "A": 0, "N": 0, "I": -1, "R": -2},
        {"C": 0, "O": 0, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": -1, "O": 0, "E": 1, "A": -1, "N": 1, "I": 1, "R": 2}
      ],
      "psy_09": [
        {"C": 2, "O": 0, "E": 0, "A": 0, "N": 0, "I": -1, "R": 0},
        {"C": 1, "O": 0, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": -1, "O": 0, "E": 0, "A": 0, "N": 1, "I": 2, "R": 0}
      ],
      "psy_10": [
        {"C": 2, "O": 0, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": 0, "O": 2, "E": 0, "A": 0, "N": 0, "I": 1, "R": 0},
        {"C": 0, "O": 1, "E": 0, "A": 1, "N": 0, "I": 0, "R": 0}
      ],
      "psy_12": [
        {"C": -1, "O": 0, "E": 0, "A": 0, "N": 0, "I": 2, "R": 0},
        {"C": 2, "O": 0, "E": 0, "A": 0, "N": 0, "I": -1, "R": 0},
        {"C": 1, "O": 1, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0}
      ],
      "psy_13": [
        {"C": 2, "O": -1, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0},
        {"C": -1, "O": 2, "E": 0, "A": 0, "N": 0, "I": 1, "R": 0},
        {"C": 1, "O": 1, "E": 0, "A": 0, "N": 0, "I": 0, "R": 0}
      ],
      "psy_14": [
        {"C": 0, "O": 0, "E": 1, "A": -1, "N": 1, "I": 1, "R": 0},
        {"C": 1, "O": 0, "E": -1, "A": 0, "N": -1, "I": -1, "R": 0},
        {"C": 0, "O": 1, "E": 0, "A": 1, "N": 0, "I": 0, "R": 0}
      ]
    };

    const dimensionInfo = {
      "E": {
        "name": "Социална енергия",
        "description": "общителност и активация",
        "lowLabel": "X (по-затворен)",
        "highLabel": "E (по-общителен)",
        "threshold": 60
      },
      "C": {
        "name": "Структура и дисциплина",
        "description": "организираност и самоконтрол",
        "lowLabel": "P (по-гъвкав)",
        "highLabel": "J (по-структуриран)",
        "threshold": 60
      },
      "O": {
        "name": "Отвореност към новото",
        "description": "новаторство и любознателност",
        "lowLabel": "S (по-практичен)",
        "highLabel": "V (по-новаторски)",
        "threshold": 60
      },
      "A": {
        "name": "Мекота в контакт",
        "description": "съгласуваност и кооперативност",
        "lowLabel": "D (по-директен)",
        "highLabel": "M (по-мек)",
        "threshold": 60
      },
      "N": {
        "name": "Емоционална реактивност",
        "description": "чувствителност към стрес",
        "lowLabel": "Стабилен",
        "highLabel": "Реактивен",
        "threshold": 65
      },
      "I": {
        "name": "Импулсивност",
        "description": "склонност към моментни действия",
        "lowLabel": "Планиращ",
        "highLabel": "Импулсивен",
        "threshold": 65
      },
      "R": {
        "name": "Рискова ориентация",
        "description": "толерантност към несигурност",
        "lowLabel": "Предпазлив",
        "highLabel": "Рисков",
        "threshold": 65
      }
    };

    // Psyadvice profiles from psyadvice.txt - пълни данни за всеки типов код
    const psyadviceProfiles = {
      'X-S-D-P': {
        typeCode: 'X-S-D-P',
        description: 'Интровертен, практичен, директен, ниска структура.',
        traits: 'Действа самостоятелно, импулсивен, труден ритъм.',
        eatingRisks: ['Пропускане на хранения', 'Ядене накрак, късно', 'Ниска последователност'],
        directions: ['Фиксирани опорни хранения', 'Прост, повтаряем режим', 'Минимален избор, готови решения'],
        communication: ['Кратка, ясна, без обяснения', 'Фокус върху действие, не теория', 'Избягвай морализиране и контрол']
      },
      'X-S-D-J': {
        typeCode: 'X-S-D-J',
        description: 'Интровертен, практичен, директен, структуриран.',
        traits: 'Контролиран, устойчив, резултатно ориентиран.',
        eatingRisks: ['Твърде строг режим', 'Игнориране на сигнали за глад', 'Контрол вместо адаптация'],
        directions: ['Структурирано, но гъвкаво меню', 'Планирани отклонения', 'Обучение за слушане на тялото'],
        communication: ['Логична, аргументирана', 'Показвай полза и ефективност', 'Уважавай автономията му']
      },
      'X-S-M-P': {
        typeCode: 'X-S-M-P',
        description: 'Интровертен, практичен, мек, гъвкав.',
        traits: 'Адаптивен, избягва конфликт, пасивен.',
        eatingRisks: ['Хранене според средата', 'Пропускане на лични нужди', 'Нерегулярен ритъм'],
        directions: ['Ясно лично хранително време', 'Предварителен план', 'Работа с граници'],
        communication: ['Мек тон, без натиск', 'Задавай въпроси, не заповеди', 'Валидирай нуждите му']
      },
      'X-S-M-J': {
        typeCode: 'X-S-M-J',
        description: 'Интровертен, практичен, мек, структуриран.',
        traits: 'Надежден, търсещ сигурност.',
        eatingRisks: ['Рутинност без разнообразие', 'Страх от промяна', 'Тревожност при нови храни'],
        directions: ['Бавни, контролирани промени', 'Малки експерименти', 'Стабилна основа'],
        communication: ['Спокойна, предвидима', 'Предварително обяснение', 'Избягвай изненади']
      },
      'X-V-D-P': {
        typeCode: 'X-V-D-P',
        description: 'Интровертен, новаторски, директен, спонтанен.',
        traits: 'Креативен, независим, хаотичен.',
        eatingRisks: ['Резки смени на диети', 'Импулсивни ограничения', 'Срив след ентусиазъм'],
        directions: ['Един експеримент наведнъж', 'Времево ограничени проби', 'Ясно начало и край'],
        communication: ['Директна, но не контролираща', 'Остави избор в рамка', 'Не ограничавай свободата рязко']
      },
      'X-V-D-J': {
        typeCode: 'X-V-D-J',
        description: 'Интровертен, новаторски, директен, структуриран.',
        traits: 'Стратегически, автономен.',
        eatingRisks: ['Прекален контрол', 'Функционално хранене без удоволствие'],
        directions: ['Баланс ефективност–удоволствие', 'Включване на непланирани елементи', 'Работа със стрес'],
        communication: ['Говори като с равен', 'Аргументирай всяка стъпка', 'Избягвай банални съвети']
      },
      'X-V-M-P': {
        typeCode: 'X-V-M-P',
        description: 'Интровертен, новаторски, мек, гъвкав.',
        traits: 'Чувствителен, разпиляващ се.',
        eatingRisks: ['Емоционално и импулсивно хранене', 'Липса на структура', 'Чести колебания'],
        directions: ['Минимална рамка', 'Редовни хранения', 'Работа с импулса, не с храната'],
        communication: ['Подкрепяща, ненатрапчива', 'Помагай да избира, не решавай вместо него', 'Избягвай критика']
      },
      'X-V-M-J': {
        typeCode: 'X-V-M-J',
        description: 'Интровертен, новаторски, мек, структуриран.',
        traits: 'Дълбоко мислещ, вътрешно напрегнат.',
        eatingRisks: ['Свръхобмисляне', 'Страх от грешка', 'Контрол през планиране'],
        directions: ['Опростяване', 'Доверие в базов режим', 'Намаляване на когнитивния шум'],
        communication: ['Ясна, подредена', 'Не претоварвай с избори', 'Подчертавай достатъчност, не оптимум']
      },
      'E-S-D-P': {
        typeCode: 'E-S-D-P',
        description: 'Екстровертен, практичен, директен, спонтанен.',
        traits: 'Действен, ориентиран към действие.',
        eatingRisks: ['Бързо хранене', 'Преяждане', 'Игнориране на ситост'],
        directions: ['По-бавно темпо', 'Ясни порции', 'Структурирани паузи'],
        communication: ['Кратка и енергична', 'Фокус върху резултат', 'Не задържай вниманието дълго']
      },
      'E-S-D-J': {
        typeCode: 'E-S-D-J',
        description: 'Екстровертен, практичен, директен, структуриран.',
        traits: 'Контролиращ, лидерски.',
        eatingRisks: ['Режим като дисциплина', 'Наказателно отношение'],
        directions: ['Устойчив дългосрочен план', 'Гъвкави правила', 'Редуциране на контрола'],
        communication: ['Ясни цели и правила', 'Говори за стратегия', 'Избягвай емоционален език']
      },
      'E-S-M-P': {
        typeCode: 'E-S-M-P',
        description: 'Екстровертен, практичен, мек, гъвкав.',
        traits: 'Социален, подкрепящ.',
        eatingRisks: ['Хранене за компания', 'Трудно казва "не"', 'Излишен прием'],
        directions: ['Предварителни решения', 'Личен хранителен план', 'Работа с граници'],
        communication: ['Топла, човешка', 'Насърчавай, не натискай', 'Утвърждавай личния избор']
      },
      'E-S-M-J': {
        typeCode: 'E-S-M-J',
        description: 'Екстровертен, практичен, мек, структуриран.',
        traits: 'Грижовен, стабилен.',
        eatingRisks: ['Поставя другите пред себе си', 'Пропускане на хранения'],
        directions: ['Приоритет към личния ритъм', 'Планирани паузи', 'Грижа към себе си'],
        communication: ['Признателна и уважителна', 'Подчертавай нуждата от самогрижа', 'Не експлоатирай отговорността му']
      },
      'E-V-D-P': {
        typeCode: 'E-V-D-P',
        description: 'Екстровертен, новаторски, директен, спонтанен.',
        traits: 'Висока енергия, търси интензивност.',
        eatingRisks: ['Крайни режими', 'Стимулантно хранене', 'Бърноут'],
        directions: ['Стабилизиране на ритъма', 'Ограничаване на крайности', 'Възстановяване'],
        communication: ['Динамична, мотивираща', 'Поставяй граници ясно', 'Канализирай енергията']
      },
      'E-V-D-J': {
        typeCode: 'E-V-D-J',
        description: 'Екстровертен, новаторски, директен, структуриран.',
        traits: 'Визионер, силна воля.',
        eatingRisks: ['Пренебрегване на възстановяването', 'Храна като гориво'],
        directions: ['Планирано възстановяване', 'Фокус върху дългосрочност'],
        communication: ['Стратегическа, на ниво визия', 'Не спори за дреболии', 'Уважавай темпото му']
      },
      'E-V-M-P': {
        typeCode: 'E-V-M-P',
        description: 'Екстровертен, новаторски, мек, гъвкав.',
        traits: 'Емоционален, нестабилен.',
        eatingRisks: ['Емоционално хранене', 'Хаотичен режим'],
        directions: ['Редовност', 'Работа с емоционалния тригер', 'Прости правила'],
        communication: ['Емоционално присъствие', 'Стабилен, спокоен тон', 'Не усилвай драмата']
      },
      'E-V-M-J': {
        typeCode: 'E-V-M-J',
        description: 'Екстровертен, новаторски, мек, структуриран.',
        traits: 'Интегративен, балансиран.',
        eatingRisks: ['Пренатоварване от ангажименти'],
        directions: ['Поддържащ, балансиран режим', 'Защита на личния ресурс'],
        communication: ['Партньорска', 'Признавай усилията', 'Пази баланса работа–възстановяване']
      }
    };

    // Функция за вземане на профил по typeCode
    function getProfileByTypeCode(typeCode) {
      if (!typeCode) return null;
      const normalized = typeCode.toUpperCase().replace(/[^EXSVDMPJ-]/g, '');
      return psyadviceProfiles[normalized] || null;
    }

    // State
    let currentQuestionIndex = 0;
    let answers = {};
    const questions = testData.items;

    // Functions
    function startTest() {
      showScreen('screenQuestions');
      renderQuestion();
    }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function renderQuestion() {
      const question = questions[currentQuestionIndex];
      const container = document.getElementById('questionContainer');
      
      const html = `
        <div class="question-card">
          <div class="question-number">Въпрос ${currentQuestionIndex + 1}</div>
          <div class="question-text">${question.text}</div>
          <div class="options" id="options">
            ${question.options.map((opt, idx) => `
              <div class="option" data-index="${idx}" onclick="selectOption(${idx})">
                <div class="option-radio"></div>
                <div class="option-text">${opt}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Restore previous answer if exists
      if (answers[question.id] !== undefined) {
        selectOption(answers[question.id], false);
      }
      
      updateProgress();
      updateNavigation();
    }

    function selectOption(index, enableNext = true) {
      const options = document.querySelectorAll('.option');
      options.forEach(opt => opt.classList.remove('selected'));
      options[index].classList.add('selected');
      
      const question = questions[currentQuestionIndex];
      answers[question.id] = index;
      
      if (enableNext) {
        document.getElementById('btnNext').disabled = false;
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
      } else {
        calculateAndShowResults();
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
      }
    }

    function updateProgress() {
      const current = currentQuestionIndex + 1;
      const total = questions.length;
      const percent = Math.round((current / total) * 100);
      
      document.getElementById('currentQuestion').textContent = current;
      document.getElementById('totalQuestions').textContent = total;
      document.getElementById('progressPercent').textContent = percent + '%';
      document.getElementById('progressFill').style.width = percent + '%';
    }

    function updateNavigation() {
      const btnPrevious = document.getElementById('btnPrevious');
      const btnNext = document.getElementById('btnNext');
      
      btnPrevious.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
      
      const question = questions[currentQuestionIndex];
      const hasAnswer = answers[question.id] !== undefined;
      btnNext.disabled = !hasAnswer;
      
      if (currentQuestionIndex === questions.length - 1) {
        btnNext.textContent = 'Виж резултатите';
      } else {
        btnNext.textContent = 'Следващ въпрос';
      }
    }

    function calculateScores() {
      const rawScores = { E: 0, C: 0, O: 0, A: 0, N: 0, I: 0, R: 0 };
      const minScores = { E: 0, C: 0, O: 0, A: 0, N: 0, I: 0, R: 0 };
      const maxScores = { E: 0, C: 0, O: 0, A: 0, N: 0, I: 0, R: 0 };
      
      // Calculate raw scores
      questions.forEach(q => {
        const answerIndex = answers[q.id];
        const scoring = scoringKey[q.id][answerIndex];
        
        Object.keys(scoring).forEach(dim => {
          rawScores[dim] += scoring[dim];
        });
      });
      
      // Calculate min/max possible scores
      questions.forEach(q => {
        const scorings = scoringKey[q.id];
        
        Object.keys(rawScores).forEach(dim => {
          const values = scorings.map(s => s[dim]);
          minScores[dim] += Math.min(...values);
          maxScores[dim] += Math.max(...values);
        });
      });
      
      // Normalize to 0-100
      const normalizedScores = {};
      Object.keys(rawScores).forEach(dim => {
        const raw = rawScores[dim];
        const min = minScores[dim];
        const max = maxScores[dim];
        const range = max - min;
        
        if (range === 0) {
          normalizedScores[dim] = 50;
        } else {
          normalizedScores[dim] = Math.round(((raw - min) / range) * 100);
        }
      });
      
      return normalizedScores;
    }

    async function calculateAndShowResults() {
      const scores = calculateScores();
      
      showScreen('screenResults');
      renderDimensions(scores);
      renderTypeCode(scores);
      renderFlags(scores);
      const analysis = analyzeNutritionalRisks(scores);
      
      // Показваме бутона "Запази"
      const saveBtn = document.getElementById('saveResultBtn');
      if (saveBtn) {
        saveBtn.style.display = 'block';
        // Премахваме предишни event listeners (ако има) и добавяме нов
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        
        // Добавяме event listener за запазване
        newSaveBtn.onclick = async function() {
          const originalText = newSaveBtn.textContent;
          newSaveBtn.textContent = 'Запазване...';
          newSaveBtn.disabled = true;
          
          try {
            await saveResults(scores, analysis);
          } catch (error) {
            console.error('Грешка при запазване на резултатите:', error);
            showSaveMessage('error', `Грешка: ${error.message}. Резултатите са запазени локално.`);
          } finally {
            newSaveBtn.textContent = originalText;
            newSaveBtn.disabled = false;
          }
        };
      }
      
      // Показване на AI анализа
      setTimeout(() => {
        renderAIAnalysis(analysis);
      }, 1500);
    }

    function renderDimensions(scores) {
      const container = document.getElementById('dimensionsContainer');
      const dimensions = ['E', 'C', 'O', 'A', 'N', 'I', 'R'];
      
      const html = dimensions.map(dim => {
        const info = dimensionInfo[dim];
        const score = scores[dim];
        
        return `
          <div class="dimension-card">
            <div class="dimension-header">
              <div class="dimension-name">${info.name}</div>
              <div class="dimension-code">${dim}</div>
            </div>
            <div class="dimension-description">${info.description}</div>
            <div class="score-bar-container">
              <div class="score-bar-labels">
                <span>${info.lowLabel}</span>
                <span>${info.highLabel}</span>
              </div>
              <div class="score-bar">
                <div class="score-marker" style="left: ${score}%"></div>
              </div>
              <div class="score-value">${score} / 100</div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }

    function renderTypeCode(scores) {
      const container = document.getElementById('typeCodeContainer');
      
      // Generate 4-axis type code (E-O-A-C)
      const E_code = scores.E >= dimensionInfo.E.threshold ? 'E' : 'X';
      const O_code = scores.O >= dimensionInfo.O.threshold ? 'V' : 'S';
      const A_code = scores.A >= dimensionInfo.A.threshold ? 'M' : 'D';
      const C_code = scores.C >= dimensionInfo.C.threshold ? 'J' : 'P';
      
      const typeCode = `${E_code}-${O_code}-${A_code}-${C_code}`;
      
      const html = `
        <div class="type-code-card">
          <div class="type-code-label">Вашият комуникационен код</div>
          <div class="type-code-value">${typeCode}</div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function renderFlags(scores) {
      const container = document.getElementById('flagsContainer');
      const flags = [];
      
      if (scores.I >= 65) {
        flags.push({
          title: 'Висока импулсивност',
          description: 'Порив за веднага: склонност към прибързани решения и похапване без план.',
          type: 'warning'
        });
      }
      
      if (scores.N >= 65) {
        flags.push({
          title: 'Висока емоционална реактивност',
          description: 'По-висока чувствителност към стрес и емоционални стимули.',
          type: 'warning'
        });
      }
      
      if (scores.R >= 65) {
        flags.push({
          title: 'Висока склонност към риск',
          description: 'Склонност към крайности: резки промени и експерименти с режим и храна.',
          type: 'warning'
        });
      }
      
      if (flags.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      const html = `
        <div class="flags-section">
          <h3>Къде да внимаваш</h3>
          ${flags.map(flag => `
            <div class="flag-card ${flag.type}">
              <div class="flag-title">${flag.title}</div>
              <div class="flag-description">${flag.description}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }

    // Запазване на резултатите в localStorage и backend
    async function saveResults(scores, analysis) {
      try {
        const timestamp = new Date().toISOString();
        
        // Генериране на type code
        const E_code = scores.E >= dimensionInfo.E.threshold ? 'E' : 'X';
        const O_code = scores.O >= dimensionInfo.O.threshold ? 'V' : 'S';
        const A_code = scores.A >= dimensionInfo.A.threshold ? 'M' : 'D';
        const C_code = scores.C >= dimensionInfo.C.threshold ? 'J' : 'P';
        const typeCode = `${E_code}-${O_code}-${A_code}-${C_code}`;
        
        // Събиране на risk flags
        const riskFlags = [];
        if (scores.I >= 65) riskFlags.push('Висока импулсивност');
        if (scores.N >= 65) riskFlags.push('Висока емоционална реактивност');
        if (scores.R >= 65) riskFlags.push('Висока склонност към риск');
        
        // Вземане на пълния профил от psyadvice
        const psyadviceProfile = getProfileByTypeCode(typeCode);
        
        // Обогатени резултати със съдържателна информация за AI анализ
        const personalityTest = {
          typeCode: typeCode,
          scores: scores,
          riskFlags: riskFlags,
          strengths: analysis.strengths || [],
          // Запазваме пълните рискове с детайли за по-задълбочен анализ
          mainRisks: analysis.risks ? analysis.risks.map(r => ({
            title: r.title,
            description: r.description
          })) : [],
          // Запазваме всички препоръки за по-добро планиране
          topRecommendations: analysis.recommendations || [],
          // Добавяме обобщение за бърз преглед (handle missing typeCode gracefully)
          summary: typeCode ? `Личностен тип ${typeCode} с ${riskFlags.length > 0 ? 'рискови фактори' : 'балансиран профил'}` : 'Личностен профил',
          timestamp: timestamp,
          // НОВО: Пълни данни от psyadvice.txt за интеграция в профила и AI асистента
          psyadvice: psyadviceProfile ? {
            description: psyadviceProfile.description,
            traits: psyadviceProfile.traits,
            eatingRisks: psyadviceProfile.eatingRisks,
            directions: psyadviceProfile.directions,
            communication: psyadviceProfile.communication
          } : null
        };
        
        // Запазване в localStorage (винаги)
        const existingData = JSON.parse(localStorage.getItem('psychTests') || '{}');
        existingData.personalityTest = personalityTest;
        localStorage.setItem('psychTests', JSON.stringify(existingData));
        console.log('[PERSONALITY TEST] Резултатите са запазени в localStorage:', personalityTest);
        
        // Проверка дали теста е стартиран от профила
        const urlParams = new URLSearchParams(window.location.search);
        const fromProfile = urlParams.get('from') === 'profile';
        
        // Проверка за userId
        const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
        
        if (!userId) {
          console.warn('[PERSONALITY TEST] Няма userId - показва се съобщение за регистрация');
          if (fromProfile) {
            // Ако теста е стартиран от профила, но няма userId - нещо не е наред
            showSaveMessage('error', 'Грешка: Не сте влезли в системата. Моля рефрешнете страницата и опитайте отново.');
          } else {
            // Ако теста е стартиран директно - показваме съобщение за регистрация
            showSaveMessage('warning', 'За да запазите резултатите в профила си, моля първо <a href="../login.html" style="color: inherit; text-decoration: underline;">влезте в акаунта си</a> или <a href="../index.html#register" style="color: inherit; text-decoration: underline;">се регистрирайте</a>. Резултатите са запазени локално в браузъра.');
          }
          return;
        }
        
        // Опит за backend запазване
        console.log('[PERSONALITY TEST] Опит за backend запазване за userId:', userId);
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
          ? 'http://localhost:8787'
          : 'https://openapichatbot.radilov-k.workers.dev';
        
        const response = await fetch(`${API_BASE}/api/savePsychTests`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            personalityTest: personalityTest
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('[PERSONALITY TEST] Backend отговор:', result);
        
        if (result.success) {
          console.log('[PERSONALITY TEST] ✓ Успешно запазване в backend');
          localStorage.setItem('psychTestsLastSync', timestamp);
          
          // Проверка дали теста е стартиран от профила
          const fromProfile = urlParams.get('from') === 'profile';
          
          // Показваме съобщение за успешно запазване
          // Проверка дали се препоръчва регенериране на плана
          if (result.data && result.data.shouldRegeneratePlan) {
            const reason = result.data.regenerationReason || 'Препоръчваме регенериране на плана за пълна интеграция на личностния профил.';
            showSaveMessage('success', `
              <div style="margin-bottom: 12px;">✓ Резултатите са запазени успешно в профила ви!</div>
              <div style="background: rgba(255, 193, 7, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 3px solid #ffc107;">
                <strong>💡 Препоръка:</strong> ${reason}
                <div style="margin-top: 8px;">
                  <a href="../code.html#profile-tab" style="color: #22c55e; text-decoration: underline; font-weight: 600;">
                    Отидете в профила → Регенерирайте плана
                  </a>
                </div>
              </div>
              <div style="margin-top: 12px; font-size: 14px; color: var(--text-color-muted);">
                Страницата ще се затвори автоматично след 3 секунди...
              </div>
            `);
          } else {
            showSaveMessage('success', `
              Резултатите са запазени успешно в профила ви! 
              <a href="../code.html#profile-tab" style="color: inherit; text-decoration: underline;">Вижте профила си тук</a>.
              <div style="margin-top: 12px; font-size: 14px; color: var(--text-color-muted);">
                Страницата ще се затвори автоматично след 3 секунди...
              </div>
            `);
          }
          
          // Затваряме страницата след 3 секунди и връщаме потребителя на профил таба
          if (fromProfile) {
            setTimeout(() => {
              // Задаваме флаг да се отвори детайлния контейнер
              sessionStorage.setItem('openPsychTestDetails', 'true');
              // Затваряме страницата и връщаме потребителя на code.html#profile-tab
              window.location.href = '../code.html?fromTest=true#profile-tab';
            }, 3000);
          }
        } else {
          console.error('[PERSONALITY TEST] Backend грешка:', result.message);
          showSaveMessage('warning', `Резултатите са запазени локално. Backend грешка: ${result.message || 'неизвестна грешка'}`);
        }
      } catch (error) {
        console.error('[PERSONALITY TEST] Грешка при запазване:', error);
        showSaveMessage('error', `Грешка при запазване: ${error.message}. Резултатите са запазени локално.`);
      }
    }
    
    function showSaveMessage(status, message) {
      // Скриваме бутона "Запази" само при успешно запазване
      const saveBtn = document.getElementById('saveResultBtn');
      if (saveBtn && status === 'success') {
        saveBtn.style.display = 'none';
      }
      
      const messageDiv = document.getElementById('saveStatusMessage');
      if (!messageDiv) return;
      
      let bgColor, borderColor, iconColor, icon, textColor;
      
      if (status === 'success') {
        bgColor = 'color-mix(in srgb, var(--primary-color) 15%, var(--card-bg))';
        borderColor = 'var(--primary-color)';
        textColor = 'var(--text-color-primary)';
        icon = '✓';
        iconColor = 'var(--primary-color)';
      } else if (status === 'warning') {
        bgColor = 'color-mix(in srgb, var(--accent-color) 10%, var(--card-bg))';
        borderColor = 'var(--accent-color)';
        textColor = 'var(--text-color-primary)';
        icon = '⚠';
        iconColor = 'var(--accent-color)';
      } else { // error
        bgColor = 'color-mix(in srgb, var(--color-danger) 15%, var(--card-bg))';
        borderColor = 'var(--color-danger)';
        textColor = 'var(--text-color-primary)';
        icon = '✕';
        iconColor = 'var(--color-danger)';
      }
      
      messageDiv.innerHTML = `
        <div style="background: ${bgColor}; 
                    border-left: 4px solid ${borderColor}; 
                    padding: var(--space-md); 
                    border-radius: var(--radius-md);">
          <p style="margin: 0; color: ${iconColor}; font-weight: 700; font-size: var(--fs-base);">
            ${icon} ${status === 'success' ? 'Успешно запазване!' : status === 'warning' ? 'Частично запазване' : 'Грешка при запазване'}
          </p>
          ${message ? `<p style="margin: var(--space-xs) 0 0 0; font-size: var(--fs-sm); color: var(--text-color-secondary); line-height: 1.5;">${message}</p>` : ''}
        </div>
      `;
    }

    function simplifyText(text, maxSentences = 2) {
      const clean = text.replace(/"([^"]*)"/g, '$1').replace(/[„“]/g, '');
      const parts = clean.split('.').map(p => p.trim()).filter(Boolean);
      if (parts.length === 0) {
        const trimmed = clean.trim();
        return trimmed && /[.!?]$/.test(trimmed) ? trimmed : `${trimmed}.`;
      }
      const simplified = parts.slice(0, maxSentences).join('. ');
      const withPeriod = /[.!?]$/.test(simplified) ? simplified : `${simplified}.`;
      return withPeriod + (parts.length > maxSentences ? '…' : '');
    }

    function simplifyList(list, limit = 5, sentences = 1) {
      const unique = Array.from(new Set(list.map(item => simplifyText(item, sentences))));
      return unique.slice(0, limit);
    }

    function analyzeNutritionalRisks(scores) {
      const risks = [];
      const recommendations = [];
      const strengths = [];
      const behavioralPatterns = [];
      
      // High Conscientiousness (C >= 70) + High Neuroticism (N >= 65)
      if (scores.C >= 70 && scores.N >= 65) {
        risks.push({
          title: 'Рестриктивни тенденции и ортонексия',
          description: 'Комбинацията от висока дисциплина и емоционална реактивност може да води до твърде строги хранителни режими, перфекционизъм и прекомерна фиксация върху чистото хранене. Възможни признаци: строго броене на калории/макроси, страх от разваляне на диетата, силна тревожност при отклонение от плана, социална изолация заради хранителни ограничения.'
        });
        behavioralPatterns.push('Многократно претегляне на порциите и проверка на етикетите');
        behavioralPatterns.push('Избягване на ситуации където нямате възможност за строг контрол');
        behavioralPatterns.push('Усещане за вина или тревожност след несъвършено хранене');
        behavioralPatterns.push('Крайно определяне на храните като добри и лоши');
        recommendations.push('Бъдете гъвкави в храненето - позволете си 10-20% от калориите в храната за удоволствие');
        recommendations.push('Обърнете се към специалист за създаване на свързан с целите ви, здравословен план');
        recommendations.push('Съзнателно работете за преодоляване на крайностите в определянето на храната');
        recommendations.push('Наблюдавайте за ранни признаци на хранително разстройство и потърсете професионална помощ при нужда');
      }
      
      // High Neuroticism (N >= 65) + Low Conscientiousness (C < 40)
      if (scores.N >= 65 && scores.C < 40) {
        risks.push({
          title: 'Емоционално хранене и компулсивно преяждане',
          description: 'Високата емоционална реактивност съчетана с по-ниска самодисциплина може да води до използване на храната за регулиране на емоции. Рискови поведения: хранене като отговор на стрес, самота, скука или тъга; нощно хранене; трудност да прекратите хранене; чувство на безконтролност около храната; скрито хранене; цикли на ограничение-преяждане.'
        });
        behavioralPatterns.push('Натрапчиво желание за определена храна при негативни емоции');
        behavioralPatterns.push('Хранене до чувство на физически дискомфорт');
        behavioralPatterns.push('Загуба на представа за реалното количество изядена храна при емоционален епизод');
        behavioralPatterns.push('Предпочитане на калорични и сладки храни (с високо съдържание на мазнини+захар)');
        recommendations.push('Създайте списък с алтернативни начини за справяне със стрес (разходка, дишане, спорт, разговор с приятел)');
        recommendations.push('Водете дневник на емоциите и храненето за разпознаване на отключващи моменти');
        recommendations.push('Задавайте си въпроса "Защо искам тази храна? От къде идва това желание? Решава ли проблема?');
        recommendations.push('Работете с психолог/психотерапевт за откриване на правилите стратегии');
        recommendations.push('Изградете работеща система за критични емоционални моменти, която не води до храна');
      }
      
      // High Impulsivity (I >= 65)
      if (scores.I >= 65) {
        risks.push({
          title: 'Импулсивно хранене и загуба на контрол',
          description: 'Склонността към бързи действия може да води до чести похапвания между другото, хранене при визуален или обонятелен стимул, и трудност да се спре веднъж започнало хранене. Типични модели: спонтанни покупки на нездравословна храна; приемане на храна без да се усетите; безконтролно хранене пред телевизор/компютър; трудност да се изчака правилното време за хранене.'
        });
        behavioralPatterns.push('Хранене в движение докато вниманието е другаде');
        behavioralPatterns.push('Покупка на храна на момента без предварително планиране');
        behavioralPatterns.push('Хранене докато готвите или преди да сервирате');
        behavioralPatterns.push('Трудност да отложите удоволствието (желание за сега)');
        recommendations.push('Премахнете видимите изкушения от ежедневната среда - далеч от погледа, далеч от дома, извън съзнание');
        recommendations.push('Използвайте техниката 10-минутна пауза преди да вземете решение за храна');
        recommendations.push('Планирайте хранения и закуски предварително - подгответе здравословни алтернативи');
        recommendations.push('Опитайте да се храните с чиния и прибори на масата без екран пред вас');
        recommendations.push('Дъвчете, наслаждавайте се на вкусовите качества и вида на храната');
        recommendations.push('Помислете предварително за менюто си, за това какво ви се яде и кога да се случи');
      }
      
      // Low Conscientiousness (C < 40) + High Openness (O >= 65)
      if (scores.C < 40 && scores.O >= 65) {
        risks.push({
         title: 'Хаотичен ритъм и непостоянство',
description: 'Склонността към спонтанност и търсене на новото често води до липса на ясен хранителен ритъм. Храненето става нередовно, с пропуснати хранения и чести експерименти, които рядко се довеждат докрай. Типични признаци са: хранене без план; пропускане на хранения, най-често сутрин; периоди на гладуване, последвани от преяждане; започване на нови диети с бързо отказване; риск от недостиг на важни хранителни вещества.'
});
behavioralPatterns.push('Нямаш фиксирани часове за хранене');
behavioralPatterns.push('Често ядеш набързо или докато правиш нещо друго');
behavioralPatterns.push('Сменяш често диети и режими, без да задържиш нито един достатъчно дълго');
behavioralPatterns.push('Храненето зависи силно от моментната мотивация');
recommendations.push('Осигури си поне 3 основни хранения на ден, дори в натоварени дни');
recommendations.push('Използвай напомняния за хранене, ако често забравяш');
recommendations.push('Разнообразявай рецептите, но запази ритъма на храненията');
recommendations.push('Дръж под ръка бърза и лесна храна за моменти без време: кисело мляко, яйца, плодове, ядки');
recommendations.push('Превърни режима в игра: малки цели, но всеки ден');
      }
      
      // High Risk-seeking (R >= 65) + High Impulsivity (I >= 65)
      if (scores.R >= 65 && scores.I >= 65) {
        risks.push({
         title: 'Екстремни подходи и йо-йо ефект',
description: 'Силната импулсивност и склонност към риск често водят до крайни диети, съмнителни добавки и всичко или нищо мислене. Резултатът е рязко отслабване, последвано от напълняване. Типични рискове: много нискокалорийни или еднообразни диети; елиминационни режими без причина; непроверени добавки; претоварване с тренировки; цикли с йо-йо ефект и метаболитни последствия.'
});
behavioralPatterns.push('Чести резки промени в храненето');
behavioralPatterns.push('Търсене на бърз резултат и готови решения');
behavioralPatterns.push('Пренебрегване на сигналите на тялото');
behavioralPatterns.push('Нетерпимост към бавен и постепенен подход');
recommendations.push('Избягвай крайности – търси умерени, устойчиви промени');
recommendations.push('Консултирай се с професионалист преди сериозни промени');
recommendations.push('Въведи правило: изчакай 2 седмици преди да започнеш радикална промяна');
recommendations.push('Фокусирай се върху навиците, не само върху кантара');
recommendations.push('Проверявай източниците, преди да приложиш даден подход');
      }
      
      // Low Extraversion (E < 35)
      if (scores.E < 35) {
        risks.push({
          title: 'Социална изолация и хранене като утеха',
          description: 'По-затворените хора често се хранят сами, а това улеснява преяждането и прави по-труден контролът върху избора на храна. Храната се превръща в заместител на близост. Типични рискове: ядене при самота; липса на споделяне на цели; избягване на съвместни хранения; задълбочаване на усещането за изолираност.'
        });
behavioralPatterns.push('Предпочиташ да се храниш сам, дори когато имаш възможност за компания');
behavioralPatterns.push('Използваш храната като начин да се успокоиш или утешиш');
behavioralPatterns.push('Трудно ти е да говориш с други за храненето или целите си');
recommendations.push('Подреди пространството си така, че храненето да е осъзнато и спокойно');
recommendations.push('Свържи се с човек, с когото можете да се подкрепяте взаимно');
recommendations.push('Обмисли участие в група или сесии за споделено насърчаване');
recommendations.push('Изгради и други начини за грижа към себе си, извън храната');
      }
      
      // High Extraversion (E >= 70) + Low Agreeableness (A < 40)
      if (scores.E >= 70 && scores.A < 40) {
        risks.push({
          title: 'Прекомерно социално хранене и алкохол',
          description: 'Високата социална активност често води до често хранене навън, алкохол и по-малък контрол. Типични рискове: големи порции в ресторанти; честа консумация на алкохол с компания (празни калории и по-слаб самоконтрол); късни хранения след излизания; натиск от другите да ядеш/пиеш повече; разпадане на режима заради социалния график.'
        });
behavioralPatterns.push('Храниш се повече в компания, отколкото сам');
behavioralPatterns.push('Трудно ти е да откажеш алкохол или десерт, когато си с други');
behavioralPatterns.push('Повечето събития, които организираш или посещаваш, са свързани с ядене или пиене');
behavioralPatterns.push('Забравяш хранителните си цели, когато си с приятели');
recommendations.push('Планирай предварително какво ще поръчаш, ако ще ядеш навън');
recommendations.push('Яж нещо леко преди излизане и избери по-леки варианти на място');
recommendations.push('Постави си ясни граници за алкохола и ги спазвай');
recommendations.push('Предложи на приятелите си срещи без храна – разходка, спорт, разговор');
recommendations.push('Учи се да поставяш граници – можеш да се забавляваш без да преяждаш');
      }
      
      // High Agreeableness (A >= 70)
      if (scores.A >= 70) {
        risks.push({
          title: 'Трудност да казваш "не" на храна',
          description: 'Когато си склонен да се съобразяваш с другите, често се случва да ядеш нещо само за да не обидиш някого. Това може да пречи на собствения ти режим. Типични рискове: ядеш от учтивост; избираш според желанията на другите; нарушаваш плана си, за да не създаваш напрежение; жертваш своето здраве заради "мир и удобство".'
        });
behavioralPatterns.push('Приемаш храна, дори когато не ти се яде, за да не обидиш някого');
behavioralPatterns.push('Ядеш повече, за да не остане храна или за да не изглеждаш неблагодарен');
behavioralPatterns.push('Избираш не най-доброто за теб, а това, което ще се хареса на другите');
behavioralPatterns.push('Чувстваш вина, когато искаш да поставиш граници');
recommendations.push('Научи се да отказваш учтиво: „Благодаря, не съм гладен/а“, „Изглежда страхотно, но ще пропусна“');
recommendations.push('Сподели с близките си какво е важно за теб, за да те подкрепят');
recommendations.push('Поставяй здравето и нуждите си на първо място');
recommendations.push('Учи се да казваш „не“ спокойно и с уважение – това също е показване на внимание');

      }
      
      // Low Openness (O < 35) + High Conscientiousness (C >= 70)
      if (scores.O < 35 && scores.C >= 70) {
        risks.push({
          title: 'Твърде ограничаващ режим и монотонност',
          description: 'Склонността към рутина и познатото може да води до ограничен избор на храни и липса на разнообразие. Това повишава риска от дефицити, прави адаптацията трудна при промени и затруднява социалните ситуации. Типични рискове: еднообразно хранене всеки ден; избягване на нови храни; тревожност при промяна; социално изолиране заради твърде тесен режим.'
        });
behavioralPatterns.push('Храниш се с едни и същи 5–10 храни всеки ден');
behavioralPatterns.push('Изпитваш тревожност или дискомфорт при нова или непозната храна');
behavioralPatterns.push('Имаш затруднения при пътувания или при смяна на обстановката');
behavioralPatterns.push('Избягваш социални събития, ако не контролираш храната');
recommendations.push('Добавяй по една нова, полезна храна седмично към менюто си');
recommendations.push('Разнообразието е важно за балансирано хранене и устойчивост');
recommendations.push('Консултирай се със специалист, ако режимът ти е прекалено ограничен');
recommendations.push('Ползвай правилото 80/20: 80% познато, 20% ново');

      }
      
      // High Neuroticism (N >= 65) + High Impulsivity (I >= 65) + Low Conscientiousness (C < 40)
      if (scores.N >= 65 && scores.I >= 65 && scores.C < 40) {
        risks.push({
          title: 'Комплексно нарушено хранително поведение',
          description: 'Тази комбинация създава висок риск от сериозни затруднения с храненето. Силни емоции, импулсивни реакции и липса на структура се наслагват и водят до тежки епизоди на преяждане. Често се наблюдава повтарящ се цикъл: загуба на контрол – вина – опити за компенсация – нов срив. В този случай е необходима професионална подкрепа.'
        });
behavioralPatterns.push('Чести епизоди на загуба на контрол върху храненето');
behavioralPatterns.push('Съчетаваш няколко проблемни поведения едновременно');
behavioralPatterns.push('Силни и болезнени емоции, свързани с храната и теглото');
recommendations.push('ВАЖНО: Потърси помощ от психолог и специалист по хранене');
recommendations.push('Първият фокус трябва да е върху овладяване на емоциите, не върху диети');
recommendations.push('Изгради стабилна система за подкрепа – хора, на които можеш да разчиташ');
recommendations.push('Обмисли терапия, насочена към промяна на мисловните и поведенческите модели');
      }
      
      // Low Conscientiousness (C < 40) + Low Agreeableness (A < 40)
      if (scores.C < 40 && scores.A < 40) {
        risks.push({
          title: 'Ниска мотивация за промяна',
          description: 'Когато липсва вътрешна нагласа за промяна, дори добре обосновани съвети често се посрещат със съпротива. Промените започват, но не се задържат. Може да има усещане, че правилата не важат за теб или че никой не разбира твоята ситуация.'
        });
behavioralPatterns.push('Склонност да отхвърляш съвети, дори когато звучат разумно');
behavioralPatterns.push('Започваш промени, но бързо се отказваш');
behavioralPatterns.push('Имаш усещане, че повечето правила не се отнасят лично до теб');
recommendations.push('Открий лична причина за промяна, която има смисъл за теб самия');
recommendations.push('Работи с човек, който уважава нуждата ти от свобода и избор');
recommendations.push('Започни с малки промени, които сам си избрал');
recommendations.push('Свържи храненето с нещо лично важно – не с чужди очаквания');
      }
      
      // High Conscientiousness (C >= 70) + High Impulsivity (I >= 65) - парадоксална комбинация
      if (scores.C >= 70 && scores.I >= 65) {
        risks.push({
          title: 'Парадокс между контрол и импулс',
          description: 'Когато силна самодисциплина се съчетае с висока импулсивност, често възниква вътрешен конфликт: стриктен режим, последван от внезапен срив. Резултатът е цикъл: контрол → напрежение → импулс → вина → още по-строг контрол. Това води до изтощение и нестабилност.'
        });
behavioralPatterns.push('Редуване на строга дисциплина и внезапни сривове');
behavioralPatterns.push('Строго спазване на режим през седмицата, последвано от срив през уикенда');
behavioralPatterns.push('Силен вътрешен натиск и самообвинение след отклонение');
recommendations.push('Разпознай този модел като структура, а не като слабост');
recommendations.push('Включи контролирани „отстъпки“ в плана, преди да се натрупа напрежение');
recommendations.push('Работи върху приемане и разбиране към себе си, вместо самообвинение');
recommendations.push('Ползвай прости техники за овладяване на импулса – дишане, кратка пауза, смяна на фокус');
      }
      
      // Identify strengths
      if (scores.C >= 60) {
        strengths.push('Когато решиш да действаш, можеш да държиш режим и да правиш устойчиви промени');
      }
      
      if (scores.O >= 60) {
        strengths.push('Креативен и отворен към новото: лесно пробваш идеи и подходи, когато имат смисъл за теб');
      }
      
      if (scores.E >= 50 && scores.E <= 70) {
        strengths.push('Балансираната социална енергия помага за поддържане на здрави социални връзки без прекомерно социално хранене');
      }
      
      if (scores.N < 50) {
        strengths.push('По-рядко ядеш само заради напрежение, ако имаш ясен ритъм и сън');
      }
      
      if (scores.I < 50) {
        strengths.push('По-лесно удържаш поривите, когато имаш готови варианти за храна');
      }
      
      if (scores.R < 50) {
        strengths.push('Предпазливият подход към риск помага за избягване на крайни и потенциално вредни диетични експерименти');
      }
      
      // If no specific risks identified
      if (risks.length === 0) {
        risks.push({
          title: 'Балансиран профил',
          description: 'Вашият личностен профил не показва ясно изразени области на риск във връзка с хранителните навици. Това е добра изходна позиция.'
        });
        recommendations.push('Поддържайте осъзнато хранене и редовен режим');
        recommendations.push('Следете за промени в стреса или емоционалното състояние, които могат да повлияят храненето');
      }
      
      const simplifiedRisks = risks.map(risk => ({
        ...risk,
        description: simplifyText(risk.description, 2)
      })).slice(0, 4);

      return {
        risks: simplifiedRisks,
        recommendations: simplifyList(recommendations, 6, 1),
        strengths: simplifyList(strengths, 4, 1),
        behavioralPatterns: simplifyList(behavioralPatterns, 5, 1)
      };
    }

    function renderAIAnalysis(analysis) {
      const container = document.getElementById('aiAnalysisContainer');
      
      let html = '';
      
      // Strengths
      if (analysis.strengths.length > 0) {
        html += `
          <div class="ai-subsection">
            <h4>🧠 Тип психопрофил</h4>
            <ul class="ai-list">
              ${analysis.strengths.map(s => `
                <li>
                  <span class="ai-bullet">•</span>
                  <span class="ai-text">${s}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      }
      
      // Risks
      html += `
        <div class="ai-subsection">
          <h4>⚠ Потенциални вредни хранителни навици</h4>
          ${analysis.risks.map(risk => `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 700; color: var(--text); margin-bottom: 4px;">${risk.title}</div>
              <div class="ai-text">${risk.description}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      // Behavioral Patterns (if any)
      if (analysis.behavioralPatterns && analysis.behavioralPatterns.length > 0) {
        html += `
          <div class="ai-subsection">
            <h4>⚠ Потенциални вредни хранителни навици</h4>
            <ul class="ai-list">
              ${analysis.behavioralPatterns.map(pattern => `
                <li>
                  <span class="ai-bullet">⊳</span>
                  <span class="ai-text">${pattern}</span>
                </li>
              `).join('')}
            </ul>
            <div class="ai-text" style="margin-top: 12px; font-style: italic; font-size: 13px;">
              Ако разпознавате 3 или повече от тези модели редовно, това може да сигнализира за необходимост от по-активна намеса.
            </div>
          </div>
        `;
      }
      
      // Recommendations
      html += `
        <div class="ai-subsection">
          <h4>✅ Препоръки</h4>
          <ul class="ai-list">
            ${analysis.recommendations.map(rec => `
              <li>
                <span class="ai-bullet">→</span>
                <span class="ai-text">${rec}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
      
      // General note
      html += `
        <div class="ai-subsection">
          <div class="ai-text" style="font-style: italic; padding-top: 12px; border-top: 1px solid var(--border);">
            <strong>Забележка:</strong> Това е ориентир, базиран на връзки между личностни особености и навици. Не е диагноза. Ако имаш сериозни трудности с храненето, потърси специалист.</div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function restartTest() {
      currentQuestionIndex = 0;
      answers = {};
      
      // Скриваме бутона "Запази" и съобщенията
      const saveBtn = document.getElementById('saveResultBtn');
      if (saveBtn) {
        saveBtn.style.display = 'none';
      }
      const messageDiv = document.getElementById('saveStatusMessage');
      if (messageDiv) {
        messageDiv.innerHTML = '';
      }
      
      showScreen('screenIntro');
    }

    // Initialize
    document.getElementById('totalQuestions').textContent = questions.length;
  </script>
</body>
</html>
