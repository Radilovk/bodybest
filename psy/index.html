<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <title>–í–∏–∑—É–∞–ª–µ–Ω –¢–µ—Å—Ç | BodyBest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="../css/base_styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0; -webkit-tap-highlight-color: transparent;}
    
    body{
      min-height:100vh;
      font-family: var(--font-primary);
      background: var(--bg-gradient);
      color: var(--text-color-primary);
      padding-bottom: 40px;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

    .screen{display:none; min-height:100vh; padding:24px 20px; max-width: 600px; margin: 0 auto;}
    .screen.active{display:flex; flex-direction:column;}

    /* Back button */
    .back-btn {
      position: fixed;
      top: var(--space-md);
      left: var(--space-md);
      width: 44px;
      height: 44px;
      border-radius: var(--radius-round);
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      color: var(--text-color-primary);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      z-index: 1000;
      text-decoration: none;
    }
    .back-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }
    .back-btn:active {
      transform: scale(0.95);
    }

    /* --------- Screen 1: Intro --------- */
    .intro{justify-content:center; text-align:center; gap:20px;}
    .logo-icon { 
      font-size: 40px; margin-bottom: 10px; display: block; 
    }
    .title{
      font-size: 26px; 
      font-weight: 800; 
      line-height: 1.2; 
      color: var(--text-color-primary);
    }
    .title span{ color: var(--primary-color); }
    .p{
      font-size: 16px; 
      line-height: 1.6; 
      color: var(--text-color-secondary);
    }
    .rules-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      text-align: left;
      margin: 10px 0 20px;
      border: 1px solid var(--border-color-soft);
    }
    .rules-card h3 { font-size: 14px; text-transform: uppercase; color: var(--primary-color); letter-spacing: 1px; margin-bottom: 10px; }
    .rules{ padding-left: 20px; color: var(--text-color-primary); font-size: 15px; line-height: 1.6; }
    .rules li { margin-bottom: 8px; }

    .btn{
      width:100%;
      border:none;
      border-radius: 99px;
      padding: 18px;
      background: var(--primary-color);
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
      transition: all 0.2s ease;
    }
    .btn:hover {
      background: color-mix(in srgb, var(--primary-color) 85%, black);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(var(--primary-rgb), 0.4);
    }
    .btn:active { transform: scale(0.98); }
    
    .btnGhost{
      display: block;
      text-align: center;
      margin-top: 15px;
      color: var(--text-color-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }
    .btnGhost:hover {
      color: var(--primary-color);
    }

    /* --------- Screen 2: Grid --------- */
    .gridHead{
      font-size: 18px; 
      font-weight: 600; 
      text-align: center; 
      margin-bottom: 20px;
      color: var(--text-color-primary);
    }
    .grid{
      flex:1;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      padding-bottom: 20px;
    }
    .thumb{
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--card-bg);
      border: 2px solid var(--border-color-soft);
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: all 0.2s ease;
      aspect-ratio: 1/1;
    }
    .thumb:hover {
      border-color: var(--secondary-color);
      transform: scale(1.02);
      box-shadow: var(--shadow-lg);
    }
    .thumb:active { transform: scale(0.98); }
    .thumb img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    /* --------- Fullscreen Overlay --------- */
    .overlay{
      position: fixed; inset: 0; z-index: 100;
      background: rgba(var(--surface-background-rgb), 0.98);
      backdrop-filter: blur(8px);
      display: none;
      flex-direction: column;
      animation: fadeIn 0.2s ease-out;
    }
    .overlay.active{ display: flex; }
    
    .ovTop{ padding: 20px; display: flex; justify-content: flex-end; }
    .ovClose{
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      color: var(--text-color-primary);
      width: 44px; height: 44px; border-radius: 50%;
      font-size: 20px; cursor: pointer; display: grid; place-items: center;
      transition: all 0.2s ease;
    }
    .ovClose:hover {
      background: var(--color-danger);
      border-color: var(--color-danger);
      color: white;
      transform: scale(1.05);
    }

    .ovBody{
      flex: 1; display: flex; align-items: center; justify-content: center; padding: 0 20px;
    }
    .ovImgWrap{
      width: 100%; max-height: 70vh;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      background: #fff;
    }
    .ovImgWrap img{ width: 100%; height: 100%; object-fit: contain; display: block; }
    
    .ovBottom{ padding: 30px 20px; display: flex; gap: 15px; }
    .btnSelect{
      flex: 2; border: none; border-radius: 99px; padding: 16px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: #fff; font-weight: 700; font-size: 16px;
      box-shadow: 0 4px 15px color-mix(in srgb, var(--primary-color) 40%, transparent);
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btnSelect:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px color-mix(in srgb, var(--primary-color) 50%, transparent);
    }
    .btnSelect:active {
      transform: translateY(0);
    }
    .btnBack{
      flex: 1; border: 2px solid var(--border-color); border-radius: 99px; padding: 16px;
      background: var(--card-bg); color: var(--text-color-secondary); font-weight: 700; font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btnBack:hover {
      background: var(--surface-background);
      border-color: var(--primary-color);
      color: var(--primary-color);
      transform: translateY(-2px);
    }
    .btnBack:active {
      transform: translateY(0);
    }

    /* --------- Screen 3: Result --------- */
    .resultImg{
      border-radius: var(--radius);
      overflow: hidden;
      height: 220px;
      width: 100%;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    .resultImg img{ width: 100%; height: 100%; object-fit: cover; }
    
    .h2{ font-size: 24px; font-weight: 800; color: var(--text-color-primary); margin-bottom: 5px; }
    .sub{ font-size: 15px; color: var(--text-color-secondary); font-weight: 500; margin-bottom: 25px; line-height: 1.5; }
    
    .section-title {
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px;
      color: var(--accent-color); margin: 25px 0 10px; display: block;
    }
    
    .card{
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    ul.clean{ list-style: none; }
    ul.clean li{ 
      display: flex; gap: 12px; margin-bottom: 12px; 
      font-size: 15px; line-height: 1.5; color: var(--text-color-primary); align-items: flex-start;
    }
    ul.clean li:last-child { margin-bottom: 0; }
    
    .icon { font-size: 16px; color: var(--accent-color); margin-top: 2px; flex-shrink: 0; }
    .icon-warn { color: var(--color-warning); } /* –ñ—ä–ª—Ç–æ-–æ—Ä–∞–Ω–∂–µ–≤–æ –∑–∞ —Ä–∏—Å–∫–æ–≤–µ */

    .actions{ margin-top: 40px; display: flex; gap: 15px; flex-direction: column; }
    .btnSmall{
      width: 100%; border: 1px solid var(--border-color); border-radius: 99px;
      padding: 15px; background: var(--card-bg); color: var(--text-color-secondary); font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btnSmall:hover {
      background: var(--surface-background);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
  </style>
  <script type="module">
    // Theme initialization
    import { initializeTheme } from '../js/uiHandlers.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
    });
  </script>
</head>
<body>
  <!-- Back to Profile Button -->
  <a href="../code.html#profile-tab" class="back-btn" title="–ù–∞–∑–∞–¥ –∫—ä–º –ø—Ä–æ—Ñ–∏–ª–∞" onclick="sessionStorage.setItem('openPsychTestDetails', 'true');">
    <i class="bi bi-arrow-left"></i>
  </a>

  <!-- Screen 1: Intro -->
  <section class="screen intro active" id="s1">
    <div class="fade-in">
      <span class="logo-icon">üåø</span>
      <div class="title">–û—Ç–∫—Ä–∏–π —Å–∫—Ä–∏—Ç–∏—è —Å–∏<br><span>—Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª</span></div>
      <p class="p" style="margin-top:10px">
        –¢–æ–∑–∏ –≤–∏–∑—É–∞–ª–µ–Ω —Ç–µ—Å—Ç –ø–æ–º–∞–≥–∞ –¥–∞ –Ω–∞–¥–Ω–∏–∫–Ω–µ—à –≤ –ø–æ–¥—Å—ä–∑–Ω–∞—Ç–µ–ª–Ω–∏—Ç–µ —Å–∏ –Ω–∞–≤–∏—Ü–∏ –∏ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Ç–∏ —Å —Ö—Ä–∞–Ω–∞—Ç–∞.
      </p>
      
      <div class="rules-card">
        <h3>–ö–∞–∫ —Ä–∞–±–æ—Ç–∏:</h3>
        <ol class="rules">
          <li>–†–∞–∑–≥–ª–µ–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞.</li>
          <li>–ù–µ –º–∏—Å–ª–∏ –ª–æ–≥–∏—á–Ω–æ.</li>
          <li>–ò–∑–±–µ—Ä–∏ —Ç–æ–≤–∞, –∫–æ–µ—Ç–æ <strong>–Ω–∞–π-—Å–∏–ª–Ω–æ –ø—Ä–∏–≤–ª–∏—á–∞</strong> –≤–Ω–∏–º–∞–Ω–∏–µ—Ç–æ —Ç–∏ –≤ –º–æ–º–µ–Ω—Ç–∞.</li>
        </ol>
      </div>

      <button class="btn" id="start">–ó–∞–ø–æ—á–Ω–∏ —Ç–µ—Å—Ç–∞</button>
      <a class="btnGhost" href="about.html">–ù–∞—É—á–∏ –ø–æ–≤–µ—á–µ –∑–∞ –º–µ—Ç–æ–¥–∞</a>
    </div>
  </section>

  <!-- Screen 2: Grid -->
  <section class="screen" id="s2">
    <div class="gridHead fade-in">–ö–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑–æ–Ω–∏—Ä–∞ —Å —Ç–µ–± —Ç–æ—á–Ω–æ —Å–µ–≥–∞?</div>
    <div class="grid fade-in" id="grid"></div>
    <div style="text-align: center; margin-top: 10px;">
      <button class="btnGhost" id="backToIntro">‚Üê –û–±—Ä–∞—Ç–Ω–æ</button>
    </div>
  </section>

  <!-- Fullscreen Preview Overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="ovTop">
      <button class="ovClose" id="ovClose">‚úï</button>
    </div>
    <div class="ovBody">
      <div class="ovImgWrap">
        <img id="ovImg" alt="–ü—Ä–µ–≥–ª–µ–¥" />
      </div>
    </div>
    <div class="ovBottom">
      <button class="btnBack" id="ovBack">–û—Ç–∫–∞–∑</button>
      <button class="btnSelect" id="ovSelect">–¢–æ–≤–∞ –µ –º–æ—è—Ç –∏–∑–±–æ—Ä</button>
    </div>
  </div>

  <!-- Screen 3: Result -->
  <section class="screen" id="s3">
    <div id="result" class="fade-in"></div>
    <div class="actions">
      <button class="btn" id="saveResultBtn" style="display: none;">–ó–∞–ø–∞–∑–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞</button>
      <button class="btn" id="again">–ù–∞–ø—Ä–∞–≤–∏ —Ç–µ—Å—Ç–∞ –æ—Ç–Ω–æ–≤–æ</button>
      <button class="btnSmall" id="toGrid">–í–∏–∂ –≤—Å–∏—á–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏</button>
    </div>
  </section>

<script>
  // ---------------- CONFIG ----------------
  const IMG_EXT = "jpg"; 

  // –ü—Ä–µ—Ä–∞–±–æ—Ç–µ–Ω–∏ –∏ —Ö—É–º–∞–Ω–∏–∑–∏—Ä–∞–Ω–∏ —Ç–µ–∫—Å—Ç–æ–≤–µ
    // –ü—Ä–µ—Ä–∞–±–æ—Ç–µ–Ω–∏ –∏ —Ö—É–º–∞–Ω–∏–∑–∏—Ä–∞–Ω–∏ —Ç–µ–∫—Å—Ç–æ–≤–µ
  const profiles = {
    "01": {
      name: "–¢–∏–ø 1: –ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç—ä—Ç",
      short: "–°—Ç—Ä–µ–º–µ–∂ –∫—ä–º –∫–æ–Ω—Ç—Ä–æ–ª –∏ —Å—Ç—Ä–æ–≥–∏ –ø—Ä–∞–≤–∏–ª–∞.",
      psycho: [
        "–°—Ç—Ä–µ–º–µ–∂ –∫—ä–º –∫–æ–Ω—Ç—Ä–æ–ª –∏ —Å—Ç—Ä–æ–≥–∏ –ø—Ä–∞–≤–∏–ª–∞",
        "–î–µ–ª–µ–Ω–∏–µ –Ω–∞ —Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞ –ø–æ–∑–≤–æ–ª–µ–Ω–∏ –∏ –∑–∞–±—Ä–∞–Ω–µ–Ω–∏",
        "–í–∏–Ω–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç –∫—ä–º —Å–∫—Ä–∏—Ç–æ –ø—Ä–µ—è–∂–¥–∞–Ω–µ"
      ],
      habits: [
        "–ü–æ—Å—Ç–æ—è–Ω–Ω–æ –Ω–∞–ø—Ä–µ–∂–µ–Ω–∏–µ –æ–∫–æ–ª–æ —Ö—Ä–∞–Ω–∞—Ç–∞",
        "–ó–∞–≥—É–±–∞ –Ω–∞ —É—Å–µ—â–∞–Ω–µ –∑–∞ –≥–ª–∞–¥ –∏ —Å–∏—Ç–æ—Å—Ç",
        "–°—Ä–∏–≤–æ–≤–µ —Å–ª–µ–¥ –¥—ä–ª–≥–∏ –ø–µ—Ä–∏–æ–¥–∏ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª",
        "–†–∏—Å–∫ –æ—Ç —Ö—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ —Ä–∞–∑—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ —Å—Ç—Ä–µ—Å"
      ],
      risks: [
        "3 –æ—Å–Ω–æ–≤–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª—é—Å 1‚Äì2 –º–∞–ª–∫–∏",
        "–ù—è–º–∞ –∑–∞–±—Ä–∞–Ω–µ–Ω–∏ —Ö—Ä–∞–Ω–∏, –∏–º–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ",
        "–°—ä–∑–Ω–∞—Ç–µ–ª–Ω–æ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –≥—ä–≤–∫–∞–≤–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "–§–æ–∫—É—Å –≤—ä—Ä—Ö—É –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ, –Ω–µ —Å—ä–≤—ä—Ä—à–µ–Ω—Å—Ç–≤–æ"
      ],
      mind: [
        "–ü—Ä–∏–µ–º–∏, —á–µ –≥—Ä–µ—à–∫–∏—Ç–µ –Ω–µ —Ä–∞–∑—Ä—É—à–∞–≤–∞—Ç –Ω–∞–ø—Ä–µ–¥—ä–∫–∞",
        "–ó–∞–º–µ–Ω–∏ —Ç—Ä—è–±–≤–∞ —Å –∏–∑–±–∏—Ä–∞–º",
        "–†–∞–±–æ—Ç–∏ —Å –∏–¥–µ—è—Ç–∞ –∑–∞ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –¥–æ–±—Ä–æ, –Ω–µ –ø–µ—Ä—Ñ–µ–∫—Ç–Ω–æ"
      ]
    },
    "02": {
      name: "–¢–∏–ø 2: –ï–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∏—è—Ç",
      short: "–•—Ä–∞–Ω–∞—Ç–∞ –∫–∞—Ç–æ —É—Ç–µ—Ö–∞ –∏ –ø—Ä–µ–≥—Ä—ä–¥–∫–∞.",
      psycho: [
        "–•—Ä–∞–Ω–µ–Ω–µ –ø—Ä–∏ —Å—Ç—Ä–µ—Å, —Ç—ä–≥–∞ –∏–ª–∏ —Å–∞–º–æ—Ç–∞",
        "–¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∏ —Ö—Ä–∞–Ω–∏",
        "–í–∏–Ω–∞ —Å–ª–µ–¥ —è–¥–µ–Ω–µ"
      ],
      habits: [
        "–ü–æ–∫–∞—á–≤–∞–Ω–µ –Ω–∞ —Ç–µ–≥–ª–æ",
        "–ù–∏—Å–∫–∞ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∞",
        "–ó–∞–º–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ –µ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∏ –Ω—É–∂–¥–∏ —Å —Ö—Ä–∞–Ω–∞",
        "–ó–∞–≥—É–±–∞ –Ω–∞ –≤—Ä—ä–∑–∫–∞ —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏—è –≥–ª–∞–¥"
      ],
      risks: [
        "–†–µ–¥–æ–≤–Ω–∏ –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–∞–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "–ü–æ–≤–µ—á–µ –ø—Ä–æ—Ç–µ–∏–Ω –∏ —Ñ–∏–±—Ä–∏",
        "–ü–∞—É–∑–∞ –ø—Ä–µ–¥–∏ —Ö—Ä–∞–Ω–µ–Ω–µ",
        "–û—Å—ä–∑–Ω–∞—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–µ –±–µ–∑ –±—ä—Ä–∑–∞–Ω–µ"
      ],
      mind: [
        "–ù–∞–∑–æ–≤–∞–≤–∞–π –µ–º–æ—Ü–∏—è—Ç–∞ –ø—Ä–µ–¥–∏ –¥–∞ —è–¥–µ—à",
        "–¢—ä—Ä—Å–∏ –∏ –¥—Ä—É–≥–∏ —Ñ–æ—Ä–º–∏ –Ω–∞ —É—Å–ø–æ–∫–æ–µ–Ω–∏–µ",
        "–ü—Ä–∏–µ–º–∏, —á–µ –µ–º–æ—Ü–∏–∏—Ç–µ –Ω–µ —Å–∞ –ø—Ä–æ–±–ª–µ–º –∑–∞ –ø–æ–ø—Ä–∞–≤—è–Ω–µ"
      ]
    },
    "03": {
      name: "–¢–∏–ø 3: –¢—ä—Ä—Å–∞—á—ä—Ç –Ω–∞ —É–¥–æ–≤–æ–ª—Å—Ç–≤–∏–µ",
      short: "–ò–º–ø—É–ª—Å–∏–≤–Ω–æ—Å—Ç –∏ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ —Å—Ç–∏–º—É–ª–∏.",
      psycho: [
        "–ò–º–ø—É–ª—Å–∏–≤–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–µ",
        "–Ø–¥–µ–Ω–µ –∑–∞—Ä–∞–¥–∏ –≤–∫—É—Å –∏ —Å—Ç–∏–º—É–ª–∏",
        "–¢—Ä—É–¥–Ω–æ —Å–ø–∏—Ä–∞–Ω–µ"
      ],
      habits: [
        "–ß–µ—Å—Ç–æ –ø–æ—Ö–∞–ø–≤–∞–Ω–µ",
        "–ü—Ä–µ—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ –Ω–∞ —Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞–Ω–µ—Ç–æ",
        "–¢—Ä—É–¥–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª –Ω–∞ —Ç–µ–≥–ª–æ—Ç–æ",
        "–ù–∞–º–∞–ª–µ–Ω–æ —É—Å–µ—â–∞–Ω–µ –∑–∞ —Å–∏—Ç–æ—Å—Ç"
      ],
      risks: [
        "–ü–æ-–≥–æ–ª–µ–º–∏ –∏ –ø–æ-—Ä–µ–¥–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "–ü–ª–∞–Ω–∏—Ä–∞–Ω–∏ —É–¥–æ–≤–æ–ª—Å—Ç–≤–∏—è",
        "–•—Ä–∞–Ω–µ–Ω–µ –±–µ–∑ –µ–∫—Ä–∞–Ω–∏",
        "–Ø—Å–Ω–∏ –≥—Ä–∞–Ω–∏—Ü–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
      ],
      mind: [
        "–ó–∞–±–∞–≤—è–π —Ç–µ–º–ø–æ—Ç–æ –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–µ",
        "–£–¥–æ–≤–æ–ª—Å—Ç–≤–∏–µ—Ç–æ –¥–∞ –µ —Å—ä–∑–Ω–∞—Ç–µ–ª–Ω–æ",
        "–†–∞–∑–≥—Ä–∞–Ω–∏—á–∞–≤–∞–π –∏–º–ø—É–ª—Å –æ—Ç –Ω—É–∂–¥–∞"
      ]
    },
    "04": {
      name: "–¢–∏–ø 4: –†–∞–∑—Å–µ—è–Ω–∏—è—Ç",
      short: "–•—Ä–∞–Ω–µ–Ω–µ –±–µ–∑ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –±–µ–∑ —Ä–∏—Ç—ä–º.",
      psycho: [
        "–ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "–ö—ä—Å–Ω–æ –∏ –æ–±–∏–ª–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–µ",
        "–Ø–¥–µ–Ω–µ –±–µ–∑ –≤–Ω–∏–º–∞–Ω–∏–µ"
      ],
      habits: [
        "–ù–µ—Å—Ç–∞–±–∏–ª–Ω–∞ –µ–Ω–µ—Ä–≥–∏—è",
        "–í–µ—á–µ—Ä–Ω–æ –ø—Ä–µ—è–∂–¥–∞–Ω–µ",
        "–°—Ç–æ–º–∞—à–µ–Ω –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç",
        "–•—Ä–æ–Ω–∏—á–Ω–∞ —É–º–æ—Ä–∞"
      ],
      risks: [
        "–ú–∏–Ω–∏–º—É–º 3 –æ–ø–æ—Ä–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "–ù–∞–ø–æ–º–Ω—è–Ω–∏—è –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–µ",
        "–õ–µ—Å–Ω–∏ —Ö—Ä–∞–Ω–∏ –ø–æ–¥ —Ä—ä–∫–∞",
        "–ü–æ-–ª–µ–∫–∞ –≤–µ—á–µ—Ä—è"
      ],
      mind: [
        "–°–≤—ä—Ä–∑–≤–∞–π —Ö—Ä–∞–Ω–µ–Ω–µ—Ç–æ —Å –µ–∂–µ–¥–Ω–µ–≤–Ω–∏ –Ω–∞–≤–∏—Ü–∏",
        "–û—Ç–Ω–∞—Å—è–π —Å–µ –∫—ä–º —Ç—è–ª–æ—Ç–æ –∫–∞—Ç–æ –∫—ä–º —Ä–µ—Å—É—Ä—Å",
        "–ù–µ —á–∞–∫–∞–π —Å–∏–ª–µ–Ω –≥–ª–∞–¥"
      ]
    },
    "05": {
      name: "–¢–∏–ø 5: –í—Å–∏—á–∫–æ –∏–ª–∏ –Ω–∏—â–æ",
      short: "–ö—Ä–∞–π–Ω–æ—Å—Ç–∏ –∏ —Å—Ä–∏–≤ –ø—Ä–∏ –º–∞–ª–∫–∞ –≥—Ä–µ—à–∫–∞.",
      psycho: [
        "–°—Ç—Ä–æ–≥–∏ —Ä–µ–∂–∏–º–∏",
        "–°—Ä–∏–≤ –ø—Ä–∏ –º–∞–ª–∫–∞ –≥—Ä–µ—à–∫–∞",
        "–ö–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ"
      ],
      habits: [
        "–ô–æ-–π–æ –µ—Ñ–µ–∫—Ç",
        "–ó–∞–≥—É–±–∞ –Ω–∞ –¥–æ–≤–µ—Ä–∏–µ –≤ —Å–µ–±–µ —Å–∏",
        "–°–∏–ª–µ–Ω –≤—ä—Ç—Ä–µ—à–µ–Ω –Ω–∞—Ç–∏—Å–∫",
        "–†–∏—Å–∫ –æ—Ç —Ö—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ —Ä–∞–∑—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
      ],
      risks: [
        "–ë–µ–∑ –∑–∞–±—Ä–∞–Ω–∏",
        "–ü–ª–∞–Ω–∏—Ä–∞–Ω–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è",
        "–§–æ–∫—É—Å –≤—ä—Ä—Ö—É —Å–µ–¥–º–∏—á–Ω–∏—è –±–∞–ª–∞–Ω—Å",
        "–ë–µ–∑ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏"
      ],
      mind: [
        "–ó–∞–º–µ–Ω–∏ –∫—Ä–∞–π–Ω–æ—Å—Ç–∏—Ç–µ —Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ—Å—Ç",
        "–ï–¥–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è —Ä–µ–∑—É–ª—Ç–∞—Ç–∞",
        "–ú–∏—Å–ª–∏ –≤ –¥—ä–ª–≥–æ—Å—Ä–æ—á–µ–Ω –ø–ª–∞–Ω"
      ]
    },
    "06": {
      name: "–¢–∏–ø 6: –°–æ—Ü–∏–∞–ª–Ω–∏—è—Ç",
      short: "–•—Ä–∞–Ω–µ–Ω–µ –∑–∞ –∫–æ–º–ø–∞–Ω–∏—è –∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç –¥–∞ –∫–∞–∑–≤–∞—à –Ω–µ.",
      psycho: [
        "–•—Ä–∞–Ω–µ–Ω–µ –∑–∞ –∫–æ–º–ø–∞–Ω–∏—è",
        "–¢—Ä—É–¥–Ω–æ—Å—Ç –¥–∞ –∫–∞–∑–≤–∞—à –Ω–µ",
        "–ó–∞–≥—É–±–∞ –Ω–∞ –ª–∏—á–µ–Ω –∏–∑–±–æ—Ä"
      ],
      habits: [
        "–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ–∫–∞—á–≤–∞–Ω–µ –Ω–∞ —Ç–µ–≥–ª–æ",
        "–í—ä—Ç—Ä–µ—à–Ω–æ –Ω–µ–¥–æ–≤–æ–ª—Å—Ç–≤–æ",
        "–í–∏–Ω–∞ —Å–ª–µ–¥ —Å—ä–±–∏—Ä–∞–Ω–∏—è"
      ],
      risks: [
        "–ú–∞–ª–∫–∞ —Ö—Ä–∞–Ω–∞ –ø—Ä–µ–¥–∏ —Å—ä–±–∏—Ç–∏—è",
        "–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ",
        "–ü–æ-–±–∞–≤–µ–Ω —Ä–∏—Ç—ä–º –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–µ"
      ],
      mind: [
        "–ì—Ä–∞–Ω–∏—Ü–∏—Ç–µ –Ω–µ —Å–∞ –æ—Ç–∫–∞–∑ –æ—Ç —Ö–æ—Ä–∞—Ç–∞",
        "–ù–µ –µ –Ω—É–∂–Ω–æ –¥–∞ –æ–±—è—Å–Ω—è–≤–∞—à –∏–∑–±–æ—Ä–∞ —Å–∏",
        "–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–∞–π —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Ç–æ —Å–∏ —Ç—è–ª–æ"
      ]
    },
    "07": {
      name: "–¢–∏–ø 7: –¢—Ä–µ–≤–æ–∂–Ω–∏—è—Ç",
      short: "–°—Ç—Ä–∞—Ö –æ—Ç –≥—Ä–µ—à–∫–∞ –∏ –ø—Ä–µ–∫–æ–º–µ—Ä–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª.",
      psycho: [
        "–°—Ç—Ä–∞—Ö –æ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª–Ω–∞ —Ö—Ä–∞–Ω–∞",
        "–û–≥—Ä–∞–Ω–∏—á–∞–≤–∞–Ω–µ –Ω–∞ —Ü–µ–ª–∏ –≥—Ä—É–ø–∏ —Ö—Ä–∞–Ω–∏",
        "–ü—Ä–µ–∫–æ–º–µ—Ä–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª"
      ],
      habits: [
        "–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∏",
        "–°–æ—Ü–∏–∞–ª–Ω–∞ –∏–∑–æ–ª–∞—Ü–∏—è",
        "–ü–æ–≤–∏—à–µ–Ω–∞ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç",
        "–õ–∏–ø—Å–∞ –Ω–∞ —É–¥–æ–≤–æ–ª—Å—Ç–≤–∏–µ"
      ],
      risks: [
        "–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞–∑—à–∏—Ä—è–≤–∞–Ω–µ –Ω–∞ –º–µ–Ω—é—Ç–æ",
        "–ü–æ-–ø—Ä–æ—Å—Ç–∏ —è—Å—Ç–∏—è",
        "–•—Ä–∞–Ω–µ–Ω–µ –∏–∑–≤—ä–Ω –¥–æ–º–∞ –æ—Ç –≤—Ä–µ–º–µ –Ω–∞ –≤—Ä–µ–º–µ"
      ],
      mind: [
        "–†–∞–±–æ—Ç–∏ —Å—ä—Å —Å—Ç—Ä–∞—Ö–∞, –Ω–µ —Å —Ö—Ä–∞–Ω–∞—Ç–∞",
        "–ó–¥—Ä–∞–≤–µ—Ç–æ –µ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç, –Ω–µ —á–∏—Å—Ç–æ—Ç–∞",
        "–ü—Ä–∏–µ–º–∏ –Ω–µ—Å—ä–≤—ä—Ä—à–µ–Ω—Å—Ç–≤–æ—Ç–æ"
      ]
    },
    "08": {
      name: "–¢–∏–ø 8: –ù–æ—â–Ω–∞—Ç–∞ –ø—Ç–∏—Ü–∞",
      short: "–ö—ä—Å–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–µ –∏ –∏–∑–º–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ä–∏—Ç—ä–º–∞.",
      psycho: [
        "–ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–µ –ø—Ä–µ–∑ –¥–µ–Ω—è",
        "–ö—ä—Å–Ω–æ –∏ –æ–±–∏–ª–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–µ",
        "–Ø–¥–µ–Ω–µ –ø—Ä–µ–¥ –µ–∫—Ä–∞–Ω–∏"
      ],
      habits: [
        "–õ–æ—à —Å—ä–Ω",
        "–•—Ä–æ–Ω–∏—á–Ω–∞ —É–º–æ—Ä–∞",
        "–ó–∞–±–∞–≤–µ–Ω –º–µ—Ç–∞–±–æ–ª–∏–∑—ä–º",
        "–¢—Ä—É–¥–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª –Ω–∞ —Ç–µ–≥–ª–æ—Ç–æ"
      ],
      risks: [
        "–†–µ–∞–ª–Ω–∞, –º–∞–∫–∞—Ä –∏ –º–∞–ª–∫–∞ –∑–∞–∫—É—Å–∫–∞",
        "–ü–æ-–≥–æ–ª—è–º –æ–±—è–¥",
        "–ü–æ-–ª–µ–∫–∞ –≤–µ—á–µ—Ä—è",
        "–û–≥—Ä–∞–Ω–∏—á–∞–≤–∞–Ω–µ –Ω–∞ –∫—ä—Å–Ω–æ—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–µ"
      ],
      mind: [
        "–ù–µ –æ—Ç–ª–∞–≥–∞–π –Ω—É–∂–¥–∏—Ç–µ —Å–∏ –∑–∞ –≤–µ—á–µ—Ä—Ç–∞",
        "–•—Ä–∞–Ω–∞—Ç–∞ –Ω–µ –µ –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –æ—Ü–µ–ª—è–≤–∞–Ω–µ",
        "–î–µ–Ω—è—Ç –æ–ø—Ä–µ–¥–µ–ª—è —Ä–∏—Ç—ä–º–∞ –Ω–∞ —Ç—è–ª–æ—Ç–æ"
      ]
    }
  };

  // ---------------- UI LOGIC ----------------
  const s1 = document.getElementById("s1");
  const s2 = document.getElementById("s2");
  const s3 = document.getElementById("s3");
  const grid = document.getElementById("grid");
  const overlay = document.getElementById("overlay");
  const ovImg = document.getElementById("ovImg");
  const ovClose = document.getElementById("ovClose");
  const ovBack = document.getElementById("ovBack");
  const ovSelect = document.getElementById("ovSelect");
  const result = document.getElementById("result");

  let pendingId = null;
  let pendingSrc = null;

  // Scroll to top helper
  const scrollToTop = () => window.scrollTo({top: 0, behavior: 'smooth'});

  function show(screen){
    [s1,s2,s3].forEach(x=>x.classList.remove("active"));
    screen.classList.add("active");
    scrollToTop();
  }

  document.getElementById("start").addEventListener("click", ()=>show(s2));
  document.getElementById("backToIntro").addEventListener("click", ()=>show(s1));
  document.getElementById("again").addEventListener("click", ()=>{
    // –°–∫—Ä–∏–≤–∞–º–µ –±—É—Ç–æ–Ω–∞ "–ó–∞–ø–∞–∑–∏" –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω –æ–ø–∏—Ç
    const saveBtn = document.getElementById('saveResultBtn');
    if (saveBtn) {
      saveBtn.style.display = 'none';
    }
    show(s2);
  });
  document.getElementById("toGrid").addEventListener("click", ()=>show(s2));
  
  // –°—ä–±–∏—Ç–∏–µ –∑–∞ –±—É—Ç–æ–Ω–∞ "–ó–∞–ø–∞–∑–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞"
  document.getElementById("saveResultBtn").addEventListener("click", async ()=>{
    // Set flag to keep accordion open when returning to profile
    sessionStorage.setItem('openPsychTestDetails', 'true');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ pendingId
    if(!pendingId || !profiles[pendingId]) {
      console.error('Invalid profile ID:', pendingId);
      showSaveStatus('error', '–ì—Ä–µ—à–∫–∞: –ù–µ–≤–∞–ª–∏–¥–µ–Ω –ø—Ä–æ—Ñ–∏–ª. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ —Ç–µ—Å—Ç–∞.');
      return;
    }
    
    const saveBtn = document.getElementById('saveResultBtn');
    const originalText = saveBtn.textContent;
    
    // –ü–æ–∫–∞–∑–≤–∞–º–µ –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
    saveBtn.textContent = '–ó–∞–ø–∞–∑–≤–∞–Ω–µ...';
    saveBtn.disabled = true;
    
    try {
      await saveVisualTestResult(pendingId);
    } finally {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }
  });

  // Build grid
  const ids = ["01","02","03","04","05","06","07","08"];
  
  // –†–∞–∑–±—ä—Ä–∫–≤–∞–Ω–µ –Ω–∞ –º–∞—Å–∏–≤–∞, –∑–∞ –¥–∞ –Ω–µ —Å–∞ –≤–∏–Ω–∞–≥–∏ –≤ –µ–¥–∏–Ω —Ä–µ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ, —Ç—É–∫ –µ –∏–∑–∫–ª—é—á–µ–Ω–æ –∑–∞ —Å–µ–≥–∞)
  // ids.sort(() => Math.random() - 0.5);

  ids.forEach(id=>{
    const btn = document.createElement("button");
    btn.className = "thumb";
    btn.type = "button";
    
    const img = document.createElement("img");
    img.src = `${id}.${IMG_EXT}`;
    img.alt = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${id}`;
    
    btn.appendChild(img);

    btn.addEventListener("click", ()=>{
      pendingId = id;
      pendingSrc = img.src;
      ovImg.src = img.src;
      openOverlay();
    });

    grid.appendChild(btn);
  });

  function openOverlay(){
    overlay.classList.add("active");
    overlay.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden"; // Stop background scrolling
  }
  
  function closeOverlay(){
    overlay.classList.remove("active");
    overlay.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }

  ovClose.addEventListener("click", closeOverlay);
  ovBack.addEventListener("click", closeOverlay);
  
  // Close on background click
  overlay.addEventListener("click", (e)=>{
    if(e.target === overlay || e.target.classList.contains('ovTop')) closeOverlay();
  });

  // –ò–∑–±–æ—Ä –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –ø–æ–∫–∞–∑–≤–∞–º–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ
  // –ó–∞–ø–∞–∑–≤–∞–Ω–µ—Ç–æ —Å–µ —Å–ª—É—á–≤–∞ —Å–∞–º–æ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–µ –Ω–∞ –±—É—Ç–æ–Ω–∞ "–ó–∞–ø–∞–∑–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞"
  ovSelect.addEventListener("click", ()=>{
    if(!pendingId) return;
    closeOverlay();
    renderResult(pendingId, pendingSrc);
    show(s3);
  });

  function renderResult(id, src){
    const p = profiles[id];
    if(!p) return;

    // –ü–æ–∫–∞–∑–≤–∞–º–µ –±—É—Ç–æ–Ω–∞ "–ó–∞–ø–∞–∑–∏"
    const saveBtn = document.getElementById('saveResultBtn');
    if (saveBtn) {
      saveBtn.style.display = 'block';
    }

    // Helper for lists
    const makeList = (items, isRisk) => `
      <ul class="clean">
        ${items.map(text => `
          <li>
            <span class="icon ${isRisk?'icon-warn':''}">‚óè</span>
            <span>${text}</span>
          </li>
        `).join("")}
      </ul>
    `;

    result.innerHTML = `
      <div class="resultImg">
        <img src="${src}" alt="–ò–∑–±–æ—Ä">
      </div>

      <div class="h2">${p.name}</div>
      <div class="sub">${p.short}</div>

      <span class="section-title">–ü—Ä–æ—Ñ–∏–ª –∏ —Ä–∏—Å–∫–æ–≤–∏ —Ö—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –Ω–∞–≤–∏—Ü–∏</span>
      <div class="card">
        ${makeList(p.psycho, false)}
      </div>

      <span class="section-title">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª–Ω–∏ –≤—Ä–µ–¥–Ω–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è</span>
      <div class="card">
        ${makeList(p.habits, false)}
      </div>

      <span class="section-title">–ü—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–µ</span>
      <div class="card">
        ${makeList(p.risks, false)}
      </div>

       <span class="section-title">–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</span>
       <div class="card">
         ${makeList(p.mind || [], false)}
       </div>

      
      <div id="saveStatusMessage" style="margin-top: 20px;"></div>
    `;
  }
  
  // –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –æ—Ç –≤–∏–∑—É–∞–ª–Ω–∏—è —Ç–µ—Å—Ç
  async function saveVisualTestResult(profileId) {
    try {
      const profile = profiles[profileId];
      if (!profile) {
        showSaveStatus('error', '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞');
        return;
      }
      
      const timestamp = new Date().toISOString();
      
      // –û–±–æ–≥–∞—Ç–µ–Ω–∞ –≤–µ—Ä—Å–∏—è —Å—ä—Å —Å—ä–¥—ä—Ä–∂–∞—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ AI –∞–Ω–∞–ª–∏–∑
      const visualTest = {
        id: profileId,
        name: profile.name,
        short: profile.short,
        // –ó–∞–ø–∞–∑–≤–∞–º–µ –ø—ä–ª–Ω–∏—Ç–µ –º–∞—Å–∏–≤–∏ –∑–∞ –ø–æ-–∑–∞–¥—ä–ª–±–æ—á–µ–Ω –∞–Ω–∞–ª–∏–∑
        mainPsycho: profile.psycho || [], // –í—Å–∏—á–∫–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        mainHabits: profile.habits || [], // –í—Å–∏—á–∫–∏ –Ω–∞–≤–∏—Ü–∏
        mainRisks: profile.risks || [], // –í—Å–∏—á–∫–∏ —Ä–∏—Å–∫–æ–≤–µ
        mainMind: profile.mind || [], // –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏
        // –î–æ–±–∞–≤—è–º–µ –æ–±–æ–±—â–µ–Ω–∏–µ –∑–∞ –±—ä—Ä–∑ –ø—Ä–µ–≥–ª–µ–¥ (handle empty short gracefully)
        summary: profile.short ? `${profile.name} - ${profile.short}` : profile.name,
        timestamp: timestamp
      };
      
      // –ó–∞–ø–∞–∑–≤–∞–Ω–µ –≤ localStorage (–≤–∏–Ω–∞–≥–∏)
      const existingData = JSON.parse(localStorage.getItem('psychTests') || '{}');
      existingData.visualTest = visualTest;
      localStorage.setItem('psychTests', JSON.stringify(existingData));
      console.log('[VISUAL TEST] –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –≤ localStorage:', visualTest);
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Ç–µ—Å—Ç–∞ –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –æ—Ç –ø—Ä–æ—Ñ–∏–ª–∞
      const urlParams = new URLSearchParams(window.location.search);
      const fromProfile = urlParams.get('from') === 'profile';
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ userId
      const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
      
      if (!userId) {
        console.warn('[VISUAL TEST] –ù—è–º–∞ userId - –ø–æ–∫–∞–∑–≤–∞ —Å–µ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è');
        if (fromProfile) {
          // –ê–∫–æ —Ç–µ—Å—Ç–∞ –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –æ—Ç –ø—Ä–æ—Ñ–∏–ª–∞, –Ω–æ –Ω—è–º–∞ userId - –Ω–µ—â–æ –Ω–µ –µ –Ω–∞—Ä–µ–¥
          showSaveStatus('error', '–ì—Ä–µ—à–∫–∞: –ù–µ —Å—Ç–µ –≤–ª–µ–∑–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞. –ú–æ–ª—è —Ä–µ—Ñ—Ä–µ—à–Ω–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.');
        } else {
          // –ê–∫–æ —Ç–µ—Å—Ç–∞ –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –¥–∏—Ä–µ–∫—Ç–Ω–æ - –ø–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
          showSaveStatus('warning', '–ó–∞ –¥–∞ –∑–∞–ø–∞–∑–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏, –º–æ–ª—è –ø—ä—Ä–≤–æ <a href="../login.html" style="color: inherit; text-decoration: underline;">–≤–ª–µ–∑—Ç–µ –≤ –∞–∫–∞—É–Ω—Ç–∞ —Å–∏</a> –∏–ª–∏ <a href="../index.html#register" style="color: inherit; text-decoration: underline;">—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π—Ç–µ</a>. –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –ª–æ–∫–∞–ª–Ω–æ –≤ –±—Ä–∞—É–∑—ä—Ä–∞.');
        }
        return;
      }
      
      // –û–ø–∏—Ç –∑–∞ backend –∑–∞–ø–∞–∑–≤–∞–Ω–µ
      console.log('[VISUAL TEST] –û–ø–∏—Ç –∑–∞ backend –∑–∞–ø–∞–∑–≤–∞–Ω–µ –∑–∞ userId:', userId);
      const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:8787'
        : 'https://openapichatbot.radilov-k.workers.dev';
      
      const response = await fetch(`${API_BASE}/api/savePsychTests`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: userId,
          visualTest: visualTest
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      console.log('[VISUAL TEST] Backend –æ—Ç–≥–æ–≤–æ—Ä:', result);
      
      if (result.success) {
        console.log('[VISUAL TEST] ‚úì –£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –≤ backend');
        localStorage.setItem('psychTestsLastSync', timestamp);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å–µ –ø—Ä–µ–ø–æ—Ä—ä—á–≤–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–ª–∞–Ω–∞
        if (result.data && result.data.shouldRegeneratePlan) {
          const reason = result.data.regenerationReason || '–ü—Ä–µ–ø–æ—Ä—ä—á–≤–∞–º–µ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–ª–∞–Ω–∞ –∑–∞ –ø—ä–ª–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞ –ø—Å–∏—Ö–æ–ø—Ä–æ—Ñ–∏–ª–∞.';
          showSaveStatus('success', `
            <div style="margin-bottom: 12px;">‚úì –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ –≤–∏!</div>
            <div style="background: rgba(255, 193, 7, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 3px solid #ffc107;">
              <strong>üí° –ü—Ä–µ–ø–æ—Ä—ä–∫–∞:</strong> ${reason}
              <div style="margin-top: 8px;">
                <a href="../code.html#profile-tab" style="color: #22c55e; text-decoration: underline; font-weight: 600;" onclick="sessionStorage.setItem('openPsychTestDetails', 'true');">
                  –û—Ç–∏–¥–µ—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ ‚Üí –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–∞–π—Ç–µ –ø–ª–∞–Ω–∞
                </a>
              </div>
            </div>
          `);
        } else {
          showSaveStatus('success', '–†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ –≤–∏! <a href="../code.html#profile-tab" style="color: inherit; text-decoration: underline;" onclick="sessionStorage.setItem(\'openPsychTestDetails\', \'true\');">–í–∏–∂—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏ —Ç—É–∫</a>.');
        }
      } else {
        console.error('[VISUAL TEST] Backend –≥—Ä–µ—à–∫–∞:', result.message);
        showSaveStatus('warning', `–†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –ª–æ–∫–∞–ª–Ω–æ. Backend –≥—Ä–µ—à–∫–∞: ${result.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –≥—Ä–µ—à–∫–∞'}`);
      }
    } catch (error) {
      console.error('[VISUAL TEST] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ:', error);
      showSaveStatus('error', `–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ: ${error.message}. –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –ª–æ–∫–∞–ª–Ω–æ.`);
    }
  }
  
  function showSaveStatus(status, message) {
    const messageDiv = document.getElementById('saveStatusMessage');
    if (!messageDiv) return;
    
    // –°–∫—Ä–∏–≤–∞–º–µ –±—É—Ç–æ–Ω–∞ "–ó–∞–ø–∞–∑–∏" —Å–∞–º–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ
    const saveBtn = document.getElementById('saveResultBtn');
    if (saveBtn && status === 'success') {
      saveBtn.style.display = 'none';
    }
    
    let bgColor, borderColor, iconColor, icon, textColor;
    
    if (status === 'success') {
      bgColor = '#d4edda';
      borderColor = '#c3e6cb';
      textColor = '#155724';
      icon = '‚úì';
      iconColor = '#28a745';
    } else if (status === 'warning') {
      bgColor = '#fff3cd';
      borderColor = '#ffeaa7';
      textColor = '#856404';
      icon = '‚ö†';
      iconColor = '#ffc107';
    } else { // error
      bgColor = '#f8d7da';
      borderColor = '#f5c6cb';
      textColor = '#721c24';
      icon = '‚úï';
      iconColor = '#dc3545';
    }
    
    messageDiv.innerHTML = `
      <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 16px; padding: 20px; text-align: center;">
        <div style="font-size: 20px; margin-bottom: 10px; color: ${iconColor};">${icon}</div>
        <div style="font-weight: 700; color: ${textColor}; margin-bottom: ${message ? '10px' : '0'}; font-size: 16px;">
          ${status === 'success' ? '–£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ!' : status === 'warning' ? '–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ' : '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ'}
        </div>
        ${message ? `<div style="font-size: 14px; color: ${textColor}; line-height: 1.5;">${message}</div>` : ''}
      </div>
    `;
  }
</script>
</body>
</html>
