<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Текст-към-Говор със Speechify</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 1rem;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #555;
        }
        select, input[type="range"] {
            padding: 0.5rem;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 1rem;
        }
        .buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        button {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #3498db;
            color: white;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        button#playBtn:hover:not(:disabled) { background-color: #2980b9; }
        button#pauseBtn { background-color: #f39c12; }
        button#pauseBtn:hover:not(:disabled) { background-color: #e67e22; }
        button#stopBtn { background-color: #e74c3c; }
        button#stopBtn:hover:not(:disabled) { background-color: #c0392b; }
        .status {
            text-align: center;
            margin-top: 1.5rem;
            font-style: italic;
            color: #7f8c8d;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Текст-към-Говор (Български)</h1>
        
        <textarea id="text-input" placeholder="Въведете или поставете текст на български тук..."></textarea>
        
        <div class="controls">
            <div class="control-group">
                <label for="voice-select">Избор на глас:</label>
                <select id="voice-select">
                    <option value="Borislav" selected>Борислав (Мъж)</option>
                    <option value="Daria">Дария (Жена)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="speed-control">Скорост: <span id="speed-value">1</span>x</label>
                <input type="range" id="speed-control" min="0.5" max="2.0" step="0.1" value="1">
            </div>
        </div>

        <div class="buttons">
            <button id="playBtn">Чети</button>
            <button id="pauseBtn" disabled>Пауза</button>
            <button id="stopBtn" disabled>Стоп</button>
        </div>

        <div class="status" id="status-message">Готово за работа</div>
    </div>

    <script>
        // Елементи от страницата
        const textInput = document.getElementById('text-input');
        const voiceSelect = document.getElementById('voice-select');
        const speedControl = document.getElementById('speed-control');
        const speedValue = document.getElementById('speed-value');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusMessage = document.getElementById('status-message');

        // ! ЗАМЕНЕТЕ С ВАШИЯ КЛЮЧ
        const SPEECHIFY_API_KEY = "IKGd6Cw6YQz5IGLdv31Ng_rZTuOuDbQM6paQxteZTH8=";
        
        let audio = null;
        let audioContext;
        let audioSource;

        // Показва стойността на скоростта
        speedControl.addEventListener('input', () => {
            speedValue.textContent = parseFloat(speedControl.value).toFixed(1);
        });

        // Функция за управление на състоянието на бутоните
        function setButtonState(isPlaying, isPaused = false) {
            playBtn.disabled = isPlaying;
            pauseBtn.disabled = !isPlaying;
            stopBtn.disabled = !isPlaying && !isPaused;
            if (isPaused) {
                pauseBtn.textContent = 'Продължи';
            } else {
                pauseBtn.textContent = 'Пауза';
            }
        }

        playBtn.addEventListener('click', async () => {
            const text = textInput.value.trim();
            if (!text) {
                alert('Моля, въведете текст.');
                return;
            }

            if (audio && audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
                audio.play();
                statusMessage.textContent = 'Продължава...';
                setButtonState(true);
                return;
            }
            
            if (audio) {
                audio.pause();
                audio = null;
            }

            statusMessage.textContent = 'Генерира се аудио... Моля, изчакайте.';
            setButtonState(true);

            try {
                const response = await fetch('https://api.speechify.com/v1/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SPEECHIFY_API_KEY}`
                    },
                    body: JSON.stringify({
                        text: text,
                        voice: {
                            name: voiceSelect.value,
                            language: 'bg-BG', // Код за български език
                            engine: 'standard' // или 'neural' ако е налично
                        },
                        format: 'mp3',
                        speed: parseFloat(speedControl.value)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Грешка от API: ${errorData.message || response.statusText}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                audio = new Audio(audioUrl);
                
                audio.onplaying = () => {
                    statusMessage.textContent = 'Просвирване...';
                    setButtonState(true);
                };

                audio.onpause = () => {
                    if (audio && audio.duration > audio.currentTime) {
                         statusMessage.textContent = 'Пауза.';
                         setButtonState(true, true); // isPlaying=true, isPaused=true
                    }
                };
                
                audio.onended = () => {
                    statusMessage.textContent = 'Готово.';
                    setButtonState(false);
                    URL.revokeObjectURL(audioUrl); // Освобождаване на паметта
                };
                
                audio.onerror = () => {
                    statusMessage.textContent = 'Грешка при просвирване на аудиото.';
                    setButtonState(false);
                };

                audio.play();

            } catch (error) {
                console.error('Грешка при заявката към Speechify:', error);
                statusMessage.textContent = `Грешка: ${error.message}`;
                setButtonState(false);
            }
        });

        pauseBtn.addEventListener('click', () => {
            if (audio) {
                if (!audio.paused) {
                    audio.pause();
                } else {
                    audio.play();
                }
            }
        });

        stopBtn.addEventListener('click', () => {
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio = null;
                statusMessage.textContent = 'Спряно. Готово за нова задача.';
                setButtonState(false);
            }
        });

        // Първоначално състояние на бутоните
        setButtonState(false);
    </script>
</body>
</html>
