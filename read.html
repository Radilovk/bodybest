<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>Текст → Говор (Speechify)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#1a1a1a;--surface:#2c2c2c;--text:#e5e7eb;--muted:#9ca3af;--border:#3b3b3b;
      --primary:#3b82f6;--primary-h:#2563eb;--ok:#22c55e;--err:#ef4444;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:720px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px}
    h1{margin:0 0 8px;font-size:22px}
    label{font-weight:600}
    textarea, select, input[type="range"]{width:100%;background:#111;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:12px}
    button{border:0;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-h)}
    .btn{background:#333;color:var(--text)}
    .btn:hover{background:#444}
    .btn-ok{background:var(--ok);color:#fff}
    .btn-ok:hover{filter:brightness(0.95)}
    #status{min-height:24px;display:flex;align-items:center;gap:8px;color:var(--muted)}
    .spin{width:18px;height:18px;border:3px solid #ffffff30;border-top-color:#fff;border-radius:50%;display:none;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #player{display:none;gap:10px;align-items:center}
    #download{display:none}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Текст → Говор</h1>

  <div class="card">
    <label for="text">Вашият текст</label>
    <textarea id="text" rows="8" placeholder="Въведете текст…"></textarea>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <span id="count" class="muted">0 символа</span>
      <div>
        <button id="import" class="btn">Импорт .txt</button>
        <input type="file" id="file" accept=".txt" hidden />
        <button id="clear" class="btn">Изчисти</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label for="voice">Глас (само български)</label>
        <select id="voice">
          <option value="">Зареждане…</option>
        </select>
        <div class="muted" id="voice-hint" style="margin-top:6px"></div>
      </div>
      <div>
        <label for="speed">Скорост: <span id="speedv">1.0</span>x</label>
        <input type="range" id="speed" min="0.5" max="2" step="0.1" value="1.0" />
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="format">Формат</label>
        <select id="format">
          <option value="mp3" selected>mp3</option>
          <option value="wav">wav</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:12px">
        <button id="play" class="btn-primary" style="flex:1">Генерирай и пусни</button>
        <button id="download" class="btn-ok">Изтегли</button>
      </div>
    </div>
  </div>

  <div class="card" id="player">
    <audio id="audio" controls style="width:100%"></audio>
  </div>

  <div id="status" class="card" style="display:flex;justify-content:space-between">
    <div style="display:flex;gap:10px;align-items:center">
      <div class="spin" id="spin"></div>
      <span id="msg">Готово.</span>
    </div>
    <span id="meta" class="muted"></span>
  </div>
</div>

<script>
const WORKER_URL = "https://read.radilov-k.workers.dev"; // смени ако е друг
const els = {
  text: document.getElementById('text'),
  count: document.getElementById('count'),
  import: document.getElementById('import'),
  file: document.getElementById('file'),
  clear: document.getElementById('clear'),
  voice: document.getElementById('voice'),
  voiceHint: document.getElementById('voice-hint'),
  speed: document.getElementById('speed'),
  speedv: document.getElementById('speedv'),
  format: document.getElementById('format'),
  play: document.getElementById('play'),
  download: document.getElementById('download'),
  player: document.getElementById('player'),
  audio: document.getElementById('audio'),
  spin: document.getElementById('spin'),
  msg: document.getElementById('msg'),
  meta: document.getElementById('meta'),
};

function setBusy(on, message){
  els.msg.textContent = message || (on ? 'Работи…' : 'Готово.');
  els.spin.style.display = on ? 'inline-block' : 'none';
  els.play.disabled = on;
}

function setError(message){
  els.msg.textContent = message;
  els.spin.style.display = 'none';
  els.play.disabled = false;
}

function charCount(){ els.count.textContent = `${els.text.value.length} символа`; }

function saveState(){
  localStorage.setItem('tts_text', els.text.value);
  localStorage.setItem('tts_speed', els.speed.value);
  localStorage.setItem('tts_format', els.format.value);
  localStorage.setItem('tts_voice_id', els.voice.value || '');
}

function loadState(){
  els.text.value = localStorage.getItem('tts_text') || '';
  els.speed.value = localStorage.getItem('tts_speed') || '1.0';
  els.format.value = localStorage.getItem('tts_format') || 'mp3';
  els.speedv.textContent = parseFloat(els.speed.value).toFixed(1);
  charCount();
}

async function loadVoices(){
  try{
    const r = await fetch(WORKER_URL + "/voices");
    if(!r.ok){ throw new Error(await r.text()); }
    const data = await r.json(); // { voices: [{id,name,language}] }
    const voices = data.voices || [];
    if(!voices.length){
      els.voice.innerHTML = `<option value="">Няма български гласове</option>`;
      els.voiceHint.textContent = 'Свържи се със Speechify за активиране на BG гласове.';
      return;
    }
    const saved = localStorage.getItem('tts_voice_id') || '';
    els.voice.innerHTML = voices.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
    if(saved && voices.some(v => v.id === saved)) els.voice.value = saved;
    els.voiceHint.textContent = `Намерени гласове: ${voices.length}`;
  }catch(err){
    els.voice.innerHTML = `<option value="">Грешка при зареждане</option>`;
    els.voiceHint.textContent = String(err);
  }
}

function resetAudio(){
  if(els.audio.src) URL.revokeObjectURL(els.audio.src);
  els.audio.removeAttribute('src');
  els.audio.load();
  els.player.style.display = 'none';
  els.download.style.display = 'none';
}

async function synth(){
  const text = els.text.value.trim();
  if(!text){ setError('Моля, въведете текст.'); return; }
  setBusy(true, 'Изпращане към сървъра…');
  resetAudio();
  try{
    const payload = {
      input: text,                                  // ← правилното поле
      voice_id: els.voice.value || undefined,       // ← ако е празно, бекендът ще вземе дефолтен BG
      audio_format: els.format.value,
      speaking_rate: parseFloat(els.speed.value)
    };

    const r = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const ct = (r.headers.get("Content-Type") || "").toLowerCase();
    els.meta.textContent = `${r.status} ${r.statusText} · ${ct}`;

    if(!r.ok || !(ct.startsWith("audio/") || ct === "application/octet-stream")){
      const txt = await r.text(); // JSON грешка от бекенда / Speechify
      setError(`TTS грешка: ${txt}`);
      return;
    }

    const blob = await r.blob();
    const url = URL.createObjectURL(blob);

    els.audio.src = url;
    els.player.style.display = 'block';
    els.download.style.display = 'inline-block';
    setBusy(false, 'Готово. Пускаме…');
    await els.audio.play();
  }catch(err){
    setError(String(err?.message || err));
  }finally{
    els.play.disabled = false;
  }
}

/* --- events --- */
document.addEventListener('DOMContentLoaded', async () => {
  loadState();
  await loadVoices();
});

els.text.addEventListener('input', () => { charCount(); saveState(); });
els.speed.addEventListener('input', () => { els.speedv.textContent = parseFloat(els.speed.value).toFixed(1); saveState(); });
els.format.addEventListener('change', saveState);
els.voice.addEventListener('change', saveState);

els.import.addEventListener('click', () => els.file.click());
els.file.addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    els.text.value = reader.result || '';
    charCount(); saveState();
  };
  reader.readAsText(f);
});

els.clear.addEventListener('click', () => {
  els.text.value = '';
  charCount(); saveState(); resetAudio();
});

els.play.addEventListener('click', synth);

els.download.addEventListener('click', () => {
  if(!els.audio.src) return;
  const a = document.createElement('a');
  a.href = els.audio.src;
  a.download = `speech_${Date.now()}.${els.format.value}`;
  document.body.appendChild(a); a.click(); a.remove();
});
</script>
</body>
</html>
