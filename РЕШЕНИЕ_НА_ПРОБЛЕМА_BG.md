# –†–µ–∑—é–º–µ –Ω–∞ –†–µ—à–µ–Ω–∏–µ—Ç–æ –Ω–∞ –ü—Ä–æ–±–ª–µ–º–∞ —Å Nutrient Lookup

## üéØ –ö–∞–∫–≤–æ –±–µ—à–µ –ø—Ä–æ–±–ª–µ–º—ä—Ç?

–ü—Ä–∏ –æ–ø–∏—Ç –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–µ—Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∞ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ç–∞ —Ö—Ä–∞–Ω–∞ –≤ extra meal –ø–æ–ª—É—á–∞–≤–∞—Ö—Ç–µ –≥—Ä–µ—à–∫–∞ 503:

```json
{
  "status": 503,
  "message": "AI —É—Å–ª—É–≥–∞—Ç–∞ –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–∞"
}
```

## üîç –ö–∞–∫–≤–æ –±–µ—à–µ –ø—Ä–∏—á–∏–Ω–∞—Ç–∞?

–ú–æ–¥—É–ª—ä—Ç `nutrient-lookup` –±–µ—à–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–∞–Ω –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞ **—Å–∞–º–æ Cloudflare AI**, –Ω–æ:
1. –í–∏–µ –∏—Å–∫–∞—Ö—Ç–µ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ **Gemini 2.0 Flash** (–∫–∞–∫—Ç–æ —Å–ø–æ–º–µ–Ω–∞—Ö—Ç–µ)
2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –∑–∞ Cloudflare AI –ª–∏–ø—Å–≤–∞—à–µ –≤ KV store
3. –ù—è–º–∞—à–µ fallback –∫—ä–º Gemini API

–ó–∞—Ç–æ–≤–∞ endpoint-—ä—Ç –≤—Ä—ä—â–∞—à–µ 503 - "AI –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω".

## ‚úÖ –ö–∞–∫–≤–æ –Ω–∞–ø—Ä–∞–≤–∏—Ö–º–µ?

### 1. –î–æ–±–∞–≤–∏—Ö–º–µ Gemini API –ø–æ–¥–¥—Ä—ä–∂–∫–∞
–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞—Ö–º–µ `worker.js` –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞ **fallback chain**:

```
–õ–æ–∫–∞–ª–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏ ‚Üí Cloudflare AI ‚Üí Gemini API ‚Üí –ì—Ä–µ—à–∫–∞ 503
```

–°–µ–≥–∞ –∞–∫–æ Cloudflare AI –Ω–µ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω, —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —â–µ —Å–µ prebaci –∫—ä–º Gemini API.

### 2. –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞—Ö–º–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞
–ü—Ä–æ–º–µ–Ω–∏—Ö–º–µ `kv/DIET_RESOURCES/model_nutrient_lookup`:
- **–ü—Ä–µ–¥–∏**: `@cf/meta/llama-3-8b-instruct` (Cloudflare AI –º–æ–¥–µ–ª)
- **–°–µ–≥–∞**: `gemini-2.0-flash-exp` (Gemini –º–æ–¥–µ–ª, –∫–æ–µ—Ç–æ –∏—Å–∫–∞—Ö—Ç–µ)

### 3. –î–æ–±–∞–≤–∏—Ö–º–µ —Ç–µ—Å—Ç–æ–≤–µ
–°—ä–∑–¥–∞–¥–æ—Ö–º–µ `tests/nutrientLookup.gemini.test.js` —Å 5 —Ç–µ—Å—Ç–∞:
- ‚úÖ Gemini API fallback —Ä–∞–±–æ—Ç–∏
- ‚úÖ –ì—Ä–µ—à–∫–∏ —Å–µ –æ–±—Ä–∞–±–æ—Ç–≤–∞—Ç –ø—Ä–∞–≤–∏–ª–Ω–æ
- ‚úÖ JSON —Å–µ –∏–∑–≤–ª–∏—á–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ –æ—Ç AI –æ—Ç–≥–æ–≤–æ—Ä–∏
- ‚úÖ All-zero responses —Å–µ –æ–±—Ä–∞–±–æ—Ç–≤–∞—Ç
- ‚úÖ –í—Å–∏—á–∫–∏ security checks –º–∏–Ω–∞–≤–∞—Ç

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–∞—Ö–º–µ –≤—Å–∏—á–∫–æ
–°—ä–∑–¥–∞–¥–æ—Ö–º–µ `NUTRIENT_LOOKUP_SETUP_BG.md` —Å –ø–æ–¥—Ä–æ–±–Ω–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

## üöÄ –ö–∞–∫–≤–æ —Ç—Ä—è–±–≤–∞ –î–ê –ù–ê–ü–†–ê–í–ò–¢–ï —Å–µ–≥–∞?

### –°—Ç—ä–ø–∫–∞ 1: –ö–∞—á–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –≤ Cloudflare KV

```bash
npm run sync-kv
```

–¢–∞–∑–∏ –∫–æ–º–∞–Ω–¥–∞ —â–µ –∫–∞—á–∏:
- `model_nutrient_lookup` ‚Üí `gemini-2.0-flash-exp`
- `prompt_nutrient_lookup` ‚Üí –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω –ø—Ä–æ–º–ø—Ç

**–í–∞–∂–Ω–æ**: –¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–µ –≤–ª–µ–∑–ª–∏ –≤ Wrangler:
```bash
wrangler login
```

### –°—Ç—ä–ø–∫–∞ 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–π—Ç–µ Gemini API Key

```bash
# –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ –∏–º–∞—Ç–µ –∫–ª—é—á–∞
wrangler secret list

# –ê–∫–æ –ª–∏–ø—Å–≤–∞, –¥–æ–±–∞–≤–µ—Ç–µ –≥–æ
wrangler secret put GEMINI_API_KEY
# –°–ª–µ–¥ —Ç–æ–≤–∞ –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞—à–∏—è—Ç Gemini API –∫–ª—é—á
```

### –°—Ç—ä–ø–∫–∞ 3: Deploy –Ω–∞ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ

```bash
npm run deploy
```

### –°—Ç—ä–ø–∫–∞ 4: –¢–µ—Å—Ç–≤–∞–π—Ç–µ

```bash
curl -X POST https://openapichatbot.radilov-k.workers.dev/nutrient-lookup \
  -H "Content-Type: application/json" \
  -d '{"food": "—à–æ–∫–æ–ª–∞–¥–æ–≤ –º—ä—Ñ–∏–Ω", "quantity": "80"}'
```

–û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç:
```json
{
  "calories": 232,
  "protein": 4,
  "carbs": 41,
  "fat": 6,
  "fiber": 1.6
}
```

## üìä –ö–∞–∫–≤–æ —Å–µ –ø—Ä–æ–º–µ–Ω–∏ –≤ –∫–æ–¥–∞?

### worker.js
```javascript
// –ü–†–ï–î–ò: –°–∞–º–æ Cloudflare AI
if (env.CF_ACCOUNT_ID && env.CF_AI_TOKEN && nutrientModel) {
    // Call Cloudflare AI
} else {
    // Error 503
}

// –°–ï–ì–ê: Cloudflare AI ‚Üí Gemini fallback
if (env.CF_ACCOUNT_ID && env.CF_AI_TOKEN && nutrientModel) {
    // Call Cloudflare AI
} else if (env.GEMINI_API_KEY && nutrientModel) {
    // Call Gemini API (–ù–û–í–û!)
} else {
    // Error 503
}
```

### –ó–∞—â–æ —Ç–æ–≤–∞ –µ –ø–æ-–¥–æ–±—Ä–æ?
1. **–ì—ä–≤–∫–∞–≤–æ—Å—Ç**: –ú–æ–∂–µ—Ç–µ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ Cloudflare AI, Gemini, –∏–ª–∏ –∏ –¥–≤–∞—Ç–∞
2. **–ù–∞–¥–µ–∂–¥–Ω–æ—Å—Ç**: –ê–∫–æ –µ–¥–∏–Ω –ø—Ä–æ–≤–∞–π–¥—ä—Ä –Ω–µ —Ä–∞–±–æ—Ç–∏, –¥—Ä—É–≥–∏—è—Ç –ø–æ–µ–º–∞
3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç**: –ü—Ä–æ–º—è–Ω–∞—Ç–∞ –Ω–∞ –º–æ–¥–µ–ª–∞ —Å—Ç–∞–≤–∞ —á—Ä–µ–∑ KV store, –±–µ–∑ –∫–æ–¥ –ø—Ä–æ–º–µ–Ω–∏
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–Ω–æ—Å—Ç**: Cloudflare AI –µ –ø–æ-–±—ä—Ä–∑ (–∞–∫–æ –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω), Gemini –µ fallback

## üîê Security

–í—Å–∏—á–∫–∏ –ø—Ä–æ–º–µ–Ω–∏ –º–∏–Ω–∞—Ö–∞ security checks:
- ‚úÖ CodeQL Scan: 0 vulnerabilities
- ‚úÖ Proper URL validation
- ‚úÖ No hardcoded secrets
- ‚úÖ Safe error handling

## üìñ –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü—ä–ª–Ω–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏**: `NUTRIENT_LOOKUP_SETUP_BG.md`
- **–¢–µ—Å—Ç–æ–≤–µ**: `tests/nutrientLookup.gemini.test.js`
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: `kv/DIET_RESOURCES/`

## ‚ùì Troubleshooting

### "wrangler: command not found"
```bash
npm install -g wrangler
wrangler login
```

### Endpoint-—ä—Ç –≤—Å–µ –æ—â–µ –≤—Ä—ä—â–∞ 503
1. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ logs: `wrangler tail`
2. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ –∫–ª—é—á–æ–≤–µ—Ç–µ —Å–∞ –∫–∞—á–µ–Ω–∏: `wrangler secret list`
3. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ KV: `wrangler kv:key get model_nutrient_lookup --binding RESOURCES_KV`

### Gemini API –≤—Ä—ä—â–∞ –≥—Ä–µ—à–∫–∞
- –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ API –∫–ª—é—á—ä—Ç –µ –≤–∞–ª–∏–¥–µ–Ω
- –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ –∏–º–∞—Ç–µ –∫–≤–æ—Ç–∞ (rate limits)
- –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ Gemini API status: https://ai.google.dev/status

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º—ä—Ç –µ **–Ω–∞–ø—ä–ª–Ω–æ —Ä–µ—à–µ–Ω**! 

–°–µ–≥–∞ nutrient-lookup endpoint-—ä—Ç:
- ‚úÖ –ü–æ–¥–¥—ä—Ä–∂–∞ Gemini API (–∫–æ–µ—Ç–æ –∏—Å–∫–∞—Ö—Ç–µ)
- ‚úÖ –ò–º–∞ fallback –∫—ä–º Cloudflare AI
- ‚úÖ –í—Ä—ä—â–∞ —è—Å–Ω–∏ –≥—Ä–µ—à–∫–∏
- ‚úÖ –ï –Ω–∞–ø—ä–ª–Ω–æ —Ç–µ—Å—Ç–≤–∞–Ω
- ‚úÖ –ï security-safe
- ‚úÖ –ï –¥–æ–±—Ä–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–∞–Ω

–°–ª–µ–¥–≤–∞–π—Ç–µ —Å—Ç—ä–ø–∫–∏—Ç–µ –ø–æ-–≥–æ—Ä–µ –∏ endpoint-—ä—Ç —â–µ –∑–∞—Ä–∞–±–æ—Ç–∏ –≤–µ–¥–Ω–∞–≥–∞!

---

**–ê–∫–æ –∏–º–∞—Ç–µ –≤—ä–ø—Ä–æ—Å–∏ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∏, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ:**
1. `NUTRIENT_LOOKUP_SETUP_BG.md` - –ü–æ–¥—Ä–æ–±–Ω–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
2. `wrangler tail` - Worker logs –≤ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ
3. Browser Console - –ó–∞ frontend –≥—Ä–µ—à–∫–∏
