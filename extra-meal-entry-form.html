<!-- extra-meal-entry-form.html -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
<link href="css/extra_meal_form_styles.css" rel="stylesheet" />
<form id="extraMealEntryFormActual" aria-labelledby="extraMealModalFormTitle" novalidate>
    <div class="form-wizard-header" style="margin-bottom: var(--space-lg);">
        <h3 id="extraMealModalFormTitle" style="text-align:center; margin-bottom: var(--space-md);">Добавяне на Извънредно Хранене</h3>
        <div class="step-indicator-container">
            <span class="step-indicator-label">Стъпка <span id="currentStepNumber">1</span> от <span id="totalStepNumber">5</span></span>
            <div class="progress-bar-steps" style="width: 100%; height: 8px; background-color: var(--surface-background); border-radius: var(--radius-sm); overflow: hidden; margin: 0 auto; max-width: 300px;">
                <div id="stepProgressBar" style="height: 100%; background-color: var(--secondary-color); width: 20%; transition: width 0.4s ease-in-out; border-radius: var(--radius-sm);"></div>
            </div>
        </div>
    </div>

    <!-- Стъпка 1: Описание на храната -->
    <div class="form-step active-step" data-step="1">
        <h4 class="step-title">
            <span class="step-icon"><svg class="icon"><use href="#icon-utensils"></use></svg></span>Описание на Храненето
        </h4>
        <div class="form-group"> <!-- Използваме общ клас за група от форма -->
            <label for="foodDescription">Какво консумирахте?</label>
            <div class="autocomplete-container" style="position: relative;">
            <textarea id="foodDescription" name="foodDescription" rows="3" placeholder="Въведете текст..." required aria-required="true" aria-describedby="foodDescriptionHelp" class="input-focus-animate"></textarea> <!-- Няма нужда от form-control, ако е глобално стилизиран textarea -->
                <div id="foodSuggestionsDropdown" class="autocomplete-suggestions hidden" role="listbox" style="position: absolute; background-color: var(--surface-background); border: 1px solid var(--input-border-color); border-top: none; z-index: 1050; width: 100%; max-height: 150px; overflow-y: auto; box-shadow: var(--shadow-sm); border-bottom-left-radius: var(--radius-md); border-bottom-right-radius: var(--radius-md);">
                    <!-- Предложенията ще се добавят от JS -->
                </div>
            </div>
            <small id="foodDescriptionHelp" class="text-muted" style="display: block; margin-top: var(--space-xs);"><i class="bi bi-check-lg" aria-hidden="true"></i> 1 храна/напитка на запис.
            <i class="bi bi-arrow-right" aria-hidden="true"></i> Завърши и стартирай нова форма за следващата.</small>
        </div>
    </div>

    <!-- Стъпка 2: Количество -->
    <div class="form-step" data-step="2" style="display: none;">
        <h4 class="step-title">
            <span class="step-icon"><svg class="icon"><use href="#icon-scale"></use></svg></span>Количество
        </h4>
        <fieldset class="form-group">
            <legend id="quantityLegend">Приблизително количество:</legend>
            <div class="quantity-input-wrapper" style="display:flex;gap:var(--space-sm);flex-wrap:wrap;margin-bottom:var(--space-md);">
                <input type="number" id="quantityCountInput" name="quantityCountInput" list="quantityCountList" min="0" step="0.5" class="input-focus-animate" placeholder="Бройка" aria-label="Бройка" aria-describedby="quantityLegend">
                <datalist id="quantityCountList">
                    <option value="0.5"></option>
                    <option value="1"></option>
                    <option value="2"></option>
                    <option value="3"></option>
                    <option value="4"></option>
                    <option value="5"></option>
                </datalist>
                <input type="text" id="measureInput" name="measureInput" list="measureSuggestionList" class="input-focus-animate" placeholder="Размер/мярка" aria-label="Размер/мярка" aria-describedby="quantityLegend">
                <datalist id="measureSuggestionList"></datalist>
            </div>
        </fieldset>
        <input type="text" id="quantityCustom" name="quantityCustom" class="input-focus-animate" style="margin-top: var(--space-sm);" placeholder="Напр. 100гр, 2 с.л., специфично количество" aria-label="Уточнение за количество">
        <input type="number" id="quantity" name="quantity" class="hidden input-focus-animate" min="0" step="0.01" inputmode="decimal" aria-hidden="true">

        <div id="macroFieldsContainer" class="form-group hidden" style="margin-top: var(--space-md);">
            <label style="display:block;margin-bottom:var(--space-xs);">Приблизителни макроси (по избор)</label>
            <div class="macro-inputs-grid" style="display:flex;flex-wrap:wrap;gap:var(--space-sm);">
                <label style="display:flex;flex-direction:column;">
                    Калории
                    <input type="number" name="calories" min="0" step="1" class="input-focus-animate" style="max-width:6rem;">
                </label>
                <label style="display:flex;flex-direction:column;">
                    Протеин (g)
                    <input type="number" name="protein" min="0" step="1" class="input-focus-animate" style="max-width:6rem;">
                </label>
                <label style="display:flex;flex-direction:column;">
                    Въглехидрати (g)
                    <input type="number" name="carbs" min="0" step="1" class="input-focus-animate" style="max-width:6rem;">
                </label>
                <label style="display:flex;flex-direction:column;">
                    Мазнини (g)
                    <input type="number" name="fat" min="0" step="1" class="input-focus-animate" style="max-width:6rem;">
                </label>
                <label style="display:flex;flex-direction:column;">
                    Фибри (g)
                    <input type="number" name="fiber" min="0" step="1" class="input-focus-animate" style="max-width:6rem;">
                </label>
            </div>
        </div>
    </div>

    <!-- Стъпка 3: Причина -->
    <div class="form-step" data-step="3" style="display: none;">
        <h4 class="step-title">
            <span class="step-icon"><i class="bi bi-question-circle"></i></span>Причина за Храненето
        </h4>
        <fieldset class="form-group">
            <legend>Основна причина:</legend>
            <div class="radio-group-vertical" style="display: flex; flex-direction: column; gap: var(--space-sm);">
                <!-- Стилът за .radio-group-vertical и label вътре ще дойде от extra_meal_form_styles.css -->
                <label><input type="radio" name="reasonPrimary" value="глад" checked> <span class="emoji-icon"><i class="bi bi-emoji-smile"></i></span> Истински физически глад</label>
                <label><input type="radio" name="reasonPrimary" value="craving"> <span class="emoji-icon"><i class="bi bi-star-fill"></i></span> Силно желание (craving)</label>
                <label><input type="radio" name="reasonPrimary" value="социално"> <span class="emoji-icon"><i class="bi bi-people"></i></span> Социално събитие / почерпка</label>
                <label><input type="radio" name="reasonPrimary" value="емоция_стрес"> <span class="emoji-icon"><i class="bi bi-emoji-frown"></i></span> Стрес / Тъга / Емоционално</label>
                <label><input type="radio" name="reasonPrimary" value="емоция_радост"> <span class="emoji-icon"><i class="bi bi-emoji-laughing"></i></span> Радост / Награда (емоционално)</label>
                <label><input type="radio" name="reasonPrimary" value="скука"> <span class="emoji-icon"><i class="bi bi-moon"></i></span> Скука / От навик</label>
                <label><input type="radio" name="reasonPrimary" value="нямах_планирана"> <span class="emoji-icon"><i class="bi bi-question-circle"></i></span> Нямах планирана храна</label>
                <label><input type="radio" name="reasonPrimary" value="other_reason"> <span class="emoji-icon"><i class="bi bi-question"></i></span> Друга причина</label>
            </div>
            <input type="text" id="reasonOtherText" name="reasonOtherText" class="hidden input-focus-animate" style="margin-top: var(--space-sm);" placeholder="Моля, уточнете причината" aria-label="Уточнение за причина">
        </fieldset>
    </div>

    <!-- Стъпка 4: Усещане и Влияние -->
    <div class="form-step" data-step="4" style="display: none;">
        <h4 class="step-title">
            <span class="step-icon"><i class="bi bi-chat-dots"></i></span>Усещане и Влияние
        </h4>
        <fieldset class="form-group">
            <legend>Как се почувствахте след това?</legend>
            <div class="radio-group-icons" style="display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-bottom: var(--space-md);">
                <!-- Стилът за .icon-radio-label ще дойде от extra_meal_form_styles.css -->
                <label class="icon-radio-label"><input type="radio" name="feelingAfter" value="ситост_доволство" checked> <span class="emoji-icon"><i class="bi bi-emoji-smile"></i></span> <span class="icon-radio-text">Заситен/а</span></label>
                <label class="icon-radio-label"><input type="radio" name="feelingAfter" value="още_глад"> <span class="emoji-icon"><i class="bi bi-emoji-neutral"></i></span> <span class="icon-radio-text">Гладен/а</span></label>
                <label class="icon-radio-label"><input type="radio" name="feelingAfter" value="преядох_тежко"> <span class="emoji-icon"><i class="bi bi-emoji-dizzy"></i></span> <span class="icon-radio-text">Тежко ми е</span></label>
                <label class="icon-radio-label"><input type="radio" name="feelingAfter" value="виновен_съжаление"> <span class="emoji-icon"><i class="bi bi-emoji-frown"></i></span> <span class="icon-radio-text">Виновен/а</span></label>
                <label class="icon-radio-label"><input type="radio" name="feelingAfter" value="без_особена_промяна"> <span class="emoji-icon"><i class="bi bi-emoji-neutral"></i></span> <span class="icon-radio-text">Без промяна</span></label>
                <label class="icon-radio-label"><input type="radio" name="feelingAfter" value="енергичен"> <span class="emoji-icon"><i class="bi bi-lightning"></i></span> <span class="icon-radio-text">Енергичен/а</span></label>
                <label class="icon-radio-label"><input type="radio" name="feelingAfter" value="отпаднал_сънлив"> <span class="emoji-icon"><i class="bi bi-moon-fill"></i></span> <span class="icon-radio-text">Отпаднал/а</span></label>
            </div>
        </fieldset>
        <fieldset class="form-group">
            <legend>Замести ли планирано хранене?</legend>
            <div class="radio-group-vertical" style="display: flex; flex-direction: column; gap: var(--space-sm);">
                <label><input type="radio" name="replacedPlanned" value="не" checked> Не, беше допълнително</label>
                <label><input type="radio" name="replacedPlanned" value="да_напълно"> Да, напълно го замести</label>
                <label><input type="radio" name="replacedPlanned" value="да_частично"> Да, частично (хапнах по-малко от планираното)</label>
            </div>
            <select id="skippedMeal" name="skippedMeal" class="hidden" style="margin-top: var(--space-sm);" autocomplete="off" aria-label="Избор на засегнато хранене">
                <option value="">-- Кое хранене беше засегнато? --</option>
                <option value="закуска">Закуска</option>
                <option value="междинно1">Междинна закуска 1</option>
                <option value="обяд">Обяд</option>
                <option value="междинно2">Междинна закуска 2</option>
                <option value="вечеря">Вечеря</option>
                <option value="няколко_планирани">Няколко планирани</option>
            </select>
        </fieldset>
    </div>

    <!-- Стъпка 5: Потвърждение -->
    <div class="form-step" data-step="5" style="display: none;">
        <h4 class="step-title">
            <span class="step-icon"><i class="bi bi-check-lg"></i></span>Преглед и Потвърждение
        </h4>
        <div id="extraMealSummary" class="summary-box fs-sm" style="background-color: var(--metric-value-group-bg-initial); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border-color); margin-bottom: var(--space-lg);">
            <p style="margin-bottom: var(--space-sm); color: var(--text-color-secondary); font-weight: 500;">Моля, прегледайте въведената информация:</p>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Храна:</strong> <span data-summary="foodDescription"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Количество:</strong> <span data-summary="quantityEstimate"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Калории:</strong> <span data-summary="calories"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Протеин:</strong> <span data-summary="protein"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Въглехидрати:</strong> <span data-summary="carbs"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Мазнини:</strong> <span data-summary="fat"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Фибри:</strong> <span data-summary="fiber"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Причина:</strong> <span data-summary="reasonPrimary"></span></div>
            <div style="margin-bottom: var(--space-xs); padding: var(--space-xs) 0; border-bottom: 1px dotted var(--border-color-soft);"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Усещане:</strong> <span data-summary="feelingAfter"></span></div>
            <div style="padding: var(--space-xs) 0;"><strong style="color: var(--text-color-primary); margin-right: var(--space-xs); min-width: 130px; display: inline-block;">Замести планирано:</strong> <span data-summary="replacedPlanned"></span></div>
        </div>
    </div>

    <!-- Навигация между стъпките -->
    <div class="form-wizard-navigation" style="margin-top: var(--space-lg); display: flex; justify-content: space-between; align-items: center; gap: var(--space-sm); border-top: 1px solid var(--border-color-soft); padding-top: var(--space-lg);">
        <button type="button" id="emPrevStepBtn" class="button button-secondary" style="flex-grow: 1;">Предишна</button> <!-- Добавен клас button -->
        <button type="button" id="emCancelBtn" class="button button-secondary modal-close-btn-form" style="flex-grow: 1; background-color: var(--text-color-muted); color: var(--text-color-on-primary);">Отказ</button> <!-- Добавен клас button -->
        <button type="button" id="emNextStepBtn" class="button button-primary" style="flex-grow: 1;">Следваща</button> <!-- Добавен клас button -->
        <button type="submit" id="emSubmitBtn" class="button button-primary" style="flex-grow: 1;">Запази</button> <!-- Добавен клас button -->
    </div>
</form>
    <script type="module">
        import { initializeExtraMealFormLogic } from './js/extraMealForm.js';
        initializeExtraMealFormLogic(document);
    </script>
