# Психологическа Персонализация на Хранителния План (psy_advice.txt)

## Обща информация

Функционалността `psy_advice` позволява адаптиране на хранителните планове и комуникацията на чат асистента според личностния тип на потребителя. Системата използва 16 дефинирани личностни профила, базирани на 4-измерен модел:

- **E/X** (Екстроверсия/Интроверсия)
- **S/V** (Sensing/Визия - практичен vs новаторски)
- **D/M** (Директен/Мек - thinking vs feeling)
- **P/J** (Perceiving/Judging - гъвкав vs структуриран)

## Структура на файла psy_advice.txt

Всеки профил съдържа три основни секции:

### 1. Хранене – риск
Списък с потенциални хранителни рискове специфични за този личностен тип.

**Примери:**
- Пропускане на хранения
- Емоционално хранене
- Свръхобмисляне
- Твърде строг режим

### 2. Насока
Препоръчителни стратегии за хранене, които адресират рисковете.

**Примери:**
- Фиксирани опорни хранения
- Бавни, контролирани промени
- Редовни хранения
- Баланс ефективност–удоволствие

### 3. Комуникация
Насоки за комуникационния стил, който е най-ефективен за този тип личност.

**Примери:**
- Кратка, ясна, без обяснения
- Мек тон, без натиск
- Логична, аргументирана
- Емоционално присъствие

## Технически аспекти

### Функции за обработка

#### `extractPsyAdviceForType(psyAdviceContent, personalityTypeCode)`
Извлича хранителните съвети от psy_advice.txt за конкретен личностен тип.

**Параметри:**
- `psyAdviceContent` (string) - Съдържанието на psy_advice.txt файла
- `personalityTypeCode` (string) - Код на личностния тип (напр. "X-S-D-P")

**Връща:**
```javascript
{
  risks: string,        // Хранителни рискове
  dietary: string,      // Препоръчителна насока
  communication: string // Комуникационен стил
}
```

**Пример:**
```javascript
const advice = extractPsyAdviceForType(psyAdviceContent, "X-S-D-P");
// advice.risks = "пропускане на хранения\nядене накрай, късно\nниска последователност"
// advice.dietary = "фиксирани опорни хранения\nпрост, повтаряем режим"
// advice.communication = "кратка, ясна, без обяснения\nфокус върху действие"
```

#### `formatPsyAdviceForPrompt(advice, personalityTypeCode)`
Форматира извлечените съвети за включване в AI prompt.

**Връща:**
Форматиран текст с ясни секции за AI модела.

### Интеграция в план генериране

1. **Зареждане на ресурса:**
   ```javascript
   const psyAdviceContent = await env.RESOURCES_KV.get('psy_advice');
   ```

2. **Извличане на личностен тип:**
   ```javascript
   const psychTestsData = await env.USER_METADATA_KV.get(`${userId}_psychTests`);
   const personalityTypeCode = psychTestsData?.personalityTest?.typeCode;
   ```

3. **Парсване на съветите:**
   ```javascript
   const advice = extractPsyAdviceForType(psyAdviceContent, personalityTypeCode);
   const psyDietaryAdvice = formatPsyAdviceForPrompt(advice, personalityTypeCode);
   ```

4. **Добавяне в prompt:**
   ```javascript
   replacements['%%PSY_DIETARY_ADVICE%%'] = psyDietaryAdvice;
   ```

### Интеграция в чат асистент

1. **Извличане на комуникационния стил:**
   ```javascript
   const advice = extractPsyAdviceForType(psyAdviceContent, personalityTypeCode);
   const psyCommunicationStyle = advice.communication;
   ```

2. **Добавяне в chat prompt:**
   ```javascript
   replacements['%%PSY_COMMUNICATION_STYLE%%'] = psyCommunicationStyle;
   ```

## Примери за използване

### Пример 1: X-S-D-P (Интровертен, практичен, директен, гъвкав)

**Хранителни рискове:**
- Пропускане на хранения
- Ядене накрай, късно
- Ниска последователност

**Насока за хранене:**
- Фиксирани опорни хранения (закуска 7:30, обяд 13:00, вечеря 19:00)
- Прост, повтаряем режим (същите храни всяка седмица)
- Минимален избор, готови решения

**Комуникация:**
- Кратка, ясна, без обяснения
- Фокус върху действие, не теория
- Избягвай морализиране и контрол

**Пример съобщение:**
> "Днес пропусна обяда. Вземи протеин бар сега и следващия обяд на 13:00."

### Пример 2: E-V-M-J (Екстровертен, новаторски, мек, структуриран)

**Хранителни рискове:**
- Пренатоварване от ангажименти

**Насока за хранене:**
- Поддържащ, балансиран режим
- Защита на личния ресурс

**Комуникация:**
- Партньорска
- Признавай усилията
- Пази баланса работа–възстановяване

**Пример съобщение:**
> "Виждам че следваш плана отлично въпреки натоварения график. Помисли да добавиш още 30 мин почивка в обедната пауза, за да запазиш енергията си."

## Поддръжка и актуализация

### Добавяне на нов профил

1. Отвори `psy/psyadvice.txt`
2. Добави нов профил с формата:
   ```
   PROFILE-CODE
   
   Описание на профила.
   Характеристики.
   
   Хранене – риск:
   
   риск 1
   
   риск 2
   
   Насока:
   
   насока 1
   
   насока 2
   
   Комуникация:
   
   стил 1
   
   стил 2
   ```

3. Синхронизирай с KV:
   ```bash
   npm run sync-kv
   ```

### Промяна на съществуващ профил

1. Редактирай съответната секция в `psy/psyadvice.txt`
2. Синхронизирай промените: `npm run sync-kv`
3. Промените ще се приложат веднага при следващо генериране на план

## Тестване

### Ръчно тестване

1. Създай тестов потребител с конкретен личностен тип
2. Генерирай хранителен план
3. Провери че принципите и менюто отразяват специфичните насоки
4. Тествай чат асистента - провери че комуникационният стил е адаптиран

### Автоматизирано тестване

```bash
npm test tests/psyAdviceExtraction.test.js
```

## Референции

- **Файл с данни:** `psy/psyadvice.txt`
- **KV ресурс:** `psy_advice` в `RESOURCES_KV`
- **Prompt шаблони:**
  - `kv/DIET_RESOURCES/prompt_unified_plan_generation_v2.txt` (план генериране)
  - `kv/DIET_RESOURCES/prompt_chat.txt` (чат асистент)
- **Worker функции:**
  - `extractPsyAdviceForType()` (line ~6770)
  - `formatPsyAdviceForPrompt()` (line ~6857)
  - `processSingleUserPlan()` (line ~5700)
  - `handleChatRequest()` (line ~2400)

## Проблеми и решения

### Проблем: Не се извличат съветите за даден профил

**Решение:**
1. Провери че личностният тип код е точен (напр. "X-S-D-P", не "XSDP")
2. Провери форматирането в psy_advice.txt (празни редове между секции)
3. Провери че профилът съществува в файла

### Проблем: Комуникационният стил не се прилага в чата

**Решение:**
1. Провери че `%%PSY_COMMUNICATION_STYLE%%` е добавен в prompt_chat.txt
2. Провери че личностният тип е записан в `${userId}_psychTests`
3. Провери логовете за грешки при извличане

## История на версиите

- **v1.0.0** (2024-12-15) - Първоначална имплементация
  - 16 личностни профила
  - Интеграция в план генериране
  - Интеграция в чат асистент
