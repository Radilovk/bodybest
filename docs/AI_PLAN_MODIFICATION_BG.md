# AI Асистент - Достъп до промяна на план с потребителско съгласие

## Обзор

Този документ описва как AI асистентът може да предлага промени в хранителния план на потребителя, които изискват изрично потребителско съгласие преди да бъдат приложени.

## Архитектура на решението

### 1. Workflow за промяна на план

```
┌─────────────────┐
│ AI Асистент     │
│ детектира нужда │
│ от промяна      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Създава         │
│ предложение     │
│ (Proposal)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Потребителят    │
│ получава        │
│ известие        │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌──────────┐
│Одобри  │ │Отхвърли  │
└───┬────┘ └────┬─────┘
    │           │
    ▼           ▼
┌────────┐ ┌──────────┐
│Промени │ │Архивира  │
│се      │ │предложе- │
│прилагат│ │нието     │
└────────┘ └──────────┘
```

### 2. Нови API Endpoints

#### POST `/api/proposePlanChange`
Създава предложение за промяна на план от AI асистента.

**Тяло на заявката:**
```json
{
  "userId": "user123",
  "proposedChanges": {
    "textDescription": "Увеличаване на протеините с 20г на ден",
    "caloriesMacros": {
      "plan": {
        "protein_grams": 160
      }
    }
  },
  "reasoning": "На база последния анализ, увеличаването на протеиновия прием ще...",
  "source": "chat"
}
```

**Отговор:**
```json
{
  "success": true,
  "message": "Предложението за промяна на плана е създадено успешно.",
  "proposalId": "proposal_1234567890",
  "proposal": {
    "id": "proposal_1234567890",
    "proposedChanges": { ... },
    "reasoning": "...",
    "createdAt": "2025-11-11T10:00:00.000Z"
  }
}
```

#### POST `/api/approvePlanChange`
Одобрява предложена промяна и я прилага към плана.

**Тяло на заявката:**
```json
{
  "userId": "user123",
  "proposalId": "proposal_1234567890",
  "userComment": "Съгласен съм, звучи добре!"
}
```

**Отговор:**
```json
{
  "success": true,
  "message": "Промените в плана са приложени успешно!",
  "updatedPlan": { ... }
}
```

#### GET `/api/getPendingPlanChanges?userId=user123`
Проверява дали има чакащи предложения за промяна.

**Отговор:**
```json
{
  "success": true,
  "hasPending": true,
  "proposal": {
    "id": "proposal_1234567890",
    "proposedChanges": { ... },
    "reasoning": "...",
    "createdAt": "2025-11-11T10:00:00.000Z",
    "expiresAt": "2025-11-18T10:00:00.000Z"
  }
}
```

#### POST `/api/rejectPlanChange`
Отхвърля предложена промяна.

**Тяло на заявката:**
```json
{
  "userId": "user123",
  "proposalId": "proposal_1234567890",
  "reason": "Не съм готов за тази промяна"
}
```

**Отговор:**
```json
{
  "success": true,
  "message": "Предложението за промяна на плана е отхвърлено."
}
```

### 3. Съхранение на данни в KV

#### Чакащо предложение
**Ключ:** `{userId}_pending_plan_proposal`

**Стойност:**
```json
{
  "id": "proposal_1234567890",
  "userId": "user123",
  "status": "pending",
  "proposedChanges": {
    "textDescription": "...",
    "caloriesMacros": { ... },
    "week1Menu": { ... }
  },
  "reasoning": "AI обосновка за промяната",
  "source": "chat",
  "currentPlanSnapshot": { ... },
  "createdAt": "2025-11-11T10:00:00.000Z",
  "expiresAt": "2025-11-18T10:00:00.000Z"
}
```

#### История на предложения
**Ключ:** `{userId}_plan_proposal_history_{proposalId}`

**Стойност:** (след одобрение или отхвърляне)
```json
{
  "id": "proposal_1234567890",
  "userId": "user123",
  "status": "approved", // или "rejected"
  "proposedChanges": { ... },
  "reasoning": "...",
  "approvedAt": "2025-11-11T11:00:00.000Z",
  "userComment": "Съгласен съм"
}
```

### 4. Frontend компоненти

#### `js/planProposalManager.js`
Модул за управление на предложенията в потребителския интерфейс.

**Основни функции:**
- `checkPendingProposals(userId)` - Проверява за чакащи предложения
- `approvePlanChange(userId, proposalId, comment)` - Одобрява промяна
- `rejectPlanChange(userId, proposalId, reason)` - Отхвърля промяна
- `showProposalModal(proposal, onApprove, onReject)` - Показва модален прозорец с предложението
- `initPlanProposalManager(userId)` - Инициализира системата при зареждане

**Използване:**
```javascript
import { initPlanProposalManager } from './js/planProposalManager.js';

// При зареждане на страницата
const userId = localStorage.getItem('userId');
if (userId) {
    initPlanProposalManager(userId);
}
```

### 5. Интеграция с чат асистента

Когато AI асистентът детектира сигнал `[PLAN_MODIFICATION_REQUEST]` в отговора си:

1. Извлича текстовото описание на промяната
2. Използва AI модел за парсиране на текста в структурирани промени
3. Създава предложение чрез `handleProposePlanChangeRequest`
4. Информира потребителя в чата за създаденото предложение

**Пример:**

```
Потребител: "Искам да увелича протеините си"

AI отговор: "Разбирам! На база вашия текущ прогрес препоръчвам увеличение с 20г 
протеини дневно. [PLAN_MODIFICATION_REQUEST]Увеличи протеините от 140г на 160г дневно 
в plan.caloriesMacros.plan.protein_grams."

Резултат:
✅ Предложението за промяна на плана е създадено успешно. Моля, прегледайте го и 
одобрете или отхвърлете промените. Използвайте бутона "Преглед на предложените промени" 
за да видите детайлите.
```

### 6. Потребителски интерфейс

#### Известие за чакащо предложение
При зареждане на страницата, ако има чакащо предложение, потребителят вижда:

```
╔═══════════════════════════════════════╗
║ 🔔 Ново предложение за промяна на     ║
║    плана                              ║
║                                       ║
║ AI асистентът предлага промени във    ║
║ Вашия хранителен план.                ║
║                                       ║
║ [👁 Преглед]                          ║
╚═══════════════════════════════════════╝
```

#### Модален прозорец за преглед
При натискане на бутона "Преглед" се показва детайлна информация:

```
╔═══════════════════════════════════════╗
║ 💡 AI Асистентът предлага промени в   ║
║    плана                              ║
╠═══════════════════════════════════════╣
║                                       ║
║ ℹ️  AI асистентът предлага промени във║
║    Вашия хранителен план на база      ║
║    анализ на текущия прогрес.         ║
║                                       ║
║ Обосновка:                            ║
║ На база последния анализ...           ║
║                                       ║
║ Промени в макронутриентите:           ║
║ • План:                               ║
║   - Протеини: 160 г                   ║
║                                       ║
║ Създадено на: 11.11.2025, 10:00      ║
║                                       ║
║ Вашият коментар (по избор):           ║
║ [текстово поле]                       ║
║                                       ║
║ [Затвори] [❌ Отхвърли] [✅ Одобри]   ║
╚═══════════════════════════════════════╝
```

### 7. Валидация и сигурност

#### Валидация на промените
- Всички промени преминават през `enforceCompletePlanBeforePersist`
- AI модел попълва липсващи макроси ако е необходимо
- Валидират се всички задължителни полета

#### Контрол на достъпа
- Само потребителят-собственик може да одобри/отхвърли предложение
- Предложенията изтичат след 7 дни
- Само едно чакащо предложение може да съществува едновременно

#### Архивиране
- Всички одобрени и отхвърлени предложения се архивират
- Пази се snapshot на плана преди промяната
- Записва се коментар на потребителя

### 8. Ограничения и бъдещи подобрения

#### Текущи ограничения
- Само едно чакащо предложение наведнъж
- Предложенията изтичат след 7 дни
- Няма механизъм за промяна на чакащо предложение

#### Планирани подобрения
- Множество предложения с приоритизация
- История на промените с възможност за връщане назад (undo)
- Детайлно сравнение преди/след
- A/B тестване на промени
- Постепенно прилагане на промени (gradual rollout)

## Тестване

### Ръчно тестване

1. **Създаване на предложение от чата:**
   ```
   Потребител: "Искам да намаля въглехидратите"
   [AI създава предложение]
   ```

2. **Преглед на предложението:**
   - Отвори dashboard
   - Виж известието за чакащо предложение
   - Натисни "Преглед"

3. **Одобряване:**
   - Прегледай промените
   - Добави коментар (по избор)
   - Натисни "Одобри"
   - Виж обновения план

4. **Отхвърляне:**
   - Натисни "Отхвърли"
   - Въведи причина (по избор)
   - Потвърди

### Автоматично тестване

Препоръчително е да се създадат тестове за:
- Създаване на предложение
- Одобряване на предложение
- Отхвърляне на предложение
- Изтичане на предложение
- Конфликти (multiple pending)
- Валидация на промените

## Документация за разработчици

### Добавяне на нови типове промени

За да добавите нов тип промяна, актуализирайте:

1. **`applyPlanChanges` функция в worker.js:**
   ```javascript
   if (proposedChanges.newField) {
       updatedPlan.newField = {
           ...updatedPlan.newField,
           ...proposedChanges.newField
       };
   }
   ```

2. **`formatProposalChanges` в planProposalManager.js:**
   ```javascript
   if (proposedChanges.newField) {
       html += '<div class="proposal-newfield">';
       html += '<h4>Промени в новото поле</h4>';
       html += '</div>';
   }
   ```

3. **Документация в `parsePlanModificationRequest`:**
   - Актуализирайте промпта да включва новото поле

### Debugging

Включете debug логове със заглавие `X-Debug: 1`:
```javascript
fetch('/api/proposePlanChange', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-Debug': '1'
    },
    body: JSON.stringify({ ... })
});
```

Логовете в worker.js ще показват детайли за процеса.

## Заключение

Тази имплементация позволява на AI асистента да предлага промени в хранителния план на потребителя по сигурен и контролиран начин, като изисква изрично потребителско съгласие преди да се приложат промените. Всички предложения се съхраняват, валидират и архивират, осигурявайки пълна проследимост и контрол.
