<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>bodybest</title><meta name="description" content="Documentation for bodybest"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">bodybest</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>bodybest</h1></div><div class="tsd-panel tsd-typography"><h1 id="bodybest" class="tsd-anchor-link">BodyBest<a href="#bodybest" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p>A simple static web application for tracking nutrition and workouts.</p>
<h2 id="development-setup" class="tsd-anchor-link">Development Setup<a href="#development-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ol>
<li>Install <a href="https://nodejs.org/">Node.js</a> (version 18 or later).</li>
<li>Install dependencies (Jest is included as a dev dependency):</li>
</ol>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span>
</code><button type="button">Copy</button></pre>

<h3 id="start-development-server" class="tsd-anchor-link">Start Development Server<a href="#start-development-server" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Run the Vite dev server which provides hot reload:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">dev</span>
</code><button type="button">Copy</button></pre>

<p>API requests to paths starting with <code>/api</code> are automatically proxied to
<code>https://openapichatbot.radilov-k.workers.dev</code> when running the dev server.</p>
<p>The application will be available at <code>http://localhost:5173</code> by default.</p>
<h3 id="build" class="tsd-anchor-link">Build<a href="#build" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Create an optimized production build in the <code>dist</code> folder:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">build</span>
</code><button type="button">Copy</button></pre>

<h3 id="lint" class="tsd-anchor-link">Lint<a href="#lint" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Check the source code with ESLint (see <code>eslint.config.js</code> for configuration):</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">lint</span>
</code><button type="button">Copy</button></pre>

<h3 id="type-check" class="tsd-anchor-link">Type Check<a href="#type-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Make sure dependencies are installed (<code>npm ci</code> or <code>npm install</code>) before running the TypeScript compiler in check mode:</p>
<pre><code class="bash"><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">tsc</span><span class="hl-1"> </span><span class="hl-3">--noEmit</span>
</code><button type="button">Copy</button></pre>

<h3 id="инсталация-на-зависимости" class="tsd-anchor-link">Инсталация на зависимости<a href="#инсталация-на-зависимости" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Преди да стартирате тестовете, инсталирайте необходимите зависимости, за да бъде
достъпен Jest:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">ci</span><span class="hl-1"> </span><span class="hl-4"># или npm install</span>
</code><button type="button">Copy</button></pre>

<h3 id="test" class="tsd-anchor-link">Test<a href="#test" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Run unit tests with Jest:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">test</span><span class="hl-1">         </span><span class="hl-4"># проверява синхронизацията и стартира Jest</span><br/><span class="hl-4"># или стартирайте директно</span><br/><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">jest</span>
</code><button type="button">Copy</button></pre>

<p><code>npm test</code> изпълнява <code>scripts/check-worker-sync.js</code> преди Jest. Скриптът сравнява
<code>worker.js</code> и <code>preworker.js</code> и прекъсва тестовете, ако файловете се различават.
При несъответствие пуснете <code>npm run build</code> или копирайте ръчно съдържанието, за
да синхронизирате файловете.
<code>npm test</code> автоматично изключва HTTP/HTTPS proxy променливите (както в горен,
така и в долен регистър) и проверява дали е инсталиран Jest. Ако липсва,
скриптът завършва с грешка, вместо да изчаква интерактивен отговор, затова
пуснете <code>npm ci</code> или <code>npm install</code> преди тестовете.
Ако стартирате <code>npx jest</code> директно и се появи предупреждение
&quot;Unknown env config &quot;http-proxy&quot;&quot;, временно изключете променливите ръчно:</p>
<pre><code class="bash"><span class="hl-0">unset</span><span class="hl-1"> </span><span class="hl-2">HTTP_PROXY</span><span class="hl-1"> </span><span class="hl-2">HTTPS_PROXY</span><span class="hl-1"> </span><span class="hl-2">http_proxy</span><span class="hl-1"> </span><span class="hl-2">https_proxy</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-2">npm_config_http_proxy</span><span class="hl-1"> </span><span class="hl-2">npm_config_https_proxy</span><br/><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">config</span><span class="hl-1"> </span><span class="hl-2">delete</span><span class="hl-1"> </span><span class="hl-2">proxy</span><br/><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">config</span><span class="hl-1"> </span><span class="hl-2">delete</span><span class="hl-1"> </span><span class="hl-2">https-proxy</span>
</code><button type="button">Copy</button></pre>

<p>Предупреждението може напълно да се скрие чрез файла <code>.npmrc</code>, който задава
<code>loglevel=error</code> и е включен в репозиторито.
Тези стъпки намаляват предупрежденията и потенциално ускоряват старта на
тестовете.</p>
<h3 id="coverage" class="tsd-anchor-link">Coverage<a href="#coverage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Създава HTML отчет за покритието с командата:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">coverage</span>
</code><button type="button">Copy</button></pre>

<p>Файловете се намират в <code>coverage/lcov-report</code>.</p>
<h3 id="registration-module-example" class="tsd-anchor-link">Registration Module Example<a href="#registration-module-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Include the common registration logic by importing <code>setupRegistration</code>:</p>
<pre><code class="html"><span class="hl-6">&lt;</span><span class="hl-7">script</span><span class="hl-8"> </span><span class="hl-9">type</span><span class="hl-8">=</span><span class="hl-10">&quot;module&quot;</span><span class="hl-6">&gt;</span><br/><span class="hl-8">  </span><span class="hl-11">import</span><span class="hl-8"> { </span><span class="hl-12">setupRegistration</span><span class="hl-8"> } </span><span class="hl-11">from</span><span class="hl-8"> </span><span class="hl-2">&quot;./js/register.js&quot;</span><span class="hl-8">;</span><br/><span class="hl-8">  </span><span class="hl-0">setupRegistration</span><span class="hl-8">(</span><span class="hl-2">&quot;#register-form&quot;</span><span class="hl-8">, </span><span class="hl-2">&quot;#register-message&quot;</span><span class="hl-8">);</span><br/><span class="hl-6">&lt;/</span><span class="hl-7">script</span><span class="hl-6">&gt;</span>
</code><button type="button">Copy</button></pre>

<h3 id="отстраняване-на-проблеми" class="tsd-anchor-link">Отстраняване на проблеми<a href="#отстраняване-на-проблеми" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Ако при стартиране на worker-а или тестовете липсват инсталираните зависимости, изпълнете:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span>
</code><button type="button">Copy</button></pre>

<p>If you see an error such as <strong>&quot;Cannot find module './mailer.js'&quot;</strong>, most often it
means the Node dependencies haven't been installed. Run <code>npm install</code> and then
try again. Recent versions of the worker rely on the <code>MAILER_ENDPOINT_URL</code>
environment variable instead of dynamic imports. If this variable is missing, the
worker uses the helper from <code>sendEmailWorker.js</code> and posts directly to
<code>MAIL_PHP_URL</code> (defaults to <code>https://mybody.best/mailer/mail.php</code>). A <strong>500</strong> error from
<code>/api/sendTestEmail</code> usually indicates a problem with the PHP backend. Inspect
the worker logs for details.</p>
<p>If TypeScript complains that it cannot find <code>Buffer</code> or the type definition file
for <strong><code>node</code></strong>, make sure Node.js types are installed and enabled:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1">  </span><span class="hl-4"># installs dev dependencies, including @types/node</span>
</code><button type="button">Copy</button></pre>

<p>Check that <code>tsconfig.json</code> includes <code>&quot;node&quot;</code> in the <code>types</code> array.</p>
<blockquote>
<p><strong>Tip</strong>: Activate Node compatibility in <code>wrangler.toml</code>:</p>
</blockquote>
<pre><code class="toml"><span class="hl-12">compatibility_flags</span><span class="hl-1"> = [</span><span class="hl-2">&quot;nodejs_compat&quot;</span><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>When <code>nodejs_compat</code> is enabled, Cloudflare Workers expose <code>Buffer</code> globally,
so you can use it directly:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-13">encoded</span><span class="hl-1"> = </span><span class="hl-12">Buffer</span><span class="hl-1">.</span><span class="hl-0">from</span><span class="hl-1">(</span><span class="hl-2">&#39;hello&#39;</span><span class="hl-1">).</span><span class="hl-0">toString</span><span class="hl-1">(</span><span class="hl-2">&#39;base64&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>След успешната инсталация стартирайте <code>npm run dev</code> отново.</p>
<p>If the error persists, be sure to run TypeScript with this configuration:</p>
<pre><code class="bash"><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">tsc</span><span class="hl-1"> </span><span class="hl-3">--project</span><span class="hl-1"> </span><span class="hl-2">tsconfig.json</span><br/><span class="hl-4"># or</span><br/><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">ts-node</span><span class="hl-1"> </span><span class="hl-3">--project</span><span class="hl-1"> </span><span class="hl-2">tsconfig.json</span><span class="hl-1"> </span><span class="hl-2">worker.js</span>
</code><button type="button">Copy</button></pre>

<h4 id="troubleshooting-cloudflare-ai" class="tsd-anchor-link">Troubleshooting Cloudflare AI<a href="#troubleshooting-cloudflare-ai" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li>Run <code>wrangler secret list</code> and confirm <code>CF_AI_TOKEN</code> is listed.</li>
<li>Ensure the token has <strong>Workers AI: Run</strong> permission.</li>
<li>Check that <code>model_image_analysis</code> points to a valid model:</li>
</ul>
<pre><code class="bash"><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">kv</span><span class="hl-1"> </span><span class="hl-2">key</span><span class="hl-1"> </span><span class="hl-2">get</span><span class="hl-1"> </span><span class="hl-2">model_image_analysis</span><span class="hl-1"> </span><span class="hl-3">--binding=RESOURCES_KV</span>
</code><button type="button">Copy</button></pre>

<p>Example errors:</p>
<pre><code><span class="hl-13">HTTP</span><span class="hl-1"> </span><span class="hl-14">403</span><span class="hl-1"> </span><span class="hl-12">permission</span><span class="hl-1"> </span><span class="hl-15">missing</span><span class="hl-1">: </span><span class="hl-12">Workers</span><span class="hl-1"> </span><span class="hl-15">AI</span><span class="hl-1">: </span><span class="hl-12">Run</span><br/><span class="hl-13">HTTP</span><span class="hl-1"> </span><span class="hl-14">404</span><span class="hl-1"> </span><span class="hl-12">account</span><span class="hl-1"> </span><span class="hl-12">not</span><span class="hl-1"> </span><span class="hl-12">found</span><span class="hl-1"> </span><span class="hl-12">or</span><span class="hl-1"> </span><span class="hl-12">not</span><span class="hl-1"> </span><span class="hl-12">authorized</span><span class="hl-1"> </span><span class="hl-12">to</span><span class="hl-1"> </span><span class="hl-12">access</span><span class="hl-1"> </span><span class="hl-12">account</span>
</code><button>Copy</button></pre>

<h5 id="verify-the-base64-string" class="tsd-anchor-link">Verify the base64 string<a href="#verify-the-base64-string" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><p>You can confirm the input is a valid image by decoding the base64 data locally:</p>
<pre><code class="bash"><span class="hl-0">echo</span><span class="hl-1"> </span><span class="hl-2">&quot;&lt;BASE64&gt;&quot;</span><span class="hl-1"> | </span><span class="hl-0">base64</span><span class="hl-1"> </span><span class="hl-3">--decode</span><span class="hl-1"> &gt; </span><span class="hl-2">test.jpg</span><br/><span class="hl-0">file</span><span class="hl-1"> </span><span class="hl-2">test.jpg</span>
</code><button type="button">Copy</button></pre>

<p>The <code>file</code> output should recognize an image format like JPEG or PNG.
Cloudflare returns <code>Tensor error: failed to decode u8</code> when the data isn't a valid image.</p>
<blockquote>
<p><strong>Note</strong>: При активирано <code>nodejs_compat</code> Cloudflare Workers предоставят <code>Buffer</code> и други Node функции като глобални, така че няма нужда от <code>import</code>.</p>
</blockquote>
<h3 id="generate-documentation" class="tsd-anchor-link">Generate Documentation<a href="#generate-documentation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Create API documentation using Typedoc:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">docs</span>
</code><button type="button">Copy</button></pre>

<p>The output is placed in <code>docs/api</code>. Open <code>docs/api/index.html</code> in your browser to view the API documentation.</p>
<h3 id="template-loading" class="tsd-anchor-link">Template Loading<a href="#template-loading" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Client pages sometimes fetch HTML snippets at runtime. Templates such as
<code>profileTemplate.html</code> and <code>extra-meal-entry-form.html</code> must reside in the same
origin as the application. The helper <code>loadTemplateInto(url, containerId)</code>
rejects cross-origin URLs and sanitizes the response before inserting it into
the page.</p>
<h2 id="deployment-to-cloudflare" class="tsd-anchor-link">Deployment to Cloudflare<a href="#deployment-to-cloudflare" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>A GitHub Action workflow at <code>.github/workflows/deploy.yml</code> deploys the worker manually. Use the <strong>Run workflow</strong> button in the Actions tab to start a deployment. It runs <code>wrangler deploy</code> using the secret <code>CF_API_TOKEN</code> for authentication. Pull requests from forks cannot access the secrets, so those builds will skip deployment.</p>
<blockquote>
<p><strong>Important</strong>: Do <strong>not</strong> run <code>wrangler deploy</code> manually. All production deployments should go through the GitHub Action so the worker version matches the repository history. You can freely use <code>wrangler dev</code> locally for testing, but push your changes to trigger an official deployment.</p>
</blockquote>
<p>To set the token:</p>
<ol>
<li>Generate an API token with <strong>Edit Cloudflare Workers</strong> permissions.</li>
<li>In your repository settings, create a GitHub secret named <code>CF_API_TOKEN</code> containing the token value.</li>
</ol>
<p>The worker configuration is stored in <code>wrangler.toml</code>. Update <code>account_id</code> with your Cloudflare account if needed. For the <code>USER_METADATA_KV</code> namespace the file expects the environment variables <code>USER_METADATA_KV_ID</code> and <code>USER_METADATA_KV_PREVIEW_ID</code>. Configure them as GitHub secrets so the workflow can substitute the correct IDs before deployment. <strong>Важно:</strong> полето <code>compatibility_date</code> не може да сочи в бъдещето спрямо датата на деплой. Ако е зададена по-нова дата, Cloudflare ще откаже деплойването. Затова поддържайте стойност, която е днес или по-стара. Например:</p>
<p>For email notifications you may set <code>MAILER_ENDPOINT_URL</code> to point to a standalone worker or service that performs the delivery. Ако липсва, и работникът, и Node скриптът изпращат заявките до <code>MAIL_PHP_URL</code> чрез <code>fetch</code>.</p>
<pre><code class="toml"><span class="hl-12">compatibility_date</span><span class="hl-1"> = </span><span class="hl-2">&quot;2025-06-20&quot;</span><br/><span class="hl-12">compatibility_flags</span><span class="hl-1"> = [</span><span class="hl-2">&quot;nodejs_compat&quot;</span><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>Препоръчително е периодично (например веднъж годишно) да обновявате тази дата до последна валидна стойност, за да се възползва worker-ът от новите възможности на Cloudflare.
Опцията <code>nodejs_compat</code> активира Node съвместимост и позволява използването на модула <code>buffer</code> без допълнителни зависимости.
В workflow-а има стъпка <code>update-compat-date</code>, която автоматично я коригира, ако е зададена по-нова от днешната.</p>
<p>Пример за промяна в <code>wrangler.toml</code> с дата в миналото:</p>
<pre><code class="toml"><span class="hl-12">compatibility_date</span><span class="hl-1"> = </span><span class="hl-2">&quot;2025-06-20&quot;</span>
</code><button type="button">Copy</button></pre>

<p>You can verify this setup locally by running:</p>
<pre><code class="bash"><span class="hl-0">node</span><span class="hl-1"> </span><span class="hl-2">scripts/validate-wrangler.js</span>
</code><button type="button">Copy</button></pre>

<p>This script checks for placeholder values and for a provided <code>CF_API_TOKEN</code>.</p>
<h3 id="worker-scripts" class="tsd-anchor-link">Worker Scripts<a href="#worker-scripts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The repository contains two Cloudflare workers.</p>
<ul>
<li><code>worker.js</code> – the main application worker defined in <code>wrangler.toml</code>. The GitHub workflow deploys this worker when you run the deployment manually.</li>
<li><code>worker-backend.js</code> – a lightweight proxy used by the PHP backend to call Cloudflare AI. Deploy it separately, for example:</li>
</ul>
<pre><code class="bash"><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">deploy</span><span class="hl-1"> </span><span class="hl-2">worker-backend.js</span><span class="hl-1"> </span><span class="hl-3">--name</span><span class="hl-1"> </span><span class="hl-2">bodybest-backend</span>
</code><button type="button">Copy</button></pre>

<p>Bind the <code>SETTINGS</code> KV namespace and provide <code>CF_AI_TOKEN</code>, <code>CF_ACCOUNT_ID</code> and model variables as secrets.</p>
<p>Заявките към този работник трябва да са <strong>само POST</strong>. При опит с друг метод
ще получите <strong>HTTP 405 Method Not Allowed</strong>:</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">GET</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-backend-ur</span><span class="hl-1">l&gt;</span><br/><span class="hl-4"># =&gt; HTTP/1.1 405 Method Not Allowed</span>
</code><button type="button">Copy</button></pre>

<h3 id="работа-с-kv" class="tsd-anchor-link">Работа с KV<a href="#работа-с-kv" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Можете да управлявате съдържанието на KV директно през <code>wrangler</code>:</p>
<pre><code class="bash"><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">kv</span><span class="hl-1"> </span><span class="hl-2">key</span><span class="hl-1"> </span><span class="hl-2">put</span><span class="hl-1"> &lt;</span><span class="hl-2">клю</span><span class="hl-1">ч&gt; </span><span class="hl-2">&quot;&lt;стойност&gt;&quot;</span><span class="hl-1"> </span><span class="hl-3">--binding=RESOURCES_KV</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">kv</span><span class="hl-1"> </span><span class="hl-2">key</span><span class="hl-1"> </span><span class="hl-2">get</span><span class="hl-1"> &lt;</span><span class="hl-2">клю</span><span class="hl-1">ч&gt; </span><span class="hl-3">--binding=RESOURCES_KV</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">kv</span><span class="hl-1"> </span><span class="hl-2">key</span><span class="hl-1"> </span><span class="hl-2">delete</span><span class="hl-1"> &lt;</span><span class="hl-2">клю</span><span class="hl-1">ч&gt; </span><span class="hl-3">--binding=RESOURCES_KV</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p>За работа с тези команди трябва да имате зададен <code>CF_API_TOKEN</code> или да сте изпълнили <code>wrangler login</code>.</p>
</blockquote>
<p>Заменете <code>RESOURCES_KV</code> с <code>USER_METADATA_KV</code> при нужда. В директорията <code>scripts</code> има примерен Node скрипт <code>manage-kv.js</code>, който изпълнява същите операции:</p>
<pre><code class="bash"><span class="hl-0">node</span><span class="hl-1"> </span><span class="hl-2">scripts/manage-kv.js</span><span class="hl-1"> </span><span class="hl-2">put</span><span class="hl-1"> </span><span class="hl-2">exampleKey</span><span class="hl-1"> </span><span class="hl-2">&quot;примерна стойност&quot;</span><br/><span class="hl-0">node</span><span class="hl-1"> </span><span class="hl-2">scripts/manage-kv.js</span><span class="hl-1"> </span><span class="hl-2">get</span><span class="hl-1"> </span><span class="hl-2">exampleKey</span><br/><span class="hl-0">node</span><span class="hl-1"> </span><span class="hl-2">scripts/manage-kv.js</span><span class="hl-1"> </span><span class="hl-2">delete</span><span class="hl-1"> </span><span class="hl-2">exampleKey</span>
</code><button type="button">Copy</button></pre>

<p>За поправяне на запис от дневника, който съдържа невалиден JSON, може да
използвате помощния скрипт <code>repair-log.js</code>:</p>
<pre><code class="bash"><span class="hl-0">node</span><span class="hl-1"> </span><span class="hl-2">scripts/repair-log.js</span><span class="hl-1"> &lt;</span><span class="hl-2">userI</span><span class="hl-1">d&gt; &lt;</span><span class="hl-2">YYYY-MM-D</span><span class="hl-1">D&gt;</span>
</code><button type="button">Copy</button></pre>

<p>Скриптът изтегля стойността от <code>USER_METADATA_KV</code>, опитва да я поправи с помощта
на <code>jsonrepair</code> и я записва обратно, ако корекцията е успешна.</p>
<p>За преглед на логовете от администраторските операции използвайте <code>view-usage-logs.js</code>:</p>
<pre><code class="bash"><span class="hl-0">node</span><span class="hl-1"> </span><span class="hl-2">scripts/view-usage-logs.js</span><span class="hl-1"> </span><span class="hl-2">sendTestEmail</span><span class="hl-1"> </span><span class="hl-14">5</span>
</code><button type="button">Copy</button></pre>

<p>Скриптът показва последните N записа за зададения тип (<code>sendTestEmail</code> или <code>analyzeImage</code>).</p>
<h3 id="задължителни-ключове-в-resources_kv" class="tsd-anchor-link">Задължителни ключове в <code>RESOURCES_KV</code><a href="#задължителни-ключове-в-resources_kv" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Следните ключове трябва да са налични в KV пространството <code>RESOURCES_KV</code>, за да
работи правилно Cloudflare worker-ът. Стойностите им могат да се качат чрез
<code>wrangler kv key put</code>.</p>
<table>
<thead>
<tr>
<th>Ключ</th>
<th>Предназначение</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>allowed_meal_combinations</code></td>
<td>JSON със списък на позволените комбинации от хранения</td>
</tr>
<tr>
<td><code>base_diet_model</code></td>
<td>Описание на базовия диетичен модел</td>
</tr>
<tr>
<td><code>eating_psychology</code></td>
<td>Текстове с психологически насоки при хранене</td>
</tr>
<tr>
<td><code>model_adaptive_quiz</code></td>
<td>Име на модела за генериране на адаптивни въпросници</td>
</tr>
<tr>
<td><code>model_adaptive_quiz_analysis</code></td>
<td>Модел за анализ на отговорите от адаптивен въпросник</td>
</tr>
<tr>
<td><code>model_chat</code></td>
<td>Модел за чат асистента</td>
</tr>
<tr>
<td><code>model_plan_generation</code></td>
<td>Модел за първоначално генериране на план</td>
</tr>
<tr>
<td><code>model_principle_adjustment</code></td>
<td>Модел за корекция на принципите</td>
</tr>
<tr>
<td><code>model_image_analysis</code></td>
<td>Модел за анализ на изображения</td>
</tr>
<tr>
<td><code>prompt_image_analysis</code></td>
<td>Шаблон за промпт при анализ на изображение</td>
</tr>
<tr>
<td><code>prompt_adaptive_quiz_generation</code></td>
<td>Шаблон за създаване на адаптивен въпросник</td>
</tr>
<tr>
<td><code>prompt_analytics_textual_summary</code></td>
<td>Шаблон за текстов анализ на прогреса</td>
</tr>
<tr>
<td><code>prompt_analyze_quiz_and_suggest_changes</code></td>
<td>Шаблон за анализ на отговорите и предложения за промяна</td>
</tr>
<tr>
<td><code>prompt_chat</code></td>
<td>Шаблон за чат промптове</td>
</tr>
<tr>
<td><code>prompt_praise_generation</code></td>
<td>Шаблон за генериране на похвали</td>
</tr>
<tr>
<td><code>prompt_principle_adjustment</code></td>
<td>Шаблон за промпт при корекция на принципи</td>
</tr>
<tr>
<td><code>prompt_unified_plan_generation_v2</code></td>
<td>Шаблон за унифицирано генериране на план</td>
</tr>
<tr>
<td><code>question_definitions</code></td>
<td>JSON с дефиниции на всички въпроси</td>
</tr>
<tr>
<td><code>recipe_data</code></td>
<td>Данни за примерни рецепти</td>
</tr>
</tbody>
</table>
<p>Примерни команди за добавяне на стойности:</p>
<pre><code class="bash"><span class="hl-4"># качване на шаблон за чат</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">kv</span><span class="hl-1"> </span><span class="hl-2">key</span><span class="hl-1"> </span><span class="hl-2">put</span><span class="hl-1"> </span><span class="hl-2">prompt_chat</span><span class="hl-1"> </span><span class="hl-2">&quot;$(</span><span class="hl-0">cat</span><span class="hl-2"> templates/prompt_chat.txt)&quot;</span><span class="hl-1"> </span><span class="hl-3">--binding=RESOURCES_KV</span><br/><span class="hl-4"># качване на рецепти</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">kv</span><span class="hl-1"> </span><span class="hl-2">key</span><span class="hl-1"> </span><span class="hl-2">put</span><span class="hl-1"> </span><span class="hl-2">recipe_data</span><span class="hl-1"> </span><span class="hl-2">&quot;$(</span><span class="hl-0">cat</span><span class="hl-2"> data/recipes.json)&quot;</span><span class="hl-1"> </span><span class="hl-3">--binding=RESOURCES_KV</span>
</code><button type="button">Copy</button></pre>

<h3 id="required-worker-secrets" class="tsd-anchor-link">Required Worker Secrets<a href="#required-worker-secrets" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Before deploying, configure the following secrets in Cloudflare (via the dashboard or <code>wrangler secret put</code>):</p>
<ul>
<li><code>GEMINI_API_KEY</code></li>
<li><code>тут_ваш_php_api_url_secret_name</code></li>
<li><code>тут_ваш_php_api_token_secret_name</code></li>
<li><code>CF_AI_TOKEN</code> – API token used for Cloudflare AI requests</li>
<li><code>OPENAI_API_KEY</code> – set via <code>wrangler secret put OPENAI_API_KEY</code>, used by <code>worker.js</code></li>
<li><code>FROM_EMAIL</code> – optional sender address for outgoing emails</li>
</ul>
<p>Без тази стойност част от AI функционалностите няма да работят.</p>
<p>Optionally set <code>CF_ACCOUNT_ID</code> via <code>wrangler secret put</code> if it differs from the value in <code>wrangler.toml</code>. Ако липсва, работникът използва стойността от <code>wrangler.toml</code>.</p>
<p>These names are referenced in <code>worker.js</code> and must exist for the worker to function.</p>
<h3 id="allowed-origins" class="tsd-anchor-link">Allowed Origins<a href="#allowed-origins" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The worker and PHP scripts support a custom list of allowed origins for CORS via the
<code>ALLOWED_ORIGINS</code> environment variable. Provide a comma-separated list of
domains from which the application (for example the admin panel) will be
loaded. If the variable is not set, the default list includes
<code>https://radilovk.github.io</code>, <code>https://radilov-k.github.io</code>,
<code>http://localhost:5173</code>, <code>http://localhost:3000</code> and <code>null</code>.</p>
<p>Add the variable in <code>wrangler.toml</code>:</p>
<pre><code class="toml"><span class="hl-1">[vars]</span><br/><span class="hl-12">ALLOWED_ORIGINS</span><span class="hl-1"> = </span><span class="hl-2">&quot;https://admin.example.com,https://myapp.example.com&quot;</span>
</code><button type="button">Copy</button></pre>

<p>This list is combined with the defaults when building the CORS headers.</p>
<h3 id="php-api-environment-variables" class="tsd-anchor-link">PHP API Environment Variables<a href="#php-api-environment-variables" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The PHP helper scripts expect the following variables set in the server environment:</p>
<ul>
<li><code>STATIC_TOKEN</code> – shared secret token used for authentication in <code>file_manager_api.php</code>.</li>
<li><code>CF_API_TOKEN</code> – token used by <code>save-questions.php</code> to update the Cloudflare KV store.</li>
<li><code>ALLOWED_ORIGINS</code> – optional comma-separated list of origins allowed to
access the PHP scripts and <code>worker-backend.js</code>. Defaults match the worker
configuration when not provided.</li>
</ul>
<p>The admin panel по подразбиране използва фиксирани данни за вход – потребителско име <code>admin</code> и парола <code>6131</code>.
Ако е зададенa променлива <code>ADMIN_PASS_HASH</code>, паролата се проверява по нейния bcrypt хеш. Празни стойности на <code>ADMIN_PASS_HASH</code> или <code>ADMIN_USERNAME</code> се игнорират и се използват стандартните данни.
Може да се зададе и <code>ADMIN_USERNAME</code> за друго потребителско име.
Интерфейсът на страницата за вход позволява показване на паролата и опция
&quot;Запомни ме&quot;, която съхранява потребителското име в <code>localStorage</code>.
Ако <code>login.php</code> липсва (напр. при статичен хостинг), скриптът в <code>login.html</code>
ще валидира локално стандартните данни и ще запази сесията в <code>localStorage</code>.
Файлът <code>logout.html</code> изчиства съхранената сесия и пренасочва обратно към
екрана за вход.
Пример за генериране на хеш:</p>
<pre><code class="bash"><span class="hl-0">php</span><span class="hl-1"> </span><span class="hl-3">-r</span><span class="hl-1"> </span><span class="hl-2">&quot;echo password_hash(&#39;yourPassword&#39;, PASSWORD_DEFAULT);&quot;</span>
</code><button type="button">Copy</button></pre>

<h3 id="конфигуриране-на-ai-модели" class="tsd-anchor-link">Конфигуриране на AI модели<a href="#конфигуриране-на-ai-модели" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Администраторският панел включва секция <strong>AI конфигурация</strong>,
която позволява бързо обновяване на използваните AI модели.</p>
<ol>
<li>
<p>Влезте в <code>admin.html</code> с администраторски акаунт.</p>
</li>
<li>
<p>Придвижете се до секцията „AI конфигурация“.</p>
</li>
<li>
<p>В отделните секции можете да задавате освен името на <code>Model</code>
и съответните <code>Prompt</code>, <code>Token limit</code> и <code>Temperature</code> стойности.
За анализа на изображения има задължително поле <em>Prompt</em>,
което ботът използва като основен текст.
Полетата за токени и температура показват динамични подсказки
според въведения модел.</p>
</li>
<li>
<p>Натиснете <strong>Запази</strong> – данните се изпращат към <code>/api/setAiConfig</code>.
При зареждане на страницата същите стойности се четат чрез <code>/api/getAiConfig</code>.</p>
</li>
<li>
<p>Ако работникът е конфигуриран със секрет <code>WORKER_ADMIN_TOKEN</code>,
заявките към <code>/api/setAiConfig</code> трябва да съдържат HTTP заглавка
<code>Authorization: Bearer &lt;токен&gt;</code>. Когато секретът липсва,
проверка не се извършва – полезно за локална разработка.</p>
</li>
<li>
<p>Можете да запазвате и зареждате комбинации от модели като &quot;пресети&quot;.
Списъкът се зарежда чрез <code>/api/listAiPresets</code>, конкретен пресет – чрез
<code>/api/getAiPreset</code>, а нов пресет се създава с POST заявка към
<code>/api/saveAiPreset</code>. Валидирането на токена при този ендпойнт
също се пропуска, ако няма зададен секрет.</p>
</li>
<li>
<p>До всяко поле за модел има бутон <strong>Тествай</strong>. С него се изпраща кратка заявка
към <code>/api/testAiModel</code>, която проверява връзката с избрания AI модел и
показва грешка при проблем с комуникацията.</p>
<p>Пример: за да използвате Cloudflare LLaVA за анализ на изображения,
въведете <code>@cf/llava-hf/llava-v1.6b</code> в полето <em>Model Image Analysis</em>.
Това записва стойността като KV ключ <code>model_image_analysis</code> и позволява
използването на LLaVA при заявки към <code>/api/analyzeImage</code>.</p>
<p>Същото може да се зададе и през CLI:</p>
<pre><code class="bash">
</code><button type="button">Copy</button></pre>

</li>
</ol>
<p>wrangler kv key put model_image_analysis &quot;@cf/llava-hf/llava-v1.6b&quot; --binding=RESOURCES_KV</p>
<pre><code><br/><span class="hl-1">&gt; **</span><span class="hl-12">Note</span><span class="hl-1">**: </span><span class="hl-12">Всички</span><span class="hl-1"> </span><span class="hl-12">Cloudflare</span><span class="hl-1"> </span><span class="hl-13">AI</span><span class="hl-1"> </span><span class="hl-12">модели</span><span class="hl-1"> </span><span class="hl-12">за</span><span class="hl-1"> </span><span class="hl-12">анализ</span><span class="hl-1"> </span><span class="hl-12">на</span><span class="hl-1"> </span><span class="hl-12">изображения</span><span class="hl-1"> </span><span class="hl-12">приемат</span><span class="hl-1"> </span><span class="hl-13">JSON</span><span class="hl-1"> </span><span class="hl-12">с</span><br/><span class="hl-1">&gt; </span><span class="hl-12">полета</span><span class="hl-1"> </span><span class="hl-2">`prompt`</span><span class="hl-1"> </span><span class="hl-12">и</span><span class="hl-1"> </span><span class="hl-2">`image`</span><span class="hl-1"> (</span><span class="hl-12">data</span><span class="hl-1"> </span><span class="hl-13">URL</span><span class="hl-1">) </span><span class="hl-12">вместо</span><span class="hl-1"> </span><span class="hl-2">`messages`</span><span class="hl-1">.</span><br/><span class="hl-1">&gt; </span><span class="hl-12">Пример</span><span class="hl-1"> </span><span class="hl-12">за</span><span class="hl-1"> </span><span class="hl-12">директно</span><span class="hl-1"> </span><span class="hl-12">извикване</span><span class="hl-1"> </span><span class="hl-12">през</span><span class="hl-1"> </span><span class="hl-2">`env.AI.run`</span><span class="hl-1">:</span><br/><br/><span class="hl-2">```javascript</span><br/><span class="hl-2">const result = await env.AI.run(&#39;@cf/llava-hf/llava-v1.6b&#39;, {</span><br/><span class="hl-2">  prompt: &#39;Опиши какво виждаш&#39;,</span><br/><span class="hl-2">  image: `</span><span class="hl-15">data</span><span class="hl-1">:</span><span class="hl-12">image</span><span class="hl-1">/</span><span class="hl-12">png</span><span class="hl-1">;</span><span class="hl-12">base64</span><span class="hl-1">,</span><span class="hl-12">$</span><span class="hl-1">{</span><span class="hl-12">base64</span><span class="hl-1">}</span><span class="hl-2">`</span><br/><span class="hl-2">});</span>
</code><button>Copy</button></pre>

<p>Кратък пример с <code>fetch</code> към Cloudflare AI:</p>
<pre><code class="javascript"><span class="hl-11">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-13">CF_URL</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-12">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-12">headers:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-12">Authorization:</span><span class="hl-1"> </span><span class="hl-2">`Bearer </span><span class="hl-3">${</span><span class="hl-13">CF_AI_TOKEN</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-12">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-12">body:</span><span class="hl-1"> </span><span class="hl-13">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-12">prompt:</span><span class="hl-1"> </span><span class="hl-2">&#39;Опиши какво виждаш&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-12">image:</span><span class="hl-1"> </span><span class="hl-2">`data:image/png;base64,</span><span class="hl-3">${</span><span class="hl-12">base64</span><span class="hl-3">}</span><span class="hl-2">`</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>По същия начин може да подадете изображение към всеки Cloudflare AI модел
чрез JSON обект от вида:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;image&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;data:image/jpeg;base64,&lt;BASE64&gt;&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;prompt&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;INPUT PROMPT&quot;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Администраторският скрипт <code>admin.js</code> добавя автоматично тази
заглавка, ако в <code>sessionStorage</code> съществува ключ <code>adminToken</code>.
Стойността може да зададете от панела в полето „Admin Token“,
което я записва в <code>sessionStorage</code>. Може и ръчно да я зададете през конзолата:</p>
<pre><code class="javascript"><span class="hl-12">sessionStorage</span><span class="hl-1">.</span><span class="hl-0">setItem</span><span class="hl-1">(</span><span class="hl-2">&#39;adminToken&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;&lt;вашият токен&gt;&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Токените за моделите вече се задават единствено като <em>worker secrets</em>.
Панелът не записва ключове в KV и отговаря само за имената на моделите.
Самият <code>WORKER_ADMIN_TOKEN</code> също не може да се редактира през панела –
необходимо е да го зададете като <em>worker secret</em> преди деплой.</p>
<h3 id="chat-assistant" class="tsd-anchor-link">Chat Assistant<a href="#chat-assistant" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The standalone page <code>assistant.html</code> allows you to send direct commands to the worker.
Open the file in a browser, enter your message and it will call the <code>/api/chat</code> endpoint.
The Cloudflare account ID is filled automatically from <code>config.js</code>.
Use the small image button next to the send icon to upload a picture. The file is sent to <code>/api/analyzeImage</code> and the analysis appears as a bot reply.
The admin panel (<code>admin.html</code>) also provides a <strong>Test Image Analysis</strong> form that sends a selected picture to <code>/api/analyzeImage</code> and shows the JSON response.</p>
<p>Some models require a short license confirmation before you can send other messages. Start the conversation with:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;messages&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">    { </span><span class="hl-16">&quot;role&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">, </span><span class="hl-16">&quot;content&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;agree&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">  ]</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>After this step you can send regular prompts and images to the model.</p>
<p>For multi-modal requests combining an image with text, use the following
structure:</p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;messages&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">    { </span><span class="hl-16">&quot;role&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">, </span><span class="hl-16">&quot;content&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;agree&quot;</span><span class="hl-1"> },</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-16">&quot;role&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;user&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-16">&quot;content&quot;</span><span class="hl-1">: [</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">          </span><span class="hl-16">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;image_url&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-16">&quot;image_url&quot;</span><span class="hl-1">: { </span><span class="hl-16">&quot;url&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        {</span><br/><span class="hl-1">          </span><span class="hl-16">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;text&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-16">&quot;text&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;Опиши подробно какво има на изображението. Ако има медицински детайли, анализирай ги.&quot;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      ]</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  ]</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Example test request with <code>curl</code>:</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-2">https://api.cloudflare.com/client/v4/accounts/</span><span class="hl-1">&lt;</span><span class="hl-2">CF_ACCOUNT_I</span><span class="hl-1">D&gt;</span><span class="hl-2">/ai/run/@cf/meta/llama-3.2-11b-instruct</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Authorization: Bearer &lt;CF_AI_TOKEN&gt;&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;messages&quot;:[{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;Здравей&quot;}]}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Replace the placeholders with your own values and keep the token secret.</p>
<p>In addition to text messages you can upload an image for automatic analysis.
Open <code>assistant.html</code>, choose a file and it will be converted to a full data URL
and sent to <code>/api/analyzeImage</code> as JSON with fields <code>userId</code>, <code>image</code> and an
optional <code>prompt</code> describing what you want to see. Malformed Base64 will return
&quot;Невалиден Base64 стринг.&quot;. You can convert a file in the browser using
FileReader:</p>
<pre><code class="javascript"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-13">reader</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">FileReader</span><span class="hl-1">();</span><br/><span class="hl-12">reader</span><span class="hl-1">.</span><span class="hl-0">onload</span><span class="hl-1"> = () </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-0">send</span><span class="hl-1">({</span><span class="hl-12">image:</span><span class="hl-1"> </span><span class="hl-12">reader</span><span class="hl-1">.</span><span class="hl-12">result</span><span class="hl-1">});</span><br/><span class="hl-12">reader</span><span class="hl-1">.</span><span class="hl-0">readAsDataURL</span><span class="hl-1">(</span><span class="hl-12">file</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>You can also generate a Base64 string via shell:</p>
<pre><code class="bash"><span class="hl-0">base64</span><span class="hl-1"> </span><span class="hl-3">-w0</span><span class="hl-1"> </span><span class="hl-2">image.jpg</span><span class="hl-1"> &gt; </span><span class="hl-2">base64.txt</span>
</code><button type="button">Copy</button></pre>

<p>The worker forwards the image data together with your text prompt to the
configured vision model and returns a JSON summary describing the detected
objects or text. По подразбиране ендпойнтът е отворен и не изисква <code>WORKER_ADMIN_TOKEN</code>.</p>
<p>Example <code>curl</code> request sending both image and text:</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">POST</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-domai</span><span class="hl-1">n&gt;</span><span class="hl-2">/api/analyzeImage</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;userId&quot;:&quot;123&quot;,&quot;image&quot;:&quot;data:image/jpeg;base64,&lt;base64&gt;&quot;,&quot;prompt&quot;:&quot;Намери текст&quot;}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>The worker also accepts a <code>data:</code> URL directly:</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">POST</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-domai</span><span class="hl-1">n&gt;</span><span class="hl-2">/api/analyzeImage</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;userId&quot;:&quot;123&quot;,&quot;image&quot;:&quot;data:image/png;base64,&lt;base64&gt;&quot;,&quot;prompt&quot;:&quot;Опиши&quot;}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Add the <code>Authorization</code> header only ако сте активирали защита с <code>WORKER_ADMIN_TOKEN</code>.</p>
<p>For Cloudflare models set <code>CF_AI_TOKEN</code>. When using Gemini Vision provide
<code>GEMINI_API_KEY</code>. Without these secrets the endpoint will respond with an error.</p>
<p>Example with the Cloudflare LLaVA model (KV key <code>model_image_analysis=@cf/llava-hf/llava-v1.6b</code>):</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">POST</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-domai</span><span class="hl-1">n&gt;</span><span class="hl-2">/api/analyzeImage</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;userId&quot;:&quot;123&quot;,&quot;image&quot;:&quot;data:image/png;base64,&lt;base64&gt;&quot;,&quot;prompt&quot;:&quot;Опиши подробно&quot;}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Добавете <code>Authorization</code> заглавка само при активен <code>WORKER_ADMIN_TOKEN</code>.</p>
<p>Пример с новия ендпойнт за байтов масив:</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">POST</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-domai</span><span class="hl-1">n&gt;</span><span class="hl-2">/api/runImageModel</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;model&quot;:&quot;@cf/llava-hf/llava-1.5-7b-hf&quot;,&quot;prompt&quot;:&quot;Какво има?&quot;,&quot;image&quot;:[1,2,3]}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Този ендпойнт приема само POST заявки. При друг метод ще получите статус 405.</p>
<h3 id="промяна-на-началното-съобщение-в-чата" class="tsd-anchor-link">Промяна на началното съобщение в чата<a href="#промяна-на-началното-съобщение-в-чата" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Текстът, който се показва при първо отваряне на чата, се намира в <code>js/config.js</code>
под формата на променлива <code>initialBotMessage</code>. Можете да редактирате този файл
или временно да презапишете стойността чрез конзолата:</p>
<pre><code class="javascript"><span class="hl-12">localStorage</span><span class="hl-1">.</span><span class="hl-0">setItem</span><span class="hl-1">(</span><span class="hl-2">&#39;initialBotMessage&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;Добре дошли!&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>След презареждане на страницата чатът ще използва новото съобщение.</p>
<h2 id="допълнителни-функции" class="tsd-anchor-link">Допълнителни функции<a href="#допълнителни-функции" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><strong>Извънредно хранене</strong> – бутонът &quot;Добави извънредно хранене&quot; в <code>code.html</code> отваря модалната форма <code>extra-meal-entry-form.html</code>. Логиката в <code>js/extraMealForm.js</code> изпраща данните към <code>/api/log-extra-meal</code> в <code>worker.js</code>.</li>
<li><strong>Изследвания</strong> – POST заявки към <code>/api/uploadTestResult</code> и <code>/api/uploadIrisDiag</code> записват данни за проведени тестове или ирисова диагностика в KV и създават събитие за автоматична адаптация на плана.</li>
<li><strong>Промяна на план</strong> – когато в чата се открие заявка за модификация, в KV се записва ключ <code>event_planMod_&lt;userId&gt;</code>. Планираната Cron задача извиква <code>processPendingUserEvents</code>, който обработва тези събития и стартира ново генериране на плана.</li>
<li><strong>AI помощник</strong> – POST заявка към <code>/api/aiHelper</code> изпраща последните логове на потребителя към модела <code>@cf/meta/llama-3-8b-instruct</code> в Cloudflare AI и връща текстово обобщение.</li>
<li><strong>Генериране на похвала</strong> – логиката съхранява моментна снимка на анализите в ключ <code>&lt;userId&gt;_last_praise_analytics</code> и добавя ново постижение само когато напредъкът превишава евентуално влошаване, а ИТМ остава в здравословни граници.</li>
<li><strong>Нови съобщения/обратна връзка</strong> – в заглавието на администраторския панел се показва червена точка, когато има непотвърдени запитвания или нова обратна връзка. Проверява се автоматично през минута чрез <code>/api/peekAdminQueries</code> и <code>/api/getFeedbackMessages</code>.</li>
</ul>
<p>Ендпойнтът <code>/api/peekAdminQueries</code> връща списък с неприключени запитвания, без да ги маркира като прочетени. Използва се основно за показване на индикатора, докато <code>/api/getAdminQueries</code> обновява флага <code>read</code> при зареждане на данните.</p>
<h3 id="нови-api-ендпойнти" class="tsd-anchor-link">Нови API ендпойнти<a href="#нови-api-ендпойнти" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>
<p><code>POST /api/acknowledgeAiUpdate</code> – маркира резюмето от AI като прочетено.</p>
</li>
<li>
<p><code>GET /api/getPlanModificationPrompt</code> – връща шаблона и модела за промяна на плана.</p>
</li>
<li>
<p><code>GET /api/getAchievements</code> – връща списък с получените постижения.</p>
</li>
<li>
<p><code>POST /api/generatePraise</code> – създава мотивационно съобщение.</p>
</li>
<li>
<p><code>POST /api/recordFeedbackChat</code> – отбелязва, че автоматичният чат е разгледан.</p>
</li>
<li>
<p><code>POST /api/submitFeedback</code> – изпраща обратна връзка от клиента.</p>
</li>
<li>
<p><code>GET /api/getAiConfig</code> – зарежда текущата AI конфигурация.</p>
</li>
<li>
<p><code>POST /api/setAiConfig</code> – записва токени и модели в <code>RESOURCES_KV</code>.</p>
</li>
<li>
<p><code>GET /api/listAiPresets</code> – връща имената на записаните AI конфигурации.</p>
</li>
<li>
<p><code>GET /api/getAiPreset</code> – връща данните за конкретен пресет.</p>
</li>
<li>
<p><code>POST /api/saveAiPreset</code> – съхранява нов пресет или обновява съществуващ.</p>
</li>
<li>
<p><code>POST /api/testAiModel</code> – проверява връзката с конкретен AI модел.</p>
</li>
<li>
<p><code>POST /api/analyzeImage</code> – анализира качено изображение и връща резултат. Изпращайте поле <code>image</code> с пълен <code>data:</code> URL. Ендпойнтът не изисква <code>WORKER_ADMIN_TOKEN</code>, освен ако изрично не сте го добавили като защита.</p>
</li>
<li>
<p><code>POST /api/runImageModel</code> – изпраща байтовете на изображение към избран Cloudflare AI модел. Заявката приема <code>{ &quot;model&quot;: &quot;@cf/llava-hf/llava-1.5-7b-hf&quot;, &quot;prompt&quot;: &quot;Описание&quot;, &quot;image&quot;: [..] }</code> и връща JSON от <code>env.AI.run</code>. При заявки с друг метод се връща статус 405.</p>
</li>
<li>
<p><code>POST /api/sendTestEmail</code> – изпраща тестов имейл. Изисква администраторски токен.</p>
</li>
<li>
<p><code>POST /api/sendEmail</code> – изпраща имейл чрез PHP бекенда. Изисква HTTP заглавка <code>Authorization: Bearer &lt;WORKER_ADMIN_TOKEN&gt;</code> и приема JSON <code>{ &quot;to&quot;: &quot;user@example.com&quot;, &quot;subject&quot;: &quot;Тема&quot;, &quot;text&quot;: &quot;Съобщение&quot; }</code>. Заявките са ограничени до няколко на минута.</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">POST</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-domai</span><span class="hl-1">n&gt;</span><span class="hl-2">/api/testAiModel</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Authorization: Bearer &lt;WORKER_ADMIN_TOKEN&gt;&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;model&quot;:&quot;@cf/meta/llama-3-8b-instruct&quot;}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Възможен е отговор <strong>HTTP 500</strong>, ако името на модела е невалидно или липсват
необходимите Cloudflare AI секрети. Имената на моделите трябва да са във
формата <code>@cf/...</code> и да съвпадат с наличните модели в Cloudflare.</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">POST</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-domai</span><span class="hl-1">n&gt;</span><span class="hl-2">/api/sendTestEmail</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Authorization: Bearer &lt;WORKER_ADMIN_TOKEN&gt;&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;recipient&quot;:&quot;user@example.com&quot;,&quot;subject&quot;:&quot;Test&quot;,&quot;body&quot;:&quot;Hello&quot;}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Полетата <code>recipient</code>, <code>subject</code> и <code>body</code> са задължителни. Като алтернатива
могат да се използват имената <code>to</code>, <code>text</code> или <code>message</code>.</p>
<pre><code class="bash"><span class="hl-0">curl</span><span class="hl-1"> </span><span class="hl-3">-X</span><span class="hl-1"> </span><span class="hl-2">POST</span><span class="hl-1"> </span><span class="hl-2">https://</span><span class="hl-1">&lt;</span><span class="hl-2">your-domai</span><span class="hl-1">n&gt;</span><span class="hl-2">/api/sendTestEmail</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Authorization: Bearer &lt;WORKER_ADMIN_TOKEN&gt;&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">-H</span><span class="hl-1"> </span><span class="hl-2">&quot;Content-Type: application/json&quot;</span><span class="hl-1"> </span><span class="hl-5">\</span><br/><span class="hl-1">  </span><span class="hl-3">--data</span><span class="hl-1"> </span><span class="hl-2">&#39;{&quot;to&quot;:&quot;someone@example.com&quot;,&quot;subject&quot;:&quot;Тест&quot;,&quot;message&quot;:&quot;Здравей&quot;}&#39;</span>
</code><button type="button">Copy</button></pre>

<pre><code class="javascript"><span class="hl-11">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">&#39;/api/sendTestEmail&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-12">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-12">headers:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-12">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-12">Authorization:</span><span class="hl-1"> </span><span class="hl-2">`Bearer </span><span class="hl-3">${</span><span class="hl-13">WORKER_ADMIN_TOKEN</span><span class="hl-3">}</span><span class="hl-2">`</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-12">body:</span><span class="hl-1"> </span><span class="hl-13">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-12">to:</span><span class="hl-1"> </span><span class="hl-2">&#39;someone@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-12">subject:</span><span class="hl-1"> </span><span class="hl-2">&#39;Тест&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-12">message:</span><span class="hl-1"> </span><span class="hl-2">&#39;Здравей&#39;</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>Ако <code>MAILER_ENDPOINT_URL</code> не е зададен, работникът използва <code>sendEmailWorker.js</code>
и изпраща данните директно към <code>MAIL_PHP_URL</code>.</p>
</li>
<li>
<p><strong>Дебъг логове</strong> – при изпращане на заглавие <code>X-Debug: 1</code> към който и да е API
ендпойнт, worker-ът записва в конзолата кратка информация за заявката.</p>
</li>
</ul>
<h3 id="промяна-на-плана" class="tsd-anchor-link">Промяна на плана<a href="#промяна-на-плана" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Процесът за актуализиране на хранителния план вече протича в два последователни етапа:</p>
<ol>
<li>Натиснете бутона <strong>Въведи промени</strong> в секцията „Инструменти за Индивидуализация&quot; на страницата <code>code.html</code>. Ще се отвори модален прозорец <em>Промяна на план</em>.</li>
<li>В полето за чат опишете желаните корекции и натиснете <strong>Изпрати</strong>. След потвърждение от асистента започва генериране на нов план. Докато процесът тече, до бутона се показва въртяща се иконка. Когато новият план е готов, съдържанието на таблото се обновява автоматично.
Съобщенията от този модален чат включват параметър <code>source: 'planModChat'</code> към <code>/api/chat</code>. Worker-ът създава събитие за модификация само когато получи този флаг, така че стандартният чат не стартира процеса.</li>
</ol>
<p>Можете да повторите стъпка 1 по всяко време при нужда от нови промени.</p>
<ul>
<li>
<p><strong>Пример за запис в KV</strong></p>
<pre><code class="json"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;testResult&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;userId&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;u1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;status&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;pending&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;createdTimestamp&quot;</span><span class="hl-1">: </span><span class="hl-14">1710000000000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-16">&quot;payload&quot;</span><span class="hl-1">: { </span><span class="hl-17">...</span><span class="hl-1"> }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</li>
</ul>
<p>Полето <code>status</code> обозначава текущия етап на обработка (напр. <code>pending</code>, <code>done</code>),
а <code>createdTimestamp</code> съдържа UNIX време на създаване в милисекунди.</p>
<h2 id="email-notifications" class="tsd-anchor-link">Email Notifications<a href="#email-notifications" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The worker can send emails in two ways:</p>
<ol>
<li>If <code>MAILER_ENDPOINT_URL</code> is set, requests are forwarded to that endpoint
(for example a standalone worker) which handles the actual delivery.</li>
<li>Otherwise the worker calls <code>sendEmailWorker.js</code>, който изпраща
заявката към <code>MAIL_PHP_URL</code>.</li>
</ol>
<p>In both cases the <code>/api/sendTestEmail</code> endpoint behaves the same and returns a
JSON response indicating success or failure.
A status <strong>500</strong> typically means the PHP backend or your external service
failed and should be investigated via the worker logs.</p>
<p>To enable real emails:</p>
<ol>
<li>Deploy <code>sendEmailWorker.js</code> with Wrangler and note the public URL that it
prints after deployment.</li>
<li>Set <code>MAILER_ENDPOINT_URL=&lt;worker-url&gt;</code> either in your environment or inside
<code>wrangler.toml</code>.</li>
</ol>
<p>Example <code>.env</code> snippet:</p>
<pre><code class="env">MAILER_ENDPOINT_URL=https://send-email-worker.example.workers.dev
</code><button type="button">Copy</button></pre>

<p>Example in <code>wrangler.toml</code>:</p>
<pre><code class="toml"><span class="hl-1">[vars]</span><br/><span class="hl-12">MAILER_ENDPOINT_URL</span><span class="hl-1"> = </span><span class="hl-2">&quot;https://send-email-worker.example.workers.dev&quot;</span>
</code><button type="button">Copy</button></pre>

<p>For a simple setup deploy <code>sendEmailWorker.js</code>, който излага <code>/api/sendEmail</code>.
Point <code>MAILER_ENDPOINT_URL</code> към URL адреса на този worker,
за да може основният сервис да изпраща имейли без Node.js.
Requests to this endpoint also require the admin token and are rate limited.</p>
<p>И <code>worker.js</code>, и помощният скрипт <code>mailer.js</code> изпращат заявките към <code>MAIL_PHP_URL</code>
чрез вградената функция <code>fetch</code>. Така няма нужда от допълнителни зависимости.
Можете да стартирате <code>mailer.js</code> като самостоятелен процес или да го промените
според вашия бекенд.</p>
<h3 id="email-environment-variables" class="tsd-anchor-link">Email Environment Variables<a href="#email-environment-variables" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>To send a test email задайте <code>WORKER_ADMIN_TOKEN</code>. Може да посочите <code>MAILER_ENDPOINT_URL</code> към отделен worker или да оставите променливата празна, за да се използва директно <code>MAIL_PHP_URL</code>. Опционалната <code>FROM_EMAIL</code> променя подателя.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MAILER_ENDPOINT_URL</code></td>
<td>Endpoint called by <code>worker.js</code> when sending emails. If omitted, the worker posts to <code>sendEmailWorker.js</code>.</td>
</tr>
<tr>
<td><code>MAIL_PHP_URL</code></td>
<td>Legacy PHP endpoint if you prefer your own backend. Defaults to <code>https://mybody.best/mailer/mail.php</code>.</td>
</tr>
<tr>
<td><code>EMAIL_PASSWORD</code></td>
<td>Password used by <code>mailer.js</code> when authenticating with the SMTP server.</td>
</tr>
<tr>
<td><code>FROM_EMAIL</code></td>
<td>Sender address used by <code>mailer.js</code> and the PHP backend.</td>
</tr>
<tr>
<td><code>WELCOME_EMAIL_SUBJECT</code></td>
<td>Optional custom subject for welcome emails sent by <code>mailer.js</code>.</td>
</tr>
<tr>
<td><code>WELCOME_EMAIL_BODY</code></td>
<td>Optional HTML body template for welcome emails. The string <code>{{name}}</code> will be replaced with the recipient's name.</td>
</tr>
<tr>
<td><code>WORKER_URL</code></td>
<td>Base URL of the main worker used by <code>mailer.js</code> to fetch email templates when no subject or body is provided.</td>
</tr>
</tbody>
</table>
<p>Проверете стойностите така:</p>
<pre><code class="bash"><span class="hl-4"># показва тайните записани за работника</span><br/><span class="hl-0">wrangler</span><span class="hl-1"> </span><span class="hl-2">secret</span><span class="hl-1"> </span><span class="hl-2">list</span><br/><br/><span class="hl-4"># или прегледайте локалния .env файл</span><br/><span class="hl-0">grep</span><span class="hl-1"> </span><span class="hl-2">MAIL_PHP_URL</span><span class="hl-1"> </span><span class="hl-2">.env</span>
</code><button type="button">Copy</button></pre>

<p>Примерен PHP скрипт за изпращане на писма е наличен в <a href="media/mail_smtp.php">docs/mail_smtp.php</a>. Настройте <code>MAIL_PHP_URL</code> да сочи към същия или сходен адрес.</p>
<h3 id="php-script-requirements" class="tsd-anchor-link">PHP script requirements<a href="#php-script-requirements" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The file <code>docs/mail_smtp.php</code> relies on <strong>PHPMailer</strong> for SMTP. Install it via Composer:</p>
<pre><code class="bash"><span class="hl-0">composer</span><span class="hl-1"> </span><span class="hl-2">require</span><span class="hl-1"> </span><span class="hl-2">phpmailer/phpmailer</span>
</code><button type="button">Copy</button></pre>

<p>The script expects <code>vendor/autoload.php</code> to reside one directory above the PHP file (<code>require __DIR__ . '/../vendor/autoload.php';</code>). Ensure the <code>vendor</code> folder is placed accordingly to avoid &quot;Failed opening required&quot; errors.</p>
<h2 id="cron-configuration" class="tsd-anchor-link">Cron configuration<a href="#cron-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Cloudflare позволява изпълнение на работници по зададен график.
За да създадете Cron trigger:</p>
<ol>
<li>Отворете <strong>Workers &amp; Pages</strong> в Cloudflare dashboard и изберете своя worker.</li>
<li>В раздел <strong>Triggers</strong> → <strong>Cron Triggers</strong> натиснете <strong>Add Cron Trigger</strong>.</li>
<li>Въведете израз като <code>0 */1 * * *</code>, който ще задейства работника на всеки час.</li>
</ol>
<p>При активиране на Cron тригера Cloudflare извиква <code>scheduled</code> хендлъра в <code>worker.js</code>,
което позволява автоматично обновяване на плановете.</p>
<p>Без активен Cron тригер събитията за промяна на плана остават необработени.
За да стартирате автоматично обновяване на плановете, добавете Cron израз
<code>*/15 * * * *</code> в Cloudflare Workers.</p>
<p>Можете да опишете графика и директно във <code>wrangler.toml</code>:</p>
<pre><code class="toml"><span class="hl-1">[triggers]</span><br/><span class="hl-12">crons</span><span class="hl-1"> = [</span><span class="hl-2">&quot;0 */1 * * *&quot;</span><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>Файлът <code>wrangler.toml</code> се използва от GitHub Actions и от <code>wrangler deploy</code>,
затова добавеният блок ще приложи същия график и при автоматичното деплойване.</p>
<h2 id="license" class="tsd-anchor-link">License<a href="#license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This project is licensed under the ISC license. See <a href="media/LICENSE">LICENSE</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#bodybest"><span>Body<wbr/>Best</span></a><ul><li><a href="#development-setup"><span>Development <wbr/>Setup</span></a></li><li><ul><li><a href="#start-development-server"><span>Start <wbr/>Development <wbr/>Server</span></a></li><li><a href="#build"><span>Build</span></a></li><li><a href="#lint"><span>Lint</span></a></li><li><a href="#type-check"><span>Type <wbr/>Check</span></a></li><li><a href="#инсталация-на-зависимости"><span>Инсталация на зависимости</span></a></li><li><a href="#test"><span>Test</span></a></li><li><a href="#coverage"><span>Coverage</span></a></li><li><a href="#registration-module-example"><span>Registration <wbr/>Module <wbr/>Example</span></a></li><li><a href="#отстраняване-на-проблеми"><span>Отстраняване на проблеми</span></a></li><li><ul><li><a href="#troubleshooting-cloudflare-ai"><span>Troubleshooting <wbr/>Cloudflare <wbr/>AI</span></a></li><li><ul><li><a href="#verify-the-base64-string"><span>Verify the base64 string</span></a></li></ul></li></ul></li><li><a href="#generate-documentation"><span>Generate <wbr/>Documentation</span></a></li><li><a href="#template-loading"><span>Template <wbr/>Loading</span></a></li></ul></li><li><a href="#deployment-to-cloudflare"><span>Deployment to <wbr/>Cloudflare</span></a></li><li><ul><li><a href="#worker-scripts"><span>Worker <wbr/>Scripts</span></a></li><li><a href="#работа-с-kv"><span>Работа с <wbr/>KV</span></a></li><li><a href="#задължителни-ключове-в-resources_kv"><span>Задължителни ключове в <wbr/>RESOURCES_<wbr/>KV</span></a></li><li><a href="#required-worker-secrets"><span>Required <wbr/>Worker <wbr/>Secrets</span></a></li><li><a href="#allowed-origins"><span>Allowed <wbr/>Origins</span></a></li><li><a href="#php-api-environment-variables"><span>PHP <wbr/>API <wbr/>Environment <wbr/>Variables</span></a></li><li><a href="#конфигуриране-на-ai-модели"><span>Конфигуриране на <wbr/>AI модели</span></a></li><li><a href="#chat-assistant"><span>Chat <wbr/>Assistant</span></a></li><li><a href="#промяна-на-началното-съобщение-в-чата"><span>Промяна на началното съобщение в чата</span></a></li></ul></li><li><a href="#допълнителни-функции"><span>Допълнителни функции</span></a></li><li><ul><li><a href="#нови-api-ендпойнти"><span>Нови <wbr/>API ендпойнти</span></a></li><li><a href="#промяна-на-плана"><span>Промяна на плана</span></a></li></ul></li><li><a href="#email-notifications"><span>Email <wbr/>Notifications</span></a></li><li><ul><li><a href="#email-environment-variables"><span>Email <wbr/>Environment <wbr/>Variables</span></a></li><li><a href="#php-script-requirements"><span>PHP script requirements</span></a></li></ul></li><li><a href="#cron-configuration"><span>Cron configuration</span></a></li><li><a href="#license"><span>License</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">bodybest</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
