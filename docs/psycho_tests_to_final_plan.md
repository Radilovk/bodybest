# Автоматично запазване на психопрофил в final_plan

## Описание

Резултатите от психологическите тестове (визуален и личностен) автоматично се запазват във `final_plan` KV записа, за да бъдат лесно достъпни при зареждане на плана.

## Как работи

### 1. При попълване на психотест

Когато потребителят попълни визуален или личностен тест, данните се запазват на три места:

1. **`{userId}_analysis`** - Пълен анализ с психопрофил данни (съществуваща функционалност)
2. **`{userId}_psych_tests`** - Сурови данни от тестовете (съществуваща функционалност)
3. **`{userId}_final_plan`** - Компактен психопрофил в съществуващия план (НОВО)

### 2. Структура на данните във final_plan

Добавена е нова секция `psychoTestsProfile` към final_plan обекта:

```json
{
  "profileSummary": "...",
  "caloriesMacros": {...},
  "week1Menu": {...},
  "psychoTestsProfile": {
    "lastUpdated": "2025-01-15T10:30:00Z",
    "visualTest": {
      "profileId": "v1",
      "profileName": "Визуален профил име",
      "profileShort": "Кратко описание",
      "mainPsycho": ["Перфекционизъм", "Контрол"],
      "mainHabits": ["Строго броене на калории", "Избягване на социални събития"],
      "mainRisks": ["Ортонексия", "Социална изолация"],
      "timestamp": "2025-01-15T10:00:00Z"
    },
    "personalityTest": {
      "typeCode": "E-V-M-J",
      "scores": {
        "E": 75,
        "C": 70,
        "O": 80,
        "A": 65,
        "N": 60,
        "I": 45,
        "R": 40
      },
      "riskFlags": ["Висока емоционална реактивност"],
      "strengths": ["Добра самодисциплина", "Отвореност към ново"],
      "mainRisks": ["Рестриктивни тенденции", "Прекалена фиксация върху чистотата"],
      "topRecommendations": ["Практикувайте гъвкавост в храненето", "Работете с нутриционист", "Позволете си 10-20% удоволствие"],
      "timestamp": "2025-01-15T10:30:00Z"
    }
  }
}
```

### 3. Съхранени данни

Запазват се **основните параметри и съдържателни обобщения** за всеки тест:

#### Визуален тест:
- `profileId` - ID на профила
- `profileName` - Име на профила
- `profileShort` - Кратко описание
- `mainPsycho` - Масив с основни психологически характеристики (първите 2)
- `mainHabits` - Масив с основни хранителни навици (първите 2)
- `mainRisks` - Масив с основни рискови области (първите 2)
- `timestamp` - Време на тестване

#### Личностен тест:
- `typeCode` - Код на личностния тип (напр. "E-V-M-J")
- `scores` - Обект със скоровете по измерения (E, C, O, A, N, I, R)
- `riskFlags` - Масив от рискови флагове (напр. "Висока импулсивност")
- `strengths` - Масив със силни страни (напр. "Добра самодисциплина")
- `mainRisks` - Масив с основни рискови области (първите 2)
- `topRecommendations` - Масив с топ препоръки (първите 3)
- `timestamp` - Време на тестване

### 4. При генериране на нов план

Когато се генерира нов план през `processSingleUserPlan`, системата:

1. Проверява за съществуващи данни в `{userId}_initial_answers.psychTests`
2. Ако намери такива, добавя `psychoTestsProfile` към новогенерирания план
3. Логва операцията в план generation log-а

## Предимства

1. **Единна точка за достъп** - Цялата информация за плана (включително психопрофил) е на едно място
2. **Ефективност** - Не е нужно да се правят допълнителни заявки към `_analysis` или `_psych_tests`
3. **Съдържателност** - Запазват се обобщенията от анализа за лесна интерпретация
4. **Обратна съвместимост** - Старите планове без `psychoTestsProfile` продължават да работят

## API промени

### handleSavePsychTestsRequest

Върнатият обект включва ново поле:

```javascript
{
  success: true,
  message: "Резултатите от тестовете са запазени успешно.",
  data: {
    visualTestSaved: true,
    personalityTestSaved: true,
    addedToFinalPlan: true,        // НОВО: дали е добавено към final_plan
    shouldRegeneratePlan: false,    // false ако addedToFinalPlan е true
    timestamp: "2025-01-15T10:30:00Z"
  }
}
```

## Тестване

Добавени са автоматични тестове в `tests/psychTestsStorage.spec.js`:

- ✅ Автоматично добавяне към съществуващ final_plan
- ✅ Препоръка за регенериране когато няма final_plan
- ✅ Валидация на структурата на данните
- ✅ Проверка за правилно съхранение на всички полета

## Съвместимост

- Работи с всички съществуващи планове
- При липса на психопрофил данни, `psychoTestsProfile` не се добавя
- Не прекъсва генерирането на план при грешка в психопрофил операциите

## Логове

Операциите се логват в следните места:

1. **Console log**: `SAVE_PSYCH_TESTS (userId): Психо профил данни добавени към final_plan успешно.`
2. **Plan generation log**: `"Психо профил данни добавени към плана"`
3. **Warning log** (при грешка): `PROCESS_USER_PLAN_WARN (userId): Не успя добавянето на психо профил към плана`

## Миграция на стари данни

Старите планове (без `psychoTestsProfile`):
- Няма нужда от миграция
- При следващо регенериране на плана, данните ще се добавят автоматично
- При ново попълване на психотест, данните се добавят автоматично
