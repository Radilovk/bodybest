# Корелация между въпросника и алгоритмите за анализ

Този документ описва как всеки въпрос от въпросника се използва в анализите и алгоритмите на системата.

## Съдържание

1. [Основни данни](#основни-данни)
2. [Сън, ритъм и активност](#сън-ритъм-и-активност)
3. [Прием на течности](#прием-на-течности)
4. [Хранене и поведение](#хранене-и-поведение)
5. [Хранителни предпочитания](#хранителни-предпочитания)
6. [Медицинско състояние](#медицинско-състояние)
7. [Формули и индекси](#формули-и-индекси)

---

## Основни данни

### Име (`name`)
- **Тип:** Свободен текст
- **Използване:** Персонализация на комуникацията (имейли, чат, похвали)
- **Индекс:** Няма директен индекс

### Пол (`gender`)
- **Тип:** Radio (Мъж/Жена)
- **Използване в `estimateMacros`:**
  - BMR изчисление (Mifflin-St Jeor): +5 за мъже, -161 за жени
  - `bmr = 10 * weight + 6.25 * height - 5 * age + (gender === 'male' ? 5 : -161)`
- **Влияние:** TDEE калории, макронутриентни цели

### Възраст (`age`)
- **Тип:** Число (години)
- **Диапазон:** 10-120
- **Използване в `estimateMacros`:**
  - BMR формула: `-5 * age`
- **Влияние:** Метаболитна скорост, калорийни нужди

### Ръст (`height`)
- **Тип:** Число (см)
- **Диапазон:** 100-250
- **Използване в `estimateMacros`:**
  - BMR формула: `+6.25 * height`
- **Използване в `calculateBmiScore`:**
  - BMI = weight / (height/100)²
- **Влияние:** Калорийни нужди, BMI индекс

### Тегло (`weight`)
- **Тип:** Число (кг)
- **Диапазон:** 30-300
- **Използване в `estimateMacros`:**
  - BMR формула: `+10 * weight`
- **Използване в `calculateBmiScore`:**
  - BMI изчисление
- **Използване в `calculateAnalyticsIndexes`:**
  - `goalProgress` за цел "отслабване": `(initialWeight - currentWeight) / targetLossKg * 100`
- **Влияние:** BMI индекс, прогрес към целта

### Имейл (`email`)
- **Тип:** Email
- **Използване:** Регистрация, нотификации, възстановяване на парола
- **Индекс:** Няма директен индекс

### Основна цел (`goal`)
- **Тип:** Radio
- **Опции:** Подобряване на здравето, Отслабване, Оформяне, Покачване на мускулна маса, Антиейджинг
- **Използване в `estimateMacros`:**
  ```javascript
  // Калорийна корекция
  if (goal === 'отслабване') calorieAdjustment = -300 to -500
  if (goal === 'покачване') calorieAdjustment = +250
  
  // Макро разпределение
  if (goal === 'отслабване') { protein: 35%, carbs: 35%, fat: 30% }
  if (goal === 'покачване') { protein: 25%, carbs: 45%, fat: 30% }
  if (goal === 'антиейджинг') { protein: 30%, carbs: 35%, fat: 35% }
  ```
- **Използване в `calculateAnalyticsIndexes`:**
  - `goalProgress` се изчислява различно за всяка цел
- **Влияние:** Основен детерминант на хранителния план

### Желани килограми за сваляне (`lossKg`)
- **Тип:** Число
- **Диапазон:** 1-100
- **Условие:** Показва се само при цел "Отслабване"
- **Използване:**
  - Калориен дефицит: >10кг = -500kcal, 5-10кг = -400kcal, <5кг = -300kcal
  - `goalProgress` = `actualLoss / targetLossKg * 100`

---

## Сън, ритъм и активност

### Часове сън (`sleepHours`)
- **Тип:** Radio
- **Опции:** Под 5, 5–6, 6–7, 7–8, Над 8
- **Използване в `calculateAnalyticsIndexes`:**
  - Част от `detailedAnalyticsMetrics` (sleep_quality)
  - Влияе на `overallHealthScore`
- **Тегло:** 15% в overallHealthScore

### Прекъсвания на съня (`sleepInterrupt`)
- **Тип:** Radio (Да/Не)
- **Използване:** Допълнителен фактор за качество на съня
- **Показва се в:** `initialValueText` на sleep_quality метрика

### Хронотип (`chronotype`)
- **Тип:** Radio (Сутрешен/Вечерен/Неутрален)
- **Използване:** AI персонализация на времена за хранене
- **Влияние:** Разпределение на храненията през деня

### Ниво на дневна активност (`dailyActivityLevel`)
- **Тип:** Radio (Ниско/Средно/Високо)
- **Използване в `estimateMacros`:**
  ```javascript
  dailyFactors = { 'ниско': 1.2, 'средно': 1.375, 'високо': 1.55 }
  ```
- **Влияние:** TDEE множител

### Ниво на стрес (`stressLevel`)
- **Тип:** Radio (Ниско/Средно/Високо)
- **Използване в `calculateAnalyticsIndexes`:**
  - Част от `detailedAnalyticsMetrics` (stress_level)
  - Влияе на `overallHealthScore`
- **Тегло:** 10% в overallHealthScore (като calmness)

### Ниво на спортна активност (`sportActivity`)
- **Тип:** Radio
- **Опции:** Висока (5–7 дни), Средна (2–4 дни), Ниска (1–2 дни), Никаква (0 дни)
- **Използване в `estimateMacros`:**
  ```javascript
  sportBonus = { 'висока': 0.2, 'средна': 0.1, 'ниска': 0.05, 'никаква': 0 }
  totalFactor = baseFactor + sportBonus
  ```
- **Влияние:** TDEE калории, макро разпределение при отслабване

---

## Прием на течности

### Дневна хидратация (`waterIntake`)
- **Тип:** Radio
- **Опции:** под 1 л, 1–1.5 л, 1.5–2 л, над 2 л
- **Използване в `calculateAnalyticsIndexes`:**
  - Част от `detailedAnalyticsMetrics` (hydration_status)
  - Влияе на `overallHealthScore`
- **Тегло:** 10% в overallHealthScore

### Сокове и газирани напитки (`drinksSweet`)
- **Тип:** Radio
- **Опции:** Не консумирам, Рядко, Често, Много често
- **Използване:** AI анализ, препоръки за намаляване
- **Влияние:** Индиректно на калориен прием

### Алкохол (`drinksAlcohol`)
- **Тип:** Radio
- **Опции:** Не консумирам, Рядко, Често, Много често
- **Използване:** AI анализ, препоръки
- **Влияние:** Калориен прием, здравословни препоръки

---

## Хранене и поведение

### Рязко покачване на тегло (`weightChange`)
- **Тип:** Radio (Не/Да)
- **Използване:** Психологически профил, AI анализ
- **Влияние:** Препоръки за стратегии за отслабване

### Детайли за покачване (`weightChangeDetails`)
- **Тип:** Textarea
- **Условие:** Показва се при "Да"
- **Използване:** AI анализ на хранителна история

### Диета последната година (`dietHistory`)
- **Тип:** Radio (Не/Да)
- **Използване:** AI анализ, избор на подход

### Тип диета (`dietType`)
- **Тип:** Text
- **Условие:** Показва се при dietHistory = "Да"
- **Използване в `estimateMacros`:**
  - Проверка за кето/нисковъглехидратна история
  - Влияе на макро разпределението

### Резултат от диетата (`dietResult`)
- **Тип:** Textarea
- **Условие:** Показва се при dietHistory = "Да"
- **Използване:** AI анализ на ефективност на предишни подходи

### Преяждане (`overeatingFrequency`)
- **Тип:** Radio
- **Опции:** Постоянно, Често, Понякога, Рядко, Никога
- **Използване:** AI психологически профил
- **Влияние:** Стратегии за контрол на порциите

### Нужда от храни (`foodCravings`)
- **Тип:** Checkbox (множествен избор)
- **Опции:** Сладко, Тестени храни, Бургери/дюнери, Чипс/снакс, Друго
- **Използване:** AI анализ на cravings
- **Влияние:** Препоръки за здравословни заместители

### Тригери за храна (`foodTriggers`)
- **Тип:** Checkbox
- **Опции:** Напрежение, Скука, Тъга, Социални събития, Нито едно, Друго
- **Използване:** Психологически профил
- **Влияние:** Стратегии за справяне с емоционално хранене

### Хранителни навици (`eatingHabits`)
- **Тип:** Checkbox
- **Опции:** Не закусвам, Хапвам на крак, Храня се предимно вечер, и др.
- **Използване:** AI персонализация
- **Влияние:** Структура на хранителния план

### Методи за компенсация (`compensationMethods`)
- **Тип:** Checkbox
- **Опции:** Гладуване, Спорт, Хапчета за отслабване, Друго, Не
- **Използване:** Скрининг за нездравословни практики
- **Влияние:** Препоръки, предпазни мерки

### Сравнение с други (`socialComparison`)
- **Тип:** Radio
- **Опции:** Постоянно, Често, Понякога, Рядко, Никога
- **Използване:** Психологически профил
- **Влияние:** Мотивационни стратегии

---

## Хранителни предпочитания

### Диетични предпочитания (`dietPreference`)
- **Тип:** Checkbox
- **Опции:** Вегетарианска, Средиземноморска, Кето, Веган, Сезонна, Фастинг, Високопротеинова
- **Използване в `estimateMacros`:**
  ```javascript
  if (isKeto) { protein: 25%, carbs: 10%, fat: 65% }
  if (isHighProtein) { protein: +10% (max 40%) }
  ```
- **Влияние:** Макро разпределение, избор на храни

### Непоносимост/алергии (`dietDislike`)
- **Тип:** Textarea
- **Използване:** AI генериране на план
- **Влияние:** Изключване на храни от плана

### Любими храни (`dietLove`)
- **Тип:** Textarea
- **Използване:** AI генериране на план
- **Влияние:** Включване на предпочитани храни

---

## Медицинско състояние

### Медицински състояния (`medicalConditions`)
- **Тип:** Checkbox
- **Опции:** Инсулинова резистентност, Диабет, Хашимото, Депресия, Тревожност, IBS, IBD, Алергии, Автоимунно, Рефлукс, Друго, Нямам
- **Използване:** AI анализ, специални препоръки
- **Влияние:** 
  - Адаптация на макроси (напр. нисък GI за диабет)
  - Изключване на проблемни храни
  - Специфични хранителни добавки

### Лекарства/добавки (`medications`)
- **Тип:** Radio (Да/Не) + детайли
- **Използване:** AI анализ на взаимодействия
- **Влияние:** Препоръки за добавки, предупреждения

### Допълнителни бележки (`additionalNotes`)
- **Тип:** Textarea
- **Използване:** AI контекст
- **Влияние:** Персонализация на плана

---

## Формули и индекси

### 1. BMR (Basal Metabolic Rate) - Mifflin-St Jeor

```
BMR = 10 × тегло(кг) + 6.25 × ръст(см) - 5 × възраст + S
където S = +5 за мъже, -161 за жени
```

### 2. TDEE (Total Daily Energy Expenditure)

```
TDEE = BMR × (dailyActivityFactor + sportActivityBonus)

dailyActivityFactor:
- Ниско: 1.2
- Средно: 1.375
- Високо: 1.55

sportActivityBonus:
- Висока (5-7 дни): +0.2
- Средна (2-4 дни): +0.1
- Ниска (1-2 дни): +0.05
- Никаква: 0
```

### 3. BMI Score (0-100)

```
BMI = тегло / (ръст/100)²

Score:
- 18.5-25 (нормално): 100
- <18.5: плавно намаление до 5
- 25-27: 100 → 80
- 27-30: 80 → 60
- 30-35: 60 → 40
- 35-40: 40 → 20
- 40-45: 20 → 5
- >45: 5
```

### 4. Overall Health Score

```
overallHealthScore = 
  (moodScore × 0.15) +
  (energyScore × 0.15) +
  (calmnessScore × 0.10) +
  (sleepScore × 0.15) +
  (hydrationScore × 0.10) +
  (bmiScore × 0.20) +
  (engagementScore × 0.15)
```

### 5. Engagement Score

```
engagementScore = 
  (mealAdherence × 0.4) +
  (indexCompletionRate × 0.4) +
  (logCompletionRate × 0.2) +
  streakBonus +
  qualityBonus

streakBonus:
- 7+ дни: +10
- 3-6 дни: +5
- <3 дни: 0

qualityBonus:
- ≥4 индекса/ден: +5
- ≥3 индекса/ден: +2
- <3: 0
```

### 6. Goal Progress

За "Отслабване":
```
rawProgress = (initialWeight - currentWeight) / targetLossKg
if (rawProgress < 0.5) goalProgress = rawProgress × 120
else goalProgress = 60 + ((rawProgress - 0.5) × 80)
```

За "Покачване на мускулна маса":
```
goalProgress = (currentWeight - initialWeight) / targetGainKg × 100
```

За "Поддържане":
```
deviation = |currentWeight - targetWeight|
if (deviation ≤ 3%) goalProgress = 100
else плавно намаление
```

---

## Визуализация на корелациите

```
┌─────────────────────────────────────────────────────────────────┐
│                    ВЪПРОСНИК                                     │
├─────────────────────────────────────────────────────────────────┤
│ Основни данни                                                    │
│   ├── weight, height, age, gender → BMR, BMI                     │
│   ├── goal → Калорийна корекция, Макро разпределение             │
│   └── lossKg → goalProgress                                      │
├─────────────────────────────────────────────────────────────────┤
│ Активност                                                        │
│   ├── dailyActivityLevel → TDEE фактор                           │
│   └── sportActivity → TDEE бонус, Макро корекция                 │
├─────────────────────────────────────────────────────────────────┤
│ Хранителни предпочитания                                         │
│   ├── Кето → Нисък carbs%                                        │
│   ├── Високопротеинова → Висок protein%                          │
│   └── Други → AI план персонализация                             │
├─────────────────────────────────────────────────────────────────┤
│ Дневни логове                                                    │
│   ├── mood, energy, calmness → overallHealthScore                │
│   ├── sleep, hydration → overallHealthScore                      │
│   └── mealAdherence → engagementScore                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ИЗХОДНИ ИНДЕКСИ                               │
├─────────────────────────────────────────────────────────────────┤
│ ✓ goalProgress (0-100%)                                          │
│ ✓ engagementScore (0-100%)                                       │
│ ✓ overallHealthScore (0-100%)                                    │
│ ✓ BMI Score (0-100)                                              │
│ ✓ Detailed Analytics Metrics                                     │
│   ├── sleep_quality                                              │
│   ├── stress_level (calmness)                                    │
│   ├── energy_level                                               │
│   ├── hydration_status                                           │
│   ├── bmi_status                                                 │
│   ├── meal_adherence                                             │
│   ├── index_completion                                           │
│   └── log_consistency                                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## Бележки за разработчици

1. **Съвместимост:** Кодът поддържа както новите (`sportActivity`, `dietDislike`), така и старите (`sportActivityLevel`, `foodPreferenceDisliked`) имена на полета за обратна съвместимост.

2. **Добавяне на нов въпрос:**
   - Добавете в `questions.json`
   - Ако е required, добавете в `requiredFields` в `questionnaireCore.js`
   - Ако е числов с ограничения, добавете в `numericRanges`
   - Актуализирайте `estimateMacros` или `calculateAnalyticsIndexes` ако влияе на изчисления

3. **Промяна на формула:**
   - `estimateMacros` - в `worker.js` за калории и макроси
   - `calculateAnalyticsIndexes` - в `worker.js` за здравни индекси
   - `calculateBmiScore` - в `worker.js` за BMI score

4. **Тестване:**
   - Тестовете в `tests/estimateMacros.test.js` покриват макро изчисленията
   - Тестовете в `js/__tests__/` покриват UI компонентите
