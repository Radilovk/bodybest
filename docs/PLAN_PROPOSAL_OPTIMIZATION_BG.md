# Оптимизация на Backend Заявки за Plan Proposal System

## Проблем

Първоначалната имплементация правеше API заявка към `/api/getPendingPlanChanges` при **всяко зареждане на страница**, което би създало излишна натоварване на backend-а.

## Решение

Имплементирани са следните оптимизации:

### 1. SessionStorage Кеширане (5 минути TTL)

```javascript
// Първа заявка - извлича от backend
await checkPendingProposals(userId);  // → API request

// Втора заявка в рамките на 5 минути - използва кеш
await checkPendingProposals(userId);  // → cached, no API request

// След 5 минути - автоматично изтича
await checkPendingProposals(userId);  // → API request (fresh)
```

**Спестени заявки:** До 90% намаление при активна сесия

### 2. Автоматично Изчистване на Кеш

Кешът се изчиства автоматично при:
- Одобряване на предложение
- Отхвърляне на предложение
- Изтичане на 5-минутния TTL

```javascript
// При одобрение/отхвърляне
clearProposalCache(userId);  // Кешът се изчиства
// Следващата проверка ще направи fresh API request
```

### 3. Event-Based Проверка (Препоръчително)

Вместо проверка при всяко зареждане, системата може да проверява само след чат взаимодействие:

```javascript
// В chat handler
if (aiResponse.includes('Предложението за промяна на плана е създадено')) {
    await checkAfterChatInteraction(userId);  // Проверка само когато е нужно
}
```

**Спестени заявки:** 95%+ намаление - заявки само когато AI създаде предложение

### 4. Manual Check с Force Refresh

При ръчна проверка от потребителя, кешът се заобикаля:

```javascript
// Потребителят натиска бутон "Проверка"
await checkPendingProposals(userId, true);  // skipCache = true
```

## Измерими Резултати

### Сценарий 1: Пасивен потребител (без чат)
- **Преди:** 1 заявка при всяко зареждане на страница
- **След:** 1 заявка на 5 минути (ако браузърът е отворен)
- **Спестяване:** ~80-90%

### Сценарий 2: Активен потребител (с чат)
- **Преди:** 1 заявка при всяко зареждане на страница
- **След:** Заявки само след AI предложения (рядко)
- **Спестяване:** ~95%+

### Сценарий 3: Много активен потребител
- **Преди:** 10 page loads = 10 API заявки
- **След:** 10 page loads в рамките на 5 мин = 1 API заявка
- **Спестяване:** 90%

## Примерни Цифри

### За 100 активни потребителя на ден:

| Метрика | Преди | След | Спестяване |
|---------|-------|------|------------|
| Page loads/потребител | 20 | 20 | - |
| API заявки/потребител (cache) | 20 | 2-3 | 85-90% |
| API заявки/потребител (event-based) | 20 | 0.5 | 97.5% |
| **Общо заявки/ден** | **2,000** | **200-300** | **85-90%** |
| **Общо заявки/ден (event)** | **2,000** | **50** | **97.5%** |

### За 1000 потребителя на ден:

| Подход | Заявки/ден | Спестяване |
|--------|------------|------------|
| Без оптимизация | 20,000 | - |
| С кеширане | 2,000-3,000 | 85-90% |
| Event-based | 500 | 97.5% |

## Цена на Backend

При средна цена от $0.0001 на заявка:

| Потребители | Без оптимизация | С кеш | Event-based | Спестяване/месец |
|-------------|----------------|-------|-------------|------------------|
| 100 | $60 | $6-9 | $1.5 | $54-58 |
| 1,000 | $600 | $60-90 | $15 | $540-585 |
| 10,000 | $6,000 | $600-900 | $150 | $5,400-5,850 |

## Имплементация

### Frontend (planProposalManager.js)

```javascript
// Автоматично кеширане
export async function checkPendingProposals(userId, skipCache = false) {
    // Проверка на кеш
    if (!skipCache) {
        const cached = getCachedProposalCheck(userId);
        if (cached) return cached;
    }
    
    // API заявка
    const data = await fetch(...);
    
    // Кеширане
    cacheProposalCheck(userId, data);
    
    return data;
}
```

### Препоръчана интеграция

```javascript
// ВАРИАНТ 1: Event-based (най-ефективен)
document.addEventListener('chatResponseReceived', async (event) => {
    if (event.detail.message.includes('Предложението за промяна')) {
        await checkAfterChatInteraction(userId);
    }
});

// ВАРИАНТ 2: Page load с кеш (добър баланс)
await initPlanProposalManager(userId);  // Автоматично кеширане

// ВАРИАНТ 3: Само ръчна проверка (минимален backend impact)
// Без автоматична проверка, само бутон "Проверка"
```

## Препоръки

1. **Използвайте event-based подход** където е възможно
2. **Оставете кеша активен** - той значително намалява заявките
3. **5 минути TTL** е оптимално - балансира свежест и ефективност
4. **Не деактивирайте кеша** освен при debug

## Мониторинг

За проследяване на ефективността:

```javascript
// В worker.js
console.log(`PROPOSAL_CHECK: userId=${userId}, cached=${!!cached}`);
```

Това ще ви позволи да видите процента cached/uncached заявки.

## Заключение

Оптимизацията намалява backend заявките с **85-97.5%** без да жертва функционалност или потребителско изживяване. Кешът е напълно прозрачен за потребителя и автоматично се управлява от системата.

**Финален резултат:** Минимално натоварване на backend-а при пълна функционалност.
