<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <!-- –ö–ª—é—á –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–í—ä–ø—Ä–æ—Å–Ω–∏–∫ –∑–∞ —Ö—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –Ω–∞–≤–∏—Ü–∏ (Dynamic)</title>
  <style type="text/css">
    /* –û—Å–Ω–æ–≤–µ–Ω —Å—Ç–∏–ª ‚Äì –∑–∞–ø–∞–∑–µ–Ω –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∞—Ç–∞ –≤–µ—Ä—Å–∏—è —Å –¥–æ–ø—ä–ª–Ω–µ–Ω–∏—è –∑–∞ –º–æ–±–∏–ª–Ω–æ—Å—Ç */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #E0E0E0;
      overflow-x: hidden;
    }
    .container {
      max-width: 600px;
      margin: 60px auto 20px;
      padding: 20px;
      background-color: #1e1e1e;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
    }
    .question-text {
      font-size: 18px;
      color: #80cbc4;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    .answer-label {
      font-size: 16px;
      line-height: 1.4;
      margin-bottom: 8px;
      display: block;
    }
    h1, h2 {
      text-align: center;
      color: #80cbc4;
      margin-bottom: 20px;
    }
    p {
      text-align: center;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    /* –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä */
    #progressContainer {
      width: 100%;
      background-color: #333;
      height: 10px;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #4fc3a1;
      transition: width 0.4s ease;
    }
    /* –í—Å—è–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–µ —Å—ä—Å—Ç–æ–∏ –æ—Ç "–µ–∫—Ä–∞–Ω" */
    .page {
      display: none;
      animation: fadeIn 0.4s ease-in-out;
    }
    .page.active {
      display: block;
    }
    /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∏ –±—É—Ç–æ–Ω–∏ */
    .nav-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      background-color: #4fc3a1;
      color: #121212;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      min-height: 48px;
    }
    button:hover {
      background-color: #43a088;
      box-shadow: 0 0 10px #80cbc4;
    }
    input[type="text"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      width: 93%;
      padding: 10px;
      margin: 10px 0 20px;
      border: 1px solid #333;
      border-radius: 5px;
      background-color: #1e1e1e;
      color: #E0E0E0;
    }
    input[type="radio"],
    input[type="checkbox"] {
      margin-right: 6px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 600px) {
      .container {
        margin: 80px 15px 20px;
        padding: 15px;
      }
      .nav-buttons button {
        width: 100%;
      }
      .question-text {
        font-size: 16px;
      }
      button {
        font-size: 16px;
        min-height: 52px;
      }
    }
  </style>
</head>
<body>

<!-- –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä -->
<div id="progressContainer">
  <div id="progressBar"></div>
</div>

<div class="container" id="dynamicContainer">
  <!-- –î–∏–Ω–∞–º–∏—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏—Ç–µ "—Å—Ç—Ä–∞–Ω–∏—Ü–∏" —â–µ —Å–µ –≤–º—ä–∫–Ω–∞—Ç —Ç—É–∫ -->
</div>

<!-- –¢–∞–π–Ω–∞ –∑–æ–Ω–∞ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞ Admin –¥–æ—Å—Ç—ä–ø -->
<div id="secretTapArea" style="position: fixed; top: 0; left: 0; width: 30px; height: 30px; opacity: 0; z-index: 9999;"></div>

<!-- –°–∫—Ä–∏—Ç Admin –±—É—Ç–æ–Ω -->
<a href="admin.html" id="adminLink" style="display:none; position: fixed; bottom: 10px; right: 10px; background: #4fc3a1; color: #121212; padding: 5px 10px; border-radius: 5px; text-decoration: none;">
  Admin
</a>

<script>
  /***** –ì–ª–æ–±–∞–ª–Ω–∏ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ *****/
  let rawQuestions = [];     // –°—É—Ä–æ–≤–∏—è—Ç –º–∞—Å–∏–≤ –æ—Ç questions.json (–π–µ—Ä–∞—Ä—Ö–∏—á–µ–Ω)
  let flatPages = [];        // –ü–ª–æ—Å—ä–∫ –º–∞—Å–∏–≤ –æ—Ç –≤—Å–∏—á–∫–∏ –≤—ä–ø—Ä–æ—Å–∏ (—Å–ª–µ–¥ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å–ø–ª–µ—Å–∫–≤–∞–Ω–µ)
  let currentPageIndex = 0;
  let totalPages = 0;
  const responses = {};

  /***** –§—É–Ω–∫—Ü–∏—è –∑–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å–ø–ª–µ—Å–∫–≤–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏—Ç–µ *****/
  function flattenQuestions(questions) {
    let output = [];
    questions.forEach(q => {
      let qCopy = Object.assign({}, q);
      delete qCopy.children;
      output.push(qCopy);
      if (q.children && Array.isArray(q.children)) {
        // –ê–∫–æ children –µ –º–∞—Å–∏–≤ (–∑–∞ –ø–æ-–ø—Ä–æ—Å—Ç–∏ —Å–ª—É—á–∞–∏)
        output = output.concat(flattenQuestions(q.children));
      } else if (q.children && typeof q.children === 'object') {
        for (const answer in q.children) {
          let childArray = q.children[answer];
          if (Array.isArray(childArray)) { // –î–æ–±–∞–≤–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –µ –º–∞—Å–∏–≤
             childArray.forEach(child => {
                child.dependency = { question: q.id, value: answer };
             });
             output = output.concat(flattenQuestions(childArray));
          } else {
             console.warn(`Expected an array for children under key '${answer}' in question '${q.id}', but got:`, typeof childArray);
          }
        }
      }
    });
    return output;
  }

  /***** –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–≥—Ä–∞–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∏—Ç–µ *****/
  function buildDynamicPages() {
    const container = document.getElementById('dynamicContainer');
    if (!container) {
        console.error("Container #dynamicContainer not found!");
        return;
    }
    container.innerHTML = ""; // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

    createStartPage();
    flatPages = flattenQuestions(rawQuestions);

    if (!flatPages.find(q => q.id === 'email')) {
        console.error("–ö—Ä–∏—Ç–∏—á–Ω–∞ –≥—Ä–µ—à–∫–∞: –í—ä–ø—Ä–æ—Å —Å id 'email' –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω –≤ questions.json. –¢–æ–π –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ.");
        // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –≥—Ä–µ—à–∫–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
        container.innerHTML = `<div style="color: #e74c3c; text-align: center; padding: 20px;">–ì—Ä–µ—à–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ –≤—ä–ø—Ä–æ—Å–Ω–∏–∫–∞ (–ª–∏–ø—Å–≤–∞ –ø–æ–ª–µ –∑–∞ –∏–º–µ–π–ª). –ú–æ–ª—è, —Å–≤—ä—Ä–∂–µ—Ç–µ —Å–µ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.</div>`;
        return; // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ –∏–∑–≥—Ä–∞–∂–¥–∞–Ω–µ—Ç–æ
    }

    flatPages.forEach((q, idx) => {
      createQuestionPage(q, idx + 1);
    });
    createFinalPage();
    setupFinalPageListener(); // –ù–∞—Å—Ç—Ä–æ–π–≤–∞–º–µ listener-–∞ —Å–ª–µ–¥ –∫–∞—Ç–æ —Ñ–∏–Ω–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞

    totalPages = 1 + flatPages.length + 1; // –°—Ç–∞—Ä—Ç–æ–≤–∞ + –í—ä–ø—Ä–æ—Å–∏ + –§–∏–Ω–∞–ª–Ω–∞
    console.log("–û–±—â–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∏ (–≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ —Å—Ç–∞—Ä—Ç –∏ —Ñ–∏–Ω–∞–ª):", totalPages);

    showPage(0); // –ü–æ–∫–∞–∑–≤–∞–º–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
  }

  /***** –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ *****/
  function createStartPage() {
    const container = document.getElementById('dynamicContainer');
    if (!container) return;
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page';
    pageDiv.id = 'page0';
    pageDiv.innerHTML = `
      <h1>–î–æ–±—Ä–µ –¥–æ—à–ª–∏!<br><br>
        <span style="font-family:Verdana,Geneva,sans-serif;">
          <span style="font-size:24px;">–ù–µ–∫–∞ –∑–∞–µ–¥–Ω–æ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏–º –ø—ä—Ä–≤–∞—Ç–∞ —Å—Ç—ä–ø–∫–∞ –∫—ä–º –í–∞—à–µ—Ç–æ –ø–æ-–¥–æ–±—Ä–æ –ê–∑</span>
        </span>
      </h1>
      <p><span style="font-size:48px;">üå±</span></p>
      <h1>
        <span style="color:#ecf0f1;">
          <span style="font-size:18px;">
            <span style="font-family:Verdana,Geneva,sans-serif;">
              –¢–æ–∑–∏ –≤—ä–ø—Ä–æ—Å–Ω–∏–∫ —â–µ –ø–æ–º–æ–≥–Ω–µ –∑–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ –í–∞—à–∏—è—Ç –ø–ª–∞–Ω —Å —Ö—Ä–∞–Ω–µ–Ω–µ –∏ —Å—ä–≤–µ—Ç–∏. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞ –ø–æ-–¥–æ–ª—É, –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ.
            </span>
          </span>
        </span>
      </h1>
      <div class="nav-buttons">
        <button type="button" id="startBtn">–ó–∞–ø–æ—á–Ω–∏</button> <!-- –î–æ–±–∞–≤–µ–Ω type="button" -->
      </div>
    `;
    container.appendChild(pageDiv);
    const startBtn = pageDiv.querySelector('#startBtn');
    if (startBtn) {
        startBtn.addEventListener('click', () => {
          console.log("–ë—É—Ç–æ–Ω '–ó–∞–ø–æ—á–Ω–∏' –µ –Ω–∞—Ç–∏—Å–Ω–∞—Ç.");
          showPage(1); // –ü—Ä–µ–º–∏–Ω–∞–≤–∞–º–µ –∫—ä–º –ø—ä—Ä–≤–∏—è –≤—ä–ø—Ä–æ—Å
        });
    } else {
        console.error("Start button not found on start page.");
    }
  }

  /***** –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞ –≤—Å–µ–∫–∏ –≤—ä–ø—Ä–æ—Å *****/
  function createQuestionPage(question, pageIndex) {
    const container = document.getElementById('dynamicContainer');
     if (!container || !question || !question.id) {
         console.error("Missing container or question data for page", pageIndex);
         return;
     };
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page';
    pageDiv.id = 'page' + pageIndex;
    let html = `<div class="question-text">${question.text || '–õ–∏–ø—Å–≤–∞ —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞'}</div>`;

    const isRequired = (question.id === 'email'); // –ü—Ä–∏–º–µ—Ä –∑–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ø–æ–ª–µ

    if (['text','number','email'].includes(question.type)) {
      html += `<input id="${question.id}" type="${question.type}" placeholder="" ${isRequired ? 'required' : ''} ${question.type === 'email' ? 'autocomplete="email"' : ''}>`;
    } else if (question.type === 'textarea') {
      html += `<textarea id="${question.id}" rows="4" ${isRequired ? 'required' : ''}></textarea>`;
    } else if (question.type === 'select') {
      html += `<select id="${question.id}" ${isRequired ? 'required' : ''}><option value="">–ò–∑–±–µ—Ä–µ—Ç–µ</option>`;
      (question.options || []).forEach(opt => {
        html += `<option value="${String(opt)}">${String(opt)}</option>`; // –ü—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞–º–µ –∫—ä–º —Å—Ç—Ä–∏–Ω–≥ –∑–∞ –≤—Å–µ–∫–∏ —Å–ª—É—á–∞–π
      });
      html += `</select>`;
    } else if (question.type === 'radio') {
      (question.options || []).forEach((opt, index) => {
          const optionValue = String(opt); // –£–≤–µ—Ä—è–≤–∞–º–µ —Å–µ, —á–µ –µ —Å—Ç—Ä–∏–Ω–≥
        html += `<label class="answer-label">
                   <input name="${question.id}" type="radio" value="${optionValue}" ${isRequired && index === 0 ? 'required' : ''}> ${optionValue}
                 </label>`;
      });
    } else if (question.type === 'checkbox') {
      (question.options || []).forEach(opt => {
          const optionValue = String(opt);
        html += `<label class="answer-label">
                   <input name="${question.id}" type="checkbox" value="${optionValue}"> ${optionValue}
                 </label>`;
      });
    } else {
        console.warn(`Unsupported question type: ${question.type} for question ID: ${question.id}`);
        html += `<p style="color: red;">–ì—Ä–µ—à–∫–∞: –ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ç–∏–ø –≤—ä–ø—Ä–æ—Å.</p>`;
    }

    if (question.dependency) {
      html += `<div style="font-size:12px; color:#aaa; margin-top: 10px;">(–ü–æ–∫–∞–∑–≤–∞ —Å–µ –∞–∫–æ '${question.dependency.question}' –µ '${question.dependency.value}')</div>`;
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∏ –±—É—Ç–æ–Ω–∏
    html += `<div class="nav-buttons">
               <button type="button" id="nextBtn${pageIndex}">–ù–∞–ø—Ä–µ–¥ ‚ñ∂</button>
               ${pageIndex > 1 ? `<button type="button" id="prevBtn${pageIndex}">‚óÄ –ù–∞–∑–∞–¥</button>` : ''} <!-- –ü–æ–∫–∞–∑–≤–∞ "–ù–∞–∑–∞–¥" —Å–∞–º–æ –∞–∫–æ –Ω–µ –µ –ø—ä—Ä–≤–∏ –≤—ä–ø—Ä–æ—Å -->
             </div>`;

    pageDiv.innerHTML = html;
    container.appendChild(pageDiv);

    // Event listeners –∑–∞ –±—É—Ç–æ–Ω–∏—Ç–µ
    const nextBtn = pageDiv.querySelector(`#nextBtn${pageIndex}`);
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (!validateAnswer(question)) {
            return;
          }
          saveAnswer(question);
          console.log(`–ü—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageIndex} –∫—ä–º ${pageIndex + 1}`);
          showPage(pageIndex + 1);
        });
    } else {
        console.error(`Next button not found for page ${pageIndex}`);
    }

    const prevBtn = pageDiv.querySelector(`#prevBtn${pageIndex}`);
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
           console.log(`–í—Ä—ä—â–∞–Ω–µ –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageIndex} –∫—ä–º ${pageIndex - 1}`);
           // –ü—Ä–µ–∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—É—â–∏—è –æ—Ç–≥–æ–≤–æ—Ä –ø—Ä–µ–¥–∏ –≤—Ä—ä—â–∞–Ω–µ –Ω–∞–∑–∞–¥
           saveAnswer(question);
           showPage(pageIndex - 1);
        });
    }
  }

  /***** –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ñ–∏–Ω–∞–ª–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ *****/
  function createFinalPage() {
    const container = document.getElementById('dynamicContainer');
    if (!container) return;
    const finalIndex = flatPages.length + 1;
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page';
    pageDiv.id = 'page' + finalIndex;
    pageDiv.innerHTML = `
      <h2>–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è! üéâ<br> –¢–æ–∫—É —â–æ –Ω–∞–ø—Ä–∞–≤–∏—Ö—Ç–µ –Ω–∞–π-–≤–∞–∂–Ω–∞—Ç–∞ —Å—Ç—ä–ø–∫–∞ –ø–æ –ø—ä—Ç—è –∫—ä–º –ø—Ä–æ–º—è–Ω–∞—Ç–∞</h2>
      <p>–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞, –∑–∞ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ –≤–∞—à–∏—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∏ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞.</p>
      <div class="nav-buttons" style="justify-content: center;">
        <button id="submitBtn" type="button">–ò–∑–ø—Ä–∞—Ç–∏</button>
        <button id="restartBtn" type="button">–û—Ç–Ω–∞—á–∞–ª–æ</button>
      </div>
       <div id="submit-message" class="message" style="margin-top: 15px; text-align: center; font-weight: bold; word-wrap: break-word;"></div> <!-- –î–æ–±–∞–≤–µ–Ω message –∫–ª–∞—Å -->
    `;
    container.appendChild(pageDiv);
  }

    // --- –§—É–Ω–∫—Ü–∏—è –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ Event Listener-–∞ –Ω–∞ –§–∏–Ω–∞–ª–Ω–∞—Ç–∞ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ---
   function setupFinalPageListener() {
        const finalIndex = flatPages.length + 1;
        const pageDiv = document.getElementById('page' + finalIndex);
        if (!pageDiv) {
            console.error("–§–∏–Ω–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ listener.");
            return;
        }
        const submitBtn = pageDiv.querySelector('#submitBtn');
        const restartBtn = pageDiv.querySelector('#restartBtn');
        const submitMessage = pageDiv.querySelector('#submit-message');

        if (!submitBtn || !restartBtn || !submitMessage) {
             console.error("–ï–¥–∏–Ω –∏–ª–∏ –ø–æ–≤–µ—á–µ –µ–ª–µ–º–µ–Ω—Ç–∏ –ª–∏–ø—Å–≤–∞—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞.");
             return;
        }

        restartBtn.addEventListener('click', () => { location.reload(); });

        submitBtn.addEventListener('click', async () => {
            submitBtn.disabled = true;
            submitBtn.textContent = '–ò–∑–ø—Ä–∞—â–∞–Ω–µ...';
            submitMessage.textContent = '';
            submitMessage.className = 'message'; // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ –∫–ª–∞—Å–æ–≤–µ—Ç–µ –∑–∞ –≥—Ä–µ—à–∫–∞/—É—Å–ø–µ—Ö
            submitMessage.style.display = 'none'; // –°–∫—Ä–∏–≤–∞–º–µ –≥–æ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ

            try {
                console.log("Submit button clicked, calling submitResponses...");
                const result = await submitResponses(); // –ò–∑–≤–∏–∫–≤–∞–º–µ –æ–±–Ω–æ–≤–µ–Ω–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è

                console.log("submitResponses finished successfully.", result);
                submitMessage.textContent = result.message || "–û—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ —Å–∞ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞!"; // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –æ—Ç Worker-–∞, –∞–∫–æ –∏–º–∞
                submitMessage.className = 'message success'; // –ó–µ–ª–µ–Ω–æ –∑–∞ —É—Å–ø–µ—Ö
                submitMessage.style.display = 'block';
                submitBtn.style.display = "none";
                        // --- –ù–ê–ß–ê–õ–û –ù–ê –§–†–ê–ì–ú–ï–ù–¢–ê –ó–ê –î–û–ë–ê–í–Ø–ù–ï ---
        // –ü–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∑–∞ —É—Å–ø–µ—Ö (—Ç–æ–∑–∏ —Ä–µ–¥ –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ –ø—Ä–µ–¥–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞)
        // submitMessage.style.display = 'block';

        const lastQuestionPageIndex = totalPages - 2; // –ò–Ω–¥–µ–∫—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –≤—ä–ø—Ä–æ—Å

        // –°–∞–º–æ –∞–∫–æ –∏–º–∞ –ø—Ä–µ–¥–∏—à–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –≤—ä–ø—Ä–æ—Å, –∫—ä–º –∫–æ—è—Ç–æ –¥–∞ —Å–µ –≤—ä—Ä–Ω–µ–º
        if (lastQuestionPageIndex >= 0) {
            // –°—ä–∑–¥–∞–≤–∞–º–µ –±—É—Ç–æ–Ω–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π" –¥–∏–Ω–∞–º–∏—á–Ω–æ
            const backToEditBtn = document.createElement('button');
            backToEditBtn.textContent = '‚óÄ –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø–æ—Å–ª–µ–¥–µ–Ω';
            backToEditBtn.type = 'button';
            backToEditBtn.style.marginTop = '15px'; // –ú–∞–ª–∫–æ –æ—Ç—Å—Ç–æ—è–Ω–∏–µ
            backToEditBtn.style.backgroundColor = '#f39c12'; // –û—Ä–∞–Ω–∂–µ–≤ —Ü–≤—è—Ç
            backToEditBtn.style.color = '#1e1e1e';
            backToEditBtn.id = 'dynamicBackBtn'; // –î–∞–≤–∞–º–µ –º—É ID, –∞–∫–æ –ø–æ—Ç—Ä—è–±–≤–∞

            // –î–æ–±–∞–≤—è–º–µ –º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç –ø—Ä–∏ –∫–ª–∏–∫
            backToEditBtn.onclick = () => {
                console.log("–î–∏–Ω–∞–º–∏—á–µ–Ω –±—É—Ç–æ–Ω '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø–æ—Å–ª–µ–¥–µ–Ω' –Ω–∞—Ç–∏—Å–Ω–∞—Ç.");
                // 1. –°–∫—Ä–∏–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∑–∞ —É—Å–ø–µ—Ö
                if (submitMessage) {
                    submitMessage.style.display = 'none';
                    submitMessage.textContent = '';
                    submitMessage.className = 'message';
                }
                // 2. –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ —Å–∞–º–∏—è –±—É—Ç–æ–Ω "–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π"
                backToEditBtn.remove();

                // 3. –ü–æ–∫–∞–∑–≤–∞–º–µ –æ—Ç–Ω–æ–≤–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∏—è Submit –±—É—Ç–æ–Ω, –≥–æ—Ç–æ–≤ –∑–∞ –Ω–æ–≤–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ
                if (submitBtn) {
                    submitBtn.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–ò–∑–ø—Ä–∞—Ç–∏ –æ—Ç–Ω–æ–≤–æ'; // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–º–µ —Ç–µ–∫—Å—Ç–∞
                }
                 // 4. –ê–∫—Ç–∏–≤–∏—Ä–∞–º–µ –∏ –±—É—Ç–æ–Ω–∞ –†–µ—Å—Ç–∞—Ä—Ç (–∞–∫–æ –µ –±–∏–ª –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–Ω)
                if (restartBtn) {
                    restartBtn.disabled = false;
                }

                // 5. –ù–∞–≤–∏–≥–∏—Ä–∞–º–µ –∫—ä–º –ø–æ—Å–ª–µ–¥–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –≤—ä–ø—Ä–æ—Å
                showPage(lastQuestionPageIndex);
            };

            // –í–º—ä–∫–≤–∞–º–µ –Ω–æ–≤–∏—è –±—É—Ç–æ–Ω –í–ï–î–ù–ê–ì–ê –°–õ–ï–î —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∑–∞ —É—Å–ø–µ—Ö
            submitMessage.parentNode.insertBefore(backToEditBtn, submitMessage.nextSibling);

            // –£–≤–µ—Ä—è–≤–∞–º–µ —Å–µ, —á–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∏—è—Ç Submit –±—É—Ç–æ–Ω –æ—Å—Ç–∞–≤–∞ —Å–∫—Ä–∏—Ç —Å–ª–µ–¥ —É—Å–ø–µ—Ö
            submitBtn.style.display = "none";
             // –ê–∫—Ç–∏–≤–∏—Ä–∞–º–µ –±—É—Ç–æ–Ω–∞ –†–µ—Å—Ç–∞—Ä—Ç —Å–ª–µ–¥ —É—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ
             restartBtn.disabled = false;
             restartBtn.textContent = "–ó–∞–ø–æ—á–Ω–∏ –Ω–∞–Ω–æ–≤–æ";

        } else {
             // –ê–∫–æ –Ω—è–º–∞ –≤—ä–ø—Ä–æ—Å–∏ (lastQuestionPageIndex < 0), –Ω—è–º–∞ —Å–º–∏—Å—ä–ª –æ—Ç –±—É—Ç–æ–Ω "–ù–∞–∑–∞–¥"
             // –ü—Ä–æ—Å—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä–∞–º–µ –†–µ—Å—Ç–∞—Ä—Ç –∏ —Å–∫—Ä–∏–≤–∞–º–µ Submit
             submitBtn.style.display = "none";
             restartBtn.disabled = false;
             restartBtn.textContent = "–ó–∞–ø–æ—á–Ω–∏ –Ω–∞–Ω–æ–≤–æ";
        }
        // --- –ö–†–ê–ô –ù–ê –§–†–ê–ì–ú–ï–ù–¢–ê –ó–ê –î–û–ë–ê–í–Ø–ù–ï ---
                restartBtn.textContent = "–ü–æ–ø—ä–ª–Ω–∏ –æ—Ç–Ω–æ–≤–æ";

            } catch (error) {
                console.error("Error caught in submitBtn listener:", error);
                submitMessage.textContent = `–ì—Ä–µ—à–∫–∞: ${error.message || '–ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ.'}`;
                submitMessage.className = 'message error'; // –ß–µ—Ä–≤–µ–Ω–æ –∑–∞ –≥—Ä–µ—à–∫–∞
                submitMessage.style.display = 'block';
                submitBtn.disabled = false; // –ê–∫—Ç–∏–≤–∏—Ä–∞–º–µ –±—É—Ç–æ–Ω–∞ –æ—Ç–Ω–æ–≤–æ
                submitBtn.textContent = '–û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ';
            }
        });
   }

  /***** –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —É—Å–ª–æ–≤–Ω–∞ –ª–æ–≥–∏–∫–∞ *****/
  function showPage(index) {
    const pages = document.querySelectorAll('.page');
    if (!pages || pages.length === 0) {
        console.error("–ù–µ —Å–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∏ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ.");
        return;
    }

    // --- –õ–æ–≥–∏–∫–∞ –∑–∞ –ø—Ä–µ—Å–∫–∞—á–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∏ (—É—Å–ª–æ–≤–Ω–∞ –ª–æ–≥–∏–∫–∞) ---
    if (index > currentPageIndex) { // –ü—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –Ω–∞–ø—Ä–µ–¥
        let targetIndex = index;
        while (targetIndex < pages.length - 1) { // –ù–µ –ø—Ä–µ—Å–∫–∞—á–∞–º–µ —Ñ–∏–Ω–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
             // flatPages[targetIndex-1] –µ –≤—ä–ø—Ä–æ—Å—ä—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞, –ö–™–ú –∫–æ—è—Ç–æ –æ—Ç–∏–≤–∞–º–µ
             const question = flatPages[targetIndex - 1];
            if (question && question.dependency) {
                const parentAnswer = responses[question.dependency.question];
                const dependencyValue = question.dependency.value;
                let shouldShow = false;
                 // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (–≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ –∑–∞ —á–µ–∫–±–æ–∫—Å–∏)
                 if (Array.isArray(parentAnswer)) {
                    shouldShow = parentAnswer.includes(dependencyValue);
                 } else {
                     shouldShow = parentAnswer === dependencyValue;
                 }

                if (!shouldShow) {
                    console.log(`–ü—Ä–µ—Å–∫–∞—á–∞–Ω–µ –Ω–∞–ø—Ä–µ–¥: —Å—Ç—Ä. ${targetIndex} (ID: ${question.id}) –ø–æ—Ä–∞–¥–∏ dependency: '${question.dependency.question}' = '${parentAnswer}' (–∏–∑–∏—Å–∫–≤–∞ '${dependencyValue}')`);
                    targetIndex++; // –û–ø–∏—Ç–∞–π —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞
                    continue; // –ü—Ä–æ–¥—ä–ª–∂–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞ –æ—Ç –Ω–æ–≤–∏—è targetIndex
                 }
            }
             break; // –ù–∞–º–µ—Ä–µ–Ω–∞ –µ –≤–∏–¥–∏–º–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
         }
         index = targetIndex; // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π –∏–Ω–¥–µ–∫—Å–∞, –¥–æ –∫–æ–π—Ç–æ —Å–º–µ —Å—Ç–∏–≥–Ω–∞–ª–∏
     } else if (index < currentPageIndex) { // –ü—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –Ω–∞–∑–∞–¥
         let targetIndex = index;
         while (targetIndex > 0) { // –ù–µ –ø—Ä–µ—Å–∫–∞—á–∞–º–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            const question = flatPages[targetIndex - 1]; // –í—ä–ø—Ä–æ—Å—ä—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞, –ö–™–ú –∫–æ—è—Ç–æ –æ—Ç–∏–≤–∞–º–µ
             if (question && question.dependency) {
                 const parentAnswer = responses[question.dependency.question];
                 const dependencyValue = question.dependency.value;
                 let shouldShow = false;
                  if (Array.isArray(parentAnswer)) {
                     shouldShow = parentAnswer.includes(dependencyValue);
                  } else {
                      shouldShow = parentAnswer === dependencyValue;
                  }

                 if (!shouldShow) {
                     console.log(`–ü—Ä–µ—Å–∫–∞—á–∞–Ω–µ –Ω–∞–∑–∞–¥: —Å—Ç—Ä. ${targetIndex} (ID: ${question.id}) –ø–æ—Ä–∞–¥–∏ dependency: '${question.dependency.question}' = '${parentAnswer}' (–∏–∑–∏—Å–∫–≤–∞ '${dependencyValue}')`);
                     targetIndex--; // –û–ø–∏—Ç–∞–π –ø—Ä–µ–¥–∏—à–Ω–∞—Ç–∞
                     continue; // –ü—Ä–æ–¥—ä–ª–∂–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞
                 }
             }
             break; // –ù–∞–º–µ—Ä–µ–Ω–∞ –≤–∏–¥–∏–º–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
         }
         index = targetIndex; // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π –∏–Ω–¥–µ–∫—Å–∞
     }
     // --------------------------------------------------------

    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞–º–µ, —á–µ –∏–Ω–¥–µ–∫—Å—ä—Ç –µ –≤ –≥—Ä–∞–Ω–∏—Ü–∏—Ç–µ
    if (index < 0) index = 0;
    if (index >= pages.length) index = pages.length - 1;

    // –ü—Ä–µ–∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞ –Ω–∞ –¢–ï–ö–£–©–ê–¢–ê (–ø—Ä–µ–¥–∏—à–Ω–∞) —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–∏ —Å–º—è–Ω–∞
     if (currentPageIndex > 0 && currentPageIndex < pages.length -1) {
         // flatPages[currentPageIndex-1] –µ –≤—ä–ø—Ä–æ—Å—ä—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞, –ö–û–Ø–¢–û –Ω–∞–ø—É—Å–∫–∞–º–µ
         const previousQuestion = flatPages[currentPageIndex - 1];
         if (previousQuestion) {
             saveAnswer(previousQuestion);
         }
     }

    // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –Ω–æ–≤–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    currentPageIndex = index;
    pages.forEach((pg, idx) => {
        if (idx === currentPageIndex) {
            pg.classList.add('active');
        } else {
            pg.classList.remove('active');
        }
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ–æ–∫—É—Å–∏—Ä–∞–Ω–µ
    const activePage = pages[currentPageIndex];
    if (activePage) {
        const firstInput = activePage.querySelector('input, select, textarea');
        if (firstInput) {
             setTimeout(() => {
                 try { firstInput.focus(); } catch (e) { console.warn("–ù–µ—É—Å–ø–µ—à–µ–Ω –æ–ø–∏—Ç –∑–∞ —Ñ–æ–∫—É—Å–∏—Ä–∞–Ω–µ:", e); }
             }, 50); // –ú–∞–ª–∫–æ –∑–∞–±–∞–≤—è–Ω–µ
         }
    } else {
      console.error(`–ì—Ä–µ—à–∫–∞: –ê–∫—Ç–∏–≤–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω–¥–µ–∫—Å ${currentPageIndex} –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞.`);
    }

    updateProgress();
    console.log("–ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞:", currentPageIndex, `(ID: page${currentPageIndex})`);
  }

  /***** –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å –±–∞—Ä–∞ *****/
  function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    if (!progressBar || !progressContainer || totalPages <= 1) return;

    // –ü—Ä–æ–≥—Ä–µ—Å—ä—Ç –µ –æ—Ç 0 –¥–æ (totalPages - 1), —Ç—ä–π –∫–∞—Ç–æ –∏–Ω–¥–µ–∫—Å–∏—Ç–µ —Å–∞ –æ—Ç 0
    const currentStep = currentPageIndex;
    // –û–±—â–∏—è—Ç –±—Ä–æ–π —Å—Ç—ä–ø–∫–∏ –µ totalPages - 1 (—Ç—ä–π –∫–∞—Ç–æ –Ω–µ –±—Ä–æ–∏–º –ø—Ä–æ–≥—Ä–µ—Å *—Å–ª–µ–¥* —Ñ–∏–Ω–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
    const totalSteps = totalPages > 1 ? totalPages - 1 : 1;
    const percent = totalSteps > 0 ? Math.round((currentStep / totalSteps) * 100) : 0;

    progressBar.style.width = Math.max(0, Math.min(100, percent)) + '%'; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞–º–µ 0-100
  }

  /***** –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä –∑–∞ –¥–∞–¥–µ–Ω –≤—ä–ø—Ä–æ—Å *****/
  function saveAnswer(question) {
      if (!question || !question.id) {
          // console.warn("–û–ø–∏—Ç –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä –∑–∞ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –≤—ä–ø—Ä–æ—Å.");
          return;
      }
    const qId = question.id;
    let answer;
    const element = document.getElementById(qId);

    if (['text', 'number', 'email', 'textarea'].includes(question.type)) {
      if (element) answer = element.value.trim();
    } else if (question.type === 'select') {
        if(element) answer = element.value;
    } else if (question.type === 'radio') {
      const checkedRadio = document.querySelector(`input[name="${qId}"]:checked`);
      if (checkedRadio) answer = checkedRadio.value;
       else answer = null; // –ê–∫–æ –Ω–∏—â–æ –Ω–µ –µ –∏–∑–±—Ä–∞–Ω–æ, –∑–∞–ø–∏—Å–≤–∞–º–µ null
    } else if (question.type === 'checkbox') {
      const checked = document.querySelectorAll(`input[name="${qId}"]:checked`);
      answer = Array.from(checked).map(ch => ch.value);
    }

    // –ó–∞–ø–∞–∑–≤–∞–º–µ –æ—Ç–≥–æ–≤–æ—Ä–∞
     if (answer !== undefined) { // –ó–∞–ø–∞–∑–≤–∞–º–µ –¥–æ—Ä–∏ null –∏–ª–∏ –ø—Ä–∞–∑–µ–Ω –º–∞—Å–∏–≤
        responses[qId] = answer;
         // console.log(`–ó–∞–ø–∞–∑–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä –∑–∞ ${qId}:`, answer);
     } else {
         console.warn(`–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª –∏–ª–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç –∑–∞ –≤—ä–ø—Ä–æ—Å —Å ID: ${qId}`);
     }
  }

  /***** –§—É–Ω–∫—Ü–∏—è –∑–∞ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞ *****/
  function validateAnswer(question) {
    if (!question || !question.id) return true;

    const qId = question.id;
    let isValid = true;
    let errorMessage = '';

    const element = document.getElementById(qId);
    const radioButtons = document.querySelectorAll(`input[name="${qId}"][type="radio"]`);
    const checkBoxes = document.querySelectorAll(`input[name="${qId}"][type="checkbox"]`);

    // --- –î–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–µ –Ω–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ—Ç–∞ ---
    const requiredFields = ['email']; // –î–æ–±–∞–≤–µ—Ç–µ –¥—Ä—É–≥–∏ ID-—Ç–∞ —Ç—É–∫, –∞–∫–æ –µ –Ω—É–∂–Ω–æ
    const isRequired = requiredFields.includes(qId);
    // -------------------------------------------

    let value = '';
    if (['text', 'number', 'email', 'textarea'].includes(question.type)) {
        if (element) value = element.value.trim();
        if (isRequired && !value) {
            isValid = false; errorMessage = "–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ —Ç–æ–≤–∞ –ø–æ–ª–µ.";
        } else if (question.type === 'email' && value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
            isValid = false; errorMessage = "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω –∏–º–µ–π–ª –∞–¥—Ä–µ—Å.";
        } else if (question.type === 'number' && value && isNaN(Number(value))) {
            isValid = false; errorMessage = "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ —á–∏—Å–ª–æ.";
        }
    } else if (question.type === 'select') {
         if (element) value = element.value;
         if (isRequired && !value) { // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –µ –∏–∑–±—Ä–∞–Ω–∞ –æ–ø—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω–∞ –æ—Ç –ø—Ä–∞–∑–Ω–∞—Ç–∞
             isValid = false; errorMessage = "–ú–æ–ª—è, –Ω–∞–ø—Ä–∞–≤–µ—Ç–µ –∏–∑–±–æ—Ä.";
         }
     } else if (question.type === 'radio') {
        const checkedRadio = document.querySelector(`input[name="${qId}"]:checked`);
        if (isRequired && !checkedRadio) {
            isValid = false; errorMessage = "–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –µ–¥–Ω–∞ –æ—Ç –æ–ø—Ü–∏–∏—Ç–µ.";
        }
    } else if (question.type === 'checkbox') {
        const checkedBoxes = document.querySelectorAll(`input[name="${qId}"]:checked`);
        if (isRequired && checkedBoxes.length === 0) {
            isValid = false; errorMessage = "–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–Ω–∞ –æ–ø—Ü–∏—è.";
        }
    }

    // –ü–æ–∫–∞–∑–≤–∞–Ω–µ/—Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –≥—Ä–µ—à–∫–∞
    const errorElementId = `error-${qId}`;
    let errorElement = document.getElementById(errorElementId);
    const pageElement = document.getElementById('page' + (flatPages.findIndex(p => p.id === qId) + 1)); // –ù–∞–º–∏—Ä–∞–º–µ —Ä–æ–¥–∏—Ç–µ–ª—Å–∫–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞

    if (!isValid) {
        if (!errorElement && pageElement) { // –°—ä–∑–¥–∞–≤–∞–º–µ —Å–∞–º–æ –∞–∫–æ –Ω—è–º–∞ –∏ –∞–∫–æ –∏–º–∞ —Ä–æ–¥–∏—Ç–µ–ª
            errorElement = document.createElement('div');
            errorElement.id = errorElementId;
            errorElement.className = 'validation-error'; // –î–æ–±–∞–≤—è–º–µ –∫–ª–∞—Å –∑–∞ —Å—Ç–∏–ª–∏–∑–∏—Ä–∞–Ω–µ
            errorElement.style.color = '#e74c3c';
            errorElement.style.fontSize = '0.9em';
            errorElement.style.marginTop = '5px';
            errorElement.setAttribute('role', 'alert'); // –ó–∞ –¥–æ—Å—Ç—ä–ø–Ω–æ—Å—Ç

            const lastControlElement = checkBoxes.length > 0 ? checkBoxes[checkBoxes.length - 1].closest('label') :
                                       (radioButtons.length > 0 ? radioButtons[radioButtons.length - 1].closest('label') :
                                       element);

             // –û–ø–∏—Ç–≤–∞–º–µ –¥–∞ –≤–º—ä–∫–Ω–µ–º —Å–ª–µ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–∞ –∏–ª–∏ –≤ –∫—Ä–∞—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
             if (lastControlElement && lastControlElement.parentNode) {
                 // –í–º—ä–∫–≤–∞–º–µ —Å–ª–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª –∏–ª–∏ –Ω–µ–≥–æ–≤–∏—è label
                 lastControlElement.parentNode.insertBefore(errorElement, lastControlElement.nextSibling);
             } else if(pageElement) {
                  // –ö–∞—Ç–æ —Ä–µ–∑–µ—Ä–≤–µ–Ω –≤–∞—Ä–∏–∞–Ω—Ç, –¥–æ–±–∞–≤—è–º–µ –ø—Ä–µ–¥–∏ –±—É—Ç–æ–Ω–∏—Ç–µ
                  const navButtons = pageElement.querySelector('.nav-buttons');
                  if(navButtons) {
                      pageElement.insertBefore(errorElement, navButtons);
                  } else {
                      pageElement.appendChild(errorElement); // –ö—Ä–∞–µ–Ω —Å–ª—É—á–∞–π
                  }
             }
        }
        if (errorElement) { // –£–≤–µ—Ä—è–≤–∞–º–µ —Å–µ, —á–µ –µ —Å—ä–∑–¥–∞–¥–µ–Ω
           errorElement.textContent = errorMessage;
        }

        // –§–æ–∫—É—Å–∏—Ä–∞–Ω–µ (–∞–∫–æ –µ–ª–µ–º–µ–Ω—Ç—ä—Ç –µ –≤–∏–¥–∏–º)
         const activePageId = 'page' + currentPageIndex;
         if (pageElement && pageElement.id === activePageId) {
             if (element && element.offsetParent !== null) element.focus(); // –§–æ–∫—É—Å —Å–∞–º–æ –∞–∫–æ –µ –≤–∏–¥–∏–º
             else if (radioButtons.length > 0 && radioButtons[0].offsetParent !== null) radioButtons[0].focus();
             else if (checkBoxes.length > 0 && checkBoxes[0].offsetParent !== null) checkBoxes[0].focus();
         }

    } else if (errorElement) {
        errorElement.remove(); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ, –∞–∫–æ –µ –≤–∞–ª–∏–¥–Ω–æ
    }

    return isValid;
  }


  /* ============================================================================
     –†–ï–í–ò–ó–ò–†–ê–ù–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –ò–ó–ü–†–ê–©–ê–ù–ï –ù–ê –î–ê–ù–ù–ò
     –ò–∑–ø—Ä–∞—â–∞ –ø—ä—Ä–≤–æ –∫—ä–º Worker-–∞ (–∫—Ä–∏—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç) –∏ —Å–∞–º–æ –∞–∫–æ –µ —É—Å–ø–µ—à–Ω–æ,
     —â–µ –æ–ø–∏—Ç–∞–º–µ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏–º TXT –∫—ä–º PHP API (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç).
     –©–µ –¥–æ–±–∞–≤–∏–º –ø–æ–≤–µ—á–µ console.log —Å—Ç—ä–ø–∫–∏ –∑–∞ –¥–µ–±—ä–≥–≤–∞–Ω–µ.
     ============================================================================ */

  const phpFileManagerUrl = "http://mybody.best/wp-content/uploads/file_manager_api.php";
  const workerSubmitUrl = "https://openapichatbot.radilov-k.workers.dev/api/submitQuestionnaire";
  const phpApiToken = window.FILE_API_TOKEN || "";

   // –ü—Ä–µ–º–µ—Å—Ç–≤–∞–º–µ –≥–∏ –∏–∑–≤—ä–Ω —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞, –∑–∞ –¥–∞ —Å–∞ –¥–æ—Å—Ç—ä–ø–Ω–∏, –∞–∫–æ –µ –Ω—É–∂–Ω–æ
   const questionMapping = {
        name: "–ò–º–µ:", gender: "–ü–æ–ª:", age: "–í—ä–∑—Ä–∞—Å—Ç:", height: "–†—ä—Å—Ç (–≤ —Å–º):", weight: "–¢–µ–≥–ª–æ (–≤ –∫–≥):",
        email: "–ò–º–µ–π–ª –∞–¥—Ä–µ—Å:", goal: "–û—Å–Ω–æ–≤–Ω–∞ —Ü–µ–ª:", lossKg: "–ñ–µ–ª–∞–Ω–∏ –∫–∏–ª–æ–≥—Ä–∞–º–∏ –∑–∞ –æ—Ç—Å–ª–∞–±–≤–∞–Ω–µ:",
        motivation: "–ú–æ—Ç–∏–≤–∞—Ü–∏—è:", weightChange: "–†—è–∑–∫–æ –ø–æ–∫–∞—á–≤–∞–Ω–µ –Ω–∞ —Ç–µ–≥–ª–æ:", weightChangeDetails: "–î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ–∫–∞—á–≤–∞–Ω–µ:",
        dietHistory: "–°–ø–∞–∑–≤–∞–Ω–∞ –¥–∏–µ—Ç–∞:", dietType: "–¢–∏–ø –¥–∏–µ—Ç–∞:", dietResult: "–†–µ–∑—É–ª—Ç–∞—Ç –æ—Ç –¥–∏–µ—Ç–∞:",
        sleepHours: "–ß–∞—Å–æ–≤–µ —Å—ä–Ω:", sleepInterrupt: "–ü—Ä–µ–∫—ä—Å–≤–∞–Ω–∏—è –Ω–∞ —Å—ä–Ω—è:", chronotype: "–•—Ä–æ–Ω–æ—Ç–∏–ø:",
        q1745878295708: "–ù–∏–≤–æ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç:", stressLevel: "–ù–∏–≤–æ –Ω–∞ —Å—Ç—Ä–µ—Å:", waterIntake: "–ü—Ä–∏–µ–º –Ω–∞ –≤–æ–¥–∞:",
        waterReplaceFreq: "–ó–∞–º–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ –≤–æ–¥–∞—Ç–∞:", q1745891342178: "–ó–∞–º–µ—Å—Ç–≤–∞—â–∏ –Ω–∞–ø–∏—Ç–∫–∏ (–†—è–¥–∫–æ):", q1745891468155: "–ó–∞–º–µ—Å—Ç–≤–∞—â–∏ –Ω–∞–ø–∏—Ç–∫–∏ (–ü–æ–Ω—è–∫–æ–≥–∞):", q1745891537884: "–ó–∞–º–µ—Å—Ç–≤–∞—â–∏ –Ω–∞–ø–∏—Ç–∫–∏ (–ß–µ—Å—Ç–æ):",
        q1745891416176: "–î—Ä—É–≥–∏ –Ω–∞–ø–∏—Ç–∫–∏ (–†—è–¥–∫–æ):", q1745891643967: "–î—Ä—É–≥–∏ –Ω–∞–ø–∏—Ç–∫–∏ (–ü–æ–Ω—è–∫–æ–≥–∞):", q1745891620471: "–î—Ä—É–≥–∏ –Ω–∞–ø–∏—Ç–∫–∏ (–ß–µ—Å—Ç–æ):",
        overeatingFrequency: "–ß–µ—Å—Ç–æ—Ç–∞ –Ω–∞ –ø—Ä–µ—è–∂–¥–∞–Ω–µ:", foodCravings: "–ù—É–∂–¥–∞ –æ—Ç —Ö—Ä–∞–Ω–∏:", foodCravingsDetails: "–ö–æ–∏ —Ö—Ä–∞–Ω–∏ (–Ω—É–∂–¥–∞):", q1745891797364: "–î—Ä—É–≥–∏ —Ö—Ä–∞–Ω–∏ (–Ω—É–∂–¥–∞):",
        foodTriggers: "–°–∏—Ç—É–∞—Ü–∏–∏ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–µ:", q1745891178105: "–î—Ä—É–≥–∏ —Å–∏—Ç—É–∞—Ü–∏–∏:", nighteat: "–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –Ω–∞–≤–∏—Ü–∏:", q1745891865984: "–î—Ä—É–≥–∏ –Ω–∞–≤–∏—Ü–∏:",
        compensationmethod: "–ú–µ—Ç–æ–¥–∏ –∑–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è:", q1745806296700: "–î—Ä—É–≥–∏ –º–µ—Ç–æ–¥–∏ –∑–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è:", comparisson: "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏:",
        q1745805447648: "–•—Ä–∞–Ω–µ–Ω–µ –Ω–∞–≤—ä–Ω (—á–µ—Å—Ç–æ—Ç–∞):", q1745805721482: "–¢–∏–ø —Ö—Ä–∞–Ω–µ–Ω–µ –Ω–∞–≤—ä–Ω:", alcoholFrequency: "–ö–æ–Ω—Å—É–º–∞—Ü–∏—è –Ω–∞ –∞–ª–∫–æ—Ö–æ–ª:",
        medications: "–ü—Ä–∏–µ–º –Ω–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞/–¥–æ–±–∞–≤–∫–∏:", q1745889856829: "–û–ø–∏—Å–∞–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞/–¥–æ–±–∞–≤–∫–∏:",
        physicalActivity: "–°–ø–æ—Ä—Ç–Ω–∏ –∑–∞–Ω–∏–º–∞–Ω–∏—è:", q1745877358368: "–í–∏–¥–æ–≤–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç:", q1745877861010: "–î—Ä—É–≥ –≤–∏–¥ —Å–ø–æ—Ä—Ç:", q1745878063775: "–ß–µ—Å—Ç–æ—Ç–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç (–ø—ä—Ç–∏/—Å–µ–¥–º.):", q1745890775342: "–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç:",
        medicalConditions: "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ:", q1745804366749: "–î—Ä—É–≥–æ –º–µ–¥. —Å—ä—Å—Ç–æ—è–Ω–∏–µ:",
        foodPreference: "–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:", q1745806409218: "–î—Ä—É–≥–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è/–ù–µ –æ–±–∏—á–∞–º:", q1745806494081: "–î—Ä—É–≥–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è/–ù–µ –æ–±–∏—á–∞–º (–∞–ª—Ç):",
        mainChallenge: "–ù–∞–π-–≥–æ–ª—è–º–æ –ø—Ä–µ–¥–∏–∑–≤–∏–∫–∞—Ç–µ–ª—Å—Ç–≤–æ:", q1745892518511: "–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:",
        submissionDate: "–î–∞—Ç–∞ –Ω–∞ –ø–æ–¥–∞–≤–∞–Ω–µ:" // –î–æ–±–∞–≤—è–º–µ –∏ –¥–∞—Ç–∞—Ç–∞ –∫—ä–º –º–∞–ø–∏–Ω–≥–∞
    };
   // const order = [ /* ... –≤–∞—à–∏—è—Ç order - –º–æ–∂–µ –¥–∞ –Ω–µ –µ –Ω—É–∂–µ–Ω, –∞–∫–æ –æ–±—Ö–æ–∂–¥–∞–º–µ –≤—Å–∏—á–∫–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏ ... */ ];

  async function submitResponses() {
      const now = new Date();
      // –î–æ–±–∞–≤—è–º–µ –¥–∞—Ç–∞—Ç–∞ –ö–™–ú responses –æ–±–µ–∫—Ç–∞, –ø—Ä–µ–¥–∏ –¥–∞ –≥–æ –∏–∑–ø—Ä–∞—Ç–∏–º
      responses.submissionDate = now.toISOString();

      console.log("Starting submitResponses...");
      // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ JSON.stringify –∑–∞ –ø–æ-–¥–æ–±—Ä–æ –ª–æ–≥–≤–∞–Ω–µ –Ω–∞ –æ–±–µ–∫—Ç–∞, –æ—Å–æ–±–µ–Ω–æ –º–∞—Å–∏–≤–∏
      console.log("Current responses object:", JSON.stringify(responses, null, 2));

      // --- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∏–º–µ–π–ª –ü–†–ï–î–ò –∏–∑–ø—Ä–∞—â–∞–Ω–µ ---
       const userEmail = responses.email ? String(responses.email).trim() : null; // –£–≤–µ—Ä—è–≤–∞–º–µ —Å–µ, —á–µ –µ —Å—Ç—Ä–∏–Ω–≥
       if (!userEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(userEmail)) {
           console.error("Validation Error: Invalid or missing email.", responses.email);
           // –ò–∑—Ç—Ä–∏–≤–∞–º–µ –¥–∞—Ç–∞—Ç–∞, –∞–∫–æ —â–µ —Ö–≤—ä—Ä–ª—è–º–µ –≥—Ä–µ—à–∫–∞
           delete responses.submissionDate;
           throw new Error("–ò–º–µ–π–ª—ä—Ç –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω –∏ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –≤–∞–ª–∏–¥–µ–Ω, –∑–∞ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ.");
       }
       console.log("Email validation passed:", userEmail);
       // ------------------------------------------

       // --- –ò–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º Worker (–ö—Ä–∏—Ç–∏—á–Ω–∞ —á–∞—Å—Ç) ---
       let workerResult;
       try {
            console.log("Attempting to send JSON to Worker:", workerSubmitUrl);
            const workerResponse = await fetch(workerSubmitUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'Authorization': `Bearer ${sessionStorage.getItem('authToken')}` // –ê–∫–æ –µ –Ω—É–∂–Ω–æ
                },
                body: JSON.stringify(responses) // –ò–∑–ø—Ä–∞—â–∞–º–µ —Ü–µ–ª–∏—è –∞–∫—Ç—É–∞–ª–µ–Ω –æ–±–µ–∫—Ç
            });
            console.log("Worker fetch completed. Status:", workerResponse.status);

             const responseText = await workerResponse.text();
             let responseData;
             try {
                 responseData = JSON.parse(responseText);
             } catch (parseError) {
                 console.error("Failed to parse Worker response as JSON:", responseText);
                 throw new Error(`–ì—Ä–µ—à–∫–∞ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞: ${workerResponse.status}. –û—Ç–≥–æ–≤–æ—Ä: ${responseText}`);
             }

            if (!workerResponse.ok) {
                console.error("Worker responded with error:", responseData);
                throw new Error(responseData.message || `Worker –æ—Ç–≥–æ–≤–æ—Ä–∏ —Å—ä—Å —Å—Ç–∞—Ç—É—Å ${workerResponse.status}`);
            }

            console.log("Successful response from Worker:", responseData);
            workerResult = responseData;

        } catch (error) {
             console.error("Error during Worker fetch or processing:", error);
             delete responses.submissionDate; // –ò–∑—Ç—Ä–∏–≤–∞–º–µ –¥–∞—Ç–∞—Ç–∞ –ø—Ä–∏ –≥—Ä–µ—à–∫–∞
             throw new Error(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞: ${error.message}`);
        }
       // --- –ö—Ä–∞–π –Ω–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º Worker ---

      // --- –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ TXT –∫—ä–º PHP API (–ù–µ–∫—Ä–∏—Ç–∏—á–Ω–∞ —á–∞—Å—Ç) ---
      console.log("Worker request successful. Proceeding with TXT backup.");
      try {
          let fileContent = "";
          // –û–±—Ö–æ–∂–¥–∞–º–µ –í–°–ò–ß–ö–ò –∫–ª—é—á–æ–≤–µ –≤ responses, –∑–∞ –¥–∞ –≤–∫–ª—é—á–∏–º –≤—Å–∏—á–∫–æ –≤ TXT
          for (const key in responses) {
               if (responses.hasOwnProperty(key)) {
                  const questionObj = flatPages.find(q => q.id === key);
                  const questionText = (questionObj && questionObj.text) ? questionObj.text : (questionMapping[key] || key.replace(/_/g, ' ')); // –ü–æ-–¥–æ–±—Ä–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ –∏–º–µ
                  const answerValue = responses[key];
                  // –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞
                   let answerText = '';
                   if (answerValue === null || answerValue === undefined) {
                       answerText = '(–Ω—è–º–∞ –æ—Ç–≥–æ–≤–æ—Ä)';
                   } else if (Array.isArray(answerValue)) {
                       answerText = answerValue.length > 0 ? answerValue.join(', ') : '(–Ω—è–º–∞ –∏–∑–±–æ—Ä)';
                   } else {
                       answerText = String(answerValue);
                   }

                  fileContent += `${questionText}\n–û—Ç–≥–æ–≤–æ—Ä: ${answerText}\n\n`;
               }
          }

          const clientName = (responses.name || "client").replace(/[^a-zA-Z0-9_\-]/g, "_");
          const timestamp = now.toISOString().replace(/[:\-T.]/g, "").slice(0, 14);
          const filename = `${clientName}_${timestamp}.txt`;

          const txtFormData = new FormData();
          txtFormData.append("filename", filename);
          txtFormData.append("content", fileContent);
          txtFormData.append("directory", "client_answers_test"); // –ü–∞–ø–∫–∞ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–∞
          txtFormData.append("action", "create_file");

          console.log("Attempting to send TXT to PHP API:", phpFileManagerUrl);
          fetch(phpFileManagerUrl, { // –ù–µ —á–∞–∫–∞–º–µ (await) —Ç–æ–∑–∏ fetch, –∑–∞ –¥–∞ –Ω–µ –±–∞–≤–∏–º
              method: "POST",
              body: txtFormData,
              headers: {
                  "Authorization": `Bearer ${phpApiToken}`
              }
          })
          .then(async phpResponse => {
              const phpData = await phpResponse.json().catch(() => ({error: '–ù–µ–≤–∞–ª–∏–¥–µ–Ω JSON –æ—Ç PHP'})); // –ü—Ä–µ–¥–ø–∞–∑–≤–∞–º–µ –æ—Ç –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–≤–∞–Ω–µ
              if (!phpResponse.ok) {
                  console.warn("TXT backup failed:", phpData.error || `–°—Ç–∞—Ç—É—Å ${phpResponse.status}`);
              } else {
                  console.log("TXT backup successful:", phpData);
              }
          })
          .catch(txtError => {
              console.warn("Error sending TXT backup (network or other):", txtError);
          });

       } catch (txtError) {
           console.warn("Error preparing or sending TXT backup:", txtError);
       }
       // --- –ö—Ä–∞–π –Ω–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ TXT ---

      // –í—Ä—ä—â–∞–º–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –æ—Ç Worker-–∞ (–æ—Ç –ø—ä—Ä–≤–∏—è try –±–ª–æ–∫)
      delete responses.submissionDate; // –ò–∑—Ç—Ä–∏–≤–∞–º–µ –¥–∞—Ç–∞—Ç–∞ –ø—Ä–µ–¥–∏ –¥–∞ –≤—ä—Ä–Ω–µ–º —Ä–µ–∑—É–ª—Ç–∞—Ç–∞
      return workerResult;
  }


  // --- –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–Ω–∏–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç ---
   document.addEventListener('DOMContentLoaded', () => {
     fetch('questions.json')
       .then(res => {
         if (!res.ok) throw new Error(`HTTP ${res.status} –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ questions.json`);
         // –î–æ–±–∞–≤—è–º–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ Content-Type, –∞–∫–æ –µ –≤—ä–∑–º–æ–∂–Ω–æ
         const contentType = res.headers.get("content-type");
            if (contentType && !contentType.includes("application/json")) {
                throw new TypeError(`–û—á–∞–∫–≤–∞–Ω JSON, –Ω–æ –ø–æ–ª—É—á–µ–Ω ${contentType}`);
             }
         return res.json();
       })
       .then(data => {
         if (!Array.isArray(data) || data.length === 0) {
            throw new Error("questions.json –µ –ø—Ä–∞–∑–µ–Ω –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –º–∞—Å–∏–≤.");
         }
         rawQuestions = data;
         buildDynamicPages(); // –ò–∑–≤–∏–∫–≤–∞–º–µ –ò–ó–¶–Ø–õ–û –∏–∑–≥—Ä–∞–∂–¥–∞–Ω–µ—Ç–æ –°–õ–ï–î —É—Å–ø–µ—à–µ–Ω fetch
       })
       .catch(err => {
           console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ questions.json:', err);
           const container = document.getElementById('dynamicContainer');
           if(container) {
                container.innerHTML = `<div style="color: #e74c3c; text-align: center; padding: 20px;">–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–Ω–∏–∫–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –¥–∞ –ø—Ä–µ–∑–∞—Ä–µ–¥–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –∏–ª–∏ —Å–µ —Å–≤—ä—Ä–∂–µ—Ç–µ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. (${err.message})</div>`;
           }
        });

       // –¢–∞–π–Ω–∞ –∑–æ–Ω–∞ –∑–∞ Admin - –±–µ–∑ –ø—Ä–æ–º—è–Ω–∞
       const secretArea = document.getElementById('secretTapArea');
       const adminLink = document.getElementById('adminLink');
       if(secretArea && adminLink) {
           secretArea.addEventListener('click', function() {
             adminLink.style.display = 'block';
             setTimeout(() => {
               adminLink.style.display = 'none';
             }, 10000);
           });
       }
   });

</script>

</body>
</html>