<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Въпросник за хранителни навици (Dynamic)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- === НАЧАЛО: АКТУАЛИЗИРАНИ И ОБЕДИНЕНИ СТИЛОВЕ === -->
  <style>
    /* =================================================================== */
    /*                      ОСНОВНИ ПРОМЕНЛИВИ И ТЕМИ                     */
    /* =================================================================== */

    :root {
      /* Тъмна тема (по подразбиране) */
      --font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --bg-primary: #121212;
      --bg-surface: #1e1e1e;
      --bg-surface-transparent: rgba(30, 30, 30, 0.65);
      --bg-quest-container: rgba(44, 62, 80, 0.65);
      --bg-sticky-header: rgba(18, 18, 18, 0.5);
      --text-primary: #E0E0E0;
      --text-accent: #80cbc4;
      --accent-primary: #4fc3a1;
      --accent-primary-hover: #43a088;
      --accent-primary-light: #5dd4b5;
      --border-color: #333;
      --input-bg: #2a2a2a;
      --shadow-color-light: rgba(0,0,0,0.6);
      --shadow-color-accent: rgba(79, 195, 161, 0.3);
      --shadow-color-accent-hover: rgba(79, 195, 161, 0.5);
      --error-color: #e74c3c;
      --error-bg: rgba(231, 76, 60, 0.1);
      --success-color: #2ecc71;
      --success-bg: rgba(46, 204, 113, 0.1);
      --hero-gradient: radial-gradient(ellipse at 50% 0%, rgba(44, 62, 80, 0.65) 0%, rgba(31, 44, 53, 0.65) 40%, transparent 80%);
      --hero-title-color: #FFFFFF;
      --hero-subtitle-color: #E0E0E0;
    }

    /* Светла тема (активира се автоматично) */
    @media (prefers-color-scheme: light) {
      :root {
        --bg-primary: #f4f5f7;
        --bg-surface: #ffffff;
        --bg-surface-transparent: rgba(255, 255, 255, 0.65);
        --bg-quest-container: rgba(240, 248, 250, 0.85);
        --bg-sticky-header: rgba(255, 255, 255, 0.5);
        --text-primary: #1a1a1a;
        --text-accent: #00796b; /* По-тъмен акцент за по-добър контраст */
        --accent-primary: #26a69a;
        --accent-primary-hover: #00897b;
        --accent-primary-light: #4db6ac;
        --border-color: #d1d5db;
        --input-bg: #f9fafb;
        --shadow-color-light: rgba(0,0,0,0.1);
        --shadow-color-accent: rgba(38, 166, 154, 0.2);
        --shadow-color-accent-hover: rgba(38, 166, 154, 0.4);
        --error-color: #d32f2f;
        --error-bg: rgba(211, 47, 47, 0.1);
        --success-color: #388e3c;
        --success-bg: rgba(56, 142, 60, 0.1);
        --hero-gradient: radial-gradient(ellipse at 50% 0%, rgba(178, 223, 219, 0.5) 0%, rgba(224, 242, 241, 0.5) 40%, transparent 80%);
        --hero-title-color: #121212;
        --hero-subtitle-color: #1a1a1a;
      }
    }

    /* =================================================================== */
    /*                           ОБЩИ СТИЛОВЕ                           */
    /* =================================================================== */

    /* Деактивиране на анимации при заявка от потребителя */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
        animation: none !important;
        transition: none !important;
      }
    }

    body {
      margin: 0;
      font-family: var(--font-primary);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    .container {
      max-width: 600px;
      margin: 60px auto 20px;
      padding: 20px;
      background-color: var(--bg-surface);
      border-radius: 10px;
      box-shadow: 0 0 15px var(--shadow-color-light);
    }

    /* Прозрачни контейнери в страницата с въпросника */
    #questPage .container:not(#dynamicContainer) {
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 0;
      background-color: transparent;
      box-shadow: none;
    }

    h1, h2 {
      text-align: center;
      color: var(--text-accent);
      margin-bottom: 20px;
    }

    p {
      text-align: center;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* =================================================================== */
    /*                СТИЛОВЕ ЗА КОМПОНЕНТИ НА ВЪПРОСНИКА               */
    /* =================================================================== */

    /* Специален контейнер за въпросника */
    #dynamicContainer {
      max-width: 640px;
      margin: 0 auto;
      padding: 10px;
      background-color: var(--bg-quest-container);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border-radius: 10px;
    }

    .question-text {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-accent);
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .answer-label {
      font-size: 16px;
      line-height: 1.4;
      margin: 8px auto;
      display: block;
      padding: 10px;
      width: 80%;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .answer-label:hover {
        background-color: rgba(var(--accent-primary), 0.1);
        border-color: var(--accent-primary);
    }

    .section-title {
      font-size: 22px;
      text-align: center;
      color: var(--accent-primary);
      margin-bottom: 20px;
    }

    /* Всяка страница се състои от "екран" */
    .page {
      display: none;
      animation: fadeIn 0.4s ease-in-out;
      position: relative;
      z-index: 2;
    }

    #questPage .page:not(.hero-start-page) {
      padding: 20px;
      max-width: 600px;
      margin: 60px auto 20px;
    }

    .page.active {
      display: block;
    }

    /* Навигационни бутони */
    .nav-buttons {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    button {
      background-color: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
      min-height: 48px;
    }

    button:hover {
      background-color: var(--accent-primary-hover);
      box-shadow: 0 0 10px var(--shadow-color-accent);
      transform: translateY(-2px);
    }

    /* Стил за бутон "Назад" за по-добра йерархия */
    .nav-buttons button:first-child:not(:last-child) {
        background-color: transparent;
        color: var(--accent-primary);
        border: 2px solid var(--accent-primary);
    }
     .nav-buttons button:first-child:not(:last-child):hover {
        background-color: var(--accent-primary);
        color: var(--bg-primary);
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="password"],
    textarea,
    select {
      width: 80%;
      padding: 12px;
      margin: 10px auto;
      display: block;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background-color: var(--input-bg);
      color: var(--text-primary);
      font-size: 16px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 8px var(--shadow-color-accent);
    }

    input[type="radio"],
    input[type="checkbox"] {
      margin-right: 10px;
      accent-color: var(--accent-primary);
      transform: scale(1.2);
    }

    .message {
      padding: 0.8rem;
      border-radius: 0.5rem;
      margin-top: 15px;
      font-size: 0.9rem;
      display: none;
      border: 1px solid transparent;
      text-align: left;
      word-wrap: break-word;
    }

    .message.error { display: block; color: var(--error-color); background-color: var(--error-bg); border-color: var(--error-color); }
    .message.success { display: block; color: var(--success-color); background-color: var(--success-bg); border-color: var(--success-color); }

    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input { width: 100%; box-sizing: border-box; }


    /* =================================================================== */
    /*             СТИЛОВЕ ЗА НАЧАЛНА СТРАНИЦА И ХЕДЪР                   */
    /* =================================================================== */

    /* "Лепкав" прогрес бар */
    .step-indicator-container {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: var(--bg-sticky-header);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        margin: 0;
        padding: 8px 15px;
    }
    
    /* Стил за прогрес бара от друг файл (предполага се) */
    .step-indicator-label { display: block; text-align: center; font-size: 0.8em; margin-bottom: 4px; }
    .progress-bar-steps { width: 100%; height: 6px; background-color: var(--border-color); border-radius: 3px; overflow: hidden; }
    .step-progress-bar { height: 100%; width: 0; background-color: var(--accent-primary); transition: width 0.4s ease-in-out; }
    

    /* Фон с частици - фиксиран за паралакс ефект */
    #particles-js {
      position: fixed; /* ВАЖНО: Променено на fixed */
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 0; /* Под съдържанието, но над фона на body */
    }

    /* Начална Hero страница */
    #page0.active.hero-start-page {
      min-height: 100vh;
      width: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      color: #fff;
      /* Статичен, но красив градиент */
      background: var(--hero-gradient), linear-gradient(35deg, #1f2c35, #2c3e50, #466368);
      background-blend-mode: overlay;
    }

    /* Премахваме стиловете на .container за първата страница */
    #page0.active.hero-start-page .container {
        max-width: 100%; margin: 0; padding: 0; background-color: transparent; border-radius: 0; box-shadow: none;
    }

    .hero-content {
      position: relative;
      z-index: 2; /* Съдържанието е над частиците */
      text-align: center;
      max-width: 900px;
      padding: 20px;
      animation: fadeIn 1s ease-in-out 0.3s forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    
    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .hero-image { max-width: 250px; margin: 0 auto 20px auto; }
    .hero-title { font-size: 2.8rem; font-weight: 700; color: var(--hero-title-color); text-shadow: 2px 2px 8px rgba(0,0,0,0.3); margin-bottom: 15px; line-height: 1.2; }
    .hero-subtitle { font-size: 1.3rem; font-weight: 300; color: var(--hero-subtitle-color); max-width: 550px; margin: 0 auto 40px auto; line-height: 1.6; }

    /* Специфични стилове за бутона на началната страница */
    #page0.hero-start-page #startBtn {
      position: relative;
      background-color: var(--accent-primary);
      color: #121212;
      font-size: 1.2rem;
      padding: 16px 45px;
      border-radius: 50px;
      box-shadow: 0 5px 20px var(--shadow-color-accent);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    #page0.hero-start-page #startBtn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px var(--shadow-color-accent-hover);
      background-color: var(--accent-primary-light);
    }

    /* Пулсираща рамка за призив към действие */
    #page0.hero-start-page #startBtn::after {
      content: "";
      position: absolute;
      z-index: -1;
      top: -6px; left: -6px; right: -6px; bottom: -6px;
      border: 2px solid var(--accent-primary);
      border-radius: 50px;
      animation: pulse 2s infinite ease-out;
      opacity: 0.5;
    }

    @keyframes pulse {
      0% { transform: scale(0.95); opacity: 0.7; }
      70% { transform: scale(1.1); opacity: 0; }
      100% { transform: scale(0.95); opacity: 0; }
    }
    
    .stats-bar { margin-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 20px; color: rgba(255, 255, 255, 0.8); user-select: none; }
    .stat-item { text-align: center; }
    .stat-label { font-size: 1rem; letter-spacing: 0.5px; }
    .stat-icon { width: 80px; height: 80px; display: block; margin: 0 auto 5px; }
    
    .quest-instructions { margin: 0 0 15px 0; max-width: 600px; text-align: center; line-height: 1.4; font-size: 1rem; color: var(--text-primary); }
    #persistentStats { display: none; justify-content: center; gap: 20px; padding: 10px 0; }
    #persistentStats .stat-icon { width: 60px; height: 60px; }


    /* =================================================================== */
    /*                         МОБИЛНА АДАПТАЦИЯ                         */
    /* =================================================================== */

    @media (max-width: 768px) {
      .hero-title { font-size: 2.2rem; min-height: 80px; }
      .hero-subtitle { font-size: 1.2rem; padding: 0 10px; }
      .stats-bar { gap: 30px; }
      #page0.hero-start-page #startBtn { width: 100%; padding: 16px 20px; justify-content: center; }
      .quest-instructions { text-align: left; } /* По-добра четимост */
    }

    @media (min-width: 769px) {
      .stats-bar { flex-direction: row; justify-content: center; }
    }
    
    @media (max-width: 600px) {
      .container { margin: 60px 15px 20px; padding: 15px; }
      #dynamicContainer { margin: 0 10px; padding: 8px; }
      
      .nav-buttons { flex-direction: column-reverse; } /* Бутон "Напред" е отгоре */
      .nav-buttons button { width: 100%; flex: 1; }

      .question-text { font-size: 18px; }
      button { font-size: 16px; min-height: 52px; }

      /* Полетата заемат цялата ширина за по-лесно попълване */
      input[type="text"], input[type="number"], input[type="email"], input[type="password"], textarea, select, .answer-label {
        width: 100%;
      }
    }
  </style>
  <!-- === КРАЙ: АКТУАЛИЗИРАНИ СТИЛОВЕ === -->
</head>
<body id="questPage">

<div id="particles-js"></div>

<!-- Прогрес бар -->
<div class="step-indicator-container">
  <span class="step-indicator-label">Стъпка <span id="questCurrentStep">0</span> от <span id="questTotalSteps">0</span></span>
  <div class="progress-bar-steps"><div id="questProgressBar" class="step-progress-bar"></div></div>
</div>

<div class="container" id="dynamicContainer">
  <!-- Динамично генерираните "страници" ще се вмъкнат тук -->
  <div id="questInstructions" class="quest-instructions">
    За да получите индивидуален и максимално ефективен план за вас,
    въведете коректна и изчерпателна информация.
  </div>
</div>

<div id="persistentStats" class="stats-bar">
  <div class="stat-item">
    <img class="stat-icon" src="https://radilovk.github.io/bodybest/img/aibrain.png" alt="AI Algorithm">
    <div class="stat-label">AI Med Алгоритъм</div>
  </div>
  <div class="stat-item">
    <img class="stat-icon" src="https://radilovk.github.io/bodybest/img/medic.png" alt="Medical Experts">
    <div class="stat-label">Реални специалисти</div>
  </div>
  <div class="stat-item">
    <img class="stat-icon" src="https://radilovk.github.io/bodybest/img/clock.png" alt="24/7 Assistant">
    <div class="stat-label">24/7 Личен асистент</div>
  </div>
</div>

<!-- Тайна зона за мобилни устройства за Admin достъп -->
<div id="secretTapArea" style="position: fixed; top: 0; left: 0; width: 30px; height: 30px; opacity: 0; z-index: 9999;"></div>

<!-- Скрит Admin бутон -->
<a href="admin.html" id="adminLink" style="display:none; position: fixed; bottom: 10px; right: 10px; background: #4fc3a1; color: #121212; padding: 5px 10px; border-radius: 5px; text-decoration: none;">
  Admin
</a>

<!-- Библиотеки за ефекти -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<!-- JAVASCRIPT ЛОГИКАТА Е НАПЪЛНО НЕПРОМЕНЕНА -->
<script type="module">
  import { workerBaseUrl } from './js/config.js';
  import { setupRegistration } from "./js/register.js";
  import { showMessage, hideMessage } from "./js/messageUtils.js";
  import { updateStepProgress } from "./js/stepProgress.js";
  
  /***** Глобални променливи (без промяна) *****/
  let rawQuestions = [];
  let flatPages = [];
  let currentPageIndex = 0;
  let totalPages = 0;
  let registrationPageIndex = 0;
  const responses = {};
  const numericRanges = {
    age: { min: 10, max: 120 }, height: { min: 100, max: 250 }, weight: { min: 30, max: 300 }, lossKg: { min: 1, max: 100 },
    q1745847247058: { min: 1, max: 300 }, q1745847190198: { min: 1, max: 300 }, q1745847315231: { min: 1, max: 300 }
  };
  const requiredFields = [
    'name','gender','age','height','weight','goal','lossKg','motivation','weightChange','weightChangeDetails',
    'dietHistory','dietType','dietResult','sleepHours','sleepInterrupt','chronotype','q1745878295708','stressLevel',
    'physicalActivity','activityTypeDaily','q1745847247058','activityTypeWeekly','q1745847190198','activityTypeRare',
    'q1745847315231','q1745877358368','q1745878063775','q1745890775342','waterIntake','waterReplaceFreq','q1745891342178',
    'q1745891468155','q1745891537884','overeatingFrequency','foodCravings','foodCravingsDetails','foodTriggers',
    'q1745891178105','nighteat','q1745891865984','compensationmethod','q1745806296700','comparisson','q1745805447648',
    'q1745805721482','alcoholFrequency','foodPreference','q1745806409218','q1745806494081','mainChallenge','q1745892518511',
    'medicalConditions','q1745804366749','medications','medicationsList','supplementsList'
  ];

  /***** Функция за рекурсивно сплескване на въпросите (без промяна) *****/
  function flattenQuestions(questions) {
    let output = [];
    questions.forEach(q => {
      let qCopy = Object.assign({}, q);
      delete qCopy.children;
      if (qCopy.type !== 'section') { output.push(qCopy); }
      if (q.children && Array.isArray(q.children)) {
        output = output.concat(flattenQuestions(q.children));
      } else if (q.children && typeof q.children === 'object') {
        for (const answer in q.children) {
          let childArray = q.children[answer];
          if (Array.isArray(childArray)) {
             childArray.forEach(child => { child.dependency = { question: q.id, value: answer }; });
             output = output.concat(flattenQuestions(childArray));
          } else { console.warn(`Expected an array for children under key '${answer}' in question '${q.id}', but got:`, typeof childArray); }
        }
      }
    });
    return output;
  }

  /***** Функция за изграждане на страниците (без промяна) *****/
  function buildDynamicPages() {
    const container = document.getElementById('dynamicContainer');
    const instr = document.getElementById('questInstructions');
    if (!container) { console.error("Container #dynamicContainer not found!"); return; }
    container.innerHTML = "";
    createStartPage();
    flatPages = flattenQuestions(rawQuestions).filter(q => q.id !== 'email' && q.type !== 'section');
    flatPages.forEach((q, idx) => { createQuestionPage(q, idx + 1); });
    createRegistrationPage();
    createFinalPage();
    setupFinalPageListener();
    if (instr) { container.appendChild(instr); }
    totalPages = 1 + flatPages.length + 2;
    console.log("Общо страници (включително старт и финал):", totalPages);
    updateStepProgress(
      document.getElementById('questProgressBar'), 0, totalPages > 1 ? totalPages - 1 : 1,
      document.getElementById('questCurrentStep'), document.getElementById('questTotalSteps')
    );
    showPage(0);
  }

  /***** СЪЗДАВАНЕ НА СТАРТОВА СТРАНИЦА (без промяна в JS логиката) *****/
  function createStartPage() {
    const container = document.getElementById('dynamicContainer');
    if (!container) return;
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page hero-start-page'; 
    pageDiv.id = 'page0';

    pageDiv.innerHTML = `
      <div class="hero-content">
        <img class="hero-image" id="heroImage" src="https://radilovk.github.io/bodybest/img/myquest.png" alt="Hero">
        <h1 class="hero-title">Твоята Промяна Започва Сега</h1>
        <p class="hero-subtitle">
          Разкажи ни повече за теб и твоите цели.<br>
          Ние ще ти помогнем да ги постигнеш!
        </p>
        
        <div class="cta-container">
          <button id="startBtn" type="button">
            Начало
          </button>
        </div>
        
        <div class="stats-bar">
          <div class="stat-item">
            <img class="stat-icon" src="https://radilovk.github.io/bodybest/img/aibrain.png" alt="AI Algorithm">
            <div class="stat-label">AI Med Алгоритъм</div>
          </div>
          <div class="stat-item">
            <img class="stat-icon" src="https://radilovk.github.io/bodybest/img/medic.png" alt="Medical Experts">
            <div class="stat-label">Реални специалисти</div>
          </div>
          <div class="stat-item">
            <img class="stat-icon" src="https://radilovk.github.io/bodybest/img/clock.png" alt="24/7 Assistant">
            <div class="stat-label">24/7 Личен асистент</div>
          </div>
        </div>
      </div>
    `;
    container.appendChild(pageDiv);

    if (window.particlesJS) {
        particlesJS('particles-js', {
            "particles": {
                "number": { "value": 60, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": "#ffffff" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.6, "random": true },
                "size": { "value": 2.5, "random": true },
                "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.2, "width": 1 },
                "move": { "enable": true, "speed": 1, "direction": "none", "out_mode": "out" }
            },
            "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } }, "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 0.3 } }, "push": { "particles_nb": 4 } } },
            "retina_detect": true
        });
    }

    const startBtn = pageDiv.querySelector('#startBtn');
    if (startBtn) {
        startBtn.addEventListener('click', () => {
          console.log("Бутон 'Начало' е натиснат.");
          pageDiv.classList.remove('hero-start-page');
          showPage(1);
        });
    } else {
        console.error("Start button not found on the new hero start page.");
    }
  }

  /***** Създаване на страница за всеки въпрос (без промяна) *****/
  function createQuestionPage(question, pageIndex) {
    const container = document.getElementById('dynamicContainer');
     if (!container || !question || !question.id) {
         console.error("Missing container or question data for page", pageIndex);
         return;
     };
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page';
    pageDiv.id = 'page' + pageIndex;
    let html = '';
    if (question.type === 'section') {
      html += `<div class="section-title">${question.sectionTitle || question.text || ''}</div>`;
    } else {
      html += `<div class="question-text">${question.text || 'Липсва текст на въпроса'}</div>`;
    }
    const isRequired = requiredFields.includes(question.id);
    if (question.type === 'section') {
    } else if (['text','number','email'].includes(question.type)) {
      const range = numericRanges[question.id];
      const rangeAttrs = (question.type === 'number' && range) ? `min="${range.min}" max="${range.max}"` : '';
      html += `<input id="${question.id}" type="${question.type}" placeholder="" ${rangeAttrs} ${isRequired ? 'required' : ''} ${question.type === 'email' ? 'autocomplete="email"' : ''}>`;
    } else if (question.type === 'textarea') {
      html += `<textarea id="${question.id}" rows="4" ${isRequired ? 'required' : ''}></textarea>`;
    } else if (question.type === 'select') {
      html += `<select id="${question.id}" ${isRequired ? 'required' : ''}><option value="">Изберете</option>`;
      (question.options || []).forEach(opt => {
        html += `<option value="${String(opt)}">${String(opt)}</option>`;
      });
      html += `</select>`;
    } else if (question.type === 'radio') {
      (question.options || []).forEach((opt, index) => {
          const optionValue = String(opt);
        html += `<label class="answer-label">
                   <input name="${question.id}" type="radio" value="${optionValue}" ${isRequired && index === 0 ? 'required' : ''}> ${optionValue}
                 </label>`;
      });
    } else if (question.type === 'checkbox') {
      (question.options || []).forEach(opt => {
          const optionValue = String(opt);
        html += `<label class="answer-label">
                   <input name="${question.id}" type="checkbox" value="${optionValue}"> ${optionValue}
                 </label>`;
      });
    } else if (question.type !== 'section') {
        console.warn(`Unsupported question type: ${question.type} for question ID: ${question.id}`);
        html += `<p style="color: red;">Грешка: Неподдържан тип въпрос.</p>`;
    }
    html += `<div class="nav-buttons">
               ${pageIndex > 1 ? `<button type="button" id="prevBtn${pageIndex}">◀ Назад</button>` : ''}
               <button type="button" id="nextBtn${pageIndex}">Напред ▶</button>
             </div>`;
    pageDiv.innerHTML = html;
    container.appendChild(pageDiv);
    const nextBtn = pageDiv.querySelector(`#nextBtn${pageIndex}`);
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (question.type !== 'section' && !validateAnswer(question)) { return; }
          if (question.type !== 'section') { saveAnswer(question); }
          console.log(`Преминаване от страница ${pageIndex} към ${pageIndex + 1}`);
          showPage(pageIndex + 1);
        });
    } else { console.error(`Next button not found for page ${pageIndex}`); }
    const prevBtn = pageDiv.querySelector(`#prevBtn${pageIndex}`);
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
           console.log(`Връщане от страница ${pageIndex} към ${pageIndex - 1}`);
           if (question.type !== 'section') { saveAnswer(question); }
           showPage(pageIndex - 1);
        });
    }
  }

  /***** Създаване на страница за регистрация (без промяна) *****/
  function createRegistrationPage() {
    const container = document.getElementById('dynamicContainer');
    if (!container) return;
    const regIndex = flatPages.length + 1;
    registrationPageIndex = regIndex;
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page';
    pageDiv.id = 'page' + regIndex;
    pageDiv.innerHTML = `
      <h2>Регистрация</h2>
      <form id="register-form-q" novalidate>
        <div class="form-group"><label for="register-email-q">Имейл:</label><input type="email" id="register-email-q" required autocomplete="email"></div>
        <div class="form-group"><label for="register-password-q">Парола (мин. 8 знака):</label><input type="password" id="register-password-q" required minlength="8"></div>
        <div class="form-group"><label for="confirm-password-q">Потвърди Парола:</label><input type="password" id="confirm-password-q" required minlength="8"></div>
        <div id="register-message-q" class="message" role="alert"></div>
        <div class="nav-buttons"><button type="button" id="regBackBtn">◀ Назад</button><button type="submit" id="regSubmitBtn">Регистрация</button></div>
      </form>
    `;
    container.appendChild(pageDiv);
    const emailInput = pageDiv.querySelector('#register-email-q');
    if (emailInput && responses.email) emailInput.value = responses.email;
    pageDiv.querySelector('#regBackBtn').addEventListener('click', () => { showPage(regIndex - 1); });
    setupRegistration("#register-form-q", "#register-message-q");
    pageDiv.querySelector("#register-form-q").addEventListener("registrationSuccess", (event) => {
      responses.email = event.detail.email;
      saveProgress();
      showPage(regIndex + 1);
    });
  }

  /***** Създаване на финална страница (без промяна) *****/
  function createFinalPage() {
    const container = document.getElementById('dynamicContainer');
    if (!container) return;
    const finalIndex = flatPages.length + 2;
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page';
    pageDiv.id = 'page' + finalIndex;
    pageDiv.innerHTML = `
      <h2>Поздравления! <i class="bi bi-stars"></i><br> Току що направихте най-важната стъпка по пътя към промяната</h2>
      <p>Натиснете бутона, за да изпратите вашите отговори за обработка.</p>
      <div class="nav-buttons" style="justify-content: center;">
        <button id="submitBtn" type="button">Изпрати</button>
        <button id="restartBtn" type="button">Отначало</button>
      </div>
       <div id="submit-message" class="message" style="margin-top: 15px; text-align: center; font-weight: bold; word-wrap: break-word;"></div>
    `;
    container.appendChild(pageDiv);
  }

  /***** Listener за финална страница (без промяна) *****/
  function setupFinalPageListener() {
        const finalIndex = flatPages.length + 2;
        const pageDiv = document.getElementById('page' + finalIndex);
        if (!pageDiv) { console.error("Финалната страница не е намерена."); return; }
        const submitBtn = pageDiv.querySelector('#submitBtn');
        const restartBtn = pageDiv.querySelector('#restartBtn');
        const submitMessage = pageDiv.querySelector('#submit-message');
        if (!submitBtn || !restartBtn || !submitMessage) { console.error("Един или повече елементи липсват на финалната страница."); return; }
        restartBtn.addEventListener('click', () => { clearProgress(); location.reload(); });
        submitBtn.addEventListener('click', async () => {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Изпращане...';
            hideMessage(submitMessage);
            try {
                const result = await submitResponses();
                showMessage(submitMessage, result.message || "Отговорите са изпратени успешно за обработка!", false);
                submitBtn.style.display = "none";
                restartBtn.disabled = false;
                restartBtn.textContent = "Попълни отново";
            } catch (error) {
                console.error("Error caught in submitBtn listener:", error);
                showMessage(submitMessage, `Грешка: ${error.message || 'Неуспешно изпращане.'}`, true);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Опитай отново';
            }
        });
   }

  /***** Показване на страница с условна логика (без промяна) *****/
  function showPage(index) {
    const pages = document.querySelectorAll('.page');
    if (!pages || pages.length === 0) { console.error("Не са намерени страници за показване."); return; }
    if (index > currentPageIndex) {
        let targetIndex = index;
        while (targetIndex < pages.length - 1) {
             const question = flatPages[targetIndex - 1];
            if (question && question.dependency) {
                const parentAnswer = responses[question.dependency.question];
                const dependencyValue = question.dependency.value;
                let shouldShow = Array.isArray(parentAnswer) ? parentAnswer.includes(dependencyValue) : parentAnswer === dependencyValue;
                if (!shouldShow) {
                    console.log(`Прескачане напред: стр. ${targetIndex}`);
                    targetIndex++; continue;
                 }
            }
             break;
         }
         index = targetIndex;
     } else if (index < currentPageIndex) {
         let targetIndex = index;
         while (targetIndex > 0) {
            const question = flatPages[targetIndex - 1];
             if (question && question.dependency) {
                 const parentAnswer = responses[question.dependency.question];
                 const dependencyValue = question.dependency.value;
                 let shouldShow = Array.isArray(parentAnswer) ? parentAnswer.includes(dependencyValue) : parentAnswer === dependencyValue;
                 if (!shouldShow) {
                     console.log(`Прескачане назад: стр. ${targetIndex}`);
                     targetIndex--; continue;
                 }
             }
             break;
         }
         index = targetIndex;
     }
    if (index < 0) index = 0;
    if (index >= pages.length) index = pages.length - 1;
     if (currentPageIndex > 0 && currentPageIndex < pages.length -1) {
         const previousQuestion = flatPages[currentPageIndex - 1];
         if (previousQuestion) { saveAnswer(previousQuestion); }
     }
    currentPageIndex = index;
    pages.forEach((pg, idx) => {
        pg.classList.toggle('active', idx === currentPageIndex);
    });
    const activePage = pages[currentPageIndex];
    if (activePage) {
        const firstInput = activePage.querySelector('input, select, textarea');
        if (firstInput) {
             setTimeout(() => { try { firstInput.focus(); } catch (e) { console.warn("Неуспешен опит за фокусиране:", e); } }, 50);
         }
    } else { console.error(`Грешка: Активна страница с индекс ${currentPageIndex} не е намерена.`); }
    updateProgress();
    const instr = document.getElementById('questInstructions');
    const stats = document.getElementById('persistentStats');
    const particles = document.getElementById('particles-js');
    if (instr && stats && particles) {
      const isHeroPage = currentPageIndex === 0;
      instr.style.display = isHeroPage ? 'none' : 'block';
      stats.style.display = isHeroPage ? 'none' : 'flex';
      particles.style.display = isHeroPage ? 'block' : 'none'; // Показваме частиците само на началната страница
    }
    console.log("Показване на страница:", currentPageIndex, `(ID: page${currentPageIndex})`);
  }

  /***** Останалите помощни функции (без промяна) *****/
  function updateProgress() {
    const progressBar = document.getElementById('questProgressBar');
    const currentLabel = document.getElementById('questCurrentStep');
    const totalLabel = document.getElementById('questTotalSteps');
    if (!progressBar || totalPages <= 1) return;
    const currentStep = currentPageIndex;
    const totalSteps = totalPages > 1 ? totalPages - 1 : 1;
    updateStepProgress(progressBar, currentStep, totalSteps, currentLabel, totalLabel);
  }
  function saveProgress() {
    try {
      localStorage.setItem('questResponses', JSON.stringify(responses));
      localStorage.setItem('questCurrentPage', String(currentPageIndex));
    } catch (e) { console.warn('Неуспешно записване в localStorage:', e); }
  }
  function loadProgress() {
    try {
      const savedResponses = localStorage.getItem('questResponses');
      const savedPage = localStorage.getItem('questCurrentPage');
      if (savedResponses) Object.assign(responses, JSON.parse(savedResponses));
      if (savedPage !== null) {
        const idx = parseInt(savedPage, 10);
        if (!Number.isNaN(idx)) currentPageIndex = idx;
      }
    } catch (e) { console.warn('Неуспешно зареждане от localStorage:', e); }
  }
  function applySavedResponses() {
    for (const [qId, answer] of Object.entries(responses)) {
      const question = flatPages.find(q => q.id === qId);
      if (!question) continue;
      const el = document.getElementById(qId);
      if (['text', 'number', 'email', 'textarea', 'select'].includes(question.type)) {
        if (el) el.value = answer;
      } else if (question.type === 'radio') {
        const radio = document.querySelector(`input[name="${qId}"][value="${answer}"]`);
        if (radio) radio.checked = true;
      } else if (question.type === 'checkbox' && Array.isArray(answer)) {
        answer.forEach(val => {
          const chk = document.querySelector(`input[name="${qId}"][value="${val}"]`);
          if (chk) chk.checked = true;
        });
      }
    }
  }
  function clearProgress() {
    localStorage.removeItem('questResponses');
    localStorage.removeItem('questCurrentPage');
    for (const key in responses) delete responses[key];
    currentPageIndex = 0;
  }
  function saveAnswer(question) {
      if (!question || !question.id) { return; }
      const qId = question.id; let answer;
      const element = document.getElementById(qId);
      if (['text', 'number', 'email', 'textarea'].includes(question.type)) { if (element) answer = element.value.trim(); } 
      else if (question.type === 'select') { if(element) answer = element.value; } 
      else if (question.type === 'radio') {
        const checkedRadio = document.querySelector(`input[name="${qId}"]:checked`);
        answer = checkedRadio ? checkedRadio.value : null;
      } else if (question.type === 'checkbox') {
        const checked = document.querySelectorAll(`input[name="${qId}"]:checked`);
        answer = Array.from(checked).map(ch => ch.value);
      }
      if (answer !== undefined) { responses[qId] = answer; saveProgress(); } 
      else { console.warn(`Не е намерен контрол за въпрос с ID: ${qId}`); }
  }
  function validateAnswer(question) {
    if (!question || !question.id) return true;
    const qId = question.id;
    let isValid = true;
    let errorMessage = '';
    const element = document.getElementById(qId);
    const isRequired = requiredFields.includes(qId);
    let value = '';
    if (['text', 'number', 'email', 'textarea'].includes(question.type)) {
        if (element) value = element.value.trim();
        if (isRequired && !value) { isValid = false; errorMessage = "Моля, попълнете това поле."; }
        else if (question.type === 'number') {
            const num = Number(value);
            if (value && isNaN(num)) { isValid = false; errorMessage = "Моля, въведете число."; }
            else { const range = numericRanges[qId]; if (range && (num < range.min || num > range.max)) { isValid = false; errorMessage = `Стойността трябва да е между ${range.min} и ${range.max}.`; } }
        }
    } else if (question.type === 'select') {
         if (element) value = element.value;
         if (isRequired && !value) { isValid = false; errorMessage = "Моля, направете избор."; }
     } else if (question.type === 'radio') {
        if (isRequired && !document.querySelector(`input[name="${qId}"]:checked`)) { isValid = false; errorMessage = "Моля, изберете една от опциите."; }
    } else if (question.type === 'checkbox') {
        if (isRequired && document.querySelectorAll(`input[name="${qId}"]:checked`).length === 0) { isValid = false; errorMessage = "Моля, изберете поне една опция."; }
    }
    const errorElementId = `error-${qId}`;
    let errorElement = document.getElementById(errorElementId);
    const pageElement = document.getElementById('page' + (flatPages.findIndex(p => p.id === qId) + 1));
    if (!isValid) {
        if (!errorElement && pageElement) {
            errorElement = document.createElement('div');
            errorElement.id = errorElementId;
            errorElement.className = 'validation-error';
            errorElement.style.color = 'var(--error-color)';
            errorElement.style.fontSize = '0.9em';
            errorElement.style.marginTop = '5px';
            errorElement.setAttribute('role', 'alert');
            const navButtons = pageElement.querySelector('.nav-buttons');
            if(navButtons) { pageElement.insertBefore(errorElement, navButtons); }
            else { pageElement.appendChild(errorElement); }
        }
        if (errorElement) { errorElement.textContent = errorMessage; }
    } else if (errorElement) { errorElement.remove(); }
    return isValid;
  }
  async function submitResponses() {
      responses.submissionDate = new Date().toISOString();
      console.log("Starting submitResponses...", JSON.stringify(responses, null, 2));
      const userEmail = String(responses.email || (document.getElementById('register-email-q') ? document.getElementById('register-email-q').value : '')).trim().toLowerCase();
      responses.email = userEmail;
       try {
            const workerResponse = await fetch(`${workerBaseUrl}/api/submitQuestionnaire`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(responses)
            });
            const responseData = await workerResponse.json();
            if (!workerResponse.ok) { throw new Error(responseData.message || `Worker отговори със статус ${workerResponse.status}`); }
            delete responses.submissionDate;
            return responseData;
        } catch (error) {
             delete responses.submissionDate;
             throw new Error(`Грешка при комуникация със сървъра: ${error.message}`);
        }
  }

  // --- Зареждане на въпросника при старт (без промяна) ---
   document.addEventListener('DOMContentLoaded', () => {
     fetch('questions.json')
       .then(res => {
         if (!res.ok) throw new Error(`HTTP ${res.status} при зареждане на questions.json`);
         const contentType = res.headers.get("content-type");
         if (contentType && !contentType.includes("application/json")) { throw new TypeError(`Очакван JSON, но получен ${contentType}`); }
         return res.json();
       })
       .then(data => {
         if (!Array.isArray(data) || data.length === 0) { throw new Error("questions.json е празен или невалиден масив."); }
         rawQuestions = data;
         buildDynamicPages();
         loadProgress();
         applySavedResponses();
         showPage(currentPageIndex);
       })
       .catch(err => {
           console.error('Грешка при зареждане или обработка на questions.json:', err);
           const container = document.getElementById('dynamicContainer');
           if(container) { container.innerHTML = `<div style="color: #e74c3c; text-align: center; padding: 20px;">Възникна грешка при зареждане на въпросника. (${err.message})</div>`; }
        });
       const secretArea = document.getElementById('secretTapArea');
       const adminLink = document.getElementById('adminLink');
       if(secretArea && adminLink) {
           secretArea.addEventListener('click', function() {
             adminLink.style.display = 'block';
             setTimeout(() => { adminLink.style.display = 'none'; }, 10000);
           });
       }
   });
</script>

</body>
</html>
